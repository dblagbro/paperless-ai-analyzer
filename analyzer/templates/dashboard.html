<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paperless AI Analyzer</title>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }

        header p {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-card.status-running .value {
            color: #27ae60;
        }

        .stat-card.status-warning .value {
            color: #f39c12;
        }

        .stat-card.status-error .value {
            color: #e74c3c;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .recent-item {
            padding: 12px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .recent-item.has-anomalies {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .recent-item.high-risk {
            border-left-color: #f39c12;
            background: #fffbf0;
        }

        .recent-item .title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .recent-item .meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .recent-item .meta span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            background: #ecf0f1;
            color: #2c3e50;
            margin-right: 5px;
        }

        .tag.anomaly {
            background: #e74c3c;
            color: white;
        }

        .tag.ai {
            background: #9b59b6;
            color: white;
        }

        .profile-list {
            list-style: none;
        }

        .profile-list li {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-list li:last-child {
            border-bottom: none;
        }

        .profile-name {
            font-weight: 600;
        }

        .profile-version {
            font-size: 12px;
            color: #666;
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .staging-profile {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .staging-profile .filename {
            font-weight: 600;
            color: #856404;
        }

        .staging-profile .actions {
            margin-top: 8px;
            font-size: 12px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-warning {
            background: #e74c3c;
        }

        .btn-warning:hover {
            background: #c0392b;
        }

        /* Tab Navigation */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tabs-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab-button.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Configuration sub-tabs */
        .config-sub-nav {
            display: flex;
            gap: 2px;
            margin-bottom: 0;
            border-bottom: 2px solid #dee2e6;
            padding: 8px 16px 0;
            flex-wrap: wrap;
            flex-shrink: 0;
            background: white;
        }
        .config-sub-btn {
            background: none;
            border: 1px solid transparent;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 13px;
            color: #555;
            border-radius: 6px 6px 0 0;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .config-sub-btn:hover { background: #f0f4f8; color: #333; }
        .config-sub-btn.active {
            color: #2980b9;
            border-bottom-color: #2980b9;
            font-weight: 600;
            background: #f8fbff;
        }
        .config-sub-content { display: none; }

        /* ‚îÄ‚îÄ Tab Help Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .tab-help-panel {
            display: none;
            background: #eaf4fb;
            border: 1px solid #b3d9f0;
            border-left: 4px solid #3498db;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 18px;
            font-size: 13px;
            color: #2c3e50;
            animation: fadeIn 0.2s ease;
        }
        .tab-help-panel ul { margin: 6px 0 0 0; padding-left: 18px; }
        .tab-help-panel li { margin-bottom: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .config-sub-content.active { display: block; animation: fadeIn 0.2s; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ‚îÄ‚îÄ Header Health Widget (v2.5.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .hh-dot { display:inline-block; width:10px; height:10px; border-radius:50%;
                  background:var(--hh-color,#555); transition:background 0.4s; cursor:default; }
        .hh-dot.hh-ok      { --hh-color:#27ae60; }
        .hh-dot.hh-warning { --hh-color:#f39c12; animation:hh-pulse-warn 1.5s infinite; }
        .hh-dot.hh-error   { --hh-color:#e74c3c; animation:hh-pulse-err  0.8s infinite; }
        .hh-dot.hh-loading { --hh-color:#555; }
        @keyframes hh-pulse-warn { 0%,100%{opacity:1} 50%{opacity:0.5} }
        @keyframes hh-pulse-err  {
          0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(231,76,60,.6)}
          50%{opacity:.7;box-shadow:0 0 0 4px rgba(231,76,60,0)} }

        /* ‚îÄ‚îÄ Tools sub-tabs (mirror config-sub-* visuals) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .tools-sub-nav { display:flex; gap:6px; padding:0 0 12px 0; border-bottom:2px solid #ecf0f1; margin-bottom:16px; flex-wrap:wrap; }
        .tools-sub-btn { padding:7px 16px; border-radius:6px; border:1px solid #dde3ea; background:#f8f9fa; color:#555; font-size:13px; cursor:pointer; font-weight:500; transition:background 0.15s,color 0.15s; }
        .tools-sub-btn:hover { background:#f0f4f8; color:#333; }
        .tools-sub-btn.active { background:#2980b9; color:#fff; border-color:#2980b9; }
        .tools-sub-content { display:none; }
        .tools-sub-content.active { display:block; animation:fadeIn 0.2s; }

        .full-width {
            grid-column: 1 / -1;
        }

        .actions-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .actions-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .action-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .action-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .logs-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .logs-viewer .log-line {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .logs-viewer .log-line.error {
            color: #f48771;
        }

        .logs-viewer .log-line.warning {
            color: #dcdcaa;
        }

        .logs-viewer .log-line.info {
            color: #4fc1ff;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-bar input, .search-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-bar input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .search-bar input[type="number"] {
            width: 100px;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .action-group {
                flex-direction: column;
                align-items: stretch;
            }

            .action-group input, .action-group button {
                width: 100%;
            }
        }

        /* Chat Interface Styles */
        .chat-container {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .chat-message.user {
            justify-content: flex-end;
        }

        .chat-message.assistant {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 14px;
        }

        /* Markdown formatting in chat bubbles */
        .message-bubble p {
            margin: 0 0 8px 0;
        }

        .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message-bubble ul,
        .message-bubble ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-bubble li {
            margin: 4px 0;
        }

        .message-bubble strong {
            font-weight: 600;
            color: inherit;
        }

        .message-bubble em {
            font-style: italic;
        }

        .message-bubble code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-bubble pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-bubble pre code {
            background: none;
            padding: 0;
        }

        .message-bubble table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .message-bubble table th,
        .message-bubble table td {
            border: 1px solid rgba(0, 0, 0, 0.2);
            padding: 6px 10px;
            text-align: left;
        }

        .message-bubble table th {
            background: rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .message-bubble table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-bubble blockquote {
            border-left: 3px solid rgba(0, 0, 0, 0.3);
            padding-left: 12px;
            margin: 8px 0;
            font-style: italic;
            opacity: 0.9;
        }

        .message-bubble h1,
        .message-bubble h2,
        .message-bubble h3,
        .message-bubble h4 {
            margin: 12px 0 8px 0;
            font-weight: 600;
        }

        .message-bubble h1 { font-size: 1.4em; }
        .message-bubble h2 { font-size: 1.2em; }
        .message-bubble h3 { font-size: 1.1em; }
        .message-bubble h4 { font-size: 1em; }

        .message-bubble hr {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.2);
            margin: 12px 0;
        }

        .chat-message.user .message-bubble {
            background: #3498db;
            color: white;
        }

        .chat-message.assistant .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-meta {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .chat-input-area {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            resize: none;
            overflow-y: auto;
            max-height: 120px;
            line-height: 1.4;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #3498db;
        }

        .chat-send-btn {
            padding: 10px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .chat-send-btn:hover {
            background: #2980b9;
        }

        .chat-send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #95a5a6;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-suggestions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 10px 0;
        }

        .suggestion-chip {
            padding: 6px 12px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Vector Store Management Styles */
        .vector-type-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .vector-type-header {
            background: #f8f9fa;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .vector-type-header h3 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .vector-type-count {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        .vector-documents-list {
            background: white;
        }

        .vector-doc-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vector-doc-item:last-child {
            border-bottom: none;
        }

        .vector-doc-item:hover {
            background: #f8f9fa;
        }

        .vector-doc-info {
            flex: 1;
        }

        .vector-doc-title {
            font-weight: 500;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .vector-doc-id {
            font-size: 12px;
            color: #999;
            font-family: monospace;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow: auto;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #2c3e50;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }

        .modal-body {
            padding: 24px;
        }

        .evidence-item {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .evidence-item.severity-critical {
            border-left-color: #e74c3c;
            background: #fef5f5;
        }

        .evidence-item.severity-high {
            border-left-color: #f39c12;
            background: #fef9f3;
        }

        .evidence-item.severity-medium {
            border-left-color: #f39c12;
            background: #fffef8;
        }

        .evidence-item.severity-low {
            border-left-color: #95a5a6;
            background: #f8f9fa;
        }

        .evidence-tag-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .evidence-severity {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .evidence-severity.critical {
            background: #e74c3c;
            color: white;
        }

        .evidence-severity.high {
            background: #f39c12;
            color: white;
        }

        .evidence-severity.medium {
            background: #f39c12;
            color: white;
        }

        .evidence-severity.low {
            background: #95a5a6;
            color: white;
        }

        .evidence-severity.info {
            background: #3498db;
            color: white;
        }

        .evidence-item.severity-info {
            border-left: 4px solid #3498db;
            background: #f0f9ff;
        }

        .evidence-description {
            font-size: 14px;
            color: #555;
            margin: 8px 0;
            line-height: 1.6;
        }

        .evidence-quotes {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border: 1px solid #e0e0e0;
        }

        .evidence-quotes h4 {
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .evidence-quote {
            font-style: italic;
            color: #444;
            padding: 8px;
            border-left: 3px solid #3498db;
            margin: 6px 0;
            background: #f8f9fa;
        }

        .evidence-location {
            font-size: 12px;
            color: #999;
            font-family: monospace;
            margin-top: 4px;
        }

        .evidence-impact {
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
        }

        .evidence-impact strong {
            color: #2c3e50;
        }

        .tag.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag.clickable:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0.9;
        }

        .no-evidence {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* ‚îÄ‚îÄ Sidebar layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #app-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #chat-sidebar {
            width: 260px;
            flex-shrink: 0;
            background: #1e2a38;
            color: #cdd4dc;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid #263444;
        }

        #chat-sidebar .sidebar-header {
            padding: 16px 14px 12px;
            border-bottom: 1px solid #263444;
        }

        #chat-sidebar .sidebar-header h3 {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.3px;
            margin-bottom: 10px;
        }

        .btn-new-chat {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            background: #2c86d4;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        .btn-new-chat:hover { background: #1a76c4; }

        #session-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        #session-list::-webkit-scrollbar { width: 4px; }
        #session-list::-webkit-scrollbar-thumb { background: #334455; border-radius: 2px; }

        .session-group-header {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #667788;
            padding: 10px 14px 4px;
        }

        .session-item {
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 0;
            transition: background 0.1s;
            position: relative;
        }
        .session-item:hover { background: #263444; }
        .session-item.active { background: #2c3e50; }

        .session-title {
            font-size: 13px;
            color: #d0d8e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 180px;
        }
        .session-meta {
            font-size: 11px;
            color: #556677;
            margin-top: 2px;
        }

        .session-badge-shared {
            font-size: 10px;
            background: #2c86d4;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 4px;
        }

        .session-actions {
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            gap: 4px;
        }
        .session-item:hover .session-actions { display: flex; }

        .session-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0.7;
            transition: opacity 0.1s;
        }
        .session-action-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }

        .sidebar-footer {
            padding: 12px 14px;
            border-top: 1px solid #263444;
            font-size: 12px;
        }

        .sidebar-user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .role-badge {
            font-size: 10px;
            padding: 1px 7px;
            border-radius: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .role-badge.admin { background: #e74c3c; color: white; }
        .role-badge.advanced { background: #8e44ad; color: white; }
        .role-badge.basic { background: #3d5166; color: #aabbcc; }

        .btn-logout {
            display: block;
            width: 100%;
            padding: 6px;
            background: none;
            border: 1px solid #334455;
            color: #8899aa;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }
        .btn-logout:hover { background: #263444; color: #cdd4dc; border-color: #4455667; }

        #main-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* ‚îÄ‚îÄ Chat session header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .chat-session-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .chat-session-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-session-actions { display: flex; gap: 8px; }
        .btn-session-action {
            padding: 5px 12px;
            font-size: 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .btn-session-action:hover { background: #f0f0f0; }

        /* ‚îÄ‚îÄ Share modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #share-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #share-modal.active { display: flex; }
        .share-modal-box {
            background: white;
            border-radius: 10px;
            padding: 28px;
            width: 420px;
            max-width: 96vw;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }
        .share-modal-box h3 { margin-bottom: 18px; font-size: 17px; color: #2c3e50; }
        .share-input-row { display: flex; gap: 8px; margin-bottom: 14px; }
        .share-input-row input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .share-list { margin-top: 12px; }
        .share-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 7px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        /* ‚îÄ‚îÄ User management table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .user-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .user-table th, .user-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .user-table th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 12px; text-transform: uppercase; }
        .user-table tr:hover td { background: #fafafa; }

        /* ‚îÄ‚îÄ Full-width, full-height layout ‚îÄ‚îÄ */
        /* Remove max-width constraint so tabs fill the screen at any zoom level */
        .container { max-width: 100%; }
        header .container { padding: 6px 20px; }        /* keep header content padded */
        #main-content > .container {
            flex: 1; overflow: hidden; display: flex; flex-direction: column;
            padding: 0; min-height: 0; margin: 0;
        }
        /* Compact header ‚Äî reduce wasted dark-grey space */
        header { padding: 6px 0; margin-bottom: 0; flex-shrink: 0; }
        header h1 { font-size: 20px; }
        header p  { font-size: 11px; margin-top: 1px; opacity: 0.75; }
        /* Tabs full-width, no rounded corners at page edges */
        .tabs-container {
            flex: 1; overflow: hidden; display: flex; flex-direction: column;
            margin-bottom: 0; min-height: 0;
            border-radius: 0; box-shadow: none; border-top: 1px solid #dde1e7;
        }
        .tabs-nav { flex-shrink: 0; }
        /* Tab buttons: tighter padding at full width */
        .tab-button { padding: 11px 16px; font-size: 13px; }
        /* Non-chat tabs scroll within the tab panel */
        .tab-content.active { flex: 1; overflow-y: auto; min-height: 0; }
        /* Config tab: flex column ‚Äî sub-nav is a fixed header, active pane scrolls in remaining space */
        #tab-config.tab-content.active { display: flex !important; flex-direction: column !important; overflow: hidden !important; padding: 0 !important; }
        .config-sub-content.active { flex: 1 !important; overflow-y: auto !important; min-height: 0 !important; padding: 16px !important; }
        /* Debug & Tools: tighten top gap */
        #tab-tools.tab-content { padding-top: 10px; }

        /* ‚îÄ‚îÄ AI Chat tab: two-column full-height layout ‚îÄ‚îÄ */
        #tab-ai-chat.active {
            display: flex; flex-direction: column;
            overflow: hidden; padding: 0; flex: 1;
        }
        #tab-ai-chat .tab-help-panel {
            margin: 0; border-radius: 0;
            border-bottom: 1px solid #d0d5dd; flex-shrink: 0;
        }
        .chat-layout {
            flex: 1; display: flex; flex-direction: row;
            overflow: hidden; min-height: 0;
        }
        /* Sessions sidebar inside chat tab */
        .chat-sessions-panel {
            width: 220px; flex-shrink: 0;
            background: #1e2a38; color: #cdd4dc;
            display: flex; flex-direction: column;
            overflow: hidden; border-right: 1px solid #263444;
        }
        .sessions-panel-header {
            padding: 14px 12px 12px; border-bottom: 1px solid #263444;
            display: flex; flex-direction: column; gap: 8px; flex-shrink: 0;
        }
        .sessions-panel-header h3 { font-size: 13px; font-weight: 700; color: #fff; margin: 0; }
        /* Main chat area */
        .chat-main-panel {
            flex: 1; display: flex; flex-direction: column;
            overflow: hidden; min-width: 0; background: #f8f9fa;
        }
        #tab-ai-chat #ai-key-warning { flex-shrink: 0; margin: 10px 16px; }
        #tab-ai-chat .chat-container {
            flex: 1; height: auto; margin: 0;
            border-radius: 0; box-shadow: none; min-height: 0;
        }
        #tab-ai-chat .chat-messages { flex: 1; min-height: 0; }
    </style>
</head>
<body>
<div id="app-layout">
    <!-- ‚îÄ‚îÄ Chat Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <!-- ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="main-content">
    <header>
        <div class="container" style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
            <div>
                <h1><span class="status-indicator"></span> Paperless AI Analyzer</h1>
                <p>Intelligent document analysis and anomaly detection</p>
            </div>
            <div id="header-health" style="flex-shrink:0; text-align:center;">
                <div style="color:#aabbcc;font-size:11px;margin-bottom:4px;letter-spacing:.5px;text-transform:uppercase;">Systems</div>
                <div style="display:flex;gap:6px;align-items:center;justify-content:center;">
                    <span class="hh-dot hh-loading" data-comp="paperless_api"  title="Paperless API"></span>
                    <span class="hh-dot hh-loading" data-comp="chromadb"       title="ChromaDB"></span>
                    <span class="hh-dot hh-loading" data-comp="llm"            title="LLM"></span>
                    <span class="hh-dot hh-loading" data-comp="analyzer_loop"  title="Analyzer Loop"></span>
                    <span class="hh-dot hh-loading" data-comp="postgres"       title="PostgreSQL"></span>
                    <span class="hh-dot hh-loading" data-comp="redis"          title="Redis"></span>
                </div>
                <div id="hh-overall" onclick="switchTab('tools')"
                     style="font-size:10px;color:#aabbcc;margin-top:3px;cursor:pointer;" title="View Health Details">Checking‚Ä¶</div>
            </div>
            <div style="text-align: right;">
                <label for="project-selector" style="color: white; font-size: 14px; display: block; margin-bottom: 5px;">Current Project:</label>
                <select id="project-selector" onchange="switchProject()" style="padding: 8px 12px; font-size: 14px; border-radius: 4px; border: 1px solid #bdc3c7; min-width: 200px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div style="text-align: right; flex-shrink: 0;">
                <div style="color: #cce5ff; font-size: 13px; margin-bottom: 6px; display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                    <a href="{{ request.script_root }}/docs" target="_blank" style="background: rgba(255,255,255,0.15); color: #cce5ff; border: 1px solid rgba(255,255,255,0.35); padding: 3px 10px; border-radius: 5px; font-size: 12px; text-decoration: none;" title="Open the full user manual">üìñ Users Manual</a>
                    <span><strong>{{ current_user.display_name }}</strong>
                    <span style="background: {{ '#e74c3c' if is_admin else ('#8e44ad' if current_user.role == 'advanced' else '#3498db') }}; color: white; font-size: 11px; padding: 1px 6px; border-radius: 10px; margin-left: 6px;">{{ 'Admin' if is_admin else ('Advanced' if current_user.role == 'advanced' else 'Basic') }}</span></span>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap;">
                    <button onclick="openAboutModal()" style="background: rgba(255,255,255,0.12); color: #cce5ff; border: 1px solid rgba(255,255,255,0.25); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" title="About this application">About</button>
                    <button onclick="toggleTabHelp()" id="help-toggle-btn" style="background: rgba(255,255,255,0.12); color: #cce5ff; border: 1px solid rgba(255,255,255,0.25); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" title="Toggle help panel for current tab">? Help: Off</button>
                    <button onclick="openBugReportModal()" style="background: rgba(255,165,0,0.25); color: #ffd580; border: 1px solid rgba(255,165,0,0.4); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" title="Report a problem">üêõ Report Issue</button>
                    <button onclick="openProfileModal()" style="background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">üë§ My Profile</button>
                    <a href="{{ url_for('logout') }}" style="background: rgba(231,76,60,0.7); color: white; border: 1px solid rgba(231,76,60,0.9); padding: 5px 12px; border-radius: 5px; font-size: 12px; text-decoration: none; display: inline-block;">Sign Out</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Change Password Modal -->
    <div id="profile-modal" onclick="if(event.target===this)closeProfileModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#243447; border-radius:12px; padding:0; width:100%; max-width:520px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.6);">
            <!-- Header -->
            <div style="padding:22px 28px 16px; border-bottom:1px solid #334455; display:flex; align-items:center; justify-content:space-between;">
                <div>
                    <div style="color:#fff; font-size:16px; font-weight:700;">üë§ My Profile</div>
                    <div id="profile-username-display" style="color:#7a9bb5; font-size:12px; margin-top:2px;"></div>
                </div>
                <button onclick="closeProfileModal()" style="background:none; border:none; color:#7a9bb5; font-size:22px; cursor:pointer; padding:0 4px; line-height:1;">√ó</button>
            </div>

            <!-- Alerts -->
            <div style="padding:0 28px;">
                <div id="profile-error" style="display:none; background:rgba(231,76,60,0.2); border:1px solid rgba(231,76,60,0.5); color:#f08080; padding:8px 12px; border-radius:5px; font-size:13px; margin-top:14px;"></div>
                <div id="profile-success" style="display:none; background:rgba(39,174,96,0.2); border:1px solid rgba(39,174,96,0.5); color:#7dcea0; padding:8px 12px; border-radius:5px; font-size:13px; margin-top:14px;"></div>
            </div>

            <!-- Profile fields -->
            <div style="padding:20px 28px 0;">
                <div style="font-size:11px; font-weight:700; text-transform:uppercase; color:#5a7a99; letter-spacing:.08em; margin-bottom:14px;">Profile Information</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px;">
                    <div>
                        <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Full Name</label>
                        <input type="text" id="profile-display-name" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Job Title</label>
                        <input type="text" id="profile-job-title" placeholder="e.g. Attorney, Paralegal" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
                    </div>
                </div>
                <div style="margin-bottom:14px;">
                    <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Email Address</label>
                    <input type="email" id="profile-email" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
                </div>
                <div style="margin-bottom:14px;">
                    <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Phone Number</label>
                    <input type="tel" id="profile-phone" placeholder="e.g. +1 555 000 0000" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
                </div>
                <div style="margin-bottom:20px;">
                    <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Address</label>
                    <textarea id="profile-address" rows="2" placeholder="Street, City, State, ZIP" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box; resize:vertical; font-family:inherit;"></textarea>
                </div>
                <div style="text-align:right; margin-bottom:24px;">
                    <button onclick="submitProfileUpdate()" style="padding:9px 22px; background:#4a90d9; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600;">Save Profile</button>
                </div>
            </div>

            <!-- Divider -->
            <div style="border-top:1px solid #334455;"></div>

            <!-- Change password -->
            <div style="padding:20px 28px 24px;">
                <div style="font-size:11px; font-weight:700; text-transform:uppercase; color:#5a7a99; letter-spacing:.08em; margin-bottom:14px;">Change Password</div>
                <div id="cp-error" style="display:none; background:rgba(231,76,60,0.2); border:1px solid rgba(231,76,60,0.5); color:#f08080; padding:8px 12px; border-radius:5px; font-size:13px; margin-bottom:14px;"></div>
                <div id="cp-success" style="display:none; background:rgba(39,174,96,0.2); border:1px solid rgba(39,174,96,0.5); color:#7dcea0; padding:8px 12px; border-radius:5px; font-size:13px; margin-bottom:14px;"></div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:16px;">
                    <div>
                        <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Current Password</label>
                        <input type="password" id="cp-current" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;" autocomplete="current-password">
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">New Password</label>
                        <input type="password" id="cp-new" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;" autocomplete="new-password">
                    </div>
                    <div>
                        <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Confirm Password</label>
                        <input type="password" id="cp-confirm" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;" autocomplete="new-password">
                    </div>
                </div>
                <div style="text-align:right;">
                    <button onclick="submitChangePassword()" style="padding:9px 22px; background:#5a6a7a; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600;">Update Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Backward-compat alias so any other code that calls openChangePasswordModal() still works -->
    <script>function openChangePasswordModal() { openProfileModal(); }</script>

    <div class="container">
        <!-- Tabbed Interface -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab-button" onclick="switchTab('projects')">üìÅ Manage Projects</button>
                <button class="tab-button" onclick="switchTab('upload')">üì§ Smart Upload</button>
                <button class="tab-button" onclick="switchTab('ai-chat')">üí¨ AI Chat</button>
                {% if CI_ENABLED %}<button class="tab-button" onclick="switchTab('case-intelligence')" id="ci-tab-btn">‚öñÔ∏è Case Intelligence</button>{% endif %}
                <button class="tab-button" onclick="switchTab('search')">üîç Search & Analysis</button>
                <button class="tab-button" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
                <button class="tab-button" onclick="switchTab('tools')">üõ†Ô∏è Debug & Tools</button>
            </div>

            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="tab-help-panel" id="help-overview">
                    <strong>üìä Overview</strong> ‚Äî At a glance, this tab shows the live status of the analyzer and key stats.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Documents Analyzed</strong> ‚Äî Total documents the AI has processed.</li>
                        <li><strong>Anomalies Detected</strong> ‚Äî Documents flagged with any anomaly (balance mismatch, layout issues, etc.).</li>
                        <li><strong>High Risk</strong> ‚Äî Documents with critical or high-severity anomalies requiring review.</li>
                        <li><strong>Recent Activity</strong> ‚Äî The latest processed documents and their results.</li>
                        <li>Use <em>Configuration ‚Üí AI Settings</em> to connect an AI model if no analysis is running.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/overview" target="_blank" style="color:#5dade2;">üìñ Full manual for this section ‚Üí</a></div>
                </div>
                <!-- Status bar moved into Overview tab -->
                <div class="status-bar" style="margin-bottom: 30px;">
                    <div class="stat-card status-running">
                        <h3>Status</h3>
                        <div class="value" id="status">Running</div>
                    </div>
                    <div class="stat-card">
                        <h3>Documents Analyzed</h3>
                        <div class="value" id="total-analyzed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Anomalies Detected</h3>
                        <div class="value" id="anomalies-detected">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>High Risk Documents</h3>
                        <div class="value" id="high-risk-count">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Profiles</h3>
                        <div class="value" id="active-profiles">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Embedded (RAG)</h3>
                        <div class="value" id="embedded-docs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Last Update</h3>
                        <div class="value" id="last-update" style="font-size: 14px;">Never</div>
                    </div>
                </div>

                <h2>Recent Activity</h2>
                <div id="recent-analyses" class="loading">Loading...</div>
            </div>

            <!-- Manage Projects Tab -->
            <div id="tab-projects" class="tab-content">
                <div class="tab-help-panel" id="help-projects">
                    <strong>üìÅ Manage Projects</strong> ‚Äî Projects group related documents so the AI can reason across them together.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>Click <strong>+ New Project</strong> to create a project and give it a name, description, and tags.</li>
                        <li>Use <strong>üì¶ Move Documents</strong> to reassign documents from one project to another.</li>
                        <li>Use <strong>üóÑÔ∏è Archive</strong> to hide completed projects without deleting them.</li>
                        <li>The <strong>Current Project</strong> selector in the header controls which project context the AI Chat uses.</li>
                        <li>Deleting a project removes it from the analyzer but does <em>not</em> delete documents from Paperless.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/projects" target="_blank" style="color:#5dade2;">üìñ Full manual for this section ‚Üí</a></div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <h2 style="margin:0 0 4px 0;">üìÅ Manage Projects</h2>
                        <p style="color:#666; margin:0; font-size:14px;">Organize documents into projects for better analysis and cross-document reference checking.</p>
                    </div>
                    <button class="btn btn-primary" onclick="openNewProjectModal()" style="white-space:nowrap;">+ New Project</button>
                </div>

                <div id="projects-list" class="loading">Loading projects...</div>
            </div>

            <!-- ‚îÄ‚îÄ Project New/Edit Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="proj-modal" onclick="if(event.target===this)closeProjModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:10px; padding:28px; width:100%; max-width:480px; box-shadow:0 8px 30px rgba(0,0,0,.2); position:relative;">
                    <h3 id="proj-modal-title" style="margin:0 0 20px 0; color:#111;">New Project</h3>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Name <span style="color:#e74c3c;">*</span></label>
                    <input type="text" id="proj-name" placeholder="e.g. Chase Bank 2026"
                        oninput="autoSlug()"
                        style="width:100%; box-sizing:border-box; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;">

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Slug</label>
                    <input type="text" id="proj-slug" placeholder="auto-generated"
                        style="width:100%; box-sizing:border-box; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:5px; font-family:monospace;">
                    <div style="font-size:11px; color:#9ca3af; margin-bottom:14px;">Lowercase letters, numbers and hyphens only. Cannot be changed after creation.</div>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Description</label>
                    <textarea id="proj-desc" rows="2" placeholder="Optional description"
                        style="width:100%; box-sizing:border-box; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; resize:vertical; margin-bottom:14px;"></textarea>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:8px;">Color</label>
                    <div id="proj-color-swatches" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px;">
                    </div>
                    <input type="color" id="proj-color-custom"
                        style="width:36px; height:28px; border:1px solid #d1d5db; border-radius:4px; cursor:pointer; padding:2px;"
                        onchange="selectCustomColor(this.value)">
                    <span style="font-size:12px; color:#6b7280; margin-left:6px;">or pick custom</span>
                    <input type="hidden" id="proj-color-val" value="#3b82f6">

                    <div id="proj-modal-error" style="display:none; color:#e74c3c; font-size:13px; margin-top:10px;"></div>

                    <div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;">
                        <button onclick="closeProjModal()" style="padding:9px 18px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:14px;">Cancel</button>
                        <button class="btn btn-primary" onclick="saveProject()" id="proj-save-btn" style="padding:9px 20px;">Save</button>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Move Documents Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="move-modal" onclick="if(event.target===this)closeMoveModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:10px; padding:28px; width:100%; max-width:500px; box-shadow:0 8px 30px rgba(0,0,0,.2); position:relative;">
                    <h3 style="margin:0 0 20px 0; color:#111;">Move Documents</h3>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">From project</label>
                    <select id="move-source" onchange="updateMovePreview()"
                        style="width:100%; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;"></select>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">To project</label>
                    <select id="move-dest" onchange="updateMovePreview()"
                        style="width:100%; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;"></select>

                    <div style="margin-bottom:14px;">
                        <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Which documents?</label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:14px; margin-bottom:8px; cursor:pointer;">
                            <input type="radio" name="move-scope" value="all" checked onchange="toggleMoveIds()"> Move <strong id="move-all-count">all</strong> documents in source project
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:14px; cursor:pointer;">
                            <input type="radio" name="move-scope" value="specific" onchange="toggleMoveIds()"> Specify document IDs
                        </label>
                        <div id="move-ids-wrap" style="display:none; margin-top:8px;">
                            <input type="text" id="move-doc-ids" placeholder="Comma-separated IDs, e.g. 12,45,67"
                                style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                            <div style="font-size:11px; color:#9ca3af; margin-top:3px;">Find document IDs in Paperless or the Overview tab</div>
                        </div>
                    </div>

                    <div id="move-preview" style="background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px; padding:10px 14px; font-size:13px; color:#0c4a6e; display:none;"></div>

                    <div id="move-modal-error" style="display:none; color:#e74c3c; font-size:13px; margin-top:10px;"></div>
                    <div id="move-modal-status" style="display:none; font-size:13px; margin-top:10px;"></div>

                    <div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;">
                        <button onclick="closeMoveModal()" style="padding:9px 18px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:14px;">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmMove()" id="move-confirm-btn" style="padding:9px 20px;">Move Documents</button>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Delete Confirm Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="del-proj-modal" onclick="if(event.target===this)closeDelProjModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:10px; padding:28px; width:100%; max-width:420px; box-shadow:0 8px 30px rgba(0,0,0,.2);">
                    <h3 style="margin:0 0 12px 0; color:#b91c1c;">Delete Project</h3>
                    <p style="font-size:14px; color:#374151; margin:0 0 14px 0;">
                        Delete <strong id="del-proj-name"></strong>? This removes the project and its <strong id="del-proj-count"></strong> document(s) from all project tracking.
                    </p>
                    <label style="display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; cursor:pointer; margin-bottom:18px;">
                        <input type="checkbox" id="del-proj-data" checked style="width:15px;height:15px;">
                        Also delete analyzer state &amp; vector data for this project
                    </label>
                    <input type="hidden" id="del-proj-slug">
                    <div id="del-proj-error" style="display:none; color:#e74c3c; font-size:13px; margin-bottom:10px;"></div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button onclick="closeDelProjModal()" style="padding:9px 18px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:14px;">Cancel</button>
                        <button onclick="confirmDeleteProject()" style="padding:9px 18px; background:#dc2626; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Smart Upload Tab -->
            <div id="tab-upload" class="tab-content">
                <div class="tab-help-panel" id="help-upload">
                    <strong>üì§ Smart Upload</strong> ‚Äî Get documents into Paperless from any source.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>File</strong> ‚Äî Drag and drop or browse for a PDF, image, or document file.</li>
                        <li><strong>URL</strong> ‚Äî Paste a direct file link <em>or a folder/directory URL</em>. If the URL points to an HTML directory listing, all compatible files are discovered automatically. Add Basic Auth credentials if the link requires a login.</li>
                        <li><strong>Cloud Share Link</strong> ‚Äî Paste a Google Drive, Dropbox, or OneDrive share link; it will be converted automatically to a direct download URL.</li>
                        {% if COURT_IMPORT_ENABLED %}<li><strong>Court Import</strong> ‚Äî Pull entire case files from federal courts (PACER / CourtListener RECAP) or NYS NYSCEF directly into your project library with 3-tier deduplication. Click <strong>üìã Paste credentials</strong> to let AI extract login info from any email or Slack message in one step, or <strong>‚öôÔ∏è Manage</strong> to enter credentials manually. NYSCEF: attorneys enter their NY Bar Registration #; parties/defendants without bar numbers tick <em>Pro Se / Party access</em> and use a free NYSCEF account (create at iapps.courts.state.ny.us/nyscef ‚Üí Unrepresented Litigants). <a href="{{ request.script_root }}/docs/court-import#court-nyscef-prose" target="_blank" style="color:#5dade2;">Pro Se setup guide ‚Üí</a></li>{% endif %}
                        <li>Enable <strong>Smart Metadata</strong> (File / URL / Cloud modes) to let the AI suggest a title, tags, and project assignment before uploading.</li>
                        <li>The <strong>Recent Imports</strong> panel below tracks all file/URL/cloud uploads with their status and Paperless document IDs.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/upload" target="_blank" style="color:#5dade2;">üìñ Full manual for this section ‚Üí</a></div>
                </div>
                <h2>üì§ Smart Upload</h2>
                <p style="color: #666; margin-bottom: 20px;">Upload documents to Paperless from a file, URL, or cloud share link.</p>

                <!-- Upload Source Card -->
                <div style="background: white; border: 1px solid #e1e4e8; border-radius: 10px; overflow: hidden; margin-bottom: 24px; box-shadow: 0 1px 4px rgba(0,0,0,.06);">

                    <!-- Mode tabs -->
                    <div style="display: flex; border-bottom: 1px solid #e1e4e8; background: #f6f8fa;">
                        <button id="umode-file" onclick="switchUploadMode('file')"
                            style="flex:1; padding: 12px 0; border: none; background: #fff; border-bottom: 3px solid #2563eb; font-weight: 600; color: #2563eb; cursor: pointer; font-size: 14px;">
                            üìÅ File
                        </button>
                        <button id="umode-url" onclick="switchUploadMode('url')"
                            style="flex:1; padding: 12px 0; border: none; background: transparent; border-bottom: 3px solid transparent; font-weight: 500; color: #555; cursor: pointer; font-size: 14px;">
                            üîó URL
                        </button>
                        <button id="umode-cloud" onclick="switchUploadMode('cloud')"
                            style="flex:1; padding: 12px 0; border: none; background: transparent; border-bottom: 3px solid transparent; font-weight: 500; color: #555; cursor: pointer; font-size: 14px;">
                            ‚òÅÔ∏è Cloud Link
                        </button>
                        {% if COURT_IMPORT_ENABLED %}
                        <button id="umode-court" onclick="switchUploadMode('court')"
                            style="flex:1; padding: 12px 0; border: none; background: transparent; border-bottom: 3px solid transparent; font-weight: 500; color: #555; cursor: pointer; font-size: 14px;">
                            üèõÔ∏è Court Import
                        </button>
                        {% endif %}
                    </div>

                    <div style="padding: 24px;">

                        <!-- FILE MODE -->
                        <div id="uinput-file">
                            <div id="upload-dropzone"
                                ondragover="event.preventDefault(); this.style.background='#eff6ff'; this.style.borderColor='#2563eb';"
                                ondragleave="this.style.background=''; this.style.borderColor='#cbd5e1';"
                                ondrop="handleDrop(event)"
                                onclick="document.getElementById('upload-file-input').click()"
                                style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all .2s;">
                                <div style="font-size: 36px; margin-bottom: 8px;">üìÑ</div>
                                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Drop file here or click to browse</div>
                                <div style="font-size: 12px; color: #9ca3af;">PDF, PNG, JPG, JPEG, DOCX, HEIC</div>
                                <div id="upload-file-name" style="margin-top: 10px; font-size: 13px; color: #2563eb; font-weight:500;"></div>
                            </div>
                            <input type="file" id="upload-file-input"
                                accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.heic"
                                style="display: none;"
                                onchange="document.getElementById('upload-file-name').textContent = this.files[0]?.name || ''">
                        </div>

                        <!-- URL MODE -->
                        <div id="uinput-url" style="display:none;">
                            <label style="display:block; font-weight:600; margin-bottom:6px; color:#374151;">File or Folder URL</label>
                            <input type="url" id="upload-url-input" placeholder="https://example.com/document.pdf  or  https://example.com/docs/"
                                style="width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;">

                            <label style="display:block; font-weight:600; margin-bottom:6px; color:#374151;">Authentication</label>
                            <select id="upload-auth-type" onchange="updateAuthFields()"
                                style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:10px;">
                                <option value="none">None</option>
                                <option value="basic">Username / Password</option>
                                <option value="token">Bearer Token</option>
                            </select>
                            <div id="upload-auth-basic" style="display:none; margin-top:8px;">
                                <input type="text" id="upload-auth-user" placeholder="Username" autocomplete="off"
                                    style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:8px;">
                                <input type="password" id="upload-auth-pass" placeholder="Password" autocomplete="new-password"
                                    style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                            </div>
                            <div id="upload-auth-token" style="display:none; margin-top:8px;">
                                <input type="text" id="upload-auth-token-val" placeholder="Bearer token"
                                    style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                            </div>
                        </div>

                        <!-- CLOUD LINK MODE -->
                        <div id="uinput-cloud" style="display:none;">
                            <label style="display:block; font-weight:600; margin-bottom:6px; color:#374151;">Cloud Share Link</label>
                            <input type="url" id="upload-cloud-input"
                                placeholder="Paste a Google Drive, Dropbox, or OneDrive share link"
                                style="width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:8px;">
                            <div id="upload-cloud-detected" style="font-size:12px; color:#6b7280; min-height:18px;"></div>
                        </div>

                        {% if COURT_IMPORT_ENABLED %}
                        <!-- COURT IMPORT MODE -->
                        <div id="uinput-court" style="display:none;">
                            <!-- Credential status pills -->
                            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:16px; padding-bottom:14px; border-bottom:1px solid #e5e7eb;">
                                <span style="font-size:12px; color:#6b7280; font-weight:500;">Court credentials:</span>
                                <span style="border:1px solid #d1d5db; border-radius:12px; padding:3px 10px; font-size:12px; color:#6b7280;" id="court-cred-pill-federal">Federal ‚Äî loading‚Ä¶</span>
                                <span style="border:1px solid #d1d5db; border-radius:12px; padding:3px 10px; font-size:12px; color:#6b7280;" id="court-cred-pill-nyscef">NYSCEF ‚Äî loading‚Ä¶</span>
                                <div style="margin-left:auto; display:flex; gap:6px;">
                                    <button class="btn" onclick="openCourtWizard()" style="padding:4px 12px; font-size:12px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px; cursor:pointer;">‚öôÔ∏è Manage</button>
                                    <button class="btn" onclick="openCourtWizardAIPaste()" style="padding:4px 12px; font-size:12px; background:#eff6ff; color:#2563eb; border:1px solid #bfdbfe; border-radius:5px; cursor:pointer;">üìã Paste credentials</button>
                                </div>
                            </div>

                            <!-- Case search -->
                            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-bottom:14px;">
                                <div style="flex:0 0 130px;">
                                    <label style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:4px;">Court System</label>
                                    <select id="court-system-select" style="width:100%; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; color:#374151;">
                                        <option value="federal">Federal</option>
                                        <option value="nyscef">NYSCEF (NYS)</option>
                                    </select>
                                </div>
                                <div style="flex:1; min-width:140px;">
                                    <label style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:4px;">Case Number</label>
                                    <input type="text" id="court-case-number" placeholder="e.g. 1:23-cv-04567"
                                           style="width:100%; box-sizing:border-box; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                                </div>
                                <div style="flex:1; min-width:140px;">
                                    <label style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:4px;">Party Name <span style="color:#9ca3af; font-weight:400;">(optional)</span></label>
                                    <input type="text" id="court-party-name" placeholder="Plaintiff or defendant"
                                           style="width:100%; box-sizing:border-box; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                                </div>
                                <button class="btn btn-primary" onclick="searchCourt()" style="padding:7px 18px; font-size:13px;">Search</button>
                            </div>
                            <div id="court-search-results" style="margin-bottom:10px;"></div>

                            <!-- Docket section (hidden until case selected) -->
                            <div id="court-docket-section" style="display:none;">
                                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; margin-bottom:10px;">
                                    <div>
                                        <div style="font-weight:600; color:#374151; font-size:14px;" id="court-docket-case-title">Case Documents</div>
                                        <div style="font-size:12px; color:#6b7280;" id="court-docket-meta"></div>
                                    </div>
                                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                        <button class="btn" id="btn-court-import-selected" onclick="startCourtImport(false)" style="display:none; padding:6px 14px; font-size:13px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px; cursor:pointer;">Import Selected</button>
                                        <button class="btn btn-primary" id="btn-court-import-all" onclick="startCourtImport(true)" style="padding:6px 14px; font-size:13px;">Import All</button>
                                    </div>
                                </div>
                                <!-- Filter bar -->
                                <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
                                    <input type="text" id="court-docket-filter" placeholder="Filter by title‚Ä¶"
                                           oninput="filterDocket()" style="flex:1; min-width:120px; padding:5px 9px; border:1px solid #d1d5db; border-radius:5px; font-size:12px; box-sizing:border-box;">
                                    <select id="court-source-filter" onchange="filterDocket()" style="padding:5px 9px; border:1px solid #d1d5db; border-radius:5px; font-size:12px; color:#374151;">
                                        <option value="">All sources</option>
                                        <option value="recap">RECAP</option>
                                        <option value="pacer">PACER</option>
                                        <option value="nyscef">NYSCEF</option>
                                    </select>
                                </div>
                                <!-- Docket table -->
                                <div style="overflow-x:auto; max-height:260px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; margin-bottom:10px;">
                                    <table style="width:100%; border-collapse:collapse; font-size:12px;" id="court-docket-table">
                                        <thead>
                                            <tr style="background:#f6f8fa; color:#6b7280; text-align:left; position:sticky; top:0;">
                                                <th style="padding:7px 8px; width:28px; border-bottom:1px solid #e5e7eb;"><input type="checkbox" id="court-select-all" onchange="courtSelectAll(this)"></th>
                                                <th style="padding:7px 8px; width:55px; border-bottom:1px solid #e5e7eb;">Seq #</th>
                                                <th style="padding:7px 8px; width:85px; border-bottom:1px solid #e5e7eb;">Date</th>
                                                <th style="padding:7px 8px; border-bottom:1px solid #e5e7eb;">Description</th>
                                                <th style="padding:7px 8px; width:65px; border-bottom:1px solid #e5e7eb;">Source</th>
                                            </tr>
                                        </thead>
                                        <tbody id="court-docket-tbody"></tbody>
                                    </table>
                                </div>
                                <!-- Import progress -->
                                <div id="court-import-progress" style="display:none; margin-top:10px; padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                        <span style="font-weight:600; color:#374151; font-size:13px;">Import Progress</span>
                                        <button class="btn" style="padding:3px 10px; font-size:11px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:4px; cursor:pointer;" id="btn-court-cancel" onclick="cancelCourtImport()">Cancel</button>
                                    </div>
                                    <div style="background:#e5e7eb; border-radius:4px; height:8px; overflow:hidden; margin-bottom:6px;">
                                        <div id="court-import-bar" style="height:100%; background:#2563eb; width:0%; transition:width .4s ease;"></div>
                                    </div>
                                    <div id="court-import-counters" style="font-size:12px; color:#6b7280; margin-bottom:8px;"></div>
                                    <div id="court-import-log" style="font-family:monospace; font-size:11px; color:#374151; max-height:120px; overflow-y:auto; background:#fff; border:1px solid #e5e7eb; border-radius:4px; padding:6px;"></div>
                                </div>
                            </div>

                            <!-- Court import history -->
                            <div style="margin-top:14px; padding-top:14px; border-top:1px solid #e5e7eb;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                    <span style="font-weight:600; font-size:13px; color:#374151;">üìã Court Import History</span>
                                    <button onclick="loadCourtHistory()" style="font-size:12px; border:none; background:none; color:#2563eb; cursor:pointer;">‚Üª Refresh</button>
                                </div>
                                <div id="court-history-table" style="font-size:12px; color:#6b7280;">Loading‚Ä¶</div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Shared upload controls (hidden when court mode is active) -->
                        <div id="upload-shared-controls">
                            <!-- Project selector -->
                            <div style="margin-top:14px;">
                                <label style="display:block; font-weight:600; margin-bottom:6px; font-size:14px; color:#374151;">Project</label>
                                <select id="upload-project-select" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; color:#374151;">
                                    <option value="">None (auto-assign by analyzer)</option>
                                </select>
                            </div>

                            <!-- Smart Metadata toggle -->
                            <div style="margin-top:18px; display:flex; align-items:center; gap:10px;">
                                <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px; color:#374151; font-weight:500;">
                                    <input type="checkbox" id="upload-smart-meta" style="width:16px; height:16px; accent-color:#2563eb;">
                                    Smart Metadata ‚Äî AI analyzes before uploading (shows preview)
                                </label>
                            </div>

                            <!-- Upload button -->
                            <div style="margin-top:20px;">
                                <button class="btn btn-primary" onclick="doUpload()"
                                    id="upload-submit-btn"
                                    style="padding: 10px 28px; font-size: 15px;">
                                    üì§ Upload to Paperless
                                </button>
                            </div>

                            <!-- Status -->
                            <div id="upload-status" style="margin-top: 16px;"></div>

                            <!-- Directory file-list picker (shown when a folder URL is scanned) -->
                            <div id="upload-filelist" style="display:none; margin-top:16px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">
                                <div style="padding:10px 14px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; gap:12px; background:#fff;">
                                    <span style="font-weight:600; font-size:13px; color:#374151;">üìÅ <span id="upload-filelist-count">0</span> compatible files found</span>
                                    <label style="font-size:12px; color:#6b7280; display:flex; align-items:center; gap:5px; cursor:pointer; margin-left:auto;">
                                        <input type="checkbox" id="upload-filelist-selectall" checked
                                            onchange="toggleSelectAllFiles(this.checked)"
                                            style="width:13px; height:13px;">
                                        Select all
                                    </label>
                                </div>
                                <div id="upload-filelist-table"
                                    style="max-height:280px; overflow-y:auto;"
                                    onchange="if(event.target.classList.contains('flist-cb')) _updateFileListBtn()">
                                </div>
                                <div style="padding:10px 14px; border-top:1px solid #e5e7eb; display:flex; gap:8px; align-items:center; background:#fff;">
                                    <button class="btn btn-primary" id="upload-filelist-btn"
                                        onclick="uploadSelectedFiles()"
                                        style="font-size:13px; padding:7px 18px;">Upload 0 files</button>
                                    <button class="btn" onclick="cancelFileList()"
                                        style="font-size:13px; padding:7px 14px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px;">Cancel</button>
                                    <span id="upload-filelist-progress" style="font-size:12px; color:#6b7280; margin-left:6px;"></span>
                                </div>
                            </div>

                            <!-- Smart metadata preview card -->
                            <div id="upload-meta-preview" style="display:none; margin-top:16px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:16px;">
                                <div style="font-weight:600; color:#0c4a6e; margin-bottom:10px;">AI Metadata Preview ‚Äî confirm before submitting</div>
                                <div id="upload-meta-content" style="font-size:13px; color:#374151;"></div>
                                <div style="margin-top:14px; display:flex; gap:10px;">
                                    <button class="btn btn-primary" onclick="confirmSmartUpload()" style="padding:8px 20px;">
                                        ‚úÖ Confirm &amp; Upload
                                    </button>
                                    <button class="btn" onclick="cancelSmartPreview()" style="padding:8px 16px; background:#e5e7eb; color:#374151;">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div><!-- /upload-shared-controls -->
                    </div>
                </div>

                {% if COURT_IMPORT_ENABLED %}
                <!-- Court credentials wizard modal (fixed overlay ‚Äî works from anywhere in the DOM) -->
                <div id="court-wizard-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:9000; align-items:center; justify-content:center;">
                    <div style="background:#fff; border:1px solid #d1d5db; border-radius:12px; width:520px; max-width:95vw; padding:28px; box-shadow:0 8px 32px rgba(0,0,0,.2);">
                        <h3 style="margin:0 0 20px 0; color:#111827;">‚öôÔ∏è Court Credentials Setup</h3>

                        <!-- Step 1: Select court -->
                        <div id="court-wizard-step1">
                            <p style="color:#6b7280; margin-bottom:14px;">Select which court system to configure:</p>
                            <label style="display:flex; align-items:flex-start; gap:10px; margin-bottom:12px; cursor:pointer;">
                                <input type="radio" name="court-wizard-system" value="federal" checked style="margin-top:3px;">
                                <span>
                                    <strong style="color:#111827;">Federal Courts (PACER + CourtListener)</strong><br>
                                    <small style="color:#6b7280;">CourtListener RECAP is free and requires no credentials. PACER credentials are optional for documents not in the archive.</small>
                                </span>
                            </label>
                            <label style="display:flex; align-items:flex-start; gap:10px; margin-bottom:20px; cursor:pointer;">
                                <input type="radio" name="court-wizard-system" value="nyscef" style="margin-top:3px;">
                                <span>
                                    <strong style="color:#111827;">New York Courts (NYSCEF)</strong><br>
                                    <small style="color:#6b7280;">Requires NY Attorney Registration # and Playwright/Chromium. Rebuild image with <code>INCLUDE_PLAYWRIGHT=true</code>.</small>
                                </span>
                            </label>
                            <div style="display:flex; justify-content:flex-end; gap:8px;">
                                <button class="btn" onclick="closeCourtWizard()" style="padding:7px 16px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px; cursor:pointer;">Cancel</button>
                                <button class="btn btn-primary" onclick="courtWizardStep(2)" style="padding:7px 16px;">Next ‚Üí</button>
                            </div>
                        </div>

                        <!-- Step 2: Enter credentials + test -->
                        <div id="court-wizard-step2" style="display:none;">

                            <!-- Entry mode tab toggle -->
                            <div style="display:flex; border-bottom:1px solid #e5e7eb; margin-bottom:14px;">
                                <button id="court-wiz-tab-manual" onclick="courtWizEntryMode('manual')"
                                        style="background:none; border:none; padding:7px 14px 6px; cursor:pointer; font-size:13px; color:#2563eb; font-weight:600; border-bottom:2px solid #2563eb;">‚úèÔ∏è Manual</button>
                                <button id="court-wiz-tab-paste" onclick="courtWizEntryMode('paste')"
                                        style="background:none; border:none; padding:7px 14px 6px; cursor:pointer; font-size:13px; color:#6b7280; font-weight:400; border-bottom:2px solid transparent;">üìã AI Paste</button>
                            </div>

                            <!-- Manual entry panel -->
                            <div id="court-wiz-manual-panel">
                                <div id="court-wizard-federal-fields">
                                    <p style="color:#6b7280; margin-bottom:12px; font-size:14px;"><strong>Federal Courts</strong> ‚Äî CourtListener is free (no credentials needed). Enter PACER credentials to access documents not in the RECAP archive.</p>
                                    <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600; color:#374151;">PACER Username <span style="color:#9ca3af; font-weight:400;">(optional)</span></label>
                                    <input type="text" id="court-wiz-federal-user" placeholder="PACER username"
                                           style="width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; margin-bottom:10px;">
                                    <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600; color:#374151;">PACER Password <span style="color:#9ca3af; font-weight:400;">(optional)</span></label>
                                    <div style="display:flex; gap:6px; margin-bottom:10px;">
                                        <input type="password" id="court-wiz-federal-pass" placeholder="PACER password"
                                               style="flex:1; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                                        <button type="button" onclick="toggleCourtPassword('court-wiz-federal-pass', this)"
                                                style="padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; background:#f9fafb; color:#6b7280; cursor:pointer; font-size:12px; white-space:nowrap;">Show</button>
                                    </div>
                                    <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600; color:#374151;">PACER Client Code <span style="color:#9ca3af; font-weight:400;">(optional)</span></label>
                                    <input type="text" id="court-wiz-federal-client" placeholder="Billing client code"
                                           style="width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; margin-bottom:10px;">
                                    <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600; color:#374151;">CourtListener API Token <span style="color:#9ca3af; font-weight:400;">(optional ‚Äî raises rate limit)</span></label>
                                    <input type="text" id="court-wiz-cl-token" placeholder="Free token from courtlistener.com"
                                           style="width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; margin-bottom:4px;">
                                </div>
                                <div id="court-wizard-nyscef-fields" style="display:none;">
                                    <div style="margin-bottom:12px; padding:10px 12px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:6px;">
                                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; color:#374151;">
                                            <input type="checkbox" id="court-wiz-nyscef-public" onchange="toggleNyscefPublic(this.checked)"
                                                   style="width:15px; height:15px;">
                                            <span><strong>Pro Se / Party access</strong> ‚Äî I'm a party/defendant (not an attorney). Create a free NYSCEF account at iapps.courts.state.ny.us/nyscef ‚Üí Unrepresented Litigants ‚Üí Create an Account, then enter those credentials below.</span>
                                        </label>
                                    </div>
                                    <div id="court-wiz-nyscef-cred-fields">
                                        <p id="court-wiz-nyscef-cred-desc" style="color:#6b7280; margin-bottom:12px; font-size:14px;"><strong>NYSCEF</strong> ‚Äî Enter your NY Attorney Registration number and e-Filing password.</p>
                                        <label id="court-wiz-nyscef-user-lbl" style="display:block; margin-bottom:5px; font-size:13px; font-weight:600; color:#374151;">NY Attorney Registration #</label>
                                        <input type="text" id="court-wiz-nyscef-user" placeholder="e.g. 1234567"
                                               style="width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; margin-bottom:10px;">
                                        <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600; color:#374151;">NYSCEF Password</label>
                                        <div style="display:flex; gap:6px; margin-bottom:10px;">
                                            <input type="password" id="court-wiz-nyscef-pass" placeholder="NYSCEF e-Filing password"
                                                   style="flex:1; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                                            <button type="button" onclick="toggleCourtPassword('court-wiz-nyscef-pass', this)"
                                                    style="padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; background:#f9fafb; color:#6b7280; cursor:pointer; font-size:12px; white-space:nowrap;">Show</button>
                                        </div>
                                    </div>
                                    <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600; color:#374151;">Default County</label>
                                    <input type="text" id="court-wiz-nyscef-county" placeholder="e.g. new york"
                                           style="width:100%; box-sizing:border-box; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; margin-bottom:4px;">
                                </div>
                            </div><!-- /court-wiz-manual-panel -->

                            <!-- AI Paste panel ‚Äî content injected by AIFormFiller widget -->
                            <div id="court-wiz-paste-panel" style="display:none;"></div>

                            <div id="court-wiz-test-result" style="margin:10px 0; font-size:13px; min-height:18px;"></div>
                            <div style="display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">
                                <button class="btn" onclick="courtWizardStep(1)" style="padding:7px 14px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px; cursor:pointer;">‚Üê Back</button>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn" onclick="testCourtCredentials()" style="padding:7px 14px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px; cursor:pointer;">üîå Test Connection</button>
                                    <button class="btn btn-primary" onclick="saveCourtCredentials()" style="padding:7px 16px;">üíæ Save</button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Confirmation -->
                        <div id="court-wizard-step3" style="display:none;">
                            <div id="court-wiz-confirm-msg" style="color:#16a34a; font-size:15px; margin-bottom:20px;"></div>
                            <div style="display:flex; justify-content:flex-end; gap:8px;">
                                <button class="btn" onclick="closeCourtWizard()" style="padding:7px 14px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px; cursor:pointer;">Close</button>
                                <button class="btn btn-primary" onclick="closeCourtWizard()" style="padding:7px 16px;">Done</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Import History -->
                <div style="background: white; border: 1px solid #e1e4e8; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,.06);">
                    <div style="padding: 16px 20px; border-bottom: 1px solid #e1e4e8; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:600; color:#374151;">Recent Imports</span>
                        <button onclick="loadImportHistory()" style="font-size:12px; border:none; background:none; color:#2563eb; cursor:pointer;">‚Üª Refresh</button>
                    </div>
                    <div id="upload-history-body" style="overflow-x:auto;">
                        <div style="padding:20px; color:#9ca3af; font-size:13px; text-align:center;">Loading‚Ä¶</div>
                    </div>
                </div>
            </div>

            <!-- AI Chat Tab -->
            <div id="tab-ai-chat" class="tab-content">
                <!-- Help panel (flex-shrink: 0, hidden by default) -->
                <div class="tab-help-panel" id="help-ai-chat">
                    <strong>üí¨ AI Chat</strong> ‚Äî Ask the AI questions about your documents using natural language.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>The AI has access to all analyzed documents in the <strong>Current Project</strong> selected in the header.</li>
                        <li>Ask things like: <em>"Are there any documents with balance mismatches?"</em> or <em>"Summarize documents from March 2024."</em></li>
                        <li>Use <strong>+ New Chat</strong> to start a fresh conversation.</li>
                        <li>Chat sessions can be <strong>shared</strong> with other users using the share button above the chat.</li>
                        <li>Requires an AI API key ‚Äî configure one under <strong>‚öôÔ∏è Configuration ‚Üí AI Settings</strong>.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/chat" target="_blank" style="color:#5dade2;">üìñ Full manual for this section ‚Üí</a></div>
                </div>

                <!-- Two-column layout: sessions list left, chat right -->
                <div class="chat-layout">

                    <!-- Left: chat sessions panel -->
                    <div class="chat-sessions-panel">
                        <div class="sessions-panel-header">
                            <h3>üí¨ Sessions</h3>
                            <button class="btn-new-chat" onclick="newChat()">+ New Chat</button>
                        </div>
                        <div id="session-list">
                            <div style="padding: 20px 14px; font-size: 12px; color: #556677;">Loading sessions‚Ä¶</div>
                        </div>
                    </div>

                    <!-- Right: chat interface -->
                    <div class="chat-main-panel">
                        <!-- API key warning banner -->
                        <div id="ai-key-warning" style="display:none; background:#fff3cd; border:1px solid #ffc107; color:#856404; padding:10px 14px; border-radius:6px; font-size:13px;">
                            ‚ö†Ô∏è <strong>No AI API key configured.</strong> Chat will not work until you add one.
                            Go to the <a href="#" onclick="switchTab('config'); return false;" style="color:#856404; font-weight:600;">‚öôÔ∏è Configuration tab</a> ‚Üí AI Configuration section.
                        </div>
                        <!-- Session title + action buttons -->
                        <div class="chat-session-header">
                            <span style="font-size: 11px; color: #888; margin-right: 6px; white-space: nowrap;">Title:</span><span class="chat-session-title" id="active-session-title">New Chat</span>
                            <div class="chat-session-actions">
                                <button class="btn-session-action" onclick="shareCurrentChat()" id="btn-share-chat" title="Share chat">üîó Share</button>
                                <button class="btn-session-action" onclick="exportCurrentChat()" id="btn-export-chat" title="Export as PDF">üì• Export PDF</button>
                                <button class="btn-session-action" onclick="clearChat()" title="Clear chat">üóëÔ∏è Clear</button>
                            </div>
                        </div>
                        <!-- Chat container: header + messages + input -->
                        <div class="chat-container">
                            <div class="chat-header">
                                <h2>üí¨ AI Document Assistant</h2>
                            </div>
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-message assistant">
                                    <div class="message-bubble">
                                        <div>üëã Hi! I'm your AI document assistant. I can help you:</div>
                                        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                                            <li>Analyze patterns across all your documents</li>
                                            <li>Find specific transactions or anomalies</li>
                                            <li>Generate reports and ledgers</li>
                                            <li>Answer questions about your financial documents</li>
                                        </ul>
                                        <div style="margin-top: 10px;">Try asking me something!</div>
                                    </div>
                                </div>
                                <div class="chat-suggestions">
                                    <div class="suggestion-chip" onclick="sendSuggestion('Show me all high-risk documents')">Show me all high-risk documents</div>
                                    <div class="suggestion-chip" onclick="sendSuggestion('What anomalies were most common?')">What anomalies were most common?</div>
                                    <div class="suggestion-chip" onclick="sendSuggestion('Generate a summary of all analyzed documents')">Generate a summary</div>
                                </div>
                            </div>
                            <div class="chat-input-area">
                                <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    <label for="document-type-filter" style="font-size: 14px; color: #666;">Filter by type:</label>
                                    <select id="document-type-filter" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; background: white;">
                                        <option value="all">All Documents</option>
                                    </select>
                                    <span id="type-breakdown" style="font-size: 12px; color: #999;"></span>
                                </div>
                                <div class="chat-input-container">
                                    <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ask me anything about your documents‚Ä¶ (Enter to send, Ctrl+Enter for new line)" onkeydown="handleChatKeypress(event)"></textarea>
                                    <button class="chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div><!-- .chat-main-panel -->

                </div><!-- .chat-layout -->
            </div><!-- #tab-ai-chat -->

            <!-- Search & Analysis Tab -->
            <div id="tab-search" class="tab-content">
                <div class="tab-help-panel" id="help-search">
                    <strong>üîç Search &amp; Analysis</strong> ‚Äî Browse, sort, and filter all documents in the current project.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>Type in the <strong>global search box</strong> and press <strong>Enter</strong> or click <strong>Search</strong>, or use any <strong>column filter</strong> to narrow results instantly.</li>
                        <li>Click any <strong>column header</strong> to sort ascending/descending.</li>
                        <li>Use the <strong>Risk min/max</strong> inputs to filter by risk score range.</li>
                        <li>Multiple column filters combine with AND logic.</li>
                        <li>Use <strong>Show / page</strong> to control how many rows appear per page (10, 25, 50, 100, or All).</li>
                        <li>Click <strong>more</strong> on any summary to expand the full text.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/search" target="_blank" style="color:#5dade2;">üìñ Full manual for this section ‚Üí</a></div>
                </div>

                <!-- Toolbar -->
                <div style="display:flex; flex-wrap:wrap; align-items:center; gap:8px; margin-bottom:12px;">
                    <input type="text" id="sa-global"
                        placeholder="üîç Search title, doc #, anomaly, summary‚Ä¶"
                        oninput="saApplyFilters()"
                        onkeydown="if(event.key==='Enter') saApplyFilters()"
                        style="flex:1; min-width:220px; padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;" />
                    <button onclick="saApplyFilters()"
                        style="padding:7px 14px; border:1px solid #3b82f6; border-radius:6px; background:#3b82f6; color:#fff; cursor:pointer; font-size:13px; font-weight:500;">Search</button>
                    <select id="sa-sort-select" onchange="saApplyFilters()"
                        style="padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; background:#fff; cursor:pointer;">
                        <option value="doc_id">Sort: Doc #</option>
                        <option value="title">Sort: Title</option>
                        <option value="timestamp">Sort: Date</option>
                        <option value="risk_score">Sort: Risk %</option>
                    </select>
                    <button onclick="saToggleSortDir()"
                        id="sa-sort-dir-btn"
                        style="padding:7px 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">‚ñ≤ Asc</button>
                    <label style="display:flex; align-items:center; gap:5px; font-size:13px; cursor:pointer;">
                        <input type="checkbox" id="sa-anomalies-only" onchange="saApplyFilters()" />
                        Anomalies only
                    </label>
                    <label style="display:flex; align-items:center; gap:5px; font-size:13px;">
                        Show
                        <select id="sa-per-page" onchange="saSetPerPage(this.value)"
                            style="padding:5px 8px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; background:#fff; cursor:pointer;">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="0">All</option>
                        </select>
                        / page
                    </label>
                    <button onclick="saClearAll()"
                        style="padding:7px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">Clear</button>
                    <span id="sa-count" style="font-size:12px; color:#6b7280; margin-left:4px;"></span>
                </div>

                <!-- Document table -->
                <div style="overflow-x:auto; border:1px solid #e5e7eb; border-radius:8px;">
                    <table style="width:100%; border-collapse:collapse; font-size:13px; table-layout:fixed;">
                        <colgroup>
                            <col style="width:70px;" />
                            <col style="width:22%;" />
                            <col style="width:90px;" />
                            <col style="width:60px;" />
                            <col style="width:24%;" />
                            <col />
                        </colgroup>
                        <thead style="background:#f9fafb; position:sticky; top:0; z-index:1;">
                            <!-- Sortable column headers -->
                            <tr>
                                <th onclick="saSortBy('doc_id')" style="padding:8px 10px; text-align:left; cursor:pointer; white-space:nowrap; border-bottom:1px solid #e5e7eb; user-select:none;">
                                    Doc # <span id="sa-sort-ind-doc_id"></span></th>
                                <th onclick="saSortBy('title')" style="padding:8px 10px; text-align:left; cursor:pointer; border-bottom:1px solid #e5e7eb; user-select:none;">
                                    Title <span id="sa-sort-ind-title"></span></th>
                                <th onclick="saSortBy('timestamp')" style="padding:8px 10px; text-align:left; cursor:pointer; white-space:nowrap; border-bottom:1px solid #e5e7eb; user-select:none;">
                                    Date <span id="sa-sort-ind-timestamp"></span></th>
                                <th onclick="saSortBy('risk_score')" style="padding:8px 10px; text-align:left; cursor:pointer; white-space:nowrap; border-bottom:1px solid #e5e7eb; user-select:none;">
                                    Risk % <span id="sa-sort-ind-risk_score"></span></th>
                                <th onclick="saSortBy('anomalies')" style="padding:8px 10px; text-align:left; cursor:pointer; border-bottom:1px solid #e5e7eb; user-select:none;">
                                    Anomalies <span id="sa-sort-ind-anomalies"></span></th>
                                <th style="padding:8px 10px; text-align:left; border-bottom:1px solid #e5e7eb;">Summary</th>
                            </tr>
                            <!-- Per-column filter row -->
                            <tr style="background:#f3f4f6;">
                                <td style="padding:4px 6px; border-bottom:2px solid #e5e7eb;">
                                    <input id="sa-filter-doc_id" type="text" placeholder="filter‚Ä¶" oninput="saApplyFilters()"
                                        style="width:100%; padding:4px 6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; box-sizing:border-box;" /></td>
                                <td style="padding:4px 6px; border-bottom:2px solid #e5e7eb;">
                                    <input id="sa-filter-title" type="text" placeholder="filter‚Ä¶" oninput="saApplyFilters()"
                                        style="width:100%; padding:4px 6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; box-sizing:border-box;" /></td>
                                <td style="padding:4px 6px; border-bottom:2px solid #e5e7eb;">
                                    <input id="sa-filter-date" type="text" placeholder="filter‚Ä¶" oninput="saApplyFilters()"
                                        style="width:100%; padding:4px 6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; box-sizing:border-box;" /></td>
                                <td style="padding:4px 6px; border-bottom:2px solid #e5e7eb;">
                                    <div style="display:flex; gap:3px;">
                                        <input id="sa-filter-risk-min" type="number" placeholder="min" oninput="saApplyFilters()"
                                            style="width:46%; padding:4px 3px; border:1px solid #d1d5db; border-radius:4px; font-size:11px;" />
                                        <input id="sa-filter-risk-max" type="number" placeholder="max" oninput="saApplyFilters()"
                                            style="width:46%; padding:4px 3px; border:1px solid #d1d5db; border-radius:4px; font-size:11px;" />
                                    </div></td>
                                <td style="padding:4px 6px; border-bottom:2px solid #e5e7eb;">
                                    <input id="sa-filter-anomalies" type="text" placeholder="filter‚Ä¶" oninput="saApplyFilters()"
                                        style="width:100%; padding:4px 6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; box-sizing:border-box;" /></td>
                                <td style="padding:4px 6px; border-bottom:2px solid #e5e7eb;">
                                    <input id="sa-filter-summary" type="text" placeholder="filter‚Ä¶" oninput="saApplyFilters()"
                                        style="width:100%; padding:4px 6px; border:1px solid #d1d5db; border-radius:4px; font-size:12px; box-sizing:border-box;" /></td>
                            </tr>
                        </thead>
                        <tbody id="sa-tbody">
                            <tr><td colspan="6" style="text-align:center; padding:30px; color:#9ca3af;">Loading‚Ä¶</td></tr>
                        </tbody>
                    </table>
                    <!-- Pagination bar -->
                    <div id="sa-pagination" style="display:none; align-items:center; justify-content:space-between; padding:8px 12px; border-top:1px solid #e5e7eb; background:#f9fafb; border-radius:0 0 8px 8px; flex-wrap:wrap; gap:8px; font-size:13px;">
                        <span id="sa-page-info" style="color:#6b7280;"></span>
                        <div id="sa-page-controls" style="display:flex; gap:4px; flex-wrap:wrap;"></div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div id="tab-config" class="tab-content">
                <div class="tab-help-panel" id="help-config">
                    <strong>‚öôÔ∏è Configuration</strong> ‚Äî Set up AI providers, analysis profiles, and system settings. Switch sub-tabs to see context-specific help.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>AI Settings</strong> ‚Äî Global API Keys (admin) + per-project provider/model for 3 use-cases (Document Analysis, AI Chat, Case Intelligence). Fallback chain: per-project ‚Üí global ‚Üí system default.</li>
                        <li><strong>AI Usage</strong> ‚Äî Daily cost + call volume chart. Hover a bar for exact values.</li>
                        <li><strong>Profiles</strong> ‚Äî Rules files that define how the AI tags and classifies documents. Activate staging profiles to use them.</li>
                        <li><strong>Vector Store</strong> ‚Äî Manages the embedded document index used for AI Chat. Clear it if documents seem stale.</li>
                        <li><strong>Notifications (SMTP)</strong> (admin) ‚Äî Configure outgoing email for welcome messages, CI budget alerts, and CI completion emails.</li>
                        <li><strong>Users</strong> (admin) ‚Äî Add, edit, or remove user accounts. Three roles: Admin / Advanced / Basic.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/configuration" target="_blank" style="color:#5dade2;">üìñ Full manual for this section ‚Üí</a></div>
                </div>

                <!-- Sub-tab help panels ‚Äî hidden by default; _refreshHelpPanel() shows the active one -->
                <div class="tab-help-panel" id="help-config-ai" style="display:none;">
                    <strong>ü§ñ AI Settings</strong> ‚Äî Provider and model configuration.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Global API Keys</strong> (admin only) ‚Äî OpenAI and Anthropic keys stored in <code>/app/data/ai_config.json</code>. Click <strong>Test</strong> next to each key to verify before saving.</li>
                        <li><strong>Per-project AI Configuration</strong> ‚Äî Three use-cases per project: Document Analysis / AI Chat / Case Intelligence. Each has a Primary and a Fallback provider+model.</li>
                        <li><strong>‚áâ All</strong> ‚Äî copies that row's settings to all three use-cases in this project.</li>
                        <li><strong>üìã Copy</strong> (admin) ‚Äî copies one project's full config to another project.</li>
                        <li><strong>Fallback chain:</strong> per-project override ‚Üí global key ‚Üí system default.</li>
                        <li>Admin sees all-projects dropdown; Advanced users see only their own project.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/configuration#ai-settings" target="_blank" style="color:#5dade2;">üìñ AI Settings manual ‚Üí</a></div>
                </div>

                <div class="tab-help-panel" id="help-config-usage" style="display:none;">
                    <strong>üí∞ AI Usage</strong> ‚Äî Daily token and cost history.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Blue bars</strong> ‚Äî daily estimated cost (USD).</li>
                        <li><strong>Amber dashed line</strong> ‚Äî daily API call volume (right axis).</li>
                        <li>Hover a bar to see exact date, cost, and call count for that day.</li>
                        <li>Use the days selector to widen or narrow the date range.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/llm-usage" target="_blank" style="color:#5dade2;">üìñ Full per-call history ‚Üí</a></div>
                </div>

                <div class="tab-help-panel" id="help-config-profiles" style="display:none;">
                    <strong>üìÑ Profiles</strong> ‚Äî Document-type analysis rules.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Active profiles</strong> are loaded from <code>/app/profiles/active/</code> and define extraction rules, risk weights, and tagging for each document type.</li>
                        <li><strong>Staging profiles</strong> are auto-generated when a document matches no active profile. Review and activate the ones you want to keep.</li>
                        <li><strong>Activate / Activate All</strong> ‚Äî move staging profiles to active.</li>
                        <li><strong>Delete</strong> ‚Äî permanently remove a staging or active profile.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/configuration#profiles" target="_blank" style="color:#5dade2;">üìñ Profiles manual ‚Üí</a></div>
                </div>

                <div class="tab-help-panel" id="help-config-vectorstore" style="display:none;">
                    <strong>üóÑÔ∏è Vector Store</strong> ‚Äî ChromaDB document index.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Process Unanalyzed</strong> ‚Äî queue docs not yet embedded. No LLM cost for already-processed docs.</li>
                        <li><strong>Re-embed Stale</strong> ‚Äî re-analyze docs modified in Paperless since their last embed.</li>
                        <li><strong>Clear All</strong> ‚Äî <em>destructive</em> ‚Äî wipes the entire project's vector index. Use only when rebuilding from scratch.</li>
                        <li><strong>Reconcile</strong> ‚Äî removes orphaned DB records for docs deleted from Paperless.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/configuration#vector-store-config" target="_blank" style="color:#5dade2;">üìñ Vector Store manual ‚Üí</a></div>
                </div>

                <div class="tab-help-panel" id="help-config-smtp" style="display:none;">
                    <strong>üìß Notifications</strong> ‚Äî SMTP outgoing email configuration (admin only).
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>SMTP is used for: welcome emails on user creation, bug reports, CI budget alerts, and CI run completion emails.</li>
                        <li><strong>CI budget alerts</strong> fire at every 10% completion checkpoint with a projected-vs-budget status.</li>
                        <li><strong>CI completion emails</strong> fire when a run finishes (success or failure).</li>
                        <li>CI notification recipient is set per-run in CI Setup ‚Üí Notifications section (pre-filled from the user's profile email).</li>
                        <li>Click <strong>Send Test Email</strong> to validate SMTP ‚Äî a test message is sent to your own account address.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/configuration#smtp-settings" target="_blank" style="color:#5dade2;">üìñ SMTP manual ‚Üí</a></div>
                </div>

                <div class="tab-help-panel" id="help-config-users" style="display:none;">
                    <strong>üë• Users</strong> ‚Äî User account management (admin only).
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Three roles:</strong> Admin (full access) / Advanced (CI + power features) / Basic (own sessions only). Role is set via the Edit (pencil) icon.</li>
                        <li><strong>+ Add User</strong> ‚Äî creates a new account. A welcome email is sent automatically if SMTP is configured.</li>
                        <li><strong>Deactivate</strong> (trash icon) ‚Äî soft-deletes the account; chat history is preserved. Click Reactivate to restore access.</li>
                        <li>You cannot deactivate your own account. At least one Admin must remain active.</li>
                        <li><strong>üë§ My Profile</strong> (header button, all users) ‚Äî every user can update their own name, email, phone, address, job title, and password without admin help.</li>
                    </ul>
                    <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/users" target="_blank" style="color:#5dade2;">üìñ User Management manual ‚Üí</a></div>
                </div>

                <!-- Sub-tab navigation (fixed header ‚Äî not inside scroll body) -->
                <div class="config-sub-nav">
                    <button class="config-sub-btn active" onclick="switchConfigTab('ai')" id="cfg-btn-ai">ü§ñ AI Settings</button>
                    <button class="config-sub-btn" onclick="switchConfigTab('usage')" id="cfg-btn-usage">üí∞ AI Usage</button>
                    <button class="config-sub-btn" onclick="switchConfigTab('profiles')" id="cfg-btn-profiles">üìÑ Profiles</button>
                    <button class="config-sub-btn" onclick="switchConfigTab('vectorstore')" id="cfg-btn-vectorstore">üóÑÔ∏è Vector Store</button>
                    {% if is_admin %}
                    <button class="config-sub-btn" onclick="switchConfigTab('smtp')" id="cfg-btn-smtp">üìß Notifications</button>
                    <button class="config-sub-btn" onclick="switchConfigTab('users')" id="cfg-btn-users">üë• Users</button>
                    {% endif %}
                </div>
                <!-- ‚îÄ‚îÄ AI Settings sub-section ‚îÄ‚îÄ -->
                <div id="cfg-ai" class="config-sub-content active">
                <h2 style="margin-bottom: 15px;">ü§ñ AI Configuration</h2>

                {% if is_admin %}
                <!-- Section 1: Global API Keys (admin only) -->
                <details id="global-api-keys-section" style="margin-bottom: 20px;">
                    <summary style="cursor:pointer; font-weight:700; font-size:15px; padding:12px 16px; background:#f0f4ff; border:1px solid #c9d8f5; border-radius:6px; list-style:none; display:flex; align-items:center; gap:8px;">
                        üîë Global API Keys <span style="font-size:11px; font-weight:400; color:#666; margin-left:8px;">(admin only)</span>
                        <span style="margin-left:auto; font-size:11px; color:#888;">‚ñº expand</span>
                    </summary>
                    <div class="card" style="margin-top:8px; border-top:none; border-radius:0 0 6px 6px;">
                        <p style="font-size:13px; color:#555; margin-bottom:14px;">These API keys are shared across all projects as the default credential source. Per-project overrides can be set below.</p>
                        <!-- OpenAI -->
                        <div style="background:#f8f9fa; padding:14px; border-radius:6px; margin-bottom:12px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                                <h3 style="margin:0; font-size:14px;">OpenAI</h3>
                                <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener"
                                   style="font-size:12px; color:#3b82f6; text-decoration:none;">üîó Get a key ‚Üí</a>
                            </div>
                            <div class="action-group" style="margin-bottom:6px;">
                                <input type="text" autocomplete="off" id="openai-api-key" placeholder="sk-..."
                                       style="flex:1; font-family:monospace; font-size:13px;" />
                                <button class="btn" onclick="testAIProvider('openai')">üß™ Test</button>
                            </div>
                            <div id="openai-test-result" style="margin-top:6px; display:none;"></div>
                        </div>
                        <!-- Anthropic -->
                        <div style="background:#f8f9fa; padding:14px; border-radius:6px; margin-bottom:12px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                                <h3 style="margin:0; font-size:14px;">Anthropic</h3>
                                <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener"
                                   style="font-size:12px; color:#3b82f6; text-decoration:none;">üîó Get a key ‚Üí</a>
                            </div>
                            <div class="action-group" style="margin-bottom:6px;">
                                <input type="text" autocomplete="off" id="anthropic-api-key" placeholder="sk-ant-api03-..."
                                       style="flex:1; font-family:monospace; font-size:13px;" />
                                <button class="btn" onclick="testAIProvider('anthropic')">üß™ Test</button>
                            </div>
                            <div id="anthropic-test-result" style="margin-top:6px; display:none;"></div>
                        </div>
                        <div style="text-align:center; padding-top:12px; border-top:1px solid #dee2e6;">
                            <button class="btn btn-success" onclick="saveGlobalAIKeys()" style="padding:8px 28px;">
                                üíæ Save Global API Keys
                            </button>
                            <div id="global-keys-result" style="margin-top:8px; display:none;"></div>
                        </div>
                        <div style="font-size:12px; color:#888; margin-top:12px; text-align:center;">
                            Keys stored in /app/data/ai_config.json ‚Äî never leave your server
                        </div>
                    </div>
                </details>
                {% endif %}

                <!-- Section 2: Per-project AI Configuration -->
                <div class="card" style="margin-bottom:20px;">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
                        <strong style="font-size:14px;">Project AI Configuration</strong>
                        {% if is_admin %}
                        <select id="ai-project-selector" onchange="loadProjectAIConfig(this.value)"
                                style="font-size:13px; padding:4px 8px; border:1px solid #ccc; border-radius:4px; min-width:180px;">
                            <option value="">‚Äî select project ‚Äî</option>
                        </select>
                        {% else %}
                        <span style="font-size:13px; color:#555; font-style:italic;" id="ai-project-label">
                            {{ session.get('current_project', 'default') }}
                        </span>
                        {% endif %}
                    </div>

                    <div id="project-ai-config-wrap">
                        <!-- Populated by loadProjectAIConfig() -->
                        <p style="color:#888; font-size:13px; font-style:italic;" id="project-ai-placeholder">
                            {% if is_admin %}Select a project above to configure its AI settings.{% else %}Loading AI settings‚Ä¶{% endif %}
                        </p>

                        <!-- Per-project API key overrides -->
                        <div id="project-api-keys-wrap" style="display:none; margin-bottom:16px; padding:12px 14px; background:#f8f9ff; border:1px solid #d4ddf7; border-radius:6px;">
                            <div style="font-size:13px; font-weight:600; margin-bottom:10px; color:#374151;">
                                üîë API Key Overrides
                                <span style="font-size:11px; font-weight:400; color:#6b7280; margin-left:6px;">Leave blank to use the global key</span>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                    <label style="font-size:12px; min-width:80px; color:#555;">OpenAI:</label>
                                    <input type="text" autocomplete="off" id="proj-openai-key"
                                        placeholder="sk-‚Ä¶  (blank = use global key)"
                                        style="flex:1; min-width:200px; padding:5px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px; font-family:monospace;" />
                                    <a href="https://platform.openai.com/api-keys" target="_blank" rel="noopener"
                                       style="font-size:11px; color:#3b82f6; text-decoration:none; white-space:nowrap;">üîó Get a key</a>
                                    <button class="btn btn-sm" onclick="clearProjectKey('openai')" style="font-size:11px; padding:4px 8px;">‚úï Clear</button>
                                    <button class="btn btn-sm" onclick="testProjectKey('openai')" style="font-size:11px; padding:4px 8px;">üß™ Test</button>
                                    <span id="proj-openai-key-status" style="font-size:11px;"></span>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                    <label style="font-size:12px; min-width:80px; color:#555;">Anthropic:</label>
                                    <input type="text" autocomplete="off" id="proj-anthropic-key"
                                        placeholder="sk-ant-‚Ä¶  (blank = use global key)"
                                        style="flex:1; min-width:200px; padding:5px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px; font-family:monospace;" />
                                    <a href="https://console.anthropic.com/settings/keys" target="_blank" rel="noopener"
                                       style="font-size:11px; color:#3b82f6; text-decoration:none; white-space:nowrap;">üîó Get a key</a>
                                    <button class="btn btn-sm" onclick="clearProjectKey('anthropic')" style="font-size:11px; padding:4px 8px;">‚úï Clear</button>
                                    <button class="btn btn-sm" onclick="testProjectKey('anthropic')" style="font-size:11px; padding:4px 8px;">üß™ Test</button>
                                    <span id="proj-anthropic-key-status" style="font-size:11px;"></span>
                                </div>
                            </div>
                        </div>

                        <div id="project-ai-table" style="display:none;">
                            <table style="width:100%; font-size:13px; border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#f0f4ff; text-align:left;">
                                        <th style="padding:8px 10px; border-bottom:2px solid #c9d8f5; width:160px;">Use-case</th>
                                        <th style="padding:8px 10px; border-bottom:2px solid #c9d8f5;">Primary Provider / Model</th>
                                        <th style="padding:8px 10px; border-bottom:2px solid #c9d8f5;">Fallback Provider / Model</th>
                                        {% if not is_basic %}<th style="padding:8px 10px; border-bottom:2px solid #c9d8f5; width:80px;">Copy</th>{% endif %}
                                    </tr>
                                </thead>
                                <tbody id="project-ai-tbody">
                                    <!-- rows injected by JS -->
                                </tbody>
                            </table>
                            {% if not is_basic %}
                            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:14px; padding-top:12px; border-top:1px solid #dee2e6;">
                                <button class="btn btn-success" onclick="saveProjectAIConfig()" style="padding:8px 20px;">
                                    üíæ Save Project Config
                                </button>
                                {% if is_admin %}
                                <span style="color:#888; font-size:12px;">|</span>
                                <span style="font-size:13px;">Copy entire config to:</span>
                                <select id="ai-copy-dest-project" style="font-size:13px; padding:4px 8px; border:1px solid #ccc; border-radius:4px; min-width:160px;">
                                    <option value="">‚Äî other project ‚Äî</option>
                                </select>
                                <button class="btn" onclick="copyProjectAIConfig()" style="font-size:12px; padding:6px 14px;">
                                    üìã Copy
                                </button>
                                {% endif %}
                            </div>
                            {% endif %}
                            <div id="project-ai-result" style="margin-top:10px; display:none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Settings sub-section folded into AI tab -->
                <h2 style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1;">‚öôÔ∏è Settings</h2>
                <div class="card" style="margin-top: 15px;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Polling Configuration</h3>
                    <div class="action-group">
                        <label for="poll-interval" style="font-weight: 500;">Poll Interval (seconds):</label>
                        <input type="number" id="poll-interval" value="30" min="5" max="3600" style="width: 100px;" />
                        <button class="btn" onclick="updatePollInterval()">Update Interval</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 10px;">
                        ‚ÑπÔ∏è How often the analyzer checks for new documents (default: 30 seconds)
                    </div>
                    <div id="settings-result" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>
                </div><!-- /cfg-ai -->

                <!-- ‚îÄ‚îÄ AI Usage sub-section ‚îÄ‚îÄ -->
                <div id="cfg-usage" class="config-sub-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="margin:0;">üí∞ AI Usage &amp; Cost</h2>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <select id="usage-days-select" onchange="loadLlmUsage()" style="padding:5px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                        <button class="btn btn-small" onclick="loadLlmUsage()">‚Üª Refresh</button>
                    </div>
                </div>

                <!-- Summary cards -->
                <div id="usage-summary" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:20px;">
                    <div class="loading">Loading usage data‚Ä¶</div>
                </div>

                <!-- Per-model breakdown -->
                <div class="card" style="margin-bottom:16px;">
                    <h3 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">By Model</h3>
                    <div id="usage-by-model" style="overflow-x:auto;">
                        <div style="color:#888; font-size:13px;">‚Äî</div>
                    </div>
                </div>

                <!-- Per-operation breakdown -->
                <div class="card" style="margin-bottom:16px;">
                    <h3 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">By Operation</h3>
                    <div id="usage-by-op" style="overflow-x:auto;">
                        <div style="color:#888; font-size:13px;">‚Äî</div>
                    </div>
                </div>

                <!-- Daily usage chart + table -->
                <div class="card" style="margin-bottom:16px;">
                    <h3 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">Daily Usage</h3>
                    <canvas id="usage-chart" style="width:100%; height:200px; display:block; margin-bottom:16px;"></canvas>
                    <div id="usage-daily" style="overflow-x:auto;">
                        <div style="color:#888; font-size:13px;">‚Äî</div>
                    </div>
                </div>

                <!-- Pricing reference -->
                <div class="card">
                    <h3 style="font-size:14px; font-weight:600; margin-bottom:12px; color:#374151;">Pricing Reference <span style="font-size:11px; font-weight:400; color:#888;">(per 1M tokens)</span></h3>
                    <div id="usage-pricing" style="overflow-x:auto;">
                        <div style="color:#888; font-size:13px;">‚Äî</div>
                    </div>
                </div>
                </div><!-- /cfg-usage -->

                <!-- ‚îÄ‚îÄ Profiles sub-section ‚îÄ‚îÄ -->
                <div id="cfg-profiles" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üìÑ Profile Management</h2>
                <div class="content-grid">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="margin: 0;">Active Profiles</h2>
                            <button class="btn btn-primary" onclick="detectDuplicates()">üîç Detect Duplicates</button>
                        </div>
                        <ul id="active-profiles-list" class="profile-list loading">Loading...</ul>
                        <div id="duplicates-result" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <div class="card" id="staging-section" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="margin: 0;">Staging Profiles (Awaiting Review)</h2>
                            <button class="btn btn-success" onclick="activateAllStagingProfiles()" id="activate-all-btn">‚úì Activate All</button>
                        </div>
                        <div id="staging-profiles"></div>
                    </div>
                </div>

                </div><!-- /cfg-profiles -->

                <!-- ‚îÄ‚îÄ Vector Store sub-section ‚îÄ‚îÄ -->
                <div id="cfg-vectorstore" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üóÑÔ∏è Vector Store Management</h2>
                <div class="card">
                    <!-- Search + controls bar -->
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap;">
                        <input type="text" id="vs-search" placeholder="Search by title, ID or type‚Ä¶"
                               oninput="filterVsDocs()"
                               style="flex:1; min-width:180px; padding:7px 12px; border:1px solid #ddd; border-radius:4px; font-size:13px;" />
                        <span id="vs-count-label" style="font-size:13px; color:#666; white-space:nowrap;"></span>
                        <button class="btn btn-small" onclick="loadVectorStoreDocuments()">‚Üª Refresh</button>
                        <button class="btn btn-small" onclick="triggerReembedStale()" id="btn-reembed-stale" title="Re-analyze documents whose OCR content changed after they were first embedded">‚ü≥ Re-embed Stale</button>
                        <button class="btn btn-small" onclick="processUnanalyzed()" id="btn-process-unanalyzed" title="Analyze only documents not yet in the processed history ‚Äî skips already-done docs">‚ñ∂ Process Unanalyzed</button>
                        <button class="btn btn-warning" onclick="confirmClearVectorStore()">Clear All</button>
                    </div>
                    <div id="vector-store-manager">
                        <div class="loading">Loading vector store documents‚Ä¶</div>
                    </div>
                    <!-- Pagination -->
                    <div id="vs-pagination" style="display:none; margin-top:16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center;"></div>
                </div>
                </div><!-- /cfg-vectorstore -->

                <!-- ‚îÄ‚îÄ SMTP / Notifications sub-section (admin only) ‚îÄ‚îÄ -->
                {% if is_admin %}
                <div id="cfg-smtp" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üìß Notifications &amp; Email</h2>
                <div class="card" style="margin-bottom: 20px;">
                    <p style="color:#555; font-size:14px; margin-bottom:16px;">
                        Configure outgoing email (SMTP) used for bug reports and alerts. All settings are stored securely on the server.
                    </p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">SMTP Host</label>
                            <input type="text" id="smtp-host" placeholder="e.g. smtpauth.earthlink.net" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Port</label>
                            <input type="number" id="smtp-port" value="587" min="1" max="65535" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Username</label>
                            <input type="text" id="smtp-user" autocomplete="off" placeholder="your@email.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Password</label>
                            <input type="password" id="smtp-pass" autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">From Address</label>
                            <input type="text" id="smtp-from" placeholder="noreply@yourdomain.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">HELO Hostname (optional)</label>
                            <input type="text" id="smtp-helo" placeholder="yourdomain.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Bug Reports Sent To</label>
                            <input type="email" id="smtp-bug-report-to" placeholder="admin@yourdomain.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; padding-top:18px;">
                            <input type="checkbox" id="smtp-starttls" checked style="cursor:pointer;">
                            <label for="smtp-starttls" style="font-size:13px; cursor:pointer;">Use STARTTLS (recommended)</label>
                        </div>
                    </div>
                    <div id="smtp-result" style="display:none; padding:8px 12px; border-radius:4px; font-size:13px; margin-bottom:12px;"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="saveSmtpSettings()">üíæ Save Settings</button>
                        <button class="btn" onclick="testSmtpSettings()">üì® Send Test Email</button>
                    </div>
                </div>
                </div><!-- /cfg-smtp -->
                {% endif %}

                <!-- ‚îÄ‚îÄ Users sub-section (admin only) ‚îÄ‚îÄ -->
                {% if is_admin %}
                <div id="cfg-users" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üë• User Management</h2>
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span style="color: #555; font-size: 14px;">Manage user accounts and roles.</span>
                        <button class="btn btn-primary" onclick="showAddUserForm()">+ Add User</button>
                    </div>

                    <!-- Add User Form (hidden by default) -->
                    <div id="add-user-form" style="display: none; background: #f8f9fa; padding: 16px; border-radius: 6px; margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px; font-size: 15px;">New User</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="new-user-username" placeholder="Username *" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="new-user-display" placeholder="Display Name" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="email" id="new-user-email" placeholder="Email (for notifications)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="password" id="new-user-password" placeholder="Password *" autocomplete="new-password" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="new-user-role" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="basic">Basic</option>
                                <option value="advanced">Advanced</option>
                                <option value="admin">Admin</option>
                            </select>
                            <div style="display:flex; align-items:center; font-size:12px; color:#888;">
                                A welcome email will be sent if SMTP is configured and an email is provided.
                            </div>
                        </div>
                        <div id="add-user-error" style="color: #e74c3c; font-size: 13px; margin-bottom: 8px; display:none;"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-success" onclick="createUser()">Create User</button>
                            <button class="btn" onclick="hideAddUserForm()">Cancel</button>
                        </div>
                    </div>

                    <!-- Edit User Modal -->
                    <div id="edit-user-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:9999; align-items:center; justify-content:center;">
                        <div style="background:#fff; border-radius:8px; padding:28px; width:560px; max-width:95vw; max-height:90vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
                            <h3 style="margin:0 0 18px; font-size:16px;">‚úèÔ∏è Edit User: <span id="edit-user-name-label"></span></h3>
                            <input type="hidden" id="edit-user-id">
                            <!-- Contact info -->
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Display Name</label>
                                    <input type="text" id="edit-display-name" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Job Title</label>
                                    <input type="text" id="edit-job-title" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Email</label>
                                    <input type="email" id="edit-email" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Phone</label>
                                    <input type="text" id="edit-phone" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                            </div>
                            <div style="margin-bottom:10px;">
                                <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Address</label>
                                <input type="text" id="edit-address" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                            </div>
                            <!-- Professional -->
                            <div style="margin:14px 0 8px; font-size:11px; font-weight:700; text-transform:uppercase; color:#6b7280; letter-spacing:.05em; border-top:1px solid #e5e7eb; padding-top:12px;">Professional</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">GitHub</label>
                                    <input type="text" id="edit-github" placeholder="github.com/username" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">LinkedIn</label>
                                    <input type="text" id="edit-linkedin" placeholder="linkedin.com/in/username" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                            </div>
                            <!-- Social -->
                            <div style="margin:14px 0 8px; font-size:11px; font-weight:700; text-transform:uppercase; color:#6b7280; letter-spacing:.05em; border-top:1px solid #e5e7eb; padding-top:12px;">Social</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Facebook</label>
                                    <input type="text" id="edit-facebook" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Instagram</label>
                                    <input type="text" id="edit-instagram" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                            </div>
                            <div style="margin-bottom:10px;">
                                <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Other Handles <span style="font-weight:400; color:#888;">(Twitter/X, etc.)</span></label>
                                <input type="text" id="edit-other-handles" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                            </div>
                            <!-- Account -->
                            <div style="margin:14px 0 8px; font-size:11px; font-weight:700; text-transform:uppercase; color:#6b7280; letter-spacing:.05em; border-top:1px solid #e5e7eb; padding-top:12px;">Account</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Role</label>
                                    <select id="edit-role" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                        <option value="basic">Basic</option>
                                        <option value="advanced">Advanced</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">Timezone</label>
                                    <input type="text" id="edit-timezone" placeholder="e.g. America/New_York" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                                </div>
                            </div>
                            <div>
                                <label style="font-size:13px; font-weight:600; display:block; margin-bottom:4px;">New Password <span style="font-weight:400; color:#888;">(leave blank to keep current)</span></label>
                                <input type="password" id="edit-password" placeholder="New password (optional)" autocomplete="new-password" style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #ddd; border-radius:4px;">
                            </div>
                            <div id="edit-user-error" style="color:#e74c3c; font-size:13px; margin-top:10px; display:none;"></div>
                            <div id="edit-user-success" style="color:#27ae60; font-size:13px; margin-top:10px; display:none;"></div>
                            <div style="display:flex; gap:8px; margin-top:18px; align-items:center;">
                                <button class="btn" style="margin-right:auto;" onclick="emailUserManual()" title="Send the user manual link to this user's email address">üìß Email Manual</button>
                                <button class="btn" onclick="closeEditUserModal()">Cancel</button>
                                <button class="btn btn-success" onclick="saveEditUser()">Save Changes</button>
                            </div>
                        </div>
                    </div>

                    <table class="user-table" id="users-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Display Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Last Login</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="7" class="loading">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
                </div><!-- /cfg-users -->
                {% endif %}

            </div><!-- /tab-config -->

            <!-- Debug & Tools Tab -->
            <div id="tab-tools" class="tab-content">
                <!-- Help panels ‚Äî one per sub-tab; _refreshHelpPanel() picks the right one -->
                <div class="tab-help-panel" id="help-tools-health">
                    <strong>ü©∫ System Health</strong> ‚Äî Live status of 6 components, checked in parallel (1.8 s timeout each). Auto-refreshes every 30 s while this sub-tab is open.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Paperless API</strong> ‚Äî Calls the Paperless health endpoint. Red here means document analysis will fail for all users.</li>
                        <li><strong>ChromaDB</strong> ‚Äî Counts documents in the default vector store. Yellow if vector search is disabled; red if the database is unreachable or corrupt.</li>
                        <li><strong>LLM</strong> ‚Äî Reads <code>LLM_ENABLED</code> and <code>LLM_API_KEY</code> env vars. No live API call is made ‚Äî yellow means disabled, red means enabled but no key set.</li>
                        <li><strong>Analyzer Loop</strong> ‚Äî Checks age of last completed poll. Yellow if more than 3√ó the poll interval has elapsed (default threshold: 90 s).</li>
                        <li><strong>PostgreSQL / Redis</strong> ‚Äî Checks running status via the Docker socket. Yellow (not red) when the Docker socket is unavailable in this container.</li>
                    </ul>
                    <div style="margin-top:6px; font-size:12px; color:#667788;">The header dots mirror this data and update every 30 s regardless of which tab you're on. Click them to jump here.</div>
                </div>
                <div class="tab-help-panel" id="help-tools-containers">
                    <strong>üê≥ Container Manager</strong> ‚Äî View and control the 7 managed Docker containers without leaving the browser. Restart and log actions require Admin role.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Restart</strong> ‚Äî Sends SIGTERM, waits up to 15 s, then SIGKILL. The container will be briefly unavailable. The list reloads 3 s after you confirm.</li>
                        <li><strong>View Logs</strong> ‚Äî Fetches the last 100 lines with RFC 3339 timestamps from Docker. Click the same button again to close that container's log drawer.</li>
                        <li><strong>Grey "not found" rows</strong> are normal for containers that don't run in every environment (e.g. <code>paperless-ai-analyzer-jacob</code>).</li>
                        <li>If the list shows "Docker unavailable", add <code>/var/run/docker.sock:/var/run/docker.sock</code> to this container's volumes in docker-compose.yml and recreate it.</li>
                    </ul>
                    <div style="margin-top:6px; font-size:12px; color:#667788;">Auto-refreshes every 60 s while this sub-tab is open.</div>
                </div>
                <div class="tab-help-panel" id="help-tools-reprocess">
                    <strong>üîÑ Reprocess Controls</strong> ‚Äî Force the analyzer to re-examine documents it has already processed.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Reprocess All</strong> ‚Äî Clears every existing analysis result and re-queues all documents. Use this after changing profiles, AI settings, or anomaly rules. Processing runs on the next poll cycle (every 30 s) and may take minutes to hours depending on your document count.</li>
                        <li><strong>Reprocess Document</strong> ‚Äî Re-queues a single document by its Paperless document ID. Useful for testing a profile change on one document before committing to a full reprocess.</li>
                    </ul>
                    <div style="margin-top:6px; font-size:12px; color:#e07b00;">‚ö†Ô∏è Reprocessing overwrites previous AI results and re-applies all current tags and anomaly rules.</div>
                </div>
                <div class="tab-help-panel" id="help-tools-reconcile">
                    <strong>üîÅ Reconcile Index</strong> ‚Äî Removes orphaned records from the local database and vector store after documents are deleted from Paperless.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>When you delete a document in Paperless, the analyzer's DB record and ChromaDB embedding are <strong>not</strong> removed automatically. Over time this causes the document count to drift and wastes vector store storage.</li>
                        <li>Reconcile checks every local record against the Paperless API and removes any that no longer exist.</li>
                        <li>Does <strong>not</strong> re-analyze anything ‚Äî safe to run at any time without triggering LLM calls or tag changes.</li>
                        <li>If reconcile removes a large number of records, a Reprocess All afterward will re-embed the remaining documents cleanly.</li>
                    </ul>
                </div>
                <div class="tab-help-panel" id="help-tools-logs">
                    <strong>üìã Live Logs</strong> ‚Äî The last 200 log lines from the analyzer process. Auto-refreshes every 15 s.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>INFO</strong> ‚Äî Normal operation: documents found, analyzed, tags applied.</li>
                        <li><strong>WARNING</strong> ‚Äî Non-fatal issues worth noting (rate limits, slow API responses, stale embeddings).</li>
                        <li><strong>ERROR</strong> ‚Äî Failures: an analysis couldn't complete, an API call failed, a document couldn't be fetched.</li>
                    </ul>
                    <div style="margin-top:6px; font-size:12px; color:#667788;">If a document isn't being analyzed, search its title or ID here. Common causes: Paperless API 500s (check Health tab), LLM rate limits, or the document not matching any profile.</div>
                </div>

                <!-- Tools sub-nav -->
                <div class="tools-sub-nav">
                    <button class="tools-sub-btn active" onclick="switchToolsTab('health')"      id="tools-btn-health">ü©∫ Health</button>
                    <button class="tools-sub-btn"        onclick="switchToolsTab('containers')"  id="tools-btn-containers">üê≥ Containers</button>
                    <button class="tools-sub-btn"        onclick="switchToolsTab('reprocess')"   id="tools-btn-reprocess">üîÑ Reprocess</button>
                    <button class="tools-sub-btn"        onclick="switchToolsTab('reconcile')"   id="tools-btn-reconcile">üîÅ Reconcile</button>
                    <button class="tools-sub-btn"        onclick="switchToolsTab('logs')"        id="tools-btn-logs">üìã Logs</button>
                </div>

                <!-- Health sub-tab -->
                <div id="tools-health" class="tools-sub-content active">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                        <h2 style="margin:0;">ü©∫ System Health</h2>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span id="tools-countdown-health" style="font-size:12px;color:#888;"></span>
                            <button class="btn btn-small" onclick="loadSystemHealth(true)">‚Üª Refresh</button>
                        </div>
                    </div>
                    <div id="health-cards" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px;">
                        <div class="loading">Checking components‚Ä¶</div>
                    </div>
                </div>

                <!-- Containers sub-tab -->
                <div id="tools-containers" class="tools-sub-content">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px;">
                        <h2 style="margin:0;">üê≥ Container Manager</h2>
                        <div style="display:flex;align-items:center;gap:10px;">
                            <span id="tools-countdown-containers" style="font-size:12px;color:#888;"></span>
                            <button class="btn btn-small" onclick="loadContainers(true)">‚Üª Refresh</button>
                        </div>
                    </div>
                    <div id="container-unavailable" style="display:none; background:#fff3cd; border:1px solid #ffc107; border-radius:6px; padding:12px 16px; margin-bottom:16px; font-size:13px; color:#664d03;">
                        ‚ö†Ô∏è Docker socket not available. Add <code>/var/run/docker.sock:/var/run/docker.sock</code> to this container's volumes in docker-compose.yml, then recreate it.
                    </div>
                    <div id="container-cards" style="display:flex; flex-direction:column; gap:8px;"></div>
                </div>

                <!-- Reprocess sub-tab -->
                <div id="tools-reprocess" class="tools-sub-content">
                    <h2>üéõÔ∏è Reprocess Controls</h2>
                    <div class="action-group" style="margin-bottom: 30px;">
                        <button class="btn btn-danger" onclick="reprocessAll()">üîÑ Reprocess All Documents</button>
                        <input type="number" id="reprocess-doc-id" placeholder="Doc ID" />
                        <button class="btn btn-success" onclick="reprocessDocument()">üîÑ Reprocess Document</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 30px;">
                        ‚ÑπÔ∏è Reprocessing will analyze documents on the next poll cycle (every 30 seconds)
                    </div>
                </div>

                <!-- Reconcile sub-tab -->
                <div id="tools-reconcile" class="tools-sub-content">
                    <h2>üîÅ Reconcile Index</h2>
                    <p style="color:#666; font-size:14px; margin-bottom:14px;">Removes stale records from the analyzed-docs database and vector store for any document that has been deleted from Paperless. Does <strong>not</strong> re-analyze anything.</p>
                    <div class="action-group" style="margin-bottom:12px;">
                        <button class="btn" id="reconcile-btn" onclick="runReconcile()">üîÅ Reconcile Now</button>
                    </div>
                    <div id="reconcile-result" style="display:none; font-size:13px; padding:10px 14px; border-radius:6px; margin-bottom:24px;"></div>
                </div>

                <!-- Logs sub-tab -->
                <div id="tools-logs" class="tools-sub-content">
                    <h2>üìã Live Logs <button class="btn btn-small" onclick="refreshLogs()">Refresh</button></h2>
                    <div class="logs-viewer" id="logs-viewer" style="margin-top: 15px;">
                        <div class="loading">Loading logs...</div>
                    </div>
                </div>
            </div>
            {% if CI_ENABLED %}
    <div id="tab-case-intelligence" class="tab-content">
        <div class="tab-help-panel" id="help-ci">
            <strong>‚öñÔ∏è Case Intelligence AI</strong> ‚Äî Proactive, evidence-grounded legal case analysis. Switch sub-tabs to see context-specific help.
            <ul style="margin:8px 0 0 0; padding-left:18px;">
                <li><strong>Setup</strong> ‚Äî Configure budget, orchestration tiers (Director/Managers/Workers), and notifications. Director LLM plans all domain assignments.</li>
                <li><strong>Findings</strong> ‚Äî 6 finding domains: Entities ¬∑ Timeline ¬∑ Financial ¬∑ Contradictions ¬∑ Theories ¬∑ Authorities. Each finding cites source doc + page.</li>
                <li>Report Builder: Director synthesizes a 12-section scientific paper (Sections I‚ÄìIX + Appendices A‚ÄìC) ‚Üí PDF download.</li>
            </ul>
            <div style="margin-top:6px; font-size:11px; color:#888;">Requires <code>CASE_INTELLIGENCE_ENABLED=true</code> in the container environment.</div>
        </div>

        <!-- CI sub-tab help panels ‚Äî hidden by default; _refreshHelpPanel() shows the active one -->
        <div class="tab-help-panel" id="help-ci-setup" style="display:none;">
            <strong>üîß CI Setup</strong> ‚Äî Configure and launch an analysis run.
            <ul style="margin:8px 0 0 0; padding-left:18px;">
                <li><strong>Role</strong> ‚Äî Plaintiff / Defendant / Neutral ‚Äî shapes how the Director frames analysis and theories. CI also generates <em>opposing-side</em> theories automatically so you see what you're up against.</li>
                <li><strong>Jurisdiction</strong> ‚Äî choose a template or leave blank for auto-detect from documents.</li>
                <li><strong>Goal / Case Description</strong> ‚Äî what to find. Click <strong>‚ú® Refine with AI</strong> to chat with an assistant that helps craft a precise, effective goal.</li>
                <li><strong>Budget (USD)</strong> ‚Äî per-run spending cap. Run pauses if exceeded; override button shown. More documents = proportionally more spend; budget is a ceiling, not a target.</li>
                <li><strong>Orchestration Tiers</strong>: Director = 1 (fixed, plans all work); Managers = Auto (min(6, docs√∑20)) or 1‚Äì10; Workers/Manager = Auto (budget-scaled) or 1‚Äì20.</li>
                <li><strong>Progress bar</strong>: shows stage ¬∑ docs processed ¬∑ active managers/workers ¬∑ tokens used ¬∑ elapsed time ¬∑ ETA (after 10% complete).</li>
                <li><strong>Notifications</strong>: Email on run complete + every 10% budget checkpoint. Recipient pre-filled from your üë§ My Profile email.</li>
                <li>Click <strong>‚ñ∂ Start Analysis</strong> ‚Üí Director generates clarifying questions ‚Üí answer or check "Proceed with assumptions".</li>
            </ul>
            <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/case-intelligence#ci-setup" target="_blank" style="color:#5dade2;">üìñ CI Setup manual ‚Üí</a></div>
        </div>

        <div class="tab-help-panel" id="help-ci-findings" style="display:none;">
            <strong>üìã CI Findings</strong> ‚Äî Browse run results and generate reports.
            <ul style="margin:8px 0 0 0; padding-left:18px;">
                <li>Select a run from the dropdown; live progress shows while running (Cancel button available).</li>
                <li><strong>Run metadata header</strong> ‚Äî who ran it, when, duration, role, document count, and AI cost.</li>
                <li><strong>6 finding domains</strong>: Entities ¬∑ Timeline ¬∑ Financial ¬∑ Contradictions ¬∑ Theories ¬∑ Authorities. Every finding cites source document + page. Theories include both your role's perspective and the opposing side's strongest arguments.</li>
                <li><strong>AI Chat integration</strong>: CI findings are embedded into the project's vector store after each run ‚Äî ask AI Chat questions and it will cite CI findings alongside document excerpts.</li>
                <li><strong>üë• Share</strong> ‚Äî share a run with another Advanced or Admin user by username. Shared users can view all findings and download the report.</li>
                <li><strong>üóë Delete Run</strong> ‚Äî permanently removes a completed run and all its findings.</li>
                <li><strong>Report Builder</strong>: Director synthesizes a 12-section scientific paper (Executive Summary ‚Üí Discovery Gaps + Appendices A‚ÄìC) ‚Üí PDF download.</li>
            </ul>
            <div style="margin-top:8px; font-size:12px;"><a href="{{ request.script_root }}/docs/case-intelligence#ci-findings" target="_blank" style="color:#5dade2;">üìñ CI Findings manual ‚Üí</a></div>
        </div>

        <!-- Sub-tab navigation -->
        <div class="ci-sub-nav">
            <button class="ci-sub-btn active" onclick="ciSwitchSub('setup')">üîß Setup</button>
            <button class="ci-sub-btn" onclick="ciSwitchSub('findings')">üìã Findings</button>
        </div>

        <!-- ‚îÄ‚îÄ Setup Sub-tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div id="ci-sub-setup" class="ci-sub-content active">

            <div id="ci-status-bar">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span id="ci-stage-label" style="font-weight:600; font-size:13px;">Ready</span>
                    <span id="ci-cost-label" style="font-size:12px; color:#666;">$0.00 / $10.00</span>
                </div>
                <div class="ci-progress-bar"><div class="ci-progress-fill" id="ci-progress-fill" style="width:0%"></div></div>
                <div style="font-size:11px; color:#888; margin-top:3px; display:flex; flex-wrap:wrap; gap:8px;">
                    <span id="ci-docs-label">0 / 0 docs</span>
                    <span id="ci-workers-label" style="display:none">&nbsp;¬∑&nbsp;<span id="ci-workers-val"></span></span>
                    <span id="ci-tokens-label" style="display:none">&nbsp;¬∑&nbsp;<span id="ci-tokens-val"></span> tok</span>
                    <span id="ci-elapsed-label" style="display:none">&nbsp;¬∑&nbsp;<span id="ci-elapsed-val"></span></span>
                    <span id="ci-eta-label"    style="display:none">&nbsp;¬∑&nbsp;~<span id="ci-eta-val"></span> left</span>
                    <span id="ci-status-label">‚Äî</span>
                </div>
            </div>

            <div class="ci-form-row">
                <div class="ci-form-group" style="flex:0 0 200px;">
                    <label>ROLE</label>
                    <select id="ci-role">
                        <option value="neutral">Neutral</option>
                        <option value="defense">Defense</option>
                        <option value="plaintiff">Plaintiff</option>
                        <option value="prosecution">Prosecution</option>
                    </select>
                </div>
                <div class="ci-form-group">
                    <label>JURISDICTION PROFILE</label>
                    <select id="ci-jurisdiction-select" onchange="ciLoadJurisdiction()">
                        <option value="">‚Äî Select template ‚Äî</option>
                    </select>
                    <div id="ci-jd-detect-status" style="margin-top:5px; font-size:12px; color:#888; min-height:16px;"></div>
                </div>
            </div>

            <div class="ci-form-row" id="ci-jurisdiction-details" style="display:none;">
                <div class="ci-form-group">
                    <label>Court</label>
                    <input type="text" id="ci-jd-court" placeholder="e.g. NYS Supreme Court">
                </div>
                <div class="ci-form-group" style="flex:0 0 180px;">
                    <label>County</label>
                    <input type="text" id="ci-jd-county" placeholder="e.g. New York">
                </div>
                <div class="ci-form-group" style="flex:0 0 160px;">
                    <label>Judge/Part</label>
                    <input type="text" id="ci-jd-part" placeholder="e.g. Part 61">
                </div>
            </div>

            <div class="ci-form-group" style="margin-bottom:14px;">
                <label style="display:flex; align-items:center; justify-content:space-between;">
                    <span>GOAL / CASE DESCRIPTION</span>
                    <button type="button" onclick="ciOpenGoalAssistant()" style="background:none; border:1px solid #8e44ad; color:#8e44ad; border-radius:5px; padding:2px 10px; font-size:11px; cursor:pointer; font-weight:600;">‚ú® Refine with AI</button>
                </label>
                <textarea id="ci-goal" placeholder="Describe the case goal and what you want the AI to focus on...&#10;e.g. Analyze all documents for evidence of financial fraud and identify key exhibits."></textarea>
            </div>

            <div class="ci-section-card">
                <h4>BUDGET &amp; MODEL ROUTING</h4>
                <div class="ci-budget-row">
                    <div class="ci-form-group" style="flex:0 0 160px;">
                        <label>Budget per run (USD)</label>
                        <input type="number" id="ci-budget" value="10.00" step="1.00" min="1.00" max="500.00">
                    </div>
                    <div class="ci-form-group" style="flex:0 0 120px;">
                        <label>Max tier</label>
                        <select id="ci-max-tier">
                            <option value="1">Tier 1 only (fast)</option>
                            <option value="2">Tier 1‚Äì2</option>
                            <option value="3" selected>Tier 1‚Äì3 (full)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ ORCHESTRATION TIERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="ci-section-card">
                <h4>ORCHESTRATION TIERS</h4>
                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; font-size:13px; margin-bottom:8px;">
                    <div class="ci-form-group">
                        <label>Director</label>
                        <input type="text" value="1" disabled
                               style="background:#e9ecef; color:#666; cursor:not-allowed;">
                        <div style="font-size:11px; color:#888; margin-top:2px;">Fixed at 1</div>
                    </div>
                    <div class="ci-form-group">
                        <label>Managers</label>
                        <select id="ci-manager-count">
                            <option value="">Auto</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="ci-form-group">
                        <label>Workers / Manager</label>
                        <select id="ci-workers-per-mgr">
                            <option value="">Auto</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="8">8</option>
                            <option value="10">10</option>
                            <option value="12">12</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>
                <div style="font-size:11px; color:#888;">
                    ‚ÑπÔ∏è Auto mode scales to your budget. Managers: min(6, ceil(docs√∑20)). Workers: budget-aware auto-scaling.
                </div>
            </div>

            <!-- ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="ci-section-card">
                <h4>NOTIFICATIONS</h4>
                <div style="display:flex; flex-direction:column; gap:8px; font-size:13px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="ci-notify-complete" checked>
                        Email when run completes
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="ci-notify-budget" checked>
                        Email budget updates (every 10%)
                    </label>
                    <div class="ci-form-group" style="max-width:320px; margin-top:4px;">
                        <label>Recipient email</label>
                        <input type="email" id="ci-notification-email"
                               placeholder="your@email.com"
                               value="{{ current_user.email | default('') | e }}">
                    </div>
                </div>
            </div>

            <!-- Clarifying questions section -->
            <div id="ci-questions-section" style="display:none;" class="ci-section-card">
                <h4>üìã SYSTEM QUESTIONS <span id="ci-q-count" style="color:#e74c3c;"></span></h4>
                <div id="ci-questions-list"></div>
                <div style="margin-top:10px; display:flex; gap:8px;">
                    <button class="btn btn-sm" onclick="ciSaveAnswers()" style="background:#27ae60; color:white;">Save Answers</button>
                    <button class="btn btn-sm" onclick="ciProceedWithAssumptions()" style="background:#f39c12; color:white;">Skip / Proceed with Assumptions</button>
                </div>
            </div>

            {% if is_advanced %}
            <div style="margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <button class="btn" onclick="ciStartRun()" id="ci-run-btn" style="background:#2c3e50; color:white; padding:10px 22px; font-size:14px;">
                    üöÄ Run Case Intelligence AI
                </button>
                <button class="btn btn-sm" onclick="ciSaveDraft()" id="ci-save-btn" style="background:#2980b9; color:white;">
                    üíæ Save Config
                </button>
                <button class="btn btn-sm" onclick="ciCancelRun()" id="ci-cancel-btn" style="display:none; background:#e74c3c; color:white;">
                    ‚úï Cancel Run
                </button>
            </div>
            {% else %}
            <div style="margin-top:12px; padding:10px 14px; background:#fef3e2; border-radius:6px; color:#e67e22; font-size:13px;">
                ‚ö†Ô∏è Advanced or Admin role required to create and run Case Intelligence analyses.
            </div>
            {% endif %}
        </div>

        <!-- ‚îÄ‚îÄ Findings Sub-tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div id="ci-sub-findings" class="ci-sub-content">

            <div style="display:flex; gap:10px; align-items:center; margin-bottom:14px; flex-wrap:wrap;">
                <select id="ci-run-selector" class="ci-run-selector" onchange="ciLoadFindings()">
                    <option value="">‚Äî Select a run ‚Äî</option>
                </select>
                <button class="btn btn-sm" onclick="ciRefreshRuns()" style="background:#3498db; color:white;">‚Üª Refresh</button>
                {% if is_advanced %}
                <button class="btn btn-sm" onclick="ciSwitchSub('setup'); ciStartNewRun()" style="background:#27ae60; color:white;">+ New Run</button>
                <button class="btn btn-sm" id="ci-share-run-btn" onclick="ciOpenShareModal()" style="background:#8e44ad; color:white; display:none;">üë• Share</button>
                <button class="btn btn-sm" id="ci-delete-run-btn" onclick="ciDeleteSelectedRun()" style="background:#e74c3c; color:white; display:none;">üóë Delete Run</button>
                {% endif %}
            </div>

            <!-- Run progress (shown while running) -->
            <div id="ci-findings-status" style="display:none;" class="ci-section-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span id="ci-f-stage" style="font-weight:600;">Running...</span>
                    <span id="ci-f-cost" style="font-size:12px; color:#666;"></span>
                </div>
                <div class="ci-progress-bar"><div class="ci-progress-fill" id="ci-f-progress" style="width:0%"></div></div>
                <div style="font-size:11px; color:#888; margin-top:4px;">
                    <span id="ci-f-docs"></span>
                    {% if is_advanced %}
                    &nbsp;<button class="btn btn-sm" onclick="ciCancelRunFromFindings()" style="background:#e74c3c; color:white; padding:2px 8px; font-size:11px; margin-left:8px;">‚úï Cancel</button>
                    {% endif %}
                </div>
            </div>

            <!-- Run Metadata Header -->
            <div id="ci-run-meta-header" style="display:none; background:#f8f9fb; border:1px solid #dde3ec; border-radius:8px; padding:14px 18px; margin-bottom:14px; font-size:12px; color:#555;">
                <div style="font-weight:700; font-size:13px; color:#1a2535; margin-bottom:8px;">üìã Run Details</div>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:6px 20px;">
                    <div><span style="color:#888;">Run by:</span> <span id="ci-meta-run-by" style="color:#222; font-weight:600;"></span></div>
                    <div><span style="color:#888;">Started:</span> <span id="ci-meta-started"></span></div>
                    <div><span style="color:#888;">Duration:</span> <span id="ci-meta-duration"></span></div>
                    <div><span style="color:#888;">Role:</span> <span id="ci-meta-role" style="text-transform:capitalize;"></span></div>
                    <div><span style="color:#888;">Documents:</span> <span id="ci-meta-docs"></span></div>
                    <div><span style="color:#888;">AI Cost:</span> <span id="ci-meta-cost" style="color:#27ae60; font-weight:600;"></span></div>
                </div>
                <div style="margin-top:8px;"><span style="color:#888;">Goal:</span> <span id="ci-meta-goal" style="color:#2c3e50; font-style:italic;"></span></div>
            </div>

            <!-- Key Findings -->
            <div id="ci-key-findings-section" style="display:none;">
                <div class="ci-accordion-header" onclick="ciToggleSection('ci-key-findings-body')">
                    <span>üìå KEY FINDINGS</span><span id="ci-key-findings-count"></span>
                </div>
                <div class="ci-accordion-body" id="ci-key-findings-body">
                    <div id="ci-key-findings-list"></div>
                </div>

                <div class="ci-accordion-header" onclick="ciToggleSection('ci-timeline-body')">
                    <span>üìÖ CHRONOLOGY</span><span id="ci-timeline-count"></span>
                </div>
                <div class="ci-accordion-body" id="ci-timeline-body">
                    <div id="ci-timeline-list"></div>
                </div>

                <div class="ci-accordion-header" onclick="ciToggleSection('ci-entities-body')">
                    <span>üë• ENTITIES / CAST OF CHARACTERS</span><span id="ci-entities-count"></span>
                </div>
                <div class="ci-accordion-body" id="ci-entities-body">
                    <div id="ci-entities-list"></div>
                </div>

                <div class="ci-accordion-header" onclick="ciToggleSection('ci-disputed-body')">
                    <span>‚öñÔ∏è DISPUTED FACTS MATRIX</span><span id="ci-disputed-count"></span>
                </div>
                <div class="ci-accordion-body" id="ci-disputed-body">
                    <div id="ci-disputed-list"></div>
                </div>

                <div class="ci-accordion-header" onclick="ciToggleSection('ci-contradictions-body')">
                    <span>‚ö° CONTRADICTIONS</span><span id="ci-contradictions-count"></span>
                </div>
                <div class="ci-accordion-body" id="ci-contradictions-body">
                    <div id="ci-contradictions-list"></div>
                </div>

                <div class="ci-accordion-header" onclick="ciToggleSection('ci-theories-body')">
                    <span>üî¨ THEORY LEDGER</span><span id="ci-theories-count"></span>
                </div>
                <div class="ci-accordion-body" id="ci-theories-body">
                    <div id="ci-theories-list"></div>
                </div>

                <div class="ci-accordion-header" onclick="ciToggleSection('ci-authorities-body')">
                    <span>üìö LEGAL AUTHORITIES</span><span id="ci-authorities-count"></span>
                </div>
                <div class="ci-accordion-body" id="ci-authorities-body">
                    <div id="ci-authorities-list"></div>
                </div>
            </div>

            <!-- No findings yet -->
            <div id="ci-no-findings" style="color:#888; font-size:13px; padding:20px 0; text-align:center;">
                Select a completed run above to view findings, or go to Setup to start a new run.
            </div>

            {% if is_advanced %}
            <!-- Report Builder -->
            <div id="ci-report-builder" style="display:none; margin-top:20px;" class="ci-section-card">
                <h4>üìù REPORT BUILDER</h4>
                <textarea id="ci-report-instructions" rows="4" placeholder="Instructions for the report&#10;e.g. Create a defense memo for counsel. Include top contradictions, key exhibit list, and financial discrepancy timeline. Format as headings with bullets. Exclude speculation."></textarea>
                <div style="display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap;">
                    <select id="ci-report-template" style="padding:6px 10px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                        <option value="attorney_memo">Attorney Memo</option>
                        <option value="chronology">Case Chronology</option>
                        <option value="financial">Financial Analysis</option>
                        <option value="deposition">Deposition Guide</option>
                        <option value="custom">Custom</option>
                    </select>
                    <button class="btn btn-sm" onclick="ciGenerateReport()" style="background:#2c3e50; color:white;">Generate Report</button>
                </div>
                <div id="ci-report-status" style="display:none; margin-top:8px; font-size:12px; color:#888;"></div>
                <div id="ci-report-preview-section" style="display:none; margin-top:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <span style="font-size:12px; font-weight:600;">PREVIEW</span>
                        <a id="ci-report-pdf-link" href="#" style="display:none; font-size:12px; color:#2980b9;">üì• Download PDF</a>
                    </div>
                    <div class="ci-report-preview" id="ci-report-preview"></div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
            {% endif %}
        </div>
    </div>


    <script>
        // Base path injected by Flask from URL_PREFIX env var (set in docker-compose)
        const BASE_PATH = "{{ request.script_root }}";
        const IS_ADMIN = {{ 'true' if is_admin else 'false' }};
        const CURRENT_PROJECT = "{{ session.get('current_project', 'default') | e }}";
        const CURRENT_USER_EMAIL = "{{ current_user.email | default('') | e }}";

        // Helper function to build API URLs
        function apiUrl(path) {
            return BASE_PATH + path;
        }

        // Simple toast notification (fixed banner, auto-dismisses)
        function showToast(message, type, duration) {
            const existing = document.getElementById('app-toast');
            if (existing) existing.remove();
            const bg = type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#2563eb';
            const toast = document.createElement('div');
            toast.id = 'app-toast';
            toast.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:${bg};color:#fff;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:500;z-index:99999;box-shadow:0 4px 16px rgba(0,0,0,0.3);max-width:600px;text-align:center;opacity:1;transition:opacity 0.4s;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, duration || 4000);
        }

        // Wrapper around fetch that detects session expiry and redirects to login
        async function apiFetch(url, options = {}) {
            const response = await fetch(url, options);
            if (response.redirected && response.url.includes('/login')) {
                window.location.href = apiUrl('/login');
                throw new Error('Session expired');
            }
            if (response.status === 401) {
                window.location.href = apiUrl('/login');
                throw new Error('Session expired');
            }
            return response;
        }

        // ‚îÄ‚îÄ Configuration sub-tab state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let vsAllDocs = [];       // flat array: {title, doc_id, type}
        let vsFiltered = [];
        let vsPage = 0;
        const VS_PAGE_SIZE = 25;
        let vsLoaded = false;

        function switchConfigTab(name) {
            document.querySelectorAll('.config-sub-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.config-sub-content').forEach(c => c.classList.remove('active'));
            const btn = document.getElementById('cfg-btn-' + name);
            const pane = document.getElementById('cfg-' + name);
            if (btn) btn.classList.add('active');
            if (pane) pane.classList.add('active');
            // Reset scroll ‚Äî each active config pane is its own scroll container
            if (pane) pane.scrollTop = 0;
            // Lazy-load usage stats on each visit
            if (name === 'usage') { loadLlmUsage(); }
            // Lazy-load vector store on first visit
            if (name === 'vectorstore' && !vsLoaded) {
                loadVectorStoreDocuments();
            }
            // Lazy-load users on first visit (admin only)
            if (name === 'users' && typeof loadUsers === 'function') {
                loadUsers();
            }
            // Update help panel to match the newly active config sub-tab
            _refreshHelpPanel();
        }

        // ‚îÄ‚îÄ Tools sub-tab switcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚îÄ‚îÄ Tools sub-tab auto-refresh state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _toolsAutoRefreshTimer = null;
        const _toolsAutoRefreshIntervals = { health: 30, containers: 60 };

        function _startToolsAutoRefresh(subTab) {
            _stopToolsAutoRefresh();
            const secs = _toolsAutoRefreshIntervals[subTab];
            if (!secs) return;
            let remaining = secs;
            _setToolsCountdown(subTab, remaining);
            _toolsAutoRefreshTimer = setInterval(() => {
                remaining--;
                _setToolsCountdown(subTab, remaining);
                if (remaining <= 0) {
                    remaining = secs;
                    if (subTab === 'health') loadSystemHealth(false);
                    else if (subTab === 'containers') loadContainers(false);
                }
            }, 1000);
        }

        function _stopToolsAutoRefresh() {
            if (_toolsAutoRefreshTimer) { clearInterval(_toolsAutoRefreshTimer); _toolsAutoRefreshTimer = null; }
            document.querySelectorAll('[id^="tools-countdown-"]').forEach(el => el.textContent = '');
        }

        function _setToolsCountdown(subTab, secs) {
            const el = document.getElementById('tools-countdown-' + subTab);
            if (el) el.textContent = secs > 0 ? `Next refresh in ${secs}s` : 'Refreshing‚Ä¶';
        }

        function _resetToolsCountdown(subTab) {
            // Reset the visible countdown when user manually refreshes;
            // the interval keeps running from its current tick position but
            // the countdown display resets to the full interval.
            const secs = _toolsAutoRefreshIntervals[subTab];
            if (!secs) return;
            // Restart the whole interval so timing aligns with the fresh data
            _startToolsAutoRefresh(subTab);
        }

        function switchToolsTab(name) {
            document.querySelectorAll('.tools-sub-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tools-sub-content').forEach(c => c.classList.remove('active'));
            const btn = document.getElementById('tools-btn-' + name);
            const pane = document.getElementById('tools-' + name);
            if (btn) btn.classList.add('active');
            if (pane) { pane.classList.add('active'); pane.scrollTop = 0; }
            // Lazy-load on each visit
            if (name === 'health') { loadSystemHealth(false); }
            if (name === 'containers') { loadContainers(false); }
            if (name === 'logs') { refreshLogs(); }
            // Start auto-refresh for tabs that support it; stop for others
            if (_toolsAutoRefreshIntervals[name]) {
                _startToolsAutoRefresh(name);
            } else {
                _stopToolsAutoRefresh();
            }
            // Update help panel for this sub-tab
            _refreshHelpPanel();
        }

        // ‚îÄ‚îÄ AI Usage / Cost ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadLlmUsage() {
            const days = parseInt(document.getElementById('usage-days-select')?.value || '30');
            document.getElementById('usage-summary').innerHTML = '<div class="loading">Loading‚Ä¶</div>';

            try {
                const res = await apiFetch(apiUrl('/api/llm-usage/stats?days=' + days));
                const data = await res.json();
                if (data.error) { document.getElementById('usage-summary').innerHTML = '<div style="color:#e74c3c;">Error: ' + data.error + '</div>'; return; }

                const o = data.overall || {};
                const fmt$ = v => v != null ? '$' + (parseFloat(v)||0).toFixed(4) : '‚Äî';
                const fmtN = v => v != null ? (parseInt(v)||0).toLocaleString() : '‚Äî';

                // Summary cards
                document.getElementById('usage-summary').innerHTML = `
                    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:14px 16px;">
                        <div style="font-size:11px;color:#166534;font-weight:600;text-transform:uppercase;margin-bottom:4px;">Total Cost</div>
                        <div style="font-size:22px;font-weight:700;color:#15803d;">${fmt$(o.total_cost)}</div>
                        <div style="font-size:11px;color:#6b7280;margin-top:2px;">Last ${days} days</div>
                    </div>
                    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:14px 16px;">
                        <div style="font-size:11px;color:#1e40af;font-weight:600;text-transform:uppercase;margin-bottom:4px;">API Calls</div>
                        <div style="font-size:22px;font-weight:700;color:#1d4ed8;">${fmtN(o.total_calls)}</div>
                        <div style="font-size:11px;color:#6b7280;margin-top:2px;">${fmtN(o.successful_calls)} ok / ${fmtN(o.failed_calls)} failed</div>
                    </div>
                    <div style="background:#fefce8;border:1px solid #fde68a;border-radius:8px;padding:14px 16px;">
                        <div style="font-size:11px;color:#92400e;font-weight:600;text-transform:uppercase;margin-bottom:4px;">Total Tokens</div>
                        <div style="font-size:22px;font-weight:700;color:#b45309;">${fmtN(o.total_tokens)}</div>
                        <div style="font-size:11px;color:#6b7280;margin-top:2px;">in: ${fmtN(o.total_input_tokens)} / out: ${fmtN(o.total_output_tokens)}</div>
                    </div>`;

                // By model table
                const tblStyle = 'width:100%;border-collapse:collapse;font-size:13px;';
                const thStyle = 'text-align:left;padding:6px 10px;border-bottom:2px solid #e5e7eb;font-size:12px;color:#6b7280;font-weight:600;';
                const tdStyle = 'padding:6px 10px;border-bottom:1px solid #f3f4f6;';
                const byModel = data.per_model || [];
                if (byModel.length) {
                    document.getElementById('usage-by-model').innerHTML = `<table style="${tblStyle}">
                        <thead><tr><th style="${thStyle}">Model</th><th style="${thStyle}">Calls</th><th style="${thStyle}">Tokens</th><th style="${thStyle}">Cost</th></tr></thead>
                        <tbody>${byModel.map(m => `<tr>
                            <td style="${tdStyle}">${m.model||'‚Äî'}</td>
                            <td style="${tdStyle}">${fmtN(m.calls)}</td>
                            <td style="${tdStyle}">${fmtN(m.total_tokens)}</td>
                            <td style="${tdStyle};font-weight:600;">${fmt$(m.cost)}</td>
                        </tr>`).join('')}</tbody></table>`;
                } else {
                    document.getElementById('usage-by-model').innerHTML = '<div style="color:#888;font-size:13px;">No data for this period.</div>';
                }

                // By operation table
                const byOp = data.per_operation || [];
                if (byOp.length) {
                    document.getElementById('usage-by-op').innerHTML = `<table style="${tblStyle}">
                        <thead><tr><th style="${thStyle}">Operation</th><th style="${thStyle}">Calls</th><th style="${thStyle}">Tokens</th><th style="${thStyle}">Cost</th></tr></thead>
                        <tbody>${byOp.map(op => `<tr>
                            <td style="${tdStyle}">${op.operation||'‚Äî'}</td>
                            <td style="${tdStyle}">${fmtN(op.calls)}</td>
                            <td style="${tdStyle}">${fmtN(op.total_tokens)}</td>
                            <td style="${tdStyle};font-weight:600;">${fmt$(op.cost)}</td>
                        </tr>`).join('')}</tbody></table>`;
                } else {
                    document.getElementById('usage-by-op').innerHTML = '<div style="color:#888;font-size:13px;">No data for this period.</div>';
                }

                // Daily usage chart + table
                const daily = data.daily_usage || [];
                renderUsageChart(daily);
                if (daily.length) {
                    document.getElementById('usage-daily').innerHTML = `<table style="${tblStyle}">
                        <thead><tr><th style="${thStyle}">Date</th><th style="${thStyle}">Calls</th><th style="${thStyle}">Tokens</th><th style="${thStyle}">Cost</th></tr></thead>
                        <tbody>${daily.map(d => `<tr>
                            <td style="${tdStyle}">${d.date||'‚Äî'}</td>
                            <td style="${tdStyle}">${fmtN(d.calls)}</td>
                            <td style="${tdStyle}">${fmtN(d.tokens)}</td>
                            <td style="${tdStyle};font-weight:600;">${fmt$(d.cost)}</td>
                        </tr>`).join('')}</tbody></table>`;
                } else {
                    document.getElementById('usage-daily').innerHTML = '<div style="color:#888;font-size:13px;">No data for this period.</div>';
                }

                // Pricing reference
                const pricingRes = await apiFetch(apiUrl('/api/llm-usage/pricing'));
                const pricingData = await pricingRes.json();
                const pricing = pricingData.pricing || {};
                const pricingModels = Object.keys(pricing);
                if (pricingModels.length) {
                    document.getElementById('usage-pricing').innerHTML = `<table style="${tblStyle}">
                        <thead><tr><th style="${thStyle}">Model</th><th style="${thStyle}">Input / 1M tokens</th><th style="${thStyle}">Output / 1M tokens</th></tr></thead>
                        <tbody>${pricingModels.map(m => `<tr>
                            <td style="${tdStyle}">${m}</td>
                            <td style="${tdStyle}">$${(pricing[m].input||0).toFixed(2)}</td>
                            <td style="${tdStyle}">$${(pricing[m].output||0).toFixed(2)}</td>
                        </tr>`).join('')}</tbody></table>`;
                } else {
                    document.getElementById('usage-pricing').innerHTML = '<div style="color:#888;font-size:13px;">No pricing data available.</div>';
                }

            } catch(e) {
                document.getElementById('usage-summary').innerHTML = '<div style="color:#e74c3c;">Failed to load usage data: ' + e.message + '</div>';
            }
        }

        // ‚îÄ‚îÄ Daily usage bar chart (Canvas) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderUsageChart(dailyData) {
            const canvas = document.getElementById('usage-chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (!rect.width) return;
            canvas.width  = rect.width  * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width, H = rect.height;

            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, W, H);

            if (!dailyData || dailyData.length === 0) {
                ctx.fillStyle = '#9ca3af';
                ctx.font = '13px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data for this period', W / 2, H / 2);
                return;
            }

            const sorted = [...dailyData].sort((a, b) => a.date.localeCompare(b.date));
            const maxCost  = Math.max(...sorted.map(d => parseFloat(d.cost)  || 0), 0.00001);
            const maxCalls = Math.max(...sorted.map(d => parseInt(d.calls)   || 0), 1);

            const PAD_L = 58, PAD_R = 16, PAD_T = 22, PAD_B = 38;
            const cW = W - PAD_L - PAD_R, cH = H - PAD_T - PAD_B;
            const n  = sorted.length;

            // Grid + Y-axis (cost)
            const ySteps = 4;
            for (let i = 0; i <= ySteps; i++) {
                const y   = PAD_T + cH - (i / ySteps) * cH;
                const val = maxCost * i / ySteps;
                ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(PAD_L, y); ctx.lineTo(PAD_L + cW, y); ctx.stroke();
                ctx.fillStyle = '#6b7280'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
                ctx.fillText('$' + (val < 0.01 ? val.toFixed(4) : val < 0.1 ? val.toFixed(3) : val.toFixed(2)), PAD_L - 4, y + 4);
            }

            // X axis line
            ctx.strokeStyle = '#d1d5db'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(PAD_L, PAD_T + cH); ctx.lineTo(PAD_L + cW, PAD_T + cH); ctx.stroke();

            // Bars + labels
            const slotW = cW / n;
            const barW  = Math.max(slotW * 0.65, 3);
            const barOff = (slotW - barW) / 2;

            sorted.forEach((d, i) => {
                const cost  = parseFloat(d.cost)  || 0;
                const barH  = (cost / maxCost) * cH;
                const x     = PAD_L + i * slotW + barOff;
                const y     = PAD_T + cH - barH;

                // Bar gradient feel
                ctx.fillStyle = '#3b82f6';
                ctx.fillRect(x, y, barW, barH);
                if (barH > 4) { ctx.fillStyle = 'rgba(255,255,255,0.18)'; ctx.fillRect(x, y, barW, 4); }

                // Cost label above tall bars
                if (barH > 18 && cost > 0) {
                    ctx.fillStyle = '#1e40af'; ctx.font = '9px sans-serif'; ctx.textAlign = 'center';
                    ctx.fillText('$' + cost.toFixed(3), x + barW / 2, y - 2);
                }

                // X-axis date label
                const label = d.date ? d.date.substring(5) : '';  // "MM-DD"
                ctx.fillStyle = '#6b7280'; ctx.textAlign = 'center';
                if (n > 20) {
                    ctx.font = '9px sans-serif';
                    ctx.save(); ctx.translate(x + barW/2, PAD_T + cH + 4); ctx.rotate(Math.PI/4);
                    ctx.fillText(label, 0, 0); ctx.restore();
                } else {
                    ctx.font = '10px sans-serif';
                    ctx.fillText(label, x + barW / 2, PAD_T + cH + 13);
                }
            });

            // Calls overlay line (secondary axis, dashed amber)
            ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 1.5; ctx.setLineDash([3, 2]);
            ctx.beginPath();
            sorted.forEach((d, i) => {
                const calls = parseInt(d.calls) || 0;
                const cx = PAD_L + i * slotW + barOff + barW / 2;
                const cy = PAD_T + cH - (calls / maxCalls) * cH;
                i === 0 ? ctx.moveTo(cx, cy) : ctx.lineTo(cx, cy);
            });
            ctx.stroke(); ctx.setLineDash([]);

            // Legend
            ctx.fillStyle = '#3b82f6'; ctx.fillRect(PAD_L, 4, 10, 8);
            ctx.fillStyle = '#374151'; ctx.font = '10px sans-serif'; ctx.textAlign = 'left';
            ctx.fillText('Daily Cost', PAD_L + 13, 12);
            ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 1.5; ctx.setLineDash([3, 2]);
            ctx.beginPath(); ctx.moveTo(PAD_L + 72, 8); ctx.lineTo(PAD_L + 84, 8); ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#374151'; ctx.fillText('API Calls', PAD_L + 87, 12);
        }

        function filterVsDocs() {
            const q = (document.getElementById('vs-search')?.value || '').toLowerCase().trim();
            vsFiltered = q
                ? vsAllDocs.filter(d =>
                    (d.title || '').toLowerCase().includes(q) ||
                    String(d.doc_id).includes(q) ||
                    (d.type || '').toLowerCase().includes(q))
                : [...vsAllDocs];
            vsPage = 0;
            renderVsPage();
        }

        function renderVsPage() {
            const container = document.getElementById('vector-store-manager');
            const pagDiv = document.getElementById('vs-pagination');
            const countLabel = document.getElementById('vs-count-label');
            if (!container) return;

            const total = vsFiltered.length;
            const totalPages = Math.ceil(total / VS_PAGE_SIZE) || 1;
            if (countLabel) countLabel.textContent = total + ' document' + (total !== 1 ? 's' : '');

            if (total === 0) {
                container.innerHTML = '<p style="color:#999;">No documents match.</p>';
                if (pagDiv) pagDiv.style.display = 'none';
                return;
            }

            const start = vsPage * VS_PAGE_SIZE;
            const slice = vsFiltered.slice(start, start + VS_PAGE_SIZE);

            // Group current page slice by type for display
            const byType = {};
            slice.forEach(d => {
                if (!byType[d.type]) byType[d.type] = [];
                byType[d.type].push(d);
            });

            let html = '';
            Object.keys(byType).sort().forEach(type => {
                const docs = byType[type];
                html += `<div class="vector-type-section">
                    <div class="vector-type-header">
                        <h3>${escapeHtml(type)} <span class="vector-type-count">(${docs.length})</span></h3>
                        <button class="btn btn-small btn-warning" onclick="confirmDeleteType('${escapeHtml(type)}')">Delete All ${escapeHtml(type)}</button>
                    </div>
                    <div class="vector-documents-list">`;
                docs.forEach(doc => {
                    html += `<div class="vector-doc-item">
                        <div class="vector-doc-info">
                            <div class="vector-doc-title">${escapeHtml(doc.title || 'Untitled')}</div>
                            <div class="vector-doc-id">ID: ${doc.doc_id}</div>
                        </div>
                        <button class="btn btn-small btn-warning" onclick="deleteIndividualDocument(${doc.doc_id}, '${escapeHtml(doc.title || 'this document')}')">Delete</button>
                    </div>`;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;

            // Pagination controls
            if (pagDiv) {
                if (totalPages <= 1) {
                    pagDiv.style.display = 'none';
                } else {
                    pagDiv.style.display = 'flex';
                    let pagHtml = `<button class="btn btn-small" onclick="vsGoPage(${vsPage-1})" ${vsPage===0?'disabled':''}>‚óÄ Prev</button>`;
                    // Show up to 7 page buttons
                    const maxBtns = 7, half = Math.floor(maxBtns/2);
                    let pStart = Math.max(0, vsPage - half);
                    let pEnd = Math.min(totalPages - 1, pStart + maxBtns - 1);
                    if (pEnd - pStart < maxBtns - 1) pStart = Math.max(0, pEnd - maxBtns + 1);
                    for (let p = pStart; p <= pEnd; p++) {
                        pagHtml += `<button class="btn btn-small${p===vsPage?' active':''}" onclick="vsGoPage(${p})">${p+1}</button>`;
                    }
                    pagHtml += `<button class="btn btn-small" onclick="vsGoPage(${vsPage+1})" ${vsPage>=totalPages-1?'disabled':''}>Next ‚ñ∂</button>`;
                    pagHtml += `<span style="font-size:13px;color:#666;margin-left:6px;">Page ${vsPage+1} of ${totalPages}</span>`;
                    pagDiv.innerHTML = pagHtml;
                }
            }
        }

        function vsGoPage(p) {
            const totalPages = Math.ceil(vsFiltered.length / VS_PAGE_SIZE) || 1;
            vsPage = Math.max(0, Math.min(p, totalPages - 1));
            renderVsPage();
            // Scroll to top of the vector store pane when changing pages
            const vsPane = document.getElementById('cfg-vectorstore');
            if (vsPane) vsPane.scrollTop = 0;
        }

        // ‚îÄ‚îÄ Tab switching function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab and reset its scroll position
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.scrollTop = 0;
            }

            // Activate selected tab button (match by onclick attribute, not text content)
            document.querySelectorAll('.tab-button').forEach(btn => {
                const m = btn.getAttribute('onclick') && btn.getAttribute('onclick').match(/'([^']+)'/);
                if (m && m[1] === tabName) {
                    btn.classList.add('active');
                }
            });

            // Load projects when projects tab is opened
            if (tabName === 'projects') {
                console.log('Projects tab selected, typeof loadProjectsList:', typeof loadProjectsList);
                if (typeof loadProjectsList === 'function') {
                    loadProjectsList();
                } else {
                    console.error('loadProjectsList is not a function!');
                }
            }
            // Config tab: reset to AI Settings sub-tab on each visit
            if (tabName === 'config') {
                switchConfigTab('ai');
            }
            // Tools tab: show Health sub-tab on each visit
            if (tabName === 'tools') {
                switchToolsTab('health');
            }
            // Check API key when AI chat tab is opened
            if (tabName === 'ai-chat') {
                checkAiKeyStatus();
            }
            // Load import history and project list when upload tab is opened
            if (tabName === 'upload') {
                loadImportHistory();
                loadUploadProjects();
            }
            // Load document table when search tab is opened
            if (tabName === 'search') {
                loadSearchTab();
            }
        }

        async function checkAiKeyStatus() {
            try {
                const res = await apiFetch(apiUrl('/api/llm/status'));
                const data = await res.json();
                // Check v2 config: any global key present = chat is usable
                const configRes = await apiFetch(apiUrl('/api/ai-config'));
                const configData = await configRes.json();
                const globalCfg = configData.config?.global || {};
                const hasAnyKey = Object.values(globalCfg).some(p => p.api_key && p.api_key.trim());
                document.getElementById('ai-key-warning').style.display = hasAnyKey ? 'none' : 'block';
            } catch (e) {
                // If we can't check, hide the warning (don't block usage)
            }
        }

        async function openProfileModal() {
            // Clear state
            ['profile-error','profile-success','cp-error','cp-success'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            ['cp-current','cp-new','cp-confirm'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('profile-modal').style.display = 'flex';

            // Load current profile
            try {
                const r = await apiFetch(apiUrl('/api/me'));
                const d = await r.json();
                document.getElementById('profile-username-display').textContent =
                    '@' + (d.username || '') + '  ¬∑  ' + (d.role || '').charAt(0).toUpperCase() + (d.role || '').slice(1);
                document.getElementById('profile-display-name').value = d.display_name || '';
                document.getElementById('profile-job-title').value   = d.job_title || '';
                document.getElementById('profile-email').value       = d.email || '';
                document.getElementById('profile-phone').value       = d.phone || '';
                document.getElementById('profile-address').value     = d.address || '';
            } catch(e) {
                const err = document.getElementById('profile-error');
                err.textContent = 'Could not load profile: ' + e.message;
                err.style.display = 'block';
            }
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').style.display = 'none';
        }

        async function submitProfileUpdate() {
            const errEl = document.getElementById('profile-error');
            const okEl  = document.getElementById('profile-success');
            errEl.style.display = 'none';
            okEl.style.display  = 'none';
            const payload = {
                display_name: document.getElementById('profile-display-name').value.trim(),
                job_title:    document.getElementById('profile-job-title').value.trim(),
                email:        document.getElementById('profile-email').value.trim(),
                phone:        document.getElementById('profile-phone').value.trim(),
                address:      document.getElementById('profile-address').value.trim(),
            };
            if (!payload.display_name) {
                errEl.textContent = 'Full name cannot be empty.';
                errEl.style.display = 'block';
                return;
            }
            try {
                const r = await apiFetch(apiUrl('/api/me'), {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });
                const d = await r.json();
                if (d.success) {
                    okEl.textContent = 'Profile saved.';
                    okEl.style.display = 'block';
                    setTimeout(() => { if (okEl) okEl.style.display = 'none'; }, 3000);
                } else {
                    errEl.textContent = d.error || 'Save failed.';
                    errEl.style.display = 'block';
                }
            } catch(e) {
                errEl.textContent = 'Network error: ' + e.message;
                errEl.style.display = 'block';
            }
        }

        async function submitChangePassword() {
            const current = document.getElementById('cp-current').value;
            const newPw = document.getElementById('cp-new').value;
            const confirm = document.getElementById('cp-confirm').value;
            const errEl = document.getElementById('cp-error');
            const okEl = document.getElementById('cp-success');
            errEl.style.display = 'none';
            okEl.style.display = 'none';
            if (!current || !newPw) { errEl.textContent = 'All fields are required.'; errEl.style.display = 'block'; return; }
            if (newPw !== confirm) { errEl.textContent = 'New passwords do not match.'; errEl.style.display = 'block'; return; }
            if (newPw.length < 6) { errEl.textContent = 'New password must be at least 6 characters.'; errEl.style.display = 'block'; return; }
            try {
                const res = await apiFetch(apiUrl('/api/change-password'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({current_password: current, new_password: newPw})
                });
                const data = await res.json();
                if (data.success) {
                    okEl.textContent = 'Password updated successfully!';
                    okEl.style.display = 'block';
                    document.getElementById('cp-current').value = '';
                    document.getElementById('cp-new').value = '';
                    document.getElementById('cp-confirm').value = '';
                    setTimeout(() => { if (okEl) okEl.style.display = 'none'; }, 3000);
                } else {
                    errEl.textContent = data.error || 'Failed to update password.';
                    errEl.style.display = 'block';
                }
            } catch (e) {
                errEl.textContent = 'Network error: ' + e.message;
                errEl.style.display = 'block';
            }
        }

        // Auto-refresh data every 10 seconds
        let refreshInterval;

        async function fetchStatus() {
            try {
                const response = await apiFetch(apiUrl('/api/status'));
                const data = await response.json();

                // Update stats
                document.getElementById('status').textContent = data.status === 'running' ? 'Running' : 'Stopped';
                document.getElementById('total-analyzed').textContent = data.stats.total_analyzed;
                document.getElementById('anomalies-detected').textContent = data.stats.anomalies_detected;
                document.getElementById('high-risk-count').textContent = data.stats.high_risk_count;
                document.getElementById('active-profiles').textContent = data.active_profiles;

                // Update embedded docs count
                if (data.vector_store && data.vector_store.enabled) {
                    document.getElementById('embedded-docs').textContent = data.vector_store.total_documents + ' ‚úì';
                } else {
                    document.getElementById('embedded-docs').textContent = 'Disabled';
                }

                // Format last update time
                if (data.last_update) {
                    const date = new Date(data.last_update);
                    document.getElementById('last-update').textContent = date.toLocaleTimeString();
                } else {
                    document.getElementById('last-update').textContent = 'Never';
                }
            } catch (error) {
                console.error('Failed to fetch status:', error);
            }
        }

        async function fetchRecent() {
            try {
                const response = await apiFetch(apiUrl('/api/recent'));
                const data = await response.json();

                const overviewContainer = document.getElementById('recent-analyses');

                if (data.analyses.length === 0) {
                    if (overviewContainer) overviewContainer.innerHTML = '<div class="empty-state">No analyses yet</div>';
                    return;
                }

                const analysesHtml = data.analyses.slice(-20).reverse().map(analysis => {
                    const hasAnomalies = analysis.anomalies_found && analysis.anomalies_found.length > 0;
                    const isHighRisk = analysis.risk_score >= 70;
                    const classes = ['recent-item'];
                    if (hasAnomalies) classes.push('has-anomalies');
                    if (isHighRisk) classes.push('high-risk');

                    let tags = '';
                    if (analysis.anomalies_found) {
                        // Check if this document has enhanced tags (issue count > 0 indicates detailed evidence)
                        const hasEvidence = analysis.issue_count > 0 || analysis.enhanced_tags;

                        tags = analysis.anomalies_found.map(a => {
                            // All anomaly tags are now clickable to show explanations
                            return `<span class="tag anomaly clickable" onclick="event.stopPropagation(); showTagEvidence(${analysis.document_id || analysis.doc_id}, '${(analysis.document_title || analysis.title).replace(/'/g, "\\'")}')" title="Click to see why this was flagged">üîç ${a}</span>`;
                        }).join('');

                        // Add "View Evidence" button if document has integrity issues
                        if (hasEvidence) {
                            tags += ` <span class="tag clickable" style="background: #3498db; color: white;" onclick="event.stopPropagation(); showTagEvidence(${analysis.document_id || analysis.doc_id}, '${(analysis.document_title || analysis.title).replace(/'/g, "\\'")}');" title="Click to view all evidence">üìã View Evidence</span>`;
                        }
                    }

                    // Format summaries ‚Äî always fully visible, no collapse
                    const briefSummary = analysis.brief_summary || '';
                    const fullSummary = analysis.full_summary || '';
                    const summaryHtml = briefSummary ? `
                        <div style="margin-top: 8px; padding: 8px 10px; background: rgba(52, 152, 219, 0.08); border-left: 3px solid #3498db; border-radius: 4px; font-size: 0.9em;">
                            <div style="color: #444; line-height: 1.5;"><strong>Brief Summary:</strong> ${briefSummary}</div>
                            ${fullSummary ? `
                                <div style="margin-top: 6px; color: #555; line-height: 1.5; border-top: 1px solid rgba(52,152,219,0.2); padding-top: 6px;"><strong>Full Summary:</strong> ${fullSummary}</div>
                            ` : ''}
                        </div>
                    ` : '';

                    return `
                        <div class="${classes.join(' ')}">
                            <div class="title">${analysis.document_title || analysis.title}</div>
                            <div class="meta">
                                <span>üìÑ <a href="https://www.voipguru.org/paperless/documents/${analysis.document_id || analysis.doc_id}" target="_blank" style="color: #3498db; text-decoration: none;">Doc #${analysis.document_id || analysis.doc_id}</a></span>
                                <span>‚ö†Ô∏è Risk: ${analysis.risk_score}%</span>
                                ${analysis.profile_matched ? `<span>üìã ${analysis.profile_matched}</span>` : '<span>‚ùì No profile</span>'}
                                <span>‚è±Ô∏è ${new Date(analysis.timestamp).toLocaleString()}</span>
                            </div>
                            ${summaryHtml}
                            ${tags ? `<div style="margin-top: 8px;">${tags}</div>` : ''}
                        </div>
                    `;
                }).join('');

                // Always update overview recent-analyses panel
                if (overviewContainer) overviewContainer.innerHTML = analysesHtml;
            } catch (error) {
                console.error('Failed to fetch recent analyses:', error);
                const overviewContainer = document.getElementById('recent-analyses');
                if (overviewContainer) overviewContainer.innerHTML = '<div class="empty-state">Failed to load</div>';
            }
        }

        async function fetchProfiles() {
            try {
                const response = await apiFetch(apiUrl('/api/profiles'));
                const data = await response.json();

                // Active profiles
                const activeList = document.getElementById('active-profiles-list');
                if (data.active.length === 0) {
                    activeList.innerHTML = '<li class="empty-state">No active profiles</li>';
                } else {
                    activeList.innerHTML = data.active.map(profile => `
                        <li style="display: flex; justify-content: space-between; align-items: center; padding: 12px;">
                            <div>
                                <span class="profile-name">${profile.name}</span>
                                <span class="profile-version">v${profile.version}</span>
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">${profile.filename}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-small" onclick="viewActiveProfile('${profile.filename}')">üëÅÔ∏è View</button>
                                <button class="btn btn-small" onclick="renameActiveProfile('${profile.filename}', '${profile.name}')">‚úèÔ∏è Rename</button>
                                <button class="btn btn-small btn-danger" onclick="deleteActiveProfile('${profile.filename}')">‚úó Delete</button>
                            </div>
                        </li>
                    `).join('');
                }

                // Staging profiles
                const stagingSection = document.getElementById('staging-section');
                const stagingContainer = document.getElementById('staging-profiles');
                if (data.staging.length > 0) {
                    if (stagingSection) stagingSection.style.display = 'block';
                    if (stagingContainer) {
                        stagingContainer.innerHTML = data.staging.map(profile => `
                            <div class="staging-profile">
                                <div class="filename">${profile.filename}</div>
                                <div class="actions" style="margin-top: 8px;">
                                    <span style="font-size: 12px; color: #666;">
                                        Created: ${new Date(profile.created).toLocaleString()}
                                    </span>
                                    <div style="margin-top: 8px; display: flex; gap: 10px;">
                                        <button class="btn btn-small" onclick="viewStagingProfile('${profile.filename}')">üëÅÔ∏è View</button>
                                        <button class="btn btn-small btn-success" onclick="activateStagingProfile('${profile.filename}')">‚úì Activate</button>
                                        <button class="btn btn-small btn-danger" onclick="deleteStagingProfile('${profile.filename}')">‚úó Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    if (stagingSection) stagingSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to fetch profiles:', error);
            }
        }

        // ‚îÄ‚îÄ Manage Projects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const PROJ_COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#64748b'];
        let _projEditSlug = null;   // null = new project, slug string = edit
        let _projCache = [];        // last fetched project list

        function _renderProjectCard(p) {
            const color    = p.color || '#3b82f6';
            const archived = p.is_archived;
            const cardId   = `proj-docs-${p.slug}`;
            return `
            <div style="background:#fff; border:1px solid #e5e7eb; border-left:4px solid ${color}; border-radius:8px; margin-bottom:12px; ${archived ? 'opacity:.6;' : ''}">
                <div style="padding:18px 20px; display:flex; align-items:center; gap:16px;">
                    <div style="flex:1; min-width:0;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:3px;">
                            <span style="font-weight:700; font-size:15px; color:#111; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.name}</span>
                        </div>
                        <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">${p.description || '<em style="color:#aaa;">No description</em>'}</div>
                        <div style="font-size:12px; color:#9ca3af;">
                            üìÑ <strong style="color:#374151;">${p.document_count}</strong> docs &nbsp;¬∑&nbsp;
                            üíæ ${(p.storage_size_mb||0).toFixed(2)} MB &nbsp;¬∑&nbsp;
                            üìÖ ${new Date(p.created_at).toLocaleDateString()} &nbsp;¬∑&nbsp;
                            <span style="font-family:monospace; font-size:11px; background:#f3f4f6; padding:1px 6px; border-radius:4px;">${p.slug}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:6px; flex-shrink:0; align-items:center;">
                        ${!archived ? `<button onclick="openEditProjectModal('${p.slug}')" title="Edit"
                            style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">‚úèÔ∏è</button>
                        <button onclick="openMoveModal('${p.slug}')" title="Move documents"
                            style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">üì¶ Move</button>` : ''}
                        ${archived
                            ? `<button onclick="toggleArchiveProject('${p.slug}', false)" title="Restore"
                                style="padding:6px 11px; border:1px solid #6b7280; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">üìÇ Restore</button>`
                            : `<button onclick="toggleArchiveProject('${p.slug}', true)" title="Archive"
                                style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">üóÑÔ∏è Archive</button>`}
                        ${p.slug !== 'default'
                            ? `<button onclick="openDelProjModal('${p.slug}', '${p.name.replace(/'/g,"\\'")}', ${p.document_count})" title="Delete project"
                                style="padding:6px 11px; border:1px solid #fca5a5; border-radius:6px; background:#fff; cursor:pointer; font-size:13px; color:#dc2626;">üóëÔ∏è</button>`
                            : ''}
                        <button onclick="toggleProjDocs('${p.slug}')" id="proj-toggle-${p.slug}"
                            title="Show/hide documents"
                            style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#f9fafb; cursor:pointer; font-size:13px;">
                            üìã Docs ‚ñº
                        </button>
                    </div>
                </div>
                <div id="${cardId}" style="display:none; border-top:1px solid #e5e7eb; padding:0 20px 16px 20px;">
                    <div id="${cardId}-inner" style="padding-top:12px; font-size:13px; color:#374151;">
                        <em style="color:#9ca3af;">Loading‚Ä¶</em>
                    </div>
                </div>
            </div>`;
        }

        async function loadProjectsList() {
            const list = document.getElementById('projects-list');
            try {
                const res = await apiFetch(apiUrl('/api/projects'));
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                _projCache = data.projects || [];

                const active   = _projCache.filter(p => !p.is_archived);
                const archived = _projCache.filter(p =>  p.is_archived);

                if (!_projCache.length) {
                    list.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No projects found. Click <strong>+ New Project</strong> to get started.</div>';
                    return;
                }

                let html = active.map(_renderProjectCard).join('');

                if (archived.length) {
                    html += `
                    <div style="margin-top:32px; margin-bottom:12px; display:flex; align-items:center; gap:10px;">
                        <span style="font-weight:700; font-size:14px; color:#6b7280; text-transform:uppercase; letter-spacing:.05em;">üóÑÔ∏è Archived (${archived.length})</span>
                        <div style="flex:1; height:1px; background:#e5e7eb;"></div>
                    </div>
                    ${archived.map(_renderProjectCard).join('')}`;
                }

                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = `<div style="color:#e74c3c; padding:20px; text-align:center;"><strong>Error loading projects:</strong><br>${e.message}</div>`;
            }
        }

        // ‚îÄ‚îÄ New / Edit modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function _buildColorSwatches(selectedColor) {
            const wrap = document.getElementById('proj-color-swatches');
            wrap.innerHTML = PROJ_COLORS.map(c =>
                `<div onclick="selectSwatch('${c}')" style="width:26px; height:26px; border-radius:50%; background:${c}; cursor:pointer; outline:${c === selectedColor ? '3px solid #1d4ed8' : '2px solid transparent'}; outline-offset:2px; transition:outline .1s;" data-color="${c}"></div>`
            ).join('');
        }

        function selectSwatch(color) {
            document.getElementById('proj-color-val').value = color;
            document.querySelectorAll('#proj-color-swatches div').forEach(el => {
                el.style.outline = el.dataset.color === color ? '3px solid #1d4ed8' : '2px solid transparent';
            });
        }

        function selectCustomColor(color) {
            document.getElementById('proj-color-val').value = color;
            document.querySelectorAll('#proj-color-swatches div').forEach(el => {
                el.style.outline = '2px solid transparent';
            });
        }

        function autoSlug() {
            if (_projEditSlug) return;  // don't overwrite slug when editing
            const name = document.getElementById('proj-name').value;
            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            document.getElementById('proj-slug').value = slug;
        }

        function openNewProjectModal() {
            _projEditSlug = null;
            document.getElementById('proj-modal-title').textContent = 'New Project';
            document.getElementById('proj-name').value = '';
            document.getElementById('proj-slug').value = '';
            document.getElementById('proj-slug').disabled = false;
            document.getElementById('proj-desc').value = '';
            document.getElementById('proj-modal-error').style.display = 'none';
            const defaultColor = PROJ_COLORS[Math.floor(Math.random() * PROJ_COLORS.length)];
            document.getElementById('proj-color-val').value = defaultColor;
            _buildColorSwatches(defaultColor);
            document.getElementById('proj-modal').style.display = 'flex';
            document.getElementById('proj-name').focus();
        }

        function openEditProjectModal(slug) {
            const p = _projCache.find(x => x.slug === slug);
            if (!p) return;
            _projEditSlug = slug;
            document.getElementById('proj-modal-title').textContent = 'Edit Project';
            document.getElementById('proj-name').value = p.name;
            document.getElementById('proj-slug').value = p.slug;
            document.getElementById('proj-slug').disabled = true;
            document.getElementById('proj-desc').value = p.description || '';
            document.getElementById('proj-modal-error').style.display = 'none';
            const color = p.color || PROJ_COLORS[0];
            document.getElementById('proj-color-val').value = color;
            _buildColorSwatches(color);
            document.getElementById('proj-modal').style.display = 'flex';
            document.getElementById('proj-name').focus();
        }

        function closeProjModal() {
            document.getElementById('proj-modal').style.display = 'none';
        }

        async function saveProject() {
            const name = document.getElementById('proj-name').value.trim();
            const slug = document.getElementById('proj-slug').value.trim();
            const description = document.getElementById('proj-desc').value.trim();
            const color = document.getElementById('proj-color-val').value;
            const errDiv = document.getElementById('proj-modal-error');
            const btn = document.getElementById('proj-save-btn');

            if (!name) { errDiv.textContent = 'Name is required.'; errDiv.style.display = ''; return; }
            if (!_projEditSlug && !slug) { errDiv.textContent = 'Slug is required.'; errDiv.style.display = ''; return; }
            if (!_projEditSlug && !/^[a-z0-9-]+$/.test(slug)) {
                errDiv.textContent = 'Slug must contain only lowercase letters, numbers, and hyphens.';
                errDiv.style.display = ''; return;
            }

            btn.disabled = true; errDiv.style.display = 'none';

            try {
                let res;
                if (_projEditSlug) {
                    res = await apiFetch(apiUrl(`/api/projects/${_projEditSlug}`), {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name, description, color})
                    });
                } else {
                    res = await apiFetch(apiUrl('/api/projects'), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name, slug, description, color})
                    });
                }
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                closeProjModal();
                loadProjectsList();
                loadProjectSelector();
            } catch (e) {
                errDiv.textContent = e.message;
                errDiv.style.display = '';
            } finally {
                btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Archive / Unarchive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function toggleArchiveProject(slug, archive) {
            const action = archive ? 'archive' : 'unarchive';
            try {
                const res = await apiFetch(apiUrl(`/api/projects/${slug}/${action}`), {method: 'POST'});
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                loadProjectsList();
                loadProjectSelector();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ‚îÄ‚îÄ Delete modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function openDelProjModal(slug, name, docCount) {
            document.getElementById('del-proj-slug').value = slug;
            document.getElementById('del-proj-name').textContent = name;
            document.getElementById('del-proj-count').textContent = docCount;
            document.getElementById('del-proj-data').checked = true;
            document.getElementById('del-proj-error').style.display = 'none';
            document.getElementById('del-proj-modal').style.display = 'flex';
        }

        function closeDelProjModal() {
            document.getElementById('del-proj-modal').style.display = 'none';
        }

        async function confirmDeleteProject() {
            const slug = document.getElementById('del-proj-slug').value;
            const deleteData = document.getElementById('del-proj-data').checked;
            const errDiv = document.getElementById('del-proj-error');
            try {
                const res = await apiFetch(apiUrl(`/api/projects/${slug}?delete_data=${deleteData}`), {method: 'DELETE'});
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                closeDelProjModal();
                loadProjectsList();
                loadProjectSelector();
            } catch (e) {
                errDiv.textContent = e.message;
                errDiv.style.display = '';
            }
        }

        // ‚îÄ‚îÄ Move Documents modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function _populateMoveSelects(sourceSlug) {
            const active = _projCache.filter(p => !p.is_archived);
            const opts = active.map(p => `<option value="${p.slug}">${p.name} (${p.document_count} docs)</option>`).join('');
            const src = document.getElementById('move-source');
            const dst = document.getElementById('move-dest');
            src.innerHTML = opts;
            dst.innerHTML = opts;
            if (sourceSlug) src.value = sourceSlug;
            // Default dest to something different
            const destSlug = active.find(p => p.slug !== src.value)?.slug;
            if (destSlug) dst.value = destSlug;
        }

        function openMoveModal(sourceSlug) {
            _populateMoveSelects(sourceSlug);
            document.querySelector('input[name="move-scope"][value="all"]').checked = true;
            document.getElementById('move-ids-wrap').style.display = 'none';
            document.getElementById('move-doc-ids').value = '';
            document.getElementById('move-modal-error').style.display = 'none';
            document.getElementById('move-modal-status').style.display = 'none';
            document.getElementById('move-confirm-btn').disabled = false;
            updateMovePreview();
            document.getElementById('move-modal').style.display = 'flex';
        }

        function closeMoveModal() {
            document.getElementById('move-modal').style.display = 'none';
        }

        function toggleMoveIds() {
            const specific = document.querySelector('input[name="move-scope"][value="specific"]').checked;
            document.getElementById('move-ids-wrap').style.display = specific ? '' : 'none';
        }

        function updateMovePreview() {
            const srcSlug = document.getElementById('move-source').value;
            const srcProj = _projCache.find(p => p.slug === srcSlug);
            const preview = document.getElementById('move-preview');
            if (srcProj) {
                document.getElementById('move-all-count').textContent = srcProj.document_count;
                preview.textContent = `üì¶ Up to ${srcProj.document_count} document(s) will be re-tagged in Paperless. This runs in the background.`;
                preview.style.display = '';
            } else {
                preview.style.display = 'none';
            }
        }

        async function confirmMove() {
            const srcSlug = document.getElementById('move-source').value;
            const dstSlug = document.getElementById('move-dest').value;
            const specific = document.querySelector('input[name="move-scope"][value="specific"]').checked;
            const errDiv = document.getElementById('move-modal-error');
            const statusDiv = document.getElementById('move-modal-status');
            const btn = document.getElementById('move-confirm-btn');

            if (srcSlug === dstSlug) {
                errDiv.textContent = 'Source and destination must be different projects.';
                errDiv.style.display = ''; return;
            }

            let docIds = [];
            if (specific) {
                const raw = document.getElementById('move-doc-ids').value.trim();
                if (!raw) { errDiv.textContent = 'Enter at least one document ID.'; errDiv.style.display = ''; return; }
                docIds = raw.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
                if (!docIds.length) { errDiv.textContent = 'No valid document IDs found.'; errDiv.style.display = ''; return; }
            }

            btn.disabled = true;
            errDiv.style.display = 'none';
            statusDiv.style.display = 'none';

            try {
                const res = await apiFetch(apiUrl('/api/projects/migrate-documents'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        source_project: srcSlug,
                        destination_project: dstSlug,
                        document_ids: docIds
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                // Close dialog immediately and show a toast so the user gets clear feedback
                closeMoveModal();
                btn.textContent = 'Move Documents';
                btn.onclick = confirmMove;
                btn.disabled = false;
                loadProjectsList();
                loadProjectSelector();
                const msg = (data.message || 'Migration started.') + (data.note ? ' ‚Äî ' + data.note : '');
                showToast('‚úÖ ' + msg, 'success', 5000);
            } catch (e) {
                errDiv.textContent = e.message;
                errDiv.style.display = '';
                btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Project document expand panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _projDocsLoaded = {};

        async function toggleProjDocs(slug) {
            const panel = document.getElementById(`proj-docs-${slug}`);
            const btn   = document.getElementById(`proj-toggle-${slug}`);
            const inner = document.getElementById(`proj-docs-${slug}-inner`);
            if (panel.style.display === 'none') {
                panel.style.display = '';
                btn.textContent = 'üìã Docs ‚ñ≤';
                if (!_projDocsLoaded[slug]) {
                    inner.innerHTML = '<em style="color:#9ca3af;">Loading‚Ä¶</em>';
                    await _loadProjDocs(slug);
                }
            } else {
                panel.style.display = 'none';
                btn.textContent = 'üìã Docs ‚ñº';
            }
        }

        async function _loadProjDocs(slug) {
            const inner = document.getElementById(`proj-docs-${slug}-inner`);
            try {
                const res  = await apiFetch(apiUrl(`/api/projects/${slug}/documents`));
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                const docs = data.documents || [];
                _projDocsLoaded[slug] = true;
                if (!docs.length) {
                    inner.innerHTML = '<p style="color:#9ca3af;text-align:center;padding:8px 0;">No analyzed documents in this project yet.</p>';
                    return;
                }
                const rows = docs.map((d, idx) => {
                    const brief    = _escHtml(d.brief_summary || '‚Äî');
                    const full     = d.full_summary || '';
                    const fullShort = _escHtml(full.length > 120 ? full.slice(0, 120) + '‚Ä¶' : full) || '‚Äî';
                    const fullFull  = _escHtml(full) || '‚Äî';
                    const date     = d.timestamp ? new Date(d.timestamp).toLocaleDateString() : '‚Äî';
                    const rowId    = `doc-row-${slug}-${d.doc_id}`;
                    const fullId   = `doc-full-${slug}-${d.doc_id}`;
                    return `
                    <tr id="${rowId}" style="border-bottom:1px solid #f3f4f6;">
                        <td style="padding:6px 8px;white-space:nowrap;color:#9ca3af;">${idx + 1}</td>
                        <td style="padding:6px 8px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${_escHtml(d.title)}">${_escHtml(d.title)}</td>
                        <td style="padding:6px 8px;white-space:nowrap;color:#6b7280;">${date}</td>
                        <td style="padding:6px 8px;max-width:180px;color:#374151;">${brief}</td>
                        <td style="padding:6px 8px;max-width:220px;color:#374151;">
                            <span id="${fullId}-short">${fullShort}</span>
                            <span id="${fullId}-full" style="display:none;">${fullFull}</span>
                            ${full.length > 120 ? `<button onclick="toggleDocFull('${fullId}')" id="${fullId}-btn"
                                style="margin-left:4px;font-size:11px;color:#3b82f6;background:none;border:none;cursor:pointer;padding:0;">more</button>` : ''}
                        </td>
                        <td style="padding:6px 8px;white-space:nowrap;">
                            <button onclick="confirmDeleteDoc('${slug}', ${d.doc_id}, ${_escHtml(JSON.stringify(d.title))})"
                                style="padding:3px 8px;border:1px solid #fca5a5;border-radius:5px;background:#fff;cursor:pointer;font-size:12px;color:#dc2626;">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>`;
                }).join('');
                inner.innerHTML = `
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;font-size:13px;">
                        <thead>
                            <tr style="background:#f9fafb;text-align:left;">
                                <th style="padding:5px 8px;font-weight:600;color:#374151;">#</th>
                                <th style="padding:5px 8px;font-weight:600;color:#374151;">Title</th>
                                <th style="padding:5px 8px;font-weight:600;color:#374151;">Date</th>
                                <th style="padding:5px 8px;font-weight:600;color:#374151;">Brief Summary</th>
                                <th style="padding:5px 8px;font-weight:600;color:#374151;">Full Summary</th>
                                <th style="padding:5px 8px;font-weight:600;color:#374151;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
            } catch (e) {
                inner.innerHTML = `<p style="color:#e74c3c;padding:8px 0;">Error: ${e.message}</p>`;
            }
        }

        function toggleDocFull(fullId) {
            const s   = document.getElementById(fullId + '-short');
            const f   = document.getElementById(fullId + '-full');
            const btn = document.getElementById(fullId + '-btn');
            const showing = f.style.display === '';
            s.style.display = showing ? '' : 'none';
            f.style.display = showing ? 'none' : '';
            btn.textContent = showing ? 'more' : 'less';
        }

        async function confirmDeleteDoc(slug, docId, title) {
            if (!confirm(`Delete "${title}" (Doc #${docId})?\n\nThis permanently removes the document from:\n‚Ä¢ Paperless-ngx\n‚Ä¢ The AI vector store\n‚Ä¢ The analyzer database\n\nThis cannot be undone.`)) return;
            try {
                const res  = await apiFetch(apiUrl(`/api/projects/${slug}/documents/${docId}`), {method: 'DELETE'});
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                const row = document.getElementById(`doc-row-${slug}-${docId}`);
                if (row) row.remove();
                delete _projDocsLoaded[slug];
                if (data.warnings && data.warnings.length) {
                    showToast('‚ö†Ô∏è Partial delete: ' + data.warnings.join('; '), 'warning', 7000);
                } else {
                    showToast(`‚úÖ Document #${docId} deleted`, 'success', 3000);
                }
                loadProjectsList();
            } catch (e) {
                alert('Delete failed: ' + e.message);
            }
        }

        function _escHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // ‚îÄ‚îÄ Upload tab state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _uploadMode = 'file';          // 'file' | 'url' | 'cloud'
        let _smartPendingPayload = null;   // holds {type, file|url, metadata, source} during preview
        let _fileListFiles = [];           // files returned by scan-url directory scan
        let _fileListAuthPayload = {};     // auth/source payload shared by all batch uploads

        function switchUploadMode(mode) {
            _uploadMode = mode;
            ['file', 'url', 'cloud', 'court'].forEach(m => {
                const btn = document.getElementById('umode-' + m);
                const pnl = document.getElementById('uinput-' + m);
                if (!btn || !pnl) return;   // court mode elements absent when feature disabled
                const active = m === mode;
                btn.style.background = active ? '#fff' : 'transparent';
                btn.style.borderBottom = active ? '3px solid #2563eb' : '3px solid transparent';
                btn.style.fontWeight = active ? '600' : '500';
                btn.style.color = active ? '#2563eb' : '#555';
                pnl.style.display = active ? '' : 'none';
            });
            // Hide the shared upload controls (project/smart-meta/submit) in court mode
            const shared = document.getElementById('upload-shared-controls');
            if (shared) shared.style.display = mode === 'court' ? 'none' : '';
            document.getElementById('upload-status').innerHTML = '';
            cancelSmartPreview();
            // Initialise court sub-tab on first switch
            if (mode === 'court') {
                if (typeof loadCourtCredStatus === 'function') loadCourtCredStatus();
                if (typeof loadCourtHistory === 'function') loadCourtHistory();
            }
        }

        function updateAuthFields() {
            const t = document.getElementById('upload-auth-type').value;
            document.getElementById('upload-auth-basic').style.display = t === 'basic' ? '' : 'none';
            document.getElementById('upload-auth-token').style.display = t === 'token' ? '' : 'none';
        }

        function handleDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (!files.length) return;
            const input = document.getElementById('upload-file-input');
            const dt = new DataTransfer();
            dt.items.add(files[0]);
            input.files = dt.files;
            document.getElementById('upload-file-name').textContent = files[0].name;
            const dz = document.getElementById('upload-dropzone');
            dz.style.background = '';
            dz.style.borderColor = '#2563eb';
        }

        function setUploadStatus(html) {
            document.getElementById('upload-status').innerHTML = html;
        }

        function cancelSmartPreview() {
            _smartPendingPayload = null;
            document.getElementById('upload-meta-preview').style.display = 'none';
            document.getElementById('upload-meta-content').innerHTML = '';
        }

        async function detectAndTransform(url) {
            const res = await apiFetch(apiUrl('/api/upload/transform-url'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url})
            });
            return await res.json();
        }

        async function _scanUrl(url, authPayload) {
            try {
                const res = await apiFetch(apiUrl('/api/upload/scan-url'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(Object.assign({url}, authPayload)),
                });
                return await res.json();
            } catch(e) {
                return {error: e.message};
            }
        }

        function _fmtSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return Math.round(bytes / 1024) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function _showFileList(files, authPayload) {
            _fileListFiles = files;
            _fileListAuthPayload = authPayload;

            const extColor = {
                '.pdf':'#dc2626','.docx':'#2563eb','.doc':'#2563eb','.odt':'#2563eb',
                '.png':'#16a34a','.jpg':'#16a34a','.jpeg':'#16a34a','.gif':'#16a34a',
                '.tiff':'#16a34a','.tif':'#16a34a','.webp':'#16a34a','.heic':'#16a34a',
                '.xlsx':'#15803d','.xls':'#15803d','.ods':'#15803d','.csv':'#15803d',
                '.pptx':'#d97706','.ppt':'#d97706','.txt':'#6b7280','.eml':'#9333ea',
            };
            const rows = files.map(function(f, i) {
                const col = extColor[f.ext] || '#6b7280';
                const badge = f.ext.slice(1).toUpperCase();
                const sz = _fmtSize(f.size_bytes);
                return '<div style="display:flex;align-items:center;gap:8px;padding:7px 12px;border-bottom:1px solid #f0f0f0;" id="flist-row-' + i + '">'
                    + '<input type="checkbox" class="flist-cb" data-idx="' + i + '" checked style="width:13px;height:13px;flex-shrink:0;">'
                    + '<span style="background:' + col + ';color:#fff;font-size:10px;font-weight:700;padding:1px 5px;border-radius:3px;min-width:34px;text-align:center;flex-shrink:0;">' + badge + '</span>'
                    + '<span style="flex:1;font-size:13px;color:#111;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + f.filename + '">' + f.filename + '</span>'
                    + (sz ? '<span style="font-size:11px;color:#9ca3af;white-space:nowrap;">' + sz + '</span>' : '')
                    + '<span id="flist-st-' + i + '" style="font-size:12px;width:20px;text-align:center;flex-shrink:0;"></span>'
                    + '</div>';
            }).join('');

            document.getElementById('upload-filelist-table').innerHTML = rows;
            document.getElementById('upload-filelist-count').textContent = files.length;
            document.getElementById('upload-filelist-selectall').checked = true;
            document.getElementById('upload-filelist').style.display = '';
            document.getElementById('upload-filelist-progress').textContent = '';
            setUploadStatus('');
            _updateFileListBtn();
        }

        function _updateFileListBtn() {
            const n = document.querySelectorAll('.flist-cb:checked').length;
            const btn = document.getElementById('upload-filelist-btn');
            btn.textContent = 'Upload ' + n + ' file' + (n !== 1 ? 's' : '');
            btn.disabled = n === 0;
        }

        function toggleSelectAllFiles(checked) {
            document.querySelectorAll('.flist-cb').forEach(function(cb) { cb.checked = checked; });
            _updateFileListBtn();
        }

        function cancelFileList() {
            _fileListFiles = [];
            _fileListAuthPayload = {};
            document.getElementById('upload-filelist').style.display = 'none';
            setUploadStatus('');
        }

        async function uploadSelectedFiles() {
            const indices = [];
            document.querySelectorAll('.flist-cb:checked').forEach(function(cb) {
                indices.push(parseInt(cb.getAttribute('data-idx')));
            });
            if (!indices.length) return;

            const btn = document.getElementById('upload-filelist-btn');
            const prog = document.getElementById('upload-filelist-progress');
            btn.disabled = true;

            let done = 0, failed = 0;
            for (let i = 0; i < indices.length; i++) {
                const idx = indices[i];
                const f = _fileListFiles[idx];
                const stEl = document.getElementById('flist-st-' + idx);
                stEl.textContent = '‚è≥';
                prog.textContent = (i + 1) + '/' + indices.length + ' uploading‚Ä¶';
                try {
                    const payload = Object.assign({}, _fileListAuthPayload, {url: f.url});
                    const res = await apiFetch(apiUrl('/api/upload/from-url'), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload),
                    });
                    const data = await res.json();
                    if (data.success) { stEl.textContent = '‚úÖ'; done++; }
                    else { stEl.title = data.error || 'failed'; stEl.textContent = '‚ùå'; failed++; }
                } catch(e) {
                    stEl.title = e.message; stEl.textContent = '‚ùå'; failed++;
                }
            }
            prog.textContent = done + ' uploaded' + (failed ? ', ' + failed + ' failed' : '') + ' ‚Äî ‚è≥ analyzer picks up in ~30 s';
            btn.disabled = false;
            if (done > 0) loadImportHistory();
        }

        async function doUpload() {
            const btn = document.getElementById('upload-submit-btn');
            const smartMeta = document.getElementById('upload-smart-meta').checked;
            btn.disabled = true;
            cancelSmartPreview();

            try {
                if (_uploadMode === 'file') {
                    await _doFileUpload(smartMeta);
                } else {
                    await _doUrlUpload(smartMeta);
                }
            } finally {
                btn.disabled = false;
            }
        }

        async function _doFileUpload(smartMeta) {
            const fileInput = document.getElementById('upload-file-input');
            if (!fileInput.files || !fileInput.files.length) {
                setUploadStatus('<div style="color:#e74c3c;">Please select a file first.</div>');
                return;
            }
            const file = fileInput.files[0];

            if (smartMeta) {
                // Step 1: analyze
                setUploadStatus('<div style="color:#2563eb;">üîç Analyzing document with AI‚Ä¶</div>');
                const fd = new FormData();
                fd.append('file', file);
                const res = await apiFetch(apiUrl('/api/upload/analyze'), {method: 'POST', body: fd});
                const meta = await res.json();
                if (meta.error) {
                    setUploadStatus('<div style="color:#e74c3c;">‚ùå Analysis failed: ' + meta.error + '</div>');
                    return;
                }
                _smartPendingPayload = {type: 'file', file, metadata: meta};
                showSmartPreview(meta);
                setUploadStatus('');
            } else {
                setUploadStatus('<div style="color:#2563eb;">‚è≥ Uploading‚Ä¶</div>');
                const fd = new FormData();
                fd.append('file', file);
                const chosenProject = document.getElementById('upload-project-select')?.value;
                if (chosenProject) fd.append('project_slug', chosenProject);
                const res = await apiFetch(apiUrl('/api/upload/submit'), {method: 'POST', body: fd});
                const data = await res.json();
                if (data.success) {
                    setUploadStatus('<div style="color:#16a34a; padding:10px; background:#dcfce7; border-radius:6px;">‚úÖ Uploaded: <strong>' + (data.title || file.name) + '</strong><br><span style="font-size:12px; color:#6b7280;">‚è≥ Analyzer will process it on the next poll (~30 s)</span></div>');
                    fileInput.value = '';
                    document.getElementById('upload-file-name').textContent = '';
                    loadImportHistory();
                } else {
                    setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + (data.error || 'Upload failed') + '</div>');
                }
            }
        }

        async function _doUrlUpload(smartMeta) {
            const rawUrl = (_uploadMode === 'cloud'
                ? document.getElementById('upload-cloud-input')
                : document.getElementById('upload-url-input')).value.trim();

            if (!rawUrl) {
                setUploadStatus('<div style="color:#e74c3c;">Please enter a URL.</div>');
                return;
            }

            // Step 1: transform cloud / share links to direct download URLs
            let directUrl = rawUrl;
            let service = 'url';
            try {
                setUploadStatus('<div style="color:#2563eb;">üîó Resolving URL‚Ä¶</div>');
                const tx = await detectAndTransform(rawUrl);
                if (tx.error) throw new Error(tx.error);
                directUrl = tx.direct_url;
                service = tx.service || 'url';
                if (_uploadMode === 'cloud') {
                    const det = document.getElementById('upload-cloud-detected');
                    det.textContent = 'Detected: ' + service.replace('_', ' ');
                }
            } catch (e) {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå URL transform error: ' + e.message + '</div>');
                return;
            }

            const authType = _uploadMode === 'url' ? document.getElementById('upload-auth-type').value : 'none';
            const chosenProject = document.getElementById('upload-project-select')?.value || undefined;
            const urlPayload = {
                url: directUrl,
                source: service,
                auth_type: authType,
                username: authType === 'basic' ? document.getElementById('upload-auth-user').value : undefined,
                password: authType === 'basic' ? document.getElementById('upload-auth-pass').value : undefined,
                token: authType === 'token' ? document.getElementById('upload-auth-token-val').value : undefined,
                project_slug: chosenProject,
            };

            // Step 2: scan ‚Äî single file or a directory listing?
            setUploadStatus('<div style="color:#2563eb;">üîç Scanning URL‚Ä¶</div>');
            const scan = await _scanUrl(directUrl, urlPayload);
            if (scan.error) {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + scan.error + '</div>');
                return;
            }

            if (scan.type === 'directory') {
                // Show file-picker panel; user chooses which files to upload
                _showFileList(scan.files, urlPayload);
                return;
            }

            // Single file ‚Äî proceed to direct upload
            if (smartMeta) {
                setUploadStatus('<div style="color:#f59e0b; padding:8px 12px; background:#fef3c7; border-radius:6px;">‚ö†Ô∏è Smart Metadata is not available for URL uploads ‚Äî uploading directly.</div>');
                await new Promise(r => setTimeout(r, 1500));
            }

            setUploadStatus('<div style="color:#2563eb;">‚è≥ Downloading and uploading‚Ä¶</div>');
            const res = await apiFetch(apiUrl('/api/upload/from-url'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(urlPayload)
            });
            const data = await res.json();
            if (data.success) {
                setUploadStatus('<div style="color:#16a34a; padding:10px; background:#dcfce7; border-radius:6px;">‚úÖ Uploaded: <strong>' + (data.title || directUrl) + '</strong><br><span style="font-size:12px; color:#6b7280;">‚è≥ Analyzer will process it on the next poll (~30 s)</span></div>');
                if (_uploadMode === 'cloud') document.getElementById('upload-cloud-input').value = '';
                if (_uploadMode === 'url') document.getElementById('upload-url-input').value = '';
                loadImportHistory();
            } else {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + (data.error || 'Upload failed') + '</div>');
            }
        }

        function showSmartPreview(meta) {
            const top = meta.project_suggestions?.[0];
            const html = `
                <table style="width:100%; border-collapse:collapse; font-size:13px;">
                    <tr><td style="padding:4px 8px; color:#6b7280; white-space:nowrap; width:130px;">Title</td><td style="padding:4px 8px; font-weight:600;">${meta.suggested_title || '‚Äî'}</td></tr>
                    <tr><td style="padding:4px 8px; color:#6b7280;">Type</td><td style="padding:4px 8px;">${meta.document_type || '‚Äî'}</td></tr>
                    <tr><td style="padding:4px 8px; color:#6b7280;">Tags</td><td style="padding:4px 8px;">${(meta.suggested_tags || []).join(', ') || '‚Äî'}</td></tr>
                    <tr><td style="padding:4px 8px; color:#6b7280;">Project</td><td style="padding:4px 8px;">${top ? top.name + ' (' + Math.round((top.confidence||0)*100) + '%)' : '‚Äî'}</td></tr>
                </table>
                ${top ? '<input type="hidden" id="smart-project-slug" value="' + top.slug + '">' : ''}
            `;
            document.getElementById('upload-meta-content').innerHTML = html;
            document.getElementById('upload-meta-preview').style.display = '';
        }

        async function confirmSmartUpload() {
            if (!_smartPendingPayload) return;
            const {type, file, metadata} = _smartPendingPayload;
            // User's explicit dropdown choice beats AI suggestion
            const dropdownSlug = document.getElementById('upload-project-select')?.value;
            const aiSlug = document.getElementById('smart-project-slug')?.value;
            const projectSlug = dropdownSlug || aiSlug;
            cancelSmartPreview();
            setUploadStatus('<div style="color:#2563eb;">‚è≥ Uploading with AI metadata‚Ä¶</div>');

            const fd = new FormData();
            fd.append('file', file);
            if (projectSlug) fd.append('project_slug', projectSlug);
            fd.append('metadata', JSON.stringify(metadata));
            const res = await apiFetch(apiUrl('/api/upload/submit'), {method: 'POST', body: fd});
            const data = await res.json();
            if (data.success) {
                setUploadStatus('<div style="color:#16a34a; padding:10px; background:#dcfce7; border-radius:6px;">‚úÖ Uploaded: <strong>' + (data.title || file.name) + '</strong><br><span style="font-size:12px; color:#6b7280;">‚è≥ Analyzer will process it on the next poll (~30 s)</span></div>');
                document.getElementById('upload-file-input').value = '';
                document.getElementById('upload-file-name').textContent = '';
                loadImportHistory();
            } else {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + (data.error || 'Upload failed') + '</div>');
            }
        }

        async function loadUploadProjects() {
            const sel = document.getElementById('upload-project-select');
            if (!sel) return;
            try {
                const res = await apiFetch(apiUrl('/api/projects'));
                const data = await res.json();
                const projects = data.projects || [];
                // Keep first option (None), rebuild the rest
                sel.innerHTML = '<option value="">None (auto-assign by analyzer)</option>';
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.slug;
                    opt.textContent = p.name + (p.document_count != null ? ' (' + p.document_count + ' docs)' : '');
                    sel.appendChild(opt);
                });
            } catch (e) {
                // Non-critical ‚Äî silently ignore if projects can't be loaded
            }
        }

        async function loadImportHistory() {
            const body = document.getElementById('upload-history-body');
            if (!body) return;
            try {
                const res = await apiFetch(apiUrl('/api/upload/history'));
                const data = await res.json();
                const rows = data.history || [];
                if (!rows.length) {
                    body.innerHTML = '<div style="padding:20px; color:#9ca3af; font-size:13px; text-align:center;">No imports yet.</div>';
                    return;
                }
                const badgeColors = {
                    file: '#6366f1', url: '#0284c7',
                    google_drive: '#16a34a', dropbox: '#2563eb', onedrive: '#0ea5e9'
                };
                const rows_html = rows.map(r => {
                    const color = badgeColors[r.source] || '#6b7280';
                    const badge = `<span style="background:${color}; color:#fff; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:600;">${(r.source || 'unknown').replace('_', '\u00a0')}</span>`;
                    const statusIcon = r.status === 'uploaded' ? '‚úÖ' : '‚ùå';
                    const ts = r.created_at ? r.created_at.replace('T', ' ').slice(0, 16) : '';
                    return `<tr style="border-top:1px solid #f3f4f6;">
                        <td style="padding:8px 12px; font-size:13px; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.filename || r.original_url || '‚Äî'}</td>
                        <td style="padding:8px 12px;">${badge}</td>
                        <td style="padding:8px 12px; font-size:12px; color:#6b7280; white-space:nowrap;">${ts}</td>
                        <td style="padding:8px 12px; font-size:13px;">${statusIcon} ${r.status}</td>
                    </tr>`;
                }).join('');
                body.innerHTML = `<table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#f9fafb;">
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Filename / URL</th>
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Source</th>
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Uploaded</th>
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Status</th>
                    </tr></thead>
                    <tbody>${rows_html}</tbody>
                </table>`;
            } catch (e) {
                body.innerHTML = '<div style="padding:12px; color:#e74c3c; font-size:13px;">Failed to load history.</div>';
            }
        }

        function refresh() {
            fetchStatus();
            fetchRecent();
            fetchProfiles();
            refreshVectorTypes();
            loadAIConfig();
            // Refresh import history only when the upload tab is visible
            if (document.getElementById('tab-upload')?.classList.contains('active')) {
                loadImportHistory();
            }
            // Vector store documents are loaded lazily when the sub-tab is opened;
            // no need to reload 700+ doc rows on every 10-second poll
        }

        // Reprocess all documents
        async function reprocessAll() {
            if (!confirm('Reset state and reprocess ALL documents? This will analyze every document on the next poll cycle.')) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/reprocess'), { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    refresh();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to reprocess: ' + error.message);
            }
        }

        // Reprocess specific document
        async function reprocessDocument() {
            const docId = document.getElementById('reprocess-doc-id').value;
            if (!docId) {
                alert('Please enter a document ID');
                return;
            }

            try {
                const response = await apiFetch(apiUrl(`/api/reprocess/${docId}`), { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    document.getElementById('reprocess-doc-id').value = '';
                    refresh();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to reprocess: ' + error.message);
            }
        }

        async function runReconcile() {
            const btn = document.getElementById('reconcile-btn');
            const result = document.getElementById('reconcile-result');
            btn.disabled = true;
            btn.textContent = '‚è≥ Reconciling...';
            result.style.display = 'none';
            try {
                const r = await apiFetch(apiUrl('/api/reconcile'), { method: 'POST' });
                const d = await r.json();
                if (!r.ok) throw new Error(d.error || 'Failed');
                const cleaned = d.db_orphans_removed + d.chroma_orphans_removed > 0;
                result.style.background = cleaned ? '#f0fdf4' : '#f8fafc';
                result.style.border = `1px solid ${cleaned ? '#86efac' : '#e2e8f0'}`;
                result.style.color = cleaned ? '#166534' : '#475569';
                result.innerHTML = `
                    <strong>${cleaned ? '‚úÖ Reconcile complete' : '‚ÑπÔ∏è Everything looks clean'}</strong><br>
                    üìÑ Paperless documents: <strong>${d.paperless_total}</strong><br>
                    üóëÔ∏è Stale DB records removed: <strong>${d.db_orphans_removed}</strong><br>
                    üóëÔ∏è Stale embeddings removed: <strong>${d.chroma_orphans_removed}</strong><br>
                    ‚è≥ Not yet analyzed: <strong>${d.not_analyzed}</strong><br>
                    ‚è≥ Not yet embedded: <strong>${d.not_embedded}</strong>
                `;
                result.style.display = 'block';
            } catch(e) {
                result.style.background = '#fef2f2';
                result.style.border = '1px solid #fca5a5';
                result.style.color = '#991b1b';
                result.innerHTML = `<strong>‚ùå Error:</strong> ${e.message}`;
                result.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÅ Reconcile Now';
            }
        }

        // Vector store management functions
        async function refreshVectorTypes() {
            try {
                const response = await apiFetch(apiUrl('/api/vector/types'));
                const data = await response.json();

                if (!data.success) {
                    console.error('Failed to load document types');
                    return;
                }

                // Update dropdown
                const dropdown = document.getElementById('document-type-filter');
                const currentSelection = dropdown.value;

                dropdown.innerHTML = '<option value="all">All Documents</option>';
                data.document_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    const count = data.by_type[type] || 0;
                    option.textContent = `${type} (${count})`;
                    dropdown.appendChild(option);
                });

                // Restore selection if it still exists
                if (data.document_types.includes(currentSelection)) {
                    dropdown.value = currentSelection;
                } else {
                    dropdown.value = 'all';
                }

                // Update breakdown text
                const breakdownSpan = document.getElementById('type-breakdown');
                const totalDocs = Object.values(data.by_type).reduce((sum, count) => sum + count, 0);
                breakdownSpan.textContent = `${totalDocs} total documents`;

            } catch (error) {
                console.error('Failed to refresh document types:', error);
            }
        }

        // Load all vector store documents grouped by type
        async function loadVectorStoreDocuments() {
            vsLoaded = true;
            const container = document.getElementById('vector-store-manager');
            if (container) container.innerHTML = '<div class="loading">Loading vector store documents‚Ä¶</div>';
            try {
                const response = await apiFetch(apiUrl('/api/vector/documents'));
                const data = await response.json();

                if (!data.success) {
                    if (container) container.innerHTML = '<p style="color:#e74c3c;">Failed to load vector store documents</p>';
                    return;
                }

                if (!data.documents || Object.keys(data.documents).length === 0) {
                    if (container) container.innerHTML = '<p style="color:#999;">No documents in vector store yet.</p>';
                    vsAllDocs = [];
                    vsFiltered = [];
                    renderVsPage();
                    return;
                }

                // Flatten into [{title, doc_id, type}, ‚Ä¶]
                vsAllDocs = [];
                Object.entries(data.documents).forEach(([type, docs]) => {
                    docs.forEach(d => vsAllDocs.push({title: d.title, doc_id: d.doc_id, type}));
                });
                // Preserve any active search filter
                filterVsDocs();

            } catch (error) {
                console.error('Failed to load vector store documents:', error);
                if (container) container.innerHTML = '<p style="color:#e74c3c;">Failed to load vector store documents</p>';
            }
        }

        // Delete individual document from vector store
        async function deleteIndividualDocument(docId, docTitle) {
            if (!confirm(`Delete "${docTitle}" from vector store?\n\nThis will remove the embedding but NOT delete the original document from Paperless.`)) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/vector/delete-document'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ doc_id: docId })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    vsLoaded = false;
                    loadVectorStoreDocuments();
                    fetchStatus();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to delete document: ' + error.message);
            }
        }

        async function confirmDeleteType(documentType) {
            if (!confirm(`Delete all "${documentType}" documents from vector store?\n\nThis will remove embeddings but NOT delete the original documents from Paperless.`)) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/vector/delete-by-type'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ document_type: documentType })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    refreshVectorTypes();
                    vsLoaded = false;
                    loadVectorStoreDocuments();
                    fetchStatus();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to delete documents: ' + error.message);
            }
        }

        async function confirmClearVectorStore() {
            if (!confirm('Clear ALL embeddings from vector store?\n\nThis will NOT delete the original documents from Paperless, only the vector embeddings. You can re-embed documents by reprocessing them.')) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/vector/clear'), { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    refreshVectorTypes();
                    vsLoaded = false;
                    loadVectorStoreDocuments();
                    fetchStatus();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to clear vector store: ' + error.message);
            }
        }

        async function triggerReembedStale() {
            const btn = document.getElementById('btn-reembed-stale');
            const orig = btn ? btn.textContent : '';
            if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Checking‚Ä¶'; }
            try {
                const response = await apiFetch(apiUrl('/api/vector/reembed-stale'), { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to start stale check: ' + error.message);
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = orig; }
            }
        }

        async function processUnanalyzed() {
            const btn = document.getElementById('btn-process-unanalyzed');
            const orig = btn ? btn.textContent : '';
            if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Scanning‚Ä¶'; }
            try {
                const response = await apiFetch(apiUrl('/api/scan/process-unanalyzed'), { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = orig; }
            }
        }

        // Update poll interval setting
        async function updatePollInterval() {
            const interval = document.getElementById('poll-interval').value;
            const resultDiv = document.getElementById('settings-result');

            if (!interval || interval < 5 || interval > 3600) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fff3cd';
                resultDiv.style.color = '#856404';
                resultDiv.textContent = '‚ö†Ô∏è Poll interval must be between 5 and 3600 seconds';
                return;
            }

            if (!confirm(`Update poll interval to ${interval} seconds?\n\nThis will require restarting the analyzer container to take effect.`)) {
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üîÑ Updating poll interval...';

            try {
                const response = await apiFetch(apiUrl('/api/settings/poll-interval'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ interval: parseInt(interval) })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.innerHTML = '‚úÖ ' + data.message.replace(/\n/g, '<br>');
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = '‚úó ' + (data.error || 'Unknown error');
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Failed to update: ' + error.message;
            }
        }

        // Refresh logs
        async function refreshLogs() {
            try {
                const response = await apiFetch(apiUrl('/api/logs?limit=100'));
                const data = await response.json();

                const logsViewer = document.getElementById('logs-viewer');

                if (data.logs.length === 0) {
                    logsViewer.innerHTML = '<div class="empty-state">No logs available</div>';
                    return;
                }

                logsViewer.innerHTML = data.logs.filter(line => line.trim()).map(line => {
                    let className = 'log-line';
                    if (line.includes('ERROR')) className += ' error';
                    else if (line.includes('WARNING') || line.includes('WARN')) className += ' warning';
                    else if (line.includes('INFO')) className += ' info';

                    return `<div class="${className}">${escapeHtml(line)}</div>`;
                }).join('');

                // Auto-scroll to bottom
                logsViewer.scrollTop = logsViewer.scrollHeight;
            } catch (error) {
                console.error('Failed to fetch logs:', error);
                document.getElementById('logs-viewer').innerHTML = '<div class="empty-state">Failed to load logs</div>';
            }
        }

        // ‚îÄ‚îÄ Search & Analysis tab ‚Äî state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var _saDocs = [];
        var _saSortField = 'doc_id';
        var _saSortDir = 'asc';
        var _saLoaded = false;
        var _saFiltered = [];   // current filtered+sorted result set
        var _saPage = 0;        // current page (0-based)
        var _saPerPage = 25;    // items per page; 0 = all

        // Load (or reload) all docs for current project into the table
        async function loadSearchTab() {
            if (_saLoaded) return;
            const tbody = document.getElementById('sa-tbody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#9ca3af;">Loading‚Ä¶</td></tr>';
            try {
                const slug = document.getElementById('project-selector').value || 'default';
                const resp = await apiFetch(apiUrl(`/api/projects/${encodeURIComponent(slug)}/documents`));
                const data = await resp.json();
                _saDocs = data.documents || [];
                _saLoaded = true;
                saApplyFilters();
            } catch (err) {
                console.error('loadSearchTab error:', err);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#e74c3c;">Failed to load documents</td></tr>';
            }
        }

        // Apply all active filters + sort, reset to page 0, then render
        function saApplyFilters() {
            const global  = (document.getElementById('sa-global')?.value || '').toLowerCase();
            const fDocId  = (document.getElementById('sa-filter-doc_id')?.value || '').toLowerCase();
            const fTitle  = (document.getElementById('sa-filter-title')?.value || '').toLowerCase();
            const fDate   = (document.getElementById('sa-filter-date')?.value || '').toLowerCase();
            const rMin    = parseFloat(document.getElementById('sa-filter-risk-min')?.value) || null;
            const rMax    = parseFloat(document.getElementById('sa-filter-risk-max')?.value) || null;
            const fAnom   = (document.getElementById('sa-filter-anomalies')?.value || '').toLowerCase();
            const fSum    = (document.getElementById('sa-filter-summary')?.value || '').toLowerCase();
            const anomOnly= document.getElementById('sa-anomalies-only')?.checked || false;

            // Read sort from dropdown
            const sortSel = document.getElementById('sa-sort-select');
            if (sortSel) _saSortField = sortSel.value;

            let docs = _saDocs.filter(d => {
                const title    = (d.title || '').toLowerCase();
                const docId    = String(d.doc_id || '');
                const dateStr  = d.timestamp ? new Date(d.timestamp).toLocaleString().toLowerCase() : '';
                const risk     = d.risk_score || 0;
                const anomStr  = (d.anomalies || []).join(' ').toLowerCase();
                const brief    = (d.brief_summary || '').toLowerCase();
                const full     = (d.full_summary || '').toLowerCase();
                const summaryAll = brief + ' ' + full;

                if (anomOnly && (!d.anomalies || d.anomalies.length === 0)) return false;
                if (rMin !== null && risk < rMin) return false;
                if (rMax !== null && risk > rMax) return false;
                if (fDocId  && !docId.includes(fDocId))     return false;
                if (fTitle  && !title.includes(fTitle))     return false;
                if (fDate   && !dateStr.includes(fDate))    return false;
                if (fAnom   && !anomStr.includes(fAnom))    return false;
                if (fSum    && !summaryAll.includes(fSum))  return false;
                if (global  && !(title + ' ' + docId + ' ' + anomStr + ' ' + summaryAll).includes(global)) return false;
                return true;
            });

            // Sort
            docs.sort((a, b) => {
                let av, bv;
                if (_saSortField === 'doc_id')         { av = a.doc_id || 0;               bv = b.doc_id || 0; }
                else if (_saSortField === 'title')      { av = (a.title||'').toLowerCase(); bv = (b.title||'').toLowerCase(); }
                else if (_saSortField === 'timestamp')  { av = a.timestamp || '';           bv = b.timestamp || ''; }
                else if (_saSortField === 'risk_score') { av = a.risk_score || 0;           bv = b.risk_score || 0; }
                else if (_saSortField === 'anomalies')  { av = (a.anomalies||[]).length;    bv = (b.anomalies||[]).length; }
                else { av = 0; bv = 0; }
                if (av < bv) return _saSortDir === 'asc' ? -1 : 1;
                if (av > bv) return _saSortDir === 'asc' ?  1 : -1;
                return 0;
            });

            updateSaSortIndicators();
            _saFiltered = docs;
            _saPage = 0;
            saRenderPage();
        }

        // Render the current page from _saFiltered
        function saRenderPage() {
            const total = _saFiltered.length;
            let pageDocs;
            if (_saPerPage === 0) {
                pageDocs = _saFiltered;
            } else {
                const start = _saPage * _saPerPage;
                pageDocs = _saFiltered.slice(start, start + _saPerPage);
            }
            renderSearchTable(pageDocs);
            saRenderPagination(total);

            const cnt = document.getElementById('sa-count');
            if (cnt) {
                if (total === 0) {
                    cnt.textContent = `0 of ${_saDocs.length} doc${_saDocs.length !== 1 ? 's' : ''}`;
                } else if (_saPerPage === 0) {
                    cnt.textContent = `${total} of ${_saDocs.length} doc${_saDocs.length !== 1 ? 's' : ''}`;
                } else {
                    const s = _saPage * _saPerPage + 1;
                    const e = Math.min((_saPage + 1) * _saPerPage, total);
                    cnt.textContent = `${s}‚Äì${e} of ${total} (${_saDocs.length} total)`;
                }
            }
        }

        // Render pagination bar
        function saRenderPagination(total) {
            const pag = document.getElementById('sa-pagination');
            const info = document.getElementById('sa-page-info');
            const controls = document.getElementById('sa-page-controls');
            if (!pag) return;

            if (total === 0 || _saPerPage === 0) {
                pag.style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(total / _saPerPage);
            pag.style.display = 'flex';
            const s = _saPage * _saPerPage + 1;
            const e = Math.min((_saPage + 1) * _saPerPage, total);
            if (info) info.textContent = `Showing ${s}‚Äì${e} of ${total} documents`;

            // Build page buttons
            const btnBase = 'padding:4px 9px; border:1px solid #d1d5db; border-radius:4px; cursor:pointer; font-size:12px; background:#fff; color:#374151;';
            const btnActive = 'padding:4px 9px; border:1px solid #3b82f6; border-radius:4px; cursor:pointer; font-size:12px; background:#3b82f6; color:#fff; font-weight:600;';
            const btnDis = 'padding:4px 9px; border:1px solid #e5e7eb; border-radius:4px; font-size:12px; background:#f9fafb; color:#9ca3af; cursor:default;';

            let pages = [];
            if (totalPages <= 9) {
                for (let i = 0; i < totalPages; i++) pages.push(i);
            } else {
                pages.push(0);
                if (_saPage > 3) pages.push('‚Ä¶');
                for (let i = Math.max(1, _saPage - 2); i <= Math.min(totalPages - 2, _saPage + 2); i++) pages.push(i);
                if (_saPage < totalPages - 4) pages.push('‚Ä¶');
                pages.push(totalPages - 1);
            }

            let html = `<button onclick="saGoPage(${_saPage - 1})" ${_saPage === 0 ? 'disabled' : ''} style="${_saPage === 0 ? btnDis : btnBase}">‚Äπ Prev</button>`;
            pages.forEach(p => {
                if (p === '‚Ä¶') {
                    html += `<span style="padding:4px 6px; font-size:12px; color:#9ca3af; align-self:center;">‚Ä¶</span>`;
                } else {
                    html += `<button onclick="saGoPage(${p})" style="${p === _saPage ? btnActive : btnBase}">${p + 1}</button>`;
                }
            });
            html += `<button onclick="saGoPage(${_saPage + 1})" ${_saPage >= totalPages - 1 ? 'disabled' : ''} style="${_saPage >= totalPages - 1 ? btnDis : btnBase}">Next ‚Ä∫</button>`;
            if (controls) controls.innerHTML = html;
        }

        // Navigate to a specific page
        function saGoPage(p) {
            const totalPages = _saPerPage === 0 ? 1 : Math.ceil(_saFiltered.length / _saPerPage);
            if (p < 0 || p >= totalPages) return;
            _saPage = p;
            saRenderPage();
            // Scroll table back to top
            const wrap = document.querySelector('#tab-search [style*="overflow-x"]');
            if (wrap) wrap.scrollTop = 0;
        }

        // Change items per page
        function saSetPerPage(val) {
            _saPerPage = parseInt(val) || 0;
            _saPage = 0;
            saRenderPage();
        }

        // Change sort field; toggle direction if same field clicked again
        function saSortBy(field) {
            if (_saSortField === field) {
                _saSortDir = _saSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                _saSortField = field;
                _saSortDir = 'asc';
            }
            // Sync dropdown
            const sel = document.getElementById('sa-sort-select');
            if (sel && ['doc_id','title','timestamp','risk_score'].includes(field)) sel.value = field;
            saApplyFilters();
        }

        // Toggle asc/desc via the direction button
        function saToggleSortDir() {
            _saSortDir = _saSortDir === 'asc' ? 'desc' : 'asc';
            saApplyFilters();
        }

        // Update ‚ñ≤/‚ñº indicators on column headers
        function updateSaSortIndicators() {
            const fields = ['doc_id','title','timestamp','risk_score','anomalies'];
            fields.forEach(f => {
                const el = document.getElementById('sa-sort-ind-' + f);
                if (!el) return;
                if (f === _saSortField) {
                    el.textContent = _saSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
                } else {
                    el.textContent = '';
                }
            });
            // Sync dir button label
            const btn = document.getElementById('sa-sort-dir-btn');
            if (btn) btn.textContent = _saSortDir === 'asc' ? '‚ñ≤ Asc' : '‚ñº Desc';
        }

        // Render filtered+sorted docs into the table body
        function renderSearchTable(docs) {
            const tbody = document.getElementById('sa-tbody');
            if (!docs.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#9ca3af;">' +
                    (_saLoaded ? 'No documents match the current filters.' : 'Loading‚Ä¶') + '</td></tr>';
                return;
            }
            tbody.innerHTML = docs.map((d, idx) => {
                const risk = d.risk_score || 0;
                const riskColor = risk >= 70 ? '#dc2626' : risk >= 40 ? '#d97706' : '#16a34a';
                const anomList = (d.anomalies || []);
                const anomHtml = anomList.length
                    ? anomList.map(a => `<span style="display:inline-block;background:#fef2f2;color:#991b1b;border:1px solid #fecaca;border-radius:3px;padding:1px 5px;margin:1px;font-size:11px;">${_escHtml(a)}</span>`).join('')
                    : '<span style="color:#9ca3af;font-size:12px;">‚Äî</span>';

                const brief = d.brief_summary || '';
                const full  = d.full_summary  || '';
                const fullId = 'sa-full-' + idx;
                let summaryHtml;
                if (!brief) {
                    summaryHtml = '<span style="color:#9ca3af;font-size:12px;">‚Äî</span>';
                } else if (!full) {
                    summaryHtml = `<span style="font-size:12px;">${_escHtml(brief)}</span>`;
                } else {
                    const briefTrunc = brief.length > 80 ? brief.slice(0, 80) + '‚Ä¶' : brief;
                    summaryHtml = `<span style="font-size:12px;">${_escHtml(briefTrunc)}</span>` +
                        ` <span id="${fullId}" style="display:none;font-size:12px;color:#374151;">${_escHtml(full)}</span>` +
                        ` <button onclick="toggleSaFull('${fullId}')" style="font-size:11px;padding:1px 5px;border:1px solid #d1d5db;border-radius:3px;background:#f9fafb;cursor:pointer;margin-left:3px;" id="${fullId}-btn">more</button>`;
                }

                const dateStr = d.timestamp ? new Date(d.timestamp).toLocaleDateString() : '‚Äî';
                const rowBg = anomList.length ? '#fff8f8' : (idx % 2 === 0 ? '#fff' : '#f9fafb');
                return `<tr style="background:${rowBg}; border-bottom:1px solid #e5e7eb;">
                    <td style="padding:7px 8px; white-space:nowrap; font-size:12px; text-align:center;">
                        <a href="https://www.voipguru.org/paperless/documents/${d.doc_id}" target="_blank" style="color:#3b82f6;text-decoration:none;">#${d.doc_id}</a>
                    </td>
                    <td style="padding:7px 10px; font-size:13px; word-wrap:break-word; overflow-wrap:break-word;">${_escHtml(d.title || '‚Äî')}</td>
                    <td style="padding:7px 8px; white-space:nowrap; font-size:12px; color:#6b7280;">${dateStr}</td>
                    <td style="padding:7px 8px; white-space:nowrap; font-weight:600; color:${riskColor}; font-size:13px; text-align:center;">${risk}%</td>
                    <td style="padding:7px 10px; word-wrap:break-word; overflow-wrap:break-word;">${anomHtml}</td>
                    <td style="padding:7px 10px;">${summaryHtml}</td>
                </tr>`;
            }).join('');
        }

        // Toggle full summary visibility
        function toggleSaFull(fullId) {
            const el  = document.getElementById(fullId);
            const btn = document.getElementById(fullId + '-btn');
            if (!el) return;
            const hidden = el.style.display === 'none';
            el.style.display  = hidden ? 'inline' : 'none';
            if (btn) btn.textContent = hidden ? 'less' : 'more';
        }

        // Clear all filters and reload
        function saClearAll() {
            ['sa-global','sa-filter-doc_id','sa-filter-title','sa-filter-date',
             'sa-filter-risk-min','sa-filter-risk-max','sa-filter-anomalies','sa-filter-summary'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const anom = document.getElementById('sa-anomalies-only');
            if (anom) anom.checked = false;
            _saPage = 0;
            saApplyFilters();
        }

        // HTML escape utility
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check LLM status and show setup panel if needed
        async function checkLLMStatus() {
            try {
                const response = await apiFetch(apiUrl('/api/llm/status'));
                const data = await response.json();

                if (!data.enabled || !data.has_key) {
                    document.getElementById('llm-setup-panel').style.display = 'block';
                    document.getElementById('llm-setup-link').href = data.setup_url;
                }

                // Update provider dropdown change handler (element only exists on Config tab)
                const llmProviderEl = document.getElementById('llm-provider');
                if (llmProviderEl) {
                    llmProviderEl.value = data.provider;
                    llmProviderEl.addEventListener('change', function(e) {
                        const links = {
                            'anthropic': 'https://console.anthropic.com/settings/keys',
                            'openai': 'https://platform.openai.com/api-keys'
                        };
                        const setupLink = document.getElementById('llm-setup-link');
                        if (setupLink) setupLink.href = links[e.target.value];
                    });
                }
            } catch (error) {
                console.error('Failed to check LLM status:', error);
            }
        }

        // Test LLM API key
        async function testLLMKey() {
            const apiKey = document.getElementById('llm-api-key').value.trim();
            const provider = document.getElementById('llm-provider').value;
            const resultDiv = document.getElementById('llm-test-result');
            const saveBtn = document.getElementById('save-llm-btn');

            if (!apiKey) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fff3cd';
                resultDiv.style.color = '#856404';
                resultDiv.textContent = '‚ö†Ô∏è Please paste your API key first';
                saveBtn.style.display = 'none';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üîÑ Testing API key...';
            saveBtn.style.display = 'none';

            try {
                const response = await apiFetch(apiUrl('/api/llm/test'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, api_key: apiKey})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.textContent = data.message;
                    saveBtn.style.display = 'inline-block';
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = data.error;
                    saveBtn.style.display = 'none';
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Failed to test key: ' + error.message;
                saveBtn.style.display = 'none';
            }
        }

        // View staging profile
        async function viewStagingProfile(filename) {
            try {
                const response = await apiFetch(apiUrl(`/api/staging/${filename}`));
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Format YAML nicely
                const yaml = JSON.stringify(data, null, 2);
                const formatted = yaml.replace(/[{}"]/g, '').replace(/,\n/g, '\n');

                alert(`Profile: ${filename}\n\n${formatted}\n\nTo activate, click the ‚úì Activate button.`);
            } catch (error) {
                alert('Failed to load profile: ' + error.message);
            }
        }

        // Activate staging profile
        async function activateStagingProfile(filename) {
            if (!confirm(`Activate profile "${filename}"?\n\nThis will move it to active profiles and restart the analyzer.`)) {
                return;
            }

            try {
                const response = await fetch(`api/staging/${filename}/activate`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Activate all staging profiles
        async function activateAllStagingProfiles() {
            if (!confirm('Activate ALL staging profiles?\n\nThis will move all staging profiles to active and require an analyzer restart.')) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/staging/activate-all'), {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    const msg = `‚úÖ ${data.message}\n\nActivated: ${data.activated}\nFailed: ${data.failed}`;
                    alert(msg);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Delete staging profile
        async function deleteStagingProfile(filename) {
            if (!confirm(`Delete profile "${filename}"?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`api/staging/${filename}/delete`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Profile deleted');
                    fetchProfiles();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Active profile management
        async function viewActiveProfile(filename) {
            try {
                const response = await apiFetch(apiUrl(`/api/active/${filename}`));
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                const yaml = JSON.stringify(data, null, 2);
                const formatted = yaml.replace(/[{}"]/g, '').replace(/,\n/g, '\n');
                alert(`Active Profile: ${filename}\n\n${formatted}`);
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        async function renameActiveProfile(filename, currentName) {
            const newName = prompt(`Rename profile "${currentName}":\n\nEnter new display name:`, currentName);
            if (!newName || newName === currentName) {
                return;
            }

            try {
                const response = await fetch(`api/active/${filename}/rename`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({display_name: newName})
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Profile renamed! Reloading profiles...');
                    fetchProfiles();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        async function deleteActiveProfile(filename) {
            if (!confirm(`Delete active profile "${filename}"?\n\nThis will stop using this profile for matching. This cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`api/active/${filename}/delete`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Profile deleted! Restart the analyzer to reload profiles.');
                    fetchProfiles();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Detect duplicate profiles
        async function detectDuplicates() {
            const resultDiv = document.getElementById('duplicates-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">Analyzing profiles for duplicates...</div>';

            try {
                const response = await apiFetch(apiUrl('/api/active/duplicates'));
                const data = await response.json();

                if (data.duplicate_groups === 0) {
                    resultDiv.innerHTML = '<div style="padding: 15px; background: #d4edda; color: #155724; border-radius: 4px;">‚úÖ No duplicates found! All profiles are unique.</div>';
                    return;
                }

                // Build duplicate groups display
                let html = `<div style="padding: 15px; background: #fff3cd; color: #856404; border-radius: 4px; margin-bottom: 15px;">
                    ‚ö†Ô∏è Found ${data.duplicate_groups} duplicate group(s) affecting ${data.groups.reduce((sum, g) => sum + g.profiles.length, 0)} profiles
                </div>`;

                data.groups.forEach((group, idx) => {
                    html += `<div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
                        <strong>Duplicate Group ${idx + 1}</strong> (${group.type})
                        <div style="font-size: 12px; color: #666; margin: 5px 0;">${group.reason}</div>
                        <ul style="margin: 10px 0; padding-left: 20px;">`;

                    group.profiles.forEach(profile => {
                        html += `<li>
                            <input type="checkbox" class="duplicate-checkbox" value="${profile.filename}" style="margin-right: 8px;">
                            <strong>${profile.filename}</strong> - ${profile.display_name}
                        </li>`;
                    });

                    html += `</ul></div>`;
                });

                html += `<div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="removeDuplicates()">üóëÔ∏è Remove Selected</button>
                    <button class="btn btn-secondary" onclick="selectAllDuplicates()">Select All</button>
                    <button class="btn btn-secondary" onclick="deselectAllDuplicates()">Deselect All</button>
                </div>`;

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div style="padding: 15px; background: #f8d7da; color: #721c24; border-radius: 4px;">‚ùå Failed to detect duplicates: ${error.message}</div>`;
            }
        }

        function selectAllDuplicates() {
            document.querySelectorAll('.duplicate-checkbox').forEach(cb => cb.checked = true);
        }

        function deselectAllDuplicates() {
            document.querySelectorAll('.duplicate-checkbox').forEach(cb => cb.checked = false);
        }

        async function removeDuplicates() {
            const checkboxes = document.querySelectorAll('.duplicate-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one profile to remove');
                return;
            }

            const filenames = Array.from(checkboxes).map(cb => cb.value);
            if (!confirm(`Remove ${filenames.length} selected profile(s)?\n\nFiles:\n${filenames.join('\n')}\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/active/duplicates/remove'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filenames})
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nRemoved: ${data.removed}\nFailed: ${data.failed}`);
                    fetchProfiles();
                    document.getElementById('duplicates-result').style.display = 'none';
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Save LLM API key
        async function saveLLMKey() {
            const apiKey = document.getElementById('llm-api-key').value.trim();
            const provider = document.getElementById('llm-provider').value;
            const resultDiv = document.getElementById('llm-test-result');

            if (!confirm('Save this API key and enable AI analysis?')) {
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üíæ Saving configuration...';

            try {
                const response = await apiFetch(apiUrl('/api/llm/save'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, api_key: apiKey})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.innerHTML = '‚úÖ ' + data.message.replace(/\n/g, '<br>');

                    // Offer to restart
                    setTimeout(() => {
                        if (confirm('Restart the analyzer container now to enable AI analysis?')) {
                            resultDiv.textContent = 'üîÑ Restarting container... (page will reload in 10 seconds)';
                            setTimeout(() => location.reload(), 10000);
                        }
                    }, 2000);
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = '‚úó ' + data.error;
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Failed to save: ' + error.message;
            }
        }

        // ‚îÄ‚îÄ AI Configuration Management (v2 per-project) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function _showAIResult(divId, success, msg) {
            const d = document.getElementById(divId);
            if (!d) return;
            d.style.display = 'block';
            d.style.padding = '8px 12px';
            d.style.borderRadius = '4px';
            if (success) {
                d.style.background = '#d4edda'; d.style.color = '#155724';
                d.textContent = '‚úÖ ' + msg;
                setTimeout(() => { d.style.display = 'none'; }, 5000);
            } else {
                d.style.background = '#f8d7da'; d.style.color = '#721c24';
                d.textContent = '‚úó ' + msg;
            }
        }

        async function loadAIConfig() {
            // Load global keys (admin only)
            if (IS_ADMIN) {
                try {
                    const r = await apiFetch(apiUrl('/api/ai-config/global'));
                    const d = await r.json();
                    if (d.success && d.global) {
                        const g = d.global;
                        if (document.getElementById('openai-api-key'))
                            document.getElementById('openai-api-key').value = g.openai?.api_key || '';
                        if (document.getElementById('anthropic-api-key'))
                            document.getElementById('anthropic-api-key').value = g.anthropic?.api_key || '';
                    }
                } catch(e) { console.error('Failed to load global AI keys:', e); }

                // Populate admin project selectors (only once ‚Äî refresh() calls us repeatedly)
                const sel = document.getElementById('ai-project-selector');
                if (sel && sel.options.length <= 1) {
                    try {
                        const r2 = await apiFetch(apiUrl('/api/projects'));
                        const d2 = await r2.json();
                        const projects = Array.isArray(d2) ? d2 : (d2.projects || []);
                        const cpDst = document.getElementById('ai-copy-dest-project');
                        projects.forEach(p => {
                            const slug = p.slug || p.name || String(p);
                            const opt = document.createElement('option');
                            opt.value = slug; opt.textContent = slug;
                            sel.appendChild(opt);
                            if (cpDst) {
                                const opt2 = document.createElement('option');
                                opt2.value = slug; opt2.textContent = slug;
                                cpDst.appendChild(opt2);
                            }
                        });
                    } catch(e) { console.error('Failed to load project list:', e); }
                }
            } else {
                // Non-admin: auto-load current project
                loadProjectAIConfig(CURRENT_PROJECT);
            }
        }

        async function saveGlobalAIKeys() {
            const oKey = document.getElementById('openai-api-key')?.value.trim() || '';
            const aKey = document.getElementById('anthropic-api-key')?.value.trim() || '';
            try {
                const r = await apiFetch(apiUrl('/api/ai-config/global'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ global: {
                        openai:    { api_key: oKey,  enabled: !!oKey },
                        anthropic: { api_key: aKey, enabled: !!aKey }
                    }})
                });
                const d = await r.json();
                _showAIResult('global-keys-result', d.success, d.message || d.error || 'Saved.');
            } catch(e) {
                _showAIResult('global-keys-result', false, e.message);
            }
        }

        const _AI_PROVIDERS = ['openai', 'anthropic'];
        const _AI_PROVIDER_MODELS = {
            openai:    ['gpt-4o','gpt-4-turbo','gpt-4','gpt-3.5-turbo'],
            anthropic: ['claude-sonnet-4-6','claude-opus-4-6','claude-haiku-4-5-20251001',
                        'claude-3-5-sonnet-20241022','claude-3-opus-20240229']
        };
        let _aiCurrentSlug = null;

        function _makeProviderSelect(id, selectedVal) {
            let html = `<select id="${id}" style="font-size:12px; padding:3px 6px; border:1px solid #ccc; border-radius:4px;">`;
            _AI_PROVIDERS.forEach(p => {
                html += `<option value="${p}" ${p === selectedVal ? 'selected' : ''}>${p}</option>`;
            });
            html += '</select>';
            return html;
        }

        function _makeModelSelect(id, provider, selectedVal) {
            const models = _AI_PROVIDER_MODELS[provider] || _AI_PROVIDER_MODELS.openai;
            let html = `<select id="${id}" style="font-size:12px; padding:3px 6px; border:1px solid #ccc; border-radius:4px;">`;
            models.forEach(m => {
                html += `<option value="${m}" ${m === selectedVal ? 'selected' : ''}>${m}</option>`;
            });
            html += '</select>';
            return html;
        }

        function _renderProjectAITable(slug, config, defaults) {
            _aiCurrentSlug = slug;
            const tbody = document.getElementById('project-ai-tbody');
            const useCases = [
                ['document_analysis', 'Document Analysis'],
                ['chat', 'AI Chat'],
                ['case_intelligence', 'Case Intelligence']
            ];
            let rows = '';
            useCases.forEach(([uc, label]) => {
                const cfg = config[uc] || defaults[uc] || {};
                const pProv = cfg.provider || 'openai';
                const pMod  = cfg.model || _AI_PROVIDER_MODELS.openai[0];
                const fProv = cfg.fallback_provider || 'anthropic';
                const fMod  = cfg.fallback_model || _AI_PROVIDER_MODELS.anthropic[0];
                rows += `<tr style="border-bottom:1px solid #f0f0f0;">
                  <td style="padding:8px 10px; font-weight:500;">${label}</td>
                  <td style="padding:8px 10px;">
                    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                      ${_makeProviderSelect(`ai-${uc}-prov`, pProv)}
                      ${_makeModelSelect(`ai-${uc}-mod`, pProv, pMod)}
                    </div>
                  </td>
                  <td style="padding:8px 10px;">
                    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                      ${_makeProviderSelect(`ai-${uc}-fprov`, fProv)}
                      ${_makeModelSelect(`ai-${uc}-fmod`, fProv, fMod)}
                    </div>
                  </td>
                  <td style="padding:8px 10px; text-align:center;">
                    <button class="btn btn-sm" onclick="copyUseCaseToAll('${uc}')" style="font-size:11px; padding:3px 8px;" title="Copy this row to all use-cases">‚áâ All</button>
                  </td>
                </tr>`;
            });
            tbody.innerHTML = rows;
            // Wire up provider selects to refresh model selects
            useCases.forEach(([uc]) => {
                ['', 'f'].forEach(prefix => {
                    const pSel = document.getElementById(`ai-${uc}-${prefix}prov`);
                    const mSel = document.getElementById(`ai-${uc}-${prefix}mod`);
                    if (pSel && mSel) {
                        pSel.onchange = () => {
                            const newProv = pSel.value;
                            const models = _AI_PROVIDER_MODELS[newProv] || _AI_PROVIDER_MODELS.openai;
                            mSel.innerHTML = models.map(m => `<option value="${m}">${m}</option>`).join('');
                        };
                    }
                });
            });
            document.getElementById('project-ai-placeholder').style.display = 'none';
            document.getElementById('project-ai-table').style.display = 'block';
        }

        async function loadProjectAIConfig(slug) {
            if (!slug) return;
            try {
                const r = await apiFetch(apiUrl(`/api/ai-config/projects/${slug}`));
                const d = await r.json();
                if (d.success !== false) {
                    _renderProjectAITable(slug, d.config || {}, d.defaults || {});
                    // Populate per-project key inputs
                    const oKey = document.getElementById('proj-openai-key');
                    const aKey = document.getElementById('proj-anthropic-key');
                    const oSt  = document.getElementById('proj-openai-key-status');
                    const aSt  = document.getElementById('proj-anthropic-key-status');
                    if (oKey) oKey.value = d.has_openai_key    ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
                    if (aKey) aKey.value = d.has_anthropic_key ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : '';
                    if (oSt)  oSt.textContent  = d.has_openai_key    ? '‚úì key saved' : '(using global)';
                    if (aSt)  aSt.textContent  = d.has_anthropic_key ? '‚úì key saved' : '(using global)';
                    if (oSt)  oSt.style.color  = d.has_openai_key    ? '#16a34a' : '#9ca3af';
                    if (aSt)  aSt.style.color  = d.has_anthropic_key ? '#16a34a' : '#9ca3af';
                    const wrap = document.getElementById('project-api-keys-wrap');
                    if (wrap) wrap.style.display = 'block';
                } else {
                    console.error('loadProjectAIConfig error:', d.error);
                }
            } catch(e) { console.error('Failed to load project AI config:', e); }
        }

        function clearProjectKey(provider) {
            const inp = document.getElementById(`proj-${provider}-key`);
            const st  = document.getElementById(`proj-${provider}-key-status`);
            if (inp) inp.value = '';
            if (st)  { st.textContent = '(will use global on save)'; st.style.color = '#9ca3af'; }
        }

        async function testProjectKey(provider) {
            const inp = document.getElementById(`proj-${provider}-key`);
            const st  = document.getElementById(`proj-${provider}-key-status`);
            const key = inp?.value.trim();
            if (!key || key === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                if (st) { st.textContent = 'Enter a new key to test'; st.style.color = '#d97706'; }
                return;
            }
            if (st) { st.textContent = 'üß™ Testing‚Ä¶'; st.style.color = '#2563eb'; }
            try {
                const r = await apiFetch(apiUrl('/api/ai-config/test'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, api_key: key})
                });
                const d = await r.json();
                if (st) { st.textContent = d.success ? ('‚úì ' + d.message) : ('‚úó ' + d.error); st.style.color = d.success ? '#16a34a' : '#dc2626'; }
            } catch(e) {
                if (st) { st.textContent = '‚úó ' + e.message; st.style.color = '#dc2626'; }
            }
        }

        async function saveProjectAIConfig() {
            if (!_aiCurrentSlug) return;
            const useCases = ['document_analysis', 'chat', 'case_intelligence'];
            const config = {};
            useCases.forEach(uc => {
                config[uc] = {
                    provider:          document.getElementById(`ai-${uc}-prov`)?.value || 'openai',
                    model:             document.getElementById(`ai-${uc}-mod`)?.value || 'gpt-4o',
                    fallback_provider: document.getElementById(`ai-${uc}-fprov`)?.value || 'anthropic',
                    fallback_model:    document.getElementById(`ai-${uc}-fmod`)?.value || 'claude-sonnet-4-6',
                };
            });
            // Include per-project API key overrides (backend preserves existing if masked)
            config.openai_api_key    = document.getElementById('proj-openai-key')?.value.trim()    || '';
            config.anthropic_api_key = document.getElementById('proj-anthropic-key')?.value.trim() || '';
            try {
                const r = await apiFetch(apiUrl(`/api/ai-config/projects/${_aiCurrentSlug}`), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({config})
                });
                const d = await r.json();
                _showAIResult('project-ai-result', d.success, d.message || d.error || 'Saved.');
                if (d.success) loadProjectAIConfig(_aiCurrentSlug); // refresh key status badges
            } catch(e) {
                _showAIResult('project-ai-result', false, e.message);
            }
        }

        async function copyUseCaseToAll(useCase) {
            if (!_aiCurrentSlug) return;
            try {
                const r = await apiFetch(apiUrl(`/api/ai-config/projects/${_aiCurrentSlug}/copy-use-case`), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({use_case: useCase})
                });
                const d = await r.json();
                if (d.success) {
                    await loadProjectAIConfig(_aiCurrentSlug);
                    _showAIResult('project-ai-result', true, d.message);
                } else {
                    _showAIResult('project-ai-result', false, d.error);
                }
            } catch(e) {
                _showAIResult('project-ai-result', false, e.message);
            }
        }

        async function copyProjectAIConfig() {
            if (!_aiCurrentSlug) return;
            const destSlug = document.getElementById('ai-copy-dest-project')?.value;
            if (!destSlug) { alert('Select a destination project first.'); return; }
            try {
                const r = await apiFetch(apiUrl('/api/ai-config/projects/copy'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({source_slug: _aiCurrentSlug, dest_slug: destSlug})
                });
                const d = await r.json();
                _showAIResult('project-ai-result', d.success, d.message || d.error || 'Done.');
            } catch(e) {
                _showAIResult('project-ai-result', false, e.message);
            }
        }

        // Legacy alias kept for testAIProvider compatibility
        async function saveAIConfig() { await saveGlobalAIKeys(); }

        async function testAIProvider(provider) {
            const apiKeyInput = document.getElementById(`${provider}-api-key`);
            const resultDiv = document.getElementById(`${provider}-test-result`);
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.padding = '10px';
                resultDiv.style.borderRadius = '4px';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Please enter an API key';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.padding = '10px';
            resultDiv.style.borderRadius = '4px';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üß™ Testing API key...';

            try {
                const response = await apiFetch(apiUrl('/api/ai-config/test'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, api_key: apiKey})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.textContent = data.message;
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = data.error;
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Test failed: ' + error.message;
            }
        }

        // ‚îÄ‚îÄ Chat session state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentSessionId = null;

        async function loadSessions() {
            try {
                const res = await apiFetch(apiUrl('/api/chat/sessions'));
                const data = await res.json();
                renderSessionList(data);
            } catch (e) {
                console.error('Failed to load sessions:', e);
            }
        }

        function renderSessionList(data) {
            const container = document.getElementById('session-list');
            const isAdmin = data.is_admin;
            let html = '';

            function formatDate(iso) {
                if (!iso) return '';
                const d = new Date(iso);
                const now = new Date();
                const diffMs = now - d;
                const diffH = Math.floor(diffMs / 3600000);
                if (diffH < 1) return 'Just now';
                if (diffH < 24) return `${diffH}h ago`;
                const diffD = Math.floor(diffH / 24);
                if (diffD < 7) return `${diffD}d ago`;
                return d.toLocaleDateString();
            }

            function sessionItemHtml(s) {
                const active = s.id === currentSessionId ? ' active' : '';
                const sharedBadge = s.is_shared ? '<span class="session-badge-shared">shared</span>' : '';
                return `<div class="session-item${active}" data-session-id="${s.id}" onclick="loadSession('${s.id}')">
                    <span class="session-title">title: ${escapeHtml(s.title)}${sharedBadge}</span>
                    <span class="session-meta">${formatDate(s.updated_at)}</span>
                    <div class="session-actions" onclick="event.stopPropagation()">
                        <button class="session-action-btn" title="Rename" onclick="renameSessionPrompt('${s.id}', '${escapeHtml(s.title).replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                        ${s.is_own !== false ? `<button class="session-action-btn" title="Delete" onclick="deleteSession('${s.id}')">üóëÔ∏è</button>` : ''}
                    </div>
                </div>`;
            }

            if (isAdmin && data.sessions_by_user) {
                for (const [username, sessions] of Object.entries(data.sessions_by_user)) {
                    html += `<div class="session-group-header">${escapeHtml(username)}</div>`;
                    sessions.forEach(s => { html += sessionItemHtml(s); });
                }
            } else if (data.sessions) {
                const own = data.sessions.filter(s => s.is_own && !s.is_shared);
                const shared = data.sessions.filter(s => s.is_shared);
                if (own.length) {
                    html += '<div class="session-group-header">My Chats</div>';
                    own.forEach(s => { html += sessionItemHtml(s); });
                }
                if (shared.length) {
                    html += '<div class="session-group-header">Shared with me</div>';
                    shared.forEach(s => { html += sessionItemHtml(s); });
                }
            }

            if (!html) {
                html = '<div style="padding: 20px 14px; font-size: 12px; color: #556677;">No chats yet. Start a new chat!</div>';
            }
            container.innerHTML = html;
        }

        function escapeHtml(str) {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        async function loadSession(sessionId) {
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${sessionId}`));
                if (!res.ok) { alert('Failed to load session'); return; }
                const data = await res.json();

                currentSessionId = sessionId;
                chatHistory = [];

                // Update header title
                document.getElementById('active-session-title').textContent = data.session.title;

                // Populate chat messages
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                data.messages.forEach(m => {
                    addChatMessage(m.role, m.content);
                    chatHistory.push({role: m.role, content: m.content});
                });

                if (!data.messages.length) {
                    // Show welcome message if empty session
                    addWelcomeMessage();
                }

                // Switch to AI Chat tab
                switchTab('ai-chat');
                // Update sidebar highlights
                loadSessions();
            } catch (e) {
                console.error('loadSession error:', e);
            }
        }

        function newChat() {
            currentSessionId = null;
            chatHistory = [];
            document.getElementById('active-session-title').textContent = 'New Chat';
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = '';
            addWelcomeMessage();
            switchTab('ai-chat');
            // Deselect active session in sidebar
            document.querySelectorAll('.session-item.active').forEach(el => el.classList.remove('active'));
        }

        function addWelcomeMessage() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = `
                <div class="chat-message assistant">
                    <div class="message-bubble">
                        <div>üëã Hi! I'm your AI document assistant. I can help you:</div>
                        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                            <li>Analyze patterns across all your documents</li>
                            <li>Find specific transactions or anomalies</li>
                            <li>Generate reports and ledgers</li>
                            <li>Answer questions about your financial documents</li>
                        </ul>
                        <div style="margin-top: 10px;">Try asking me something!</div>
                    </div>
                </div>
                <div class="chat-suggestions">
                    <div class="suggestion-chip" onclick="sendSuggestion('Show me all high-risk documents')">Show me all high-risk documents</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('What anomalies were most common?')">What anomalies were most common?</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Generate a summary of all analyzed documents')">Generate a summary</div>
                </div>`;
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this chat session? This cannot be undone.')) return;
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${sessionId}`), {method: 'DELETE'});
                if (!res.ok) { alert('Failed to delete session'); return; }
                if (currentSessionId === sessionId) newChat();
                loadSessions();
            } catch (e) { console.error(e); }
        }

        async function renameSessionPrompt(sessionId, currentTitle) {
            const newTitle = prompt('Rename chat:', currentTitle);
            if (!newTitle || newTitle.trim() === currentTitle) return;
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${sessionId}`), {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: newTitle.trim()}),
                });
                if (!res.ok) { alert('Failed to rename session'); return; }
                if (currentSessionId === sessionId) {
                    document.getElementById('active-session-title').textContent = newTitle.trim();
                }
                loadSessions();
            } catch (e) { console.error(e); }
        }

        // ‚îÄ‚îÄ Share modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _shareSessionId = null;

        function shareCurrentChat() {
            if (!currentSessionId) { alert('Start a chat first, then share it.'); return; }
            openShareModal(currentSessionId);
        }

        async function openShareModal(sessionId) {
            _shareSessionId = sessionId;
            document.getElementById('share-modal').classList.add('active');
            document.getElementById('share-username-input').value = '';
            document.getElementById('share-error').style.display = 'none';
            await refreshShareList();
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
            _shareSessionId = null;
        }

        async function refreshShareList() {
            if (!_shareSessionId) return;
            const res = await apiFetch(apiUrl(`/api/chat/sessions/${_shareSessionId}`));
            const data = await res.json();
            const shares = data.shared_with || [];
            const list = document.getElementById('share-list');
            if (!shares.length) {
                list.innerHTML = '<div style="color: #999; font-size: 13px;">No shares yet</div>';
            } else {
                list.innerHTML = shares.map(s => `
                    <div class="share-list-item">
                        <span>üë§ ${escapeHtml(s.username)}</span>
                        <button class="btn btn-danger" style="font-size: 12px; padding: 3px 10px;"
                            onclick="removeShare(${s.id})">Remove</button>
                    </div>`).join('');
            }
        }

        async function addShare() {
            const username = document.getElementById('share-username-input').value.trim();
            const errEl = document.getElementById('share-error');
            if (!username) { errEl.textContent = 'Enter a username'; errEl.style.display = 'block'; return; }
            errEl.style.display = 'none';
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${_shareSessionId}/share`), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username}),
                });
                const data = await res.json();
                if (!res.ok) { errEl.textContent = data.error || 'Failed to share'; errEl.style.display = 'block'; return; }
                document.getElementById('share-username-input').value = '';
                await refreshShareList();
            } catch (e) { errEl.textContent = e.message; errEl.style.display = 'block'; }
        }

        async function removeShare(uid) {
            await apiFetch(apiUrl(`/api/chat/sessions/${_shareSessionId}/share/${uid}`), {method: 'DELETE'});
            await refreshShareList();
        }

        document.addEventListener('click', e => {
            const m = document.getElementById('share-modal');
            if (m && e.target === m) closeShareModal();
        });

        // ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function exportCurrentChat() {
            if (!currentSessionId) { alert('Start a chat first, then export it.'); return; }
            window.location.href = apiUrl(`/api/chat/sessions/${currentSessionId}/export`);
        }

        // ‚îÄ‚îÄ User management (admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadUsers() {
            try {
                const res = await apiFetch(apiUrl('/api/users'));
                if (!res.ok) return;
                const data = await res.json();
                renderUsersTable(data.users);
            } catch (e) { console.error(e); }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            if (!users || !users.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="color:#999;">No users found</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(u => `<tr>
                <td><strong>${escapeHtml(u.username)}</strong></td>
                <td>${escapeHtml(u.display_name || '')}</td>
                <td style="font-size:12px; color:#555;">${escapeHtml(u.email || '‚Äî')}</td>
                <td><span class="role-badge ${u.role}">${u.role}</span></td>
                <td style="font-size:12px; color:#666;">${u.last_login ? u.last_login.split('T')[0] : 'Never'}</td>
                <td>${u.is_active ? '‚úÖ' : '‚ùå'}</td>
                <td style="display:flex; gap:6px; flex-wrap:wrap;">
                    <button class="btn" style="font-size:11px; padding:3px 8px;" onclick="openEditUserModal(${JSON.stringify(u).replace(/"/g,'&quot;')})">‚úèÔ∏è Edit</button>
                    ${u.is_active
                        ? `<button class="btn btn-danger" style="font-size:11px; padding:3px 8px;" onclick="deactivateUser(${u.id})">Deactivate</button>`
                        : `<button class="btn btn-success" style="font-size:11px; padding:3px 8px;" onclick="activateUser(${u.id})">Activate</button>`
                    }
                </td>
            </tr>`).join('');
        }

        function showAddUserForm() {
            document.getElementById('add-user-form').style.display = 'block';
        }
        function hideAddUserForm() {
            document.getElementById('add-user-form').style.display = 'none';
        }

        async function createUser() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value.trim();
            const display_name = document.getElementById('new-user-display').value.trim();
            const email = document.getElementById('new-user-email').value.trim();
            const role = document.getElementById('new-user-role').value;
            const errEl = document.getElementById('add-user-error');
            if (!username || !password) { errEl.textContent = 'Username and password required'; errEl.style.display = 'block'; return; }
            errEl.style.display = 'none';
            try {
                const res = await apiFetch(apiUrl('/api/users'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password, role, display_name, email}),
                });
                const data = await res.json();
                if (!res.ok) { errEl.textContent = data.error || 'Failed to create user'; errEl.style.display = 'block'; return; }
                hideAddUserForm();
                ['new-user-username','new-user-password','new-user-display','new-user-email'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.value = '';
                });
                if (data.email_sent) alert(`‚úÖ User created and welcome email sent to ${email}`);
                loadUsers();
            } catch (e) { errEl.textContent = e.message; errEl.style.display = 'block'; }
        }

        function openEditUserModal(u) {
            document.getElementById('edit-user-id').value = u.id;
            document.getElementById('edit-user-name-label').textContent = u.username;
            document.getElementById('edit-display-name').value = u.display_name || '';
            document.getElementById('edit-job-title').value = u.job_title || '';
            document.getElementById('edit-email').value = u.email || '';
            document.getElementById('edit-phone').value = u.phone || '';
            document.getElementById('edit-address').value = u.address || '';
            document.getElementById('edit-github').value = u.github || '';
            document.getElementById('edit-linkedin').value = u.linkedin || '';
            document.getElementById('edit-facebook').value = u.facebook || '';
            document.getElementById('edit-instagram').value = u.instagram || '';
            document.getElementById('edit-other-handles').value = u.other_handles || '';
            document.getElementById('edit-role').value = u.role || 'basic';
            document.getElementById('edit-timezone').value = u.timezone || '';
            document.getElementById('edit-password').value = '';
            document.getElementById('edit-user-error').style.display = 'none';
            const modal = document.getElementById('edit-user-modal');
            modal.style.display = 'flex';
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').style.display = 'none';
        }

        async function emailUserManual() {
            const uid = document.getElementById('edit-user-id').value;
            const errEl = document.getElementById('edit-user-error');
            const okEl  = document.getElementById('edit-user-success');
            errEl.style.display = 'none';
            okEl.style.display  = 'none';
            try {
                const r = await fetch(`${BASE_PATH}/api/users/${uid}/send-manual`, {method:'POST'});
                const d = await r.json();
                if (!r.ok) throw new Error(d.error || 'Failed');
                okEl.textContent = `‚úì ${d.message}`;
                okEl.style.display = 'block';
                setTimeout(() => { okEl.style.display = 'none'; }, 4000);
            } catch(e) {
                errEl.textContent = `Failed to send: ${e.message}`;
                errEl.style.display = 'block';
            }
        }

        async function saveEditUser() {
            const uid = document.getElementById('edit-user-id').value;
            const display_name = document.getElementById('edit-display-name').value.trim();
            const job_title = document.getElementById('edit-job-title').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const phone = document.getElementById('edit-phone').value.trim();
            const address = document.getElementById('edit-address').value.trim();
            const github = document.getElementById('edit-github').value.trim();
            const linkedin = document.getElementById('edit-linkedin').value.trim();
            const facebook = document.getElementById('edit-facebook').value.trim();
            const instagram = document.getElementById('edit-instagram').value.trim();
            const other_handles = document.getElementById('edit-other-handles').value.trim();
            const role = document.getElementById('edit-role').value;
            const timezone = document.getElementById('edit-timezone').value.trim();
            const password = document.getElementById('edit-password').value;
            const errEl = document.getElementById('edit-user-error');
            errEl.style.display = 'none';
            const payload = {display_name, job_title, email, phone, address, github, linkedin, facebook, instagram, other_handles, role, timezone};
            if (password) payload.password = password;
            try {
                const res = await apiFetch(apiUrl(`/api/users/${uid}`), {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload),
                });
                const data = await res.json();
                if (!res.ok) { errEl.textContent = data.error || 'Failed to save'; errEl.style.display = 'block'; return; }
                closeEditUserModal();
                loadUsers();
            } catch (e) { errEl.textContent = e.message; errEl.style.display = 'block'; }
        }

        async function deactivateUser(uid) {
            if (!confirm('Deactivate this user?')) return;
            await apiFetch(apiUrl(`/api/users/${uid}`), {method: 'DELETE'});
            loadUsers();
        }

        async function activateUser(uid) {
            await apiFetch(apiUrl(`/api/users/${uid}`), {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({is_active: 1}),
            });
            loadUsers();
        }

        // Chat functionality
        let chatHistory = [];

        function addChatMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            // Render markdown for assistant messages, plain text for user
            if (role === 'assistant' && typeof marked !== 'undefined') {
                // Configure marked for safe rendering
                marked.setOptions({
                    breaks: true,  // Convert \n to <br>
                    gfm: true,     // GitHub Flavored Markdown (tables, etc.)
                    headerIds: false,
                    mangle: false
                });
                bubble.innerHTML = marked.parse(content);
            } else {
                bubble.textContent = content;
            }

            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            chatHistory.push({role, content});
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = '<div class="message-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            const documentTypeFilter = document.getElementById('document-type-filter');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addChatMessage('user', message);
            input.value = '';

            // Disable input while processing
            input.disabled = true;
            sendBtn.disabled = true;
            showTypingIndicator();

            try {
                const requestBody = {
                    message: message,
                    history: chatHistory.slice(-10), // Last 10 messages for context
                    session_id: currentSessionId,
                };

                // Add document type filter if selected
                if (documentTypeFilter && documentTypeFilter.value !== 'all') {
                    requestBody.document_type = documentTypeFilter.value;
                }

                const response = await apiFetch(apiUrl('/api/chat'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });

                // Detect session expiry: redirected to login page
                if (response.redirected && response.url.includes('/login')) {
                    hideTypingIndicator();
                    addChatMessage('assistant', '‚ö†Ô∏è Your session has expired. Please [reload the page](' + window.location.href + ') and log in again.');
                    return;
                }

                if (!response.ok && response.status === 401) {
                    hideTypingIndicator();
                    window.location.href = apiUrl('/login');
                    return;
                }

                const data = await response.json();

                hideTypingIndicator();

                if (data.response) {
                    addChatMessage('assistant', data.response);
                    // Track session and update sidebar
                    if (data.session_id) {
                        const wasNew = !currentSessionId;
                        currentSessionId = data.session_id;
                        if (wasNew) {
                            // Auto-title: update header from first message
                            const autoTitle = message.slice(0, 60);
                            document.getElementById('active-session-title').textContent = autoTitle;
                        }
                        loadSessions();
                    }
                } else {
                    addChatMessage('assistant', 'Sorry, I encountered an error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                hideTypingIndicator();
                addChatMessage('assistant', 'Sorry, I encountered an error: ' + error.message);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.ctrlKey) {
                event.preventDefault();
                sendChatMessage();
            }
            // Ctrl+Enter falls through to default textarea behaviour (inserts newline)
        }

        function sendSuggestion(text) {
            document.getElementById('chat-input').value = text;
            sendChatMessage();
        }

        function clearChat() {
            if (!confirm('Start a new chat? The current session will remain in the sidebar.')) return;
            newChat();
        }

        // Initial load
        refresh();
        refreshLogs();
        checkLLMStatus();

        // Auto-refresh every 10 seconds
        refreshInterval = setInterval(refresh, 10000);

        // Auto-refresh logs every 15 seconds
        setInterval(refreshLogs, 15000);

        // Header health widget ‚Äî initial poll + 30 s auto-poll
        pollHeaderHealth();
        setInterval(pollHeaderHealth, 30000);

        // ‚îÄ‚îÄ System Health & Container Manager (v2.5.0) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // Silent background poll that updates only the header dots
        async function pollHeaderHealth() {
            try {
                const res = await apiFetch(apiUrl('/api/system-health'));
                if (!res.ok) return;
                const data = await res.json();
                _updateHeaderDots(data.components || {}, data.overall || 'warning');
            } catch (e) {
                // Silent ‚Äî don't alert on background poll failures
            }
        }

        // Full health load for the Health sub-tab
        // manualRefresh=true ‚Üí user clicked Refresh; reset the countdown timer
        async function loadSystemHealth(manualRefresh = false) {
            if (manualRefresh) _resetToolsCountdown('health');
            const container = document.getElementById('health-cards');
            if (!container) return;
            container.innerHTML = '<div class="loading">Checking components‚Ä¶</div>';
            try {
                const res = await apiFetch(apiUrl('/api/system-health'));
                const data = await res.json();
                _updateHeaderDots(data.components || {}, data.overall || 'warning');
                const labels = {
                    paperless_api: 'Paperless API',
                    chromadb: 'ChromaDB',
                    llm: 'LLM',
                    analyzer_loop: 'Analyzer Loop',
                    postgres: 'PostgreSQL',
                    redis: 'Redis',
                };
                container.innerHTML = '';
                for (const [id, label] of Object.entries(labels)) {
                    const result = (data.components || {})[id] || {status: 'warning', latency_ms: 0, detail: 'No data'};
                    container.appendChild(_renderHealthCard(id, label, result));
                }
                // Overall status line
                const checkedAt = data.checked_at ? new Date(data.checked_at).toLocaleTimeString() : '';
                const overallDiv = document.createElement('div');
                overallDiv.style.cssText = 'grid-column:1/-1;font-size:12px;color:#888;margin-top:4px;';
                overallDiv.textContent = `Overall: ${data.overall || '?'} ‚Äî checked at ${checkedAt}`;
                container.appendChild(overallDiv);
            } catch (e) {
                container.innerHTML = `<div style="color:#e74c3c;padding:12px;">Failed to load health data: ${e.message}</div>`;
            }
        }

        function _renderHealthCard(id, label, result) {
            const colors = {ok: '#27ae60', warning: '#f39c12', error: '#e74c3c'};
            const badgeBg = {ok: 'rgba(39,174,96,0.15)', warning: 'rgba(243,156,18,0.15)', error: 'rgba(231,76,60,0.15)'};
            const color = colors[result.status] || '#888';
            const card = document.createElement('div');
            card.style.cssText = `background:#fff;border-radius:8px;padding:14px 16px;border-left:4px solid ${color};box-shadow:0 1px 4px rgba(0,0,0,0.08);`;
            const latencyStr = result.latency_ms > 0 ? ` <span style="color:#999;font-size:11px;">${result.latency_ms}ms</span>` : '';
            card.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                    <span style="font-weight:600;font-size:14px;color:#333;">${label}</span>
                    <span style="background:${badgeBg[result.status]};color:${color};border:1px solid ${color};padding:2px 10px;border-radius:12px;font-size:12px;font-weight:600;">${result.status}${latencyStr}</span>
                </div>
                <div style="font-size:13px;color:#555;">${result.detail || ''}</div>`;
            return card;
        }

        function _updateHeaderDots(components, overall) {
            for (const [comp, result] of Object.entries(components)) {
                const dot = document.querySelector(`[data-comp="${comp}"]`);
                if (!dot) continue;
                dot.className = 'hh-dot hh-' + (result.status || 'loading');
                const labels = {
                    paperless_api: 'Paperless API', chromadb: 'ChromaDB', llm: 'LLM',
                    analyzer_loop: 'Analyzer Loop', postgres: 'PostgreSQL', redis: 'Redis',
                };
                dot.title = `${labels[comp] || comp}: ${result.status} ‚Äî ${result.detail || ''}`;
            }
            const overallEl = document.getElementById('hh-overall');
            if (overallEl) {
                const overallColors = {ok: '#27ae60', warning: '#f39c12', error: '#e74c3c'};
                overallEl.textContent = overall === 'ok' ? 'All systems OK' : overall === 'error' ? 'System error' : 'Warning';
                overallEl.style.color = overallColors[overall] || '#aabbcc';
            }
        }

        // ‚îÄ‚îÄ Container Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        // manualRefresh=true ‚Üí user clicked Refresh; reset the countdown timer
        async function loadContainers(manualRefresh = false) {
            if (manualRefresh) _resetToolsCountdown('containers');
            const cardsEl = document.getElementById('container-cards');
            const unavailEl = document.getElementById('container-unavailable');
            if (!cardsEl) return;
            cardsEl.innerHTML = '<div class="loading">Loading containers‚Ä¶</div>';
            try {
                const res = await apiFetch(apiUrl('/api/containers'));
                const data = await res.json();
                if (!data.available) {
                    unavailEl && (unavailEl.style.display = 'block');
                    cardsEl.innerHTML = '';
                    return;
                }
                unavailEl && (unavailEl.style.display = 'none');
                cardsEl.innerHTML = '';
                (data.containers || []).forEach(c => cardsEl.appendChild(_renderContainerCard(c)));
            } catch (e) {
                cardsEl.innerHTML = `<div style="color:#e74c3c;padding:12px;">Failed to load containers: ${e.message}</div>`;
            }
        }

        function _renderContainerCard(c) {
            const statusColors = {running: '#27ae60', exited: '#e74c3c', not_found: '#888', error: '#e74c3c'};
            const dotColor = statusColors[c.status] || '#f39c12';
            const uptimeStr = c.uptime_seconds != null ? _fmtUptime(c.uptime_seconds) : '‚Äî';
            const row = document.createElement('div');
            row.id = `container-row-${c.name}`;
            row.style.cssText = 'background:#fff;border-radius:6px;padding:12px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);flex-wrap:wrap;';
            const dot = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${dotColor};flex-shrink:0;"></span>`;
            const imgStr = c.image ? `<span style="color:#888;font-size:12px;font-family:monospace;">${c.image}</span>` : '';
            const uptimePart = `<span style="color:#888;font-size:12px;">Up: ${uptimeStr}</span>`;
            let adminBtns = '';
            if (IS_ADMIN && c.status !== 'not_found') {
                adminBtns = `
                    <button class="btn btn-small" onclick="restartContainer('${c.name}')" style="font-size:12px;padding:4px 10px;">‚ü≥ Restart</button>
                    <button class="btn btn-small" onclick="viewContainerLogs('${c.name}')" style="font-size:12px;padding:4px 10px;">üìã Logs</button>`;
            }
            row.innerHTML = `
                ${dot}
                <span style="font-weight:600;font-size:14px;color:#333;min-width:240px;">${c.name}</span>
                <span style="font-size:12px;padding:2px 8px;border-radius:10px;background:${dotColor}22;color:${dotColor};font-weight:600;">${c.status}</span>
                ${imgStr}
                ${uptimePart}
                <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">${adminBtns}</div>
                <div id="container-msg-${c.name}" style="width:100%;font-size:12px;display:none;padding:4px 0;"></div>`;
            return row;
        }

        function _fmtUptime(s) {
            if (s < 60) return `${s}s`;
            const m = Math.floor(s / 60) % 60;
            const h = Math.floor(s / 3600) % 24;
            const d = Math.floor(s / 86400);
            if (d > 0) return `${d}d ${h}h`;
            if (h > 0) return `${h}h ${m}m`;
            return `${m}m`;
        }

        async function restartContainer(name) {
            if (!confirm(`Restart container "${name}"? It will be briefly unavailable.`)) return;
            const msgEl = document.getElementById(`container-msg-${name}`);
            if (msgEl) { msgEl.style.display = 'block'; msgEl.style.color = '#888'; msgEl.textContent = 'Restarting‚Ä¶'; }
            try {
                const res = await apiFetch(apiUrl(`/api/containers/${name}/restart`), {method: 'POST'});
                const data = await res.json();
                if (res.ok) {
                    if (msgEl) { msgEl.style.color = '#27ae60'; msgEl.textContent = `‚úì ${data.message || 'Restarted'}`; }
                    setTimeout(loadContainers, 3000);
                } else {
                    if (msgEl) { msgEl.style.color = '#e74c3c'; msgEl.textContent = `‚úó ${data.error || 'Failed'}`; }
                }
            } catch (e) {
                if (msgEl) { msgEl.style.color = '#e74c3c'; msgEl.textContent = `‚úó ${e.message}`; }
            }
        }

        async function viewContainerLogs(name) {
            // Remove any existing log drawer for this container
            const existingDrawer = document.getElementById(`log-drawer-${name}`);
            if (existingDrawer) { existingDrawer.remove(); return; }

            const cardsEl = document.getElementById('container-cards');
            const drawer = document.createElement('div');
            drawer.id = `log-drawer-${name}`;
            drawer.className = 'logs-viewer';
            drawer.style.cssText = 'margin-top:8px;margin-bottom:8px;';
            drawer.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #e0e0e0;">
                    <strong style="font-size:13px;">Logs: ${name}</strong>
                    <button class="btn btn-small" onclick="document.getElementById('log-drawer-${name}').remove()" style="font-size:11px;">‚úï Close</button>
                </div>
                <div id="log-drawer-lines-${name}" style="padding:10px 12px;font-size:12px;color:#aabbcc;"><em>Loading‚Ä¶</em></div>`;
            if (cardsEl) cardsEl.appendChild(drawer);

            try {
                const res = await apiFetch(apiUrl(`/api/containers/${name}/logs?lines=100`));
                const data = await res.json();
                const linesEl = document.getElementById(`log-drawer-lines-${name}`);
                if (!linesEl) return;
                if (!res.ok) { linesEl.innerHTML = `<span style="color:#e74c3c;">${data.error || 'Error fetching logs'}</span>`; return; }
                if (!data.lines || data.lines.length === 0) { linesEl.innerHTML = '<em style="color:#888;">No log lines returned.</em>'; return; }
                linesEl.innerHTML = data.lines.map(l =>
                    `<div style="white-space:pre-wrap;word-break:break-all;padding:1px 0;">${l.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`
                ).join('');
                linesEl.scrollTop = linesEl.scrollHeight;
            } catch (e) {
                const linesEl = document.getElementById(`log-drawer-lines-${name}`);
                if (linesEl) linesEl.innerHTML = `<span style="color:#e74c3c;">${e.message}</span>`;
            }
        }

        // Tag Evidence Modal Functions
        async function showTagEvidence(docId, docTitle) {
            const modal = document.getElementById('tag-evidence-modal');
            const modalTitle = document.getElementById('modal-doc-title');
            const modalBody = document.getElementById('modal-evidence-body');

            // Show modal and loading state
            modal.classList.add('active');
            modalTitle.textContent = `Document #${docId}: ${docTitle}`;
            modalBody.innerHTML = '<div class="loading">Loading evidence...</div>';

            try {
                const response = await apiFetch(apiUrl(`/api/tag-evidence/${docId}`));
                const data = await response.json();

                if (data.error) {
                    modalBody.innerHTML = `<div class="no-evidence">${data.error}</div>`;
                    return;
                }

                if (!data.tags || data.tags.length === 0) {
                    modalBody.innerHTML = '<div class="no-evidence">No detailed evidence available for this document.</div>';
                    return;
                }

                // Render evidence items
                let html = '';
                if (data.integrity_summary) {
                    html += `<div style="margin-bottom: 20px; padding: 12px; background: #e8f4f8; border-radius: 6px;">
                        <strong>Integrity Summary:</strong> ${data.integrity_summary}
                        ${data.critical_count > 0 ? `<span style="color: #e74c3c; margin-left: 12px;">‚ö†Ô∏è ${data.critical_count} critical issue(s)</span>` : ''}
                    </div>`;
                }

                for (const tag of data.tags) {
                    const sev = tag.severity || 'low';
                    const severityClass = `severity-${sev}`;
                    const evidence = tag.evidence || {};

                    // Convert newlines in description to <br> for HTML rendering
                    const descHtml = (tag.description || 'No description')
                        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                        .replace(/\n/g, '<br>');

                    // Style for info-level (false positive / pass)
                    const itemStyle = sev === 'info'
                        ? 'style="background: #f0f9ff; border-left: 4px solid #3498db; opacity: 0.85;"'
                        : '';

                    html += `
                        <div class="evidence-item ${severityClass}" ${itemStyle}>
                            <div class="evidence-tag-name">
                                <span>${tag.tag}</span>
                                <span class="evidence-severity ${sev}">${sev}</span>
                            </div>
                            <div class="evidence-description">
                                <strong>${tag.category || 'Issue'}:</strong><br>${descHtml}
                            </div>
                    `;

                    // Duplicate text lines ‚Äî show as quoted code blocks
                    if (evidence.duplicate_texts && evidence.duplicate_texts.length > 0) {
                        html += '<div class="evidence-quotes"><h4>üîÅ Duplicated text:</h4>';
                        for (const line of evidence.duplicate_texts.slice(0, 10)) {
                            const safe = line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote" style="font-family:monospace; font-size:0.85em;">${safe}</div>`;
                        }
                        html += '</div>';
                    }

                    // Details list (page_discontinuity, etc.)
                    if (evidence.details && evidence.details.length > 0) {
                        html += '<div class="evidence-quotes"><h4>üìã Details:</h4>';
                        for (const detail of evidence.details) {
                            const safe = detail.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote">‚Ä¢ ${safe}</div>`;
                        }
                        html += '</div>';
                    }

                    // Quotes if available (LLM-detected issues)
                    if (evidence.quotes && evidence.quotes.length > 0) {
                        html += '<div class="evidence-quotes"><h4>üìÑ Evidence from document:</h4>';
                        for (const quote of evidence.quotes.slice(0, 3)) {
                            const safe = quote.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote">"${safe}"</div>`;
                        }
                        html += '</div>';
                    }

                    // Conflicting values if available
                    if (evidence.conflicting_values && evidence.conflicting_values.length > 0) {
                        html += '<div class="evidence-quotes"><h4>‚ö†Ô∏è Conflicting values:</h4>';
                        for (const conflict of evidence.conflicting_values) {
                            const safe = conflict.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote">${safe}</div>`;
                        }
                        html += '</div>';
                    }

                    // Location if available
                    if (evidence.location) {
                        html += `<div class="evidence-location">üìç Found: ${evidence.location}</div>`;
                    }

                    // Impact
                    if (tag.impact) {
                        html += `<div class="evidence-impact"><strong>Impact:</strong> ${tag.impact}</div>`;
                    }

                    // Suggested action
                    if (tag.suggested_action) {
                        html += `<div class="evidence-impact" style="background: #e8f8f5;"><strong>Suggested Action:</strong> ${tag.suggested_action}</div>`;
                    }

                    html += '</div>';
                }

                modalBody.innerHTML = html;
            } catch (error) {
                modalBody.innerHTML = `<div class="no-evidence">Error loading evidence: ${error.message}</div>`;
            }
        }

        function closeTagModal() {
            document.getElementById('tag-evidence-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('tag-evidence-modal');
            if (e.target === modal) {
                closeTagModal();
            }
        });

        // Project Selector Functions
        async function loadProjectSelector() {
            try {
                const response = await apiFetch(apiUrl('/api/projects'));
                const data = await response.json();

                const selector = document.getElementById('project-selector');
                if (!selector) return;

                // Get current project
                const currentResponse = await apiFetch(apiUrl('/api/current-project'));
                const currentProject = await currentResponse.json();

                // Populate dropdown
                selector.innerHTML = data.projects
                    .filter(p => !p.is_archived)
                    .map(p => `<option value="${p.slug}" ${p.slug === currentProject.slug ? 'selected' : ''}>${p.name}</option>`)
                    .join('');

            } catch (error) {
                console.error('Failed to load project selector:', error);
                const selector = document.getElementById('project-selector');
                if (selector) {
                    selector.innerHTML = '<option value="">Error loading projects</option>';
                }
            }
        }

        async function switchProject() {
            const selector = document.getElementById('project-selector');
            const projectSlug = selector.value;

            try {
                const response = await apiFetch(apiUrl('/api/current-project'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_slug: projectSlug })
                });

                if (response.ok) {
                    // Reload page to refresh all data for new project
                    window.location.reload();
                } else {
                    alert('Failed to switch project');
                }
            } catch (error) {
                console.error('Failed to switch project:', error);
                alert('Failed to switch project');
            }
        }

        // Load project selector on page load
        loadProjectSelector();
        // Load chat sessions on page load
        loadSessions();


        // ‚îÄ‚îÄ About / Help / Bug Report / SMTP ‚Äî initialise state first ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Variables must be initialised before any code that could throw, so
        // that function bodies that reference them don't hit the TDZ.
        var _helpVisible = false;
        var _helpPanelMap = {
            'overview': 'help-overview',
            'projects': 'help-projects',
            'upload':   'help-upload',
            'ai-chat':  'help-ai-chat',
            'search':   'help-search',
            'config':   'help-config',
            // tools sub-tabs are handled dynamically in _refreshHelpPanel
        };
        var _smtpLoaded = false;

        // ‚îÄ‚îÄ About Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openAboutModal() {
            var m = document.getElementById('about-modal');
            if (!m) return;
            m.style.display = 'flex';
            document.getElementById('about-version-line').textContent = 'Loading‚Ä¶';
            document.getElementById('about-components').innerHTML = '<span style="color:#8899aa;">Loading‚Ä¶</span>';
            apiFetch(apiUrl('/api/about')).then(function(r) { return r.json(); }).then(function(d) {
                document.getElementById('about-version-line').textContent = 'Version ' + d.version;
                var comp = d.components || {};
                var rows = '';
                Object.keys(comp).forEach(function(k) {
                    rows += '<span style="color:#aabbcc;">' + escapeHtml(k) + '</span>' +
                            '<span style="color:#7db8f7; font-weight:600;">' + escapeHtml(comp[k]) + '</span>';
                });
                document.getElementById('about-components').innerHTML = rows || '<span style="color:#aabbcc;">‚Äî</span>';
            }).catch(function() {
                document.getElementById('about-version-line').textContent = 'Version unknown';
            });
        }
        function closeAboutModal() {
            var m = document.getElementById('about-modal');
            if (m) m.style.display = 'none';
        }

        // ‚îÄ‚îÄ Tab Help Panels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleTabHelp() {
            _helpVisible = !_helpVisible;
            var btn = document.getElementById('help-toggle-btn');
            if (btn) {
                btn.style.background = _helpVisible
                    ? 'rgba(52,152,219,0.35)'
                    : 'rgba(255,255,255,0.12)';
                btn.textContent = _helpVisible ? '? Help: On' : '? Help: Off';
            }
            _refreshHelpPanel();
        }
        function _refreshHelpPanel() {
            // Hide all help panels (both mapped and sub-tab panels)
            document.querySelectorAll('.tab-help-panel').forEach(function(el) {
                el.style.display = 'none';
            });
            if (!_helpVisible) return;
            var activeTab = document.querySelector('.tab-button.active');
            if (!activeTab) return;
            var m = activeTab.getAttribute('onclick').match(/'([^']+)'/);
            var tabName = m ? m[1] : null;
            if (tabName === 'tools') {
                // Show help for the active tools sub-tab
                var activeSubBtn = document.querySelector('.tools-sub-btn.active');
                if (activeSubBtn) {
                    var sm = activeSubBtn.getAttribute('onclick').match(/'([^']+)'/);
                    var subName = sm ? sm[1] : null;
                    if (subName) {
                        var subEl = document.getElementById('help-tools-' + subName);
                        if (subEl) subEl.style.display = 'block';
                    }
                }
            } else if (tabName === 'config') {
                // Show help for the active config sub-tab; fall back to main config panel
                var activeSubBtn = document.querySelector('.config-sub-btn.active');
                var subName = null;
                if (activeSubBtn) {
                    var sm = activeSubBtn.getAttribute('onclick').match(/'([^']+)'/);
                    subName = sm ? sm[1] : null;
                }
                var subEl = subName ? document.getElementById('help-config-' + subName) : null;
                var fallback = document.getElementById('help-config');
                var panel = subEl || fallback;
                if (panel) panel.style.display = 'block';
            } else if (tabName === 'case-intelligence') {
                // Show help for the active CI sub-tab; fall back to main CI panel
                var activeSubBtn = document.querySelector('.ci-sub-btn.active');
                var subName = null;
                if (activeSubBtn) {
                    var sm = activeSubBtn.getAttribute('onclick').match(/'([^']+)'/);
                    subName = sm ? sm[1] : null;
                }
                var subEl = subName ? document.getElementById('help-ci-' + subName) : null;
                var fallback = document.getElementById('help-ci');
                var panel = subEl || fallback;
                if (panel) panel.style.display = 'block';
            } else {
                var panelId = tabName ? _helpPanelMap[tabName] : null;
                if (panelId) {
                    var el = document.getElementById(panelId);
                    if (el) el.style.display = 'block';
                }
            }
        }
        // Wrap switchTab so the help panel updates, config sub-tabs are reset,
        // and the tools auto-refresh stops when leaving the tools tab.
        (function() {
            var _orig = switchTab;
            switchTab = function(name) {
                _orig(name);
                // Explicitly clear config sub-tab active state when leaving config.
                if (name !== 'config') {
                    document.querySelectorAll('.config-sub-content').forEach(function(c) {
                        c.classList.remove('active');
                    });
                }
                // Stop tools auto-refresh when navigating away from the tools tab
                if (name !== 'tools') {
                    _stopToolsAutoRefresh();
                }
                _refreshHelpPanel();
            };
        })();

        // ‚îÄ‚îÄ Bug Report Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openBugReportModal() {
            var m = document.getElementById('bug-report-modal');
            if (!m) return;
            m.style.display = 'flex';
            document.getElementById('bug-report-result').style.display = 'none';
            document.getElementById('bug-description').value = '';
            document.getElementById('bug-contact-email').value = '';
            document.getElementById('bug-har-file').value = '';
            document.getElementById('bug-severity').value = 'Medium';
            document.getElementById('bug-include-logs').checked = true;
        }
        function closeBugReportModal() {
            var m = document.getElementById('bug-report-modal');
            if (m) m.style.display = 'none';
        }
        async function submitBugReport() {
            var desc = document.getElementById('bug-description').value.trim();
            var resEl = document.getElementById('bug-report-result');
            function showErr(msg) {
                resEl.style.display = 'block';
                resEl.style.background = 'rgba(231,76,60,0.15)';
                resEl.style.border = '1px solid rgba(231,76,60,0.4)';
                resEl.style.color = '#f08080';
                resEl.textContent = msg;
            }
            if (!desc) { showErr('Please describe the problem before sending.'); return; }
            var email = document.getElementById('bug-contact-email').value.trim();
            if (!email) { showErr('Please enter your email address so we can follow up.'); return; }
            var btn = document.querySelector('#bug-report-modal button[onclick="submitBugReport()"]');
            if (btn) { btn.disabled = true; btn.textContent = 'Sending‚Ä¶'; }
            var fd = new FormData();
            fd.append('description', desc);
            fd.append('severity', document.getElementById('bug-severity').value);
            fd.append('contact_email', document.getElementById('bug-contact-email').value);
            fd.append('include_logs', document.getElementById('bug-include-logs').checked ? 'true' : 'false');
            var harInput = document.getElementById('bug-har-file');
            if (harInput.files && harInput.files[0]) fd.append('har_file', harInput.files[0]);
            try {
                var r = await apiFetch(apiUrl('/api/bug-report'), { method: 'POST', body: fd });
                var d = await r.json();
                resEl.style.display = 'block';
                if (d.ok) {
                    resEl.style.background = 'rgba(39,174,96,0.15)';
                    resEl.style.border = '1px solid rgba(39,174,96,0.4)';
                    resEl.style.color = '#7dcea0';
                    resEl.textContent = d.message;
                    if (btn) { btn.disabled = false; btn.textContent = 'üì® Send Report'; }
                    setTimeout(closeBugReportModal, 3000);
                } else {
                    showErr(d.error || 'Failed to send report.');
                    if (btn) { btn.disabled = false; btn.textContent = 'üì® Send Report'; }
                }
            } catch (e) {
                showErr('Network error: ' + e.message);
                if (btn) { btn.disabled = false; btn.textContent = 'üì® Send Report'; }
            }
        }

        // ‚îÄ‚îÄ SMTP Settings (admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function _ensureSmtpLoaded(subtab) {
            if (subtab === 'smtp' && !_smtpLoaded) {
                _smtpLoaded = true;
                loadSmtpSettings();
            }
        }
        // Wrap switchConfigTab to lazy-load SMTP settings
        (function() {
            var _orig = switchConfigTab;
            switchConfigTab = function(name) { _orig(name); _ensureSmtpLoaded(name); };
        })();
        function loadSmtpSettings() {
            apiFetch(apiUrl('/api/smtp-settings')).then(function(r) { return r.json(); }).then(function(d) {
                if (d.error) return;
                document.getElementById('smtp-host').value = d.host || '';
                document.getElementById('smtp-port').value = d.port || 587;
                document.getElementById('smtp-user').value = d.user || '';
                document.getElementById('smtp-pass').value = d.pass || '';
                document.getElementById('smtp-from').value = d.from || '';
                document.getElementById('smtp-helo').value = d.helo || '';
                document.getElementById('smtp-bug-report-to').value = d.bug_report_to || '';
                document.getElementById('smtp-starttls').checked = !!d.starttls;
            }).catch(function() {});
        }
        function _showSmtpResult(msg, ok) {
            var el = document.getElementById('smtp-result');
            el.style.display = 'block';
            el.style.background = ok ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)';
            el.style.border = '1px solid ' + (ok ? 'rgba(39,174,96,0.4)' : 'rgba(231,76,60,0.4)');
            el.style.color = ok ? '#27ae60' : '#e74c3c';
            el.textContent = msg;
        }
        async function saveSmtpSettings() {
            var payload = {
                host: document.getElementById('smtp-host').value.trim(),
                port: parseInt(document.getElementById('smtp-port').value) || 587,
                user: document.getElementById('smtp-user').value.trim(),
                pass: document.getElementById('smtp-pass').value,
                from: document.getElementById('smtp-from').value.trim(),
                helo: document.getElementById('smtp-helo').value.trim(),
                bug_report_to: document.getElementById('smtp-bug-report-to').value.trim(),
                starttls: document.getElementById('smtp-starttls').checked,
            };
            try {
                var r = await apiFetch(apiUrl('/api/smtp-settings'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                var d = await r.json();
                _showSmtpResult(d.ok ? d.message : (d.error || 'Failed'), !!d.ok);
            } catch (e) {
                _showSmtpResult('Error: ' + e.message, false);
            }
        }
        async function testSmtpSettings() {
            _showSmtpResult('Sending test email‚Ä¶', true);
            try {
                var r = await apiFetch(apiUrl('/api/smtp-settings/test'), { method: 'POST' });
                var d = await r.json();
                _showSmtpResult(d.ok ? d.message : (d.error || 'Failed'), !!d.ok);
            } catch (e) {
                _showSmtpResult('Error: ' + e.message, false);
            }
        }
    </script>

    {% if CI_ENABLED %}
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         CASE INTELLIGENCE AI TAB ‚Äî v3.0.0
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <style>
        /* Case Intelligence styles */
        .ci-sub-nav { display:flex; gap:4px; padding:0; border-bottom:1px solid #dde3ea; margin-bottom:16px; flex-wrap:wrap; }
        .ci-sub-btn { background:none; border:1px solid transparent; border-bottom:3px solid transparent; margin-bottom:-2px; padding:6px 16px; cursor:pointer; font-size:13px; color:#555; border-radius:6px 6px 0 0; transition:all 0.15s; white-space:nowrap; }
        .ci-sub-btn:hover { background:#f0f4f8; color:#333; }
        .ci-sub-btn.active { color:#2980b9; border-bottom-color:#2980b9; font-weight:600; background:#f8fbff; }
        .ci-sub-content { display:none; }
        .ci-sub-content.active { display:block; animation:fadeIn 0.2s; }
        .ci-form-row { display:flex; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
        .ci-form-group { flex:1; min-width:200px; }
        .ci-form-group label { display:block; font-size:12px; color:#666; margin-bottom:4px; font-weight:600; }
        .ci-form-group input, .ci-form-group select, .ci-form-group textarea {
            width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:5px;
            font-size:13px; background:#fff; color:#333; box-sizing:border-box;
        }
        .ci-form-group textarea { resize:vertical; min-height:70px; }
        .ci-section-card { background:#f8f9fa; border:1px solid #e0e0e0; border-radius:8px; padding:16px; margin-bottom:14px; }
        .ci-section-card h4 { font-size:13px; font-weight:700; color:#2c3e50; margin-bottom:10px; }
        .ci-budget-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .ci-progress-bar { width:100%; height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden; margin:6px 0; }
        .ci-progress-fill { height:100%; background:#27ae60; border-radius:4px; transition:width 0.5s; }
        .ci-progress-fill.blocked { background:#e74c3c; }
        .ci-finding-item { background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:12px 14px; margin-bottom:8px; }
        .ci-finding-item .severity-badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700; margin-right:6px; }
        .severity-badge.critical { background:#fde8e8; color:#c0392b; }
        .severity-badge.high { background:#fef3e2; color:#e67e22; }
        .severity-badge.medium { background:#e8f5e9; color:#27ae60; }
        .severity-badge.low { background:#e8f4ff; color:#2980b9; }
        .ci-accordion-header { cursor:pointer; padding:10px 12px; background:#ecf0f1; border-radius:6px; margin-bottom:4px; font-size:13px; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
        .ci-accordion-header:hover { background:#dfe6e9; }
        .ci-accordion-body { display:none; padding:10px 12px; border:1px solid #e0e0e0; border-radius:0 0 6px 6px; margin-bottom:8px; }
        .ci-accordion-body.open { display:block; }
        .ci-run-selector { padding:6px 10px; border:1px solid #ddd; border-radius:5px; font-size:13px; min-width:220px; }
        .ci-q-item { background:#fff; border-left:3px solid #3498db; padding:10px 12px; margin-bottom:8px; border-radius:0 5px 5px 0; }
        .ci-q-item.required { border-left-color:#e74c3c; }
        .ci-q-item label { font-size:12px; font-weight:700; color:#555; }
        .ci-q-item input[type="text"] { width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-size:13px; margin-top:4px; }
        .ci-report-preview { background:#1e1e1e; color:#d4d4d4; padding:16px; border-radius:6px; font-family:monospace; font-size:12px; max-height:300px; overflow-y:auto; white-space:pre-wrap; }
        .ci-tag-pill { display:inline-block; background:#e8f4ff; color:#2980b9; padding:2px 8px; border-radius:10px; font-size:11px; margin:2px; }
        #ci-status-bar { background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:10px 14px; margin-bottom:12px; display:none; }
        #ci-status-bar.visible { display:block; }
    </style>



    <script>
    // ‚îÄ‚îÄ Case Intelligence JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const IS_ADVANCED = {{ 'true' if is_advanced else 'false' }};
    let ciCurrentRunId = null;
    let ciPollTimer = null;
    let ciSelectedRunId = null;
    let ciFindingsPollTimer = null;

    function ciSwitchSub(sub) {
        document.querySelectorAll('.ci-sub-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.ci-sub-content').forEach(c => c.classList.remove('active'));
        const btn = document.querySelector(`.ci-sub-btn[onclick="ciSwitchSub('${sub}')"]`);
        if (btn) btn.classList.add('active');
        const el = document.getElementById(`ci-sub-${sub}`);
        if (el) el.classList.add('active');

        if (sub === 'findings') {
            ciRefreshRuns();
        }
        // Update help panel to match the newly active CI sub-tab
        if (typeof _refreshHelpPanel === 'function') _refreshHelpPanel();
    }

    function ciToggleSection(id) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle('open');
    }

    // Load jurisdiction profiles on tab open
    async function ciLoadJurisdictions() {
        try {
            const r = await apiFetch(apiUrl('/api/ci/jurisdictions'));
            const d = await r.json();
            const sel = document.getElementById('ci-jurisdiction-select');
            sel.innerHTML = '<option value="">‚Äî Select template ‚Äî</option>';
            (d.jurisdictions || []).forEach(j => {
                const o = document.createElement('option');
                o.value = j.jurisdiction_id;
                o.textContent = j.display_name;
                o.dataset.court = j.court;
                o.dataset.framework = j.baseline_framework;
                sel.appendChild(o);
            });
        } catch(e) {
            console.warn('CI jurisdictions load failed:', e);
        }
    }

    function ciLoadJurisdiction() {
        const sel = document.getElementById('ci-jurisdiction-select');
        const opt = sel.options[sel.selectedIndex];
        if (!opt || !opt.value) {
            document.getElementById('ci-jurisdiction-details').style.display = 'none';
            return;
        }
        document.getElementById('ci-jd-court').value = opt.dataset.court || '';
        document.getElementById('ci-jurisdiction-details').style.display = 'flex';
    }

    async function ciDetectJurisdiction() {
        const statusEl = document.getElementById('ci-jd-detect-status');
        if (!statusEl) return;
        statusEl.textContent = 'üîç Detecting jurisdiction from documents‚Ä¶';
        statusEl.style.color = '#888';
        try {
            const r = await apiFetch(apiUrl('/api/ci/detect-jurisdiction'), { method: 'POST' });
            const d = await r.json();
            if (!d.detected) {
                statusEl.textContent = d.reason || 'Could not detect jurisdiction automatically.';
                return;
            }
            // Pre-select the detected profile in the dropdown
            const sel = document.getElementById('ci-jurisdiction-select');
            let matched = false;
            for (let i = 0; i < sel.options.length; i++) {
                if (sel.options[i].value === d.jurisdiction_id) {
                    sel.selectedIndex = i;
                    matched = true;
                    break;
                }
            }
            if (matched) {
                ciLoadJurisdiction();
                // Populate county if detected
                if (d.county) {
                    const countyEl = document.getElementById('ci-jd-county');
                    if (countyEl && !countyEl.value) countyEl.value = d.county;
                }
                const pct = Math.round((d.confidence || 0.5) * 100);
                const reason = d.reason ? ` ‚Äî ${d.reason}` : '';
                statusEl.innerHTML = `‚úì Auto-detected: <strong>${escapeHtml(d.display_name)}</strong> (${pct}% confidence${reason})`;
                statusEl.style.color = '#27ae60';
            } else {
                statusEl.textContent = `Detected: ${d.display_name} (not in dropdown ‚Äî select manually)`;
                statusEl.style.color = '#e67e22';
            }
        } catch(e) {
            statusEl.textContent = 'Auto-detection unavailable.';
            console.warn('CI detect-jurisdiction failed:', e);
        }
    }

    function ciGetConfig() {
        const jdSelect = document.getElementById('ci-jurisdiction-select');
        const jdOpt = jdSelect.options[jdSelect.selectedIndex];
        const jurisdiction = {
            jurisdiction_id: jdSelect.value,
            display_name: jdOpt ? jdOpt.textContent.trim() : 'Custom',
            court: document.getElementById('ci-jd-court').value,
            county: document.getElementById('ci-jd-county').value,
            judge_part: document.getElementById('ci-jd-part').value,
            baseline_framework: jdOpt ? (jdOpt.dataset.framework || '') : '',
            authority_jurisdictions: ['NYS', '2nd Circuit', 'US'],
        };
        return {
            role: document.getElementById('ci-role').value,
            goal_text: document.getElementById('ci-goal').value.trim(),
            budget_per_run_usd: parseFloat(document.getElementById('ci-budget').value) || 10.0,
            max_tier: parseInt(document.getElementById('ci-max-tier').value) || 3,
            jurisdiction,
            notification_email: (document.getElementById('ci-notification-email')?.value || '').trim(),
            notify_on_complete: document.getElementById('ci-notify-complete')?.checked ? 1 : 0,
            notify_on_budget:   document.getElementById('ci-notify-budget')?.checked   ? 1 : 0,
        };
    }

    async function ciSaveDraft() {
        if (!IS_ADVANCED) return;
        try {
            const config = ciGetConfig();
            const r = await apiFetch(apiUrl('/api/ci/runs'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config),
            });
            const d = await r.json();
            if (d.run_id) {
                ciCurrentRunId = d.run_id;
                showToast('Config saved (draft run: ' + d.run_id.substr(0,8) + ')', 'success');
                // Load questions
                await ciLoadQuestions(d.run_id);
            } else {
                showToast(d.error || 'Save failed', 'error');
            }
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function ciStartRun() {
        if (!IS_ADVANCED) return;
        // Save draft first if no run
        if (!ciCurrentRunId) {
            await ciSaveDraft();
        }
        if (!ciCurrentRunId) return;

        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + ciCurrentRunId + '/start'), {
                method: 'POST',
            });
            const d = await r.json();
            if (d.status === 'started') {
                document.getElementById('ci-status-bar').classList.add('visible');
                document.getElementById('ci-cancel-btn').style.display = 'inline-block';
                document.getElementById('ci-run-btn').disabled = true;
                showToast('Case Intelligence run started', 'success');
                ciStartPolling(ciCurrentRunId);
            } else {
                showToast(d.error || 'Failed to start', 'error');
            }
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function ciCancelRun() {
        if (!ciCurrentRunId) return;
        try {
            await apiFetch(apiUrl('/api/ci/runs/' + ciCurrentRunId + '/cancel'), { method: 'POST' });
            showToast('Cancellation signal sent', 'info');
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    function ciStartPolling(runId) {
        if (ciPollTimer) clearInterval(ciPollTimer);
        ciPollTimer = setInterval(() => ciPollStatus(runId), 3000);
        ciPollStatus(runId);
    }

    async function ciPollStatus(runId) {
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + runId + '/status'));
            const d = await r.json();
            ciUpdateStatusBar(d);
            if (['completed', 'failed', 'cancelled', 'budget_blocked'].includes(d.status)) {
                clearInterval(ciPollTimer);
                document.getElementById('ci-cancel-btn').style.display = 'none';
                document.getElementById('ci-run-btn').disabled = false;
                if (d.status === 'completed') {
                    showToast('CI run completed!', 'success');
                } else if (d.status === 'budget_blocked') {
                    showToast('Budget ceiling reached: ' + (d.budget_blocked_note || ''), 'warning');
                } else if (d.status === 'failed') {
                    showToast('Run failed: ' + (d.error_message || 'unknown error'), 'error');
                }
            }
        } catch(e) {
            console.warn('CI poll failed:', e);
        }
    }

    function ciUpdateStatusBar(d) {
        const pct = d.progress_pct || 0;
        const fill = document.getElementById('ci-progress-fill');
        if (fill) {
            fill.style.width = pct + '%';
            fill.className = 'ci-progress-fill' + (d.budget_blocked ? ' blocked' : '');
        }
        const stage = document.getElementById('ci-stage-label');
        if (stage) stage.textContent = d.current_stage || d.status || '‚Äî';
        const cost = document.getElementById('ci-cost-label');
        if (cost) cost.textContent = '$' + (d.cost_so_far_usd || 0).toFixed(2) + ' / $' + (d.budget_per_run_usd || 10).toFixed(2);
        const docs = document.getElementById('ci-docs-label');
        if (docs) docs.textContent = (d.docs_processed || 0) + ' / ' + (d.docs_total || 0) + ' docs';
        const st = document.getElementById('ci-status-label');
        if (st) st.textContent = d.status || '‚Äî';

        // Workers + managers
        const wkLabel = document.getElementById('ci-workers-label');
        if (wkLabel) {
            const mgr = d.active_managers || 0, wkr = d.active_workers || 0;
            if (mgr > 0 || wkr > 0) {
                document.getElementById('ci-workers-val').textContent = mgr + 'mgr ¬∑ ' + wkr + 'wkr';
                wkLabel.style.display = 'inline';
            } else { wkLabel.style.display = 'none'; }
        }
        // Tokens
        const tokLabel = document.getElementById('ci-tokens-label');
        if (tokLabel) {
            const total = (d.tokens_in || 0) + (d.tokens_out || 0);
            if (total > 0) {
                document.getElementById('ci-tokens-val').textContent =
                    total >= 1000 ? (total / 1000).toFixed(1) + 'k' : total;
                tokLabel.style.display = 'inline';
            } else { tokLabel.style.display = 'none'; }
        }
        // Elapsed + ETA
        const elapsed = d.elapsed_seconds || 0;
        const elLabel = document.getElementById('ci-elapsed-label');
        if (elLabel && elapsed > 0) {
            document.getElementById('ci-elapsed-val').textContent =
                elapsed < 60 ? elapsed + 's' : Math.floor(elapsed / 60) + 'm ' + Math.floor(elapsed % 60) + 's';
            elLabel.style.display = 'inline';
        } else if (elLabel) { elLabel.style.display = 'none'; }
        const etaLabel = document.getElementById('ci-eta-label');
        if (etaLabel && elapsed > 0 && pct >= 10 && pct < 100) {
            const remaining = Math.max(0, (elapsed / (pct / 100)) - elapsed);
            document.getElementById('ci-eta-val').textContent =
                remaining < 60 ? Math.round(remaining) + 's' : Math.round(remaining / 60) + 'm';
            etaLabel.style.display = 'inline';
        } else if (etaLabel) { etaLabel.style.display = 'none'; }
    }

    async function ciLoadQuestions(runId) {
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + runId + '/questions'));
            const d = await r.json();
            const qs = d.questions || [];
            const section = document.getElementById('ci-questions-section');
            const list = document.getElementById('ci-questions-list');
            const count = document.getElementById('ci-q-count');
            if (qs.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            count.textContent = '(' + qs.filter(q => q.is_required).length + ' required)';
            list.innerHTML = qs.map(q => `
                <div class="ci-q-item ${q.is_required ? 'required' : ''}">
                    <label>${q.is_required ? '‚òÖ ' : ''}${escapeHtml(q.question)}</label>
                    <input type="text" id="ci-q-${q.id}" placeholder="Your answer..." value="${escapeHtml(q.answer || '')}">
                </div>
            `).join('');
        } catch(e) {
            console.warn('CI load questions failed:', e);
        }
    }

    async function ciSaveAnswers() {
        if (!ciCurrentRunId) return;
        const qs = document.querySelectorAll('[id^="ci-q-"]');
        const answers = {};
        qs.forEach(inp => {
            const qid = inp.id.replace('ci-q-', '');
            if (inp.value.trim()) answers[qid] = inp.value.trim();
        });
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + ciCurrentRunId + '/answers'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ answers }),
            });
            const d = await r.json();
            if (d.status === 'answers_saved') showToast('Answers saved', 'success');
        } catch(e) {
            showToast('Error saving answers: ' + e.message, 'error');
        }
    }

    async function ciProceedWithAssumptions() {
        if (!ciCurrentRunId) return;
        try {
            await apiFetch(apiUrl('/api/ci/runs/' + ciCurrentRunId + '/answers'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ proceed_with_assumptions: true }),
            });
            showToast('Will proceed with assumptions', 'info');
            document.getElementById('ci-questions-section').style.display = 'none';
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    function ciStartNewRun() {
        ciCurrentRunId = null;
        document.getElementById('ci-status-bar').classList.remove('visible');
        document.getElementById('ci-questions-section').style.display = 'none';
    }

    // ‚îÄ‚îÄ Findings sub-tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function ciRefreshRuns() {
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs'));
            const d = await r.json();
            const runs = d.runs || [];
            const sel = document.getElementById('ci-run-selector');
            const prevVal = sel.value;
            sel.innerHTML = '<option value="">‚Äî Select a run ‚Äî</option>';
            runs.forEach(run => {
                const o = document.createElement('option');
                o.value = run.id;
                const date = run.created_at ? run.created_at.substring(0,16).replace('T',' ') : '';
                const ownerNote = run._shared ? ` ¬∑ shared by ${run.owner_name}` :
                                  (run.owner_name && run.user_id !== {{ current_user.id }} ? ` ¬∑ ${run.owner_name}` : '');
                o.textContent = `Run ${run.id.substr(0,8)} ‚Äî ${date} (${run.status})${ownerNote}`;
                o.dataset.status = run.status;
                o.dataset.ownerId = run.user_id;
                sel.appendChild(o);
            });
            if (prevVal && runs.find(r => r.id === prevVal)) sel.value = prevVal;
        } catch(e) {
            console.warn('CI refresh runs failed:', e);
        }
    }

    async function ciLoadFindings() {
        const runId = document.getElementById('ci-run-selector').value;
        const deleteBtn = document.getElementById('ci-delete-run-btn');
        const shareBtn = document.getElementById('ci-share-run-btn');
        if (!runId) {
            document.getElementById('ci-no-findings').style.display = 'block';
            document.getElementById('ci-key-findings-section').style.display = 'none';
            document.getElementById('ci-findings-status').style.display = 'none';
            document.getElementById('ci-run-meta-header').style.display = 'none';
            document.getElementById('ci-report-builder') && (document.getElementById('ci-report-builder').style.display = 'none');
            if (deleteBtn) deleteBtn.style.display = 'none';
            if (shareBtn) shareBtn.style.display = 'none';
            return;
        }
        ciSelectedRunId = runId;
        if (deleteBtn) deleteBtn.style.display = 'inline-block';
        if (shareBtn) shareBtn.style.display = 'inline-block';
        if (ciFindingsPollTimer) clearInterval(ciFindingsPollTimer);

        // First check status
        try {
            const sr = await apiFetch(apiUrl('/api/ci/runs/' + runId + '/status'));
            const sd = await sr.json();
            if (['running', 'queued'].includes(sd.status)) {
                document.getElementById('ci-findings-status').style.display = 'block';
                ciFindingsPollTimer = setInterval(() => ciFindingsPoll(runId), 3000);
                ciFindingsPoll(runId);
                return;
            }
        } catch(e) {}

        // Load full findings
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + runId + '/findings'));
            const d = await r.json();
            ciRenderFindings(d, runId);
        } catch(e) {
            showToast('Error loading findings: ' + e.message, 'error');
        }
    }

    async function ciFindingsPoll(runId) {
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + runId + '/status'));
            const d = await r.json();
            const stage = document.getElementById('ci-f-stage');
            if (stage) stage.textContent = d.current_stage || d.status;
            const cost = document.getElementById('ci-f-cost');
            if (cost) cost.textContent = '$' + (d.cost_so_far_usd || 0).toFixed(2) + ' / $' + (d.budget_per_run_usd || 10).toFixed(2);
            const progress = document.getElementById('ci-f-progress');
            if (progress) progress.style.width = (d.progress_pct || 0) + '%';
            const docs = document.getElementById('ci-f-docs');
            if (docs) docs.textContent = (d.docs_processed || 0) + ' / ' + (d.docs_total || 0) + ' docs';

            if (['completed', 'failed', 'cancelled', 'budget_blocked'].includes(d.status)) {
                clearInterval(ciFindingsPollTimer);
                document.getElementById('ci-findings-status').style.display = 'none';
                if (d.status === 'completed') {
                    ciLoadFindings();
                }
            }
        } catch(e) {}
    }

    async function ciCancelRunFromFindings() {
        if (!ciSelectedRunId) return;
        try {
            await apiFetch(apiUrl('/api/ci/runs/' + ciSelectedRunId + '/cancel'), { method: 'POST' });
            showToast('Cancellation sent', 'info');
        } catch(e) {}
    }

    async function ciDeleteSelectedRun() {
        if (!ciSelectedRunId) return;
        const selector = document.getElementById('ci-run-selector');
        const runLabel = selector ? selector.options[selector.selectedIndex]?.text : ciSelectedRunId;
        if (!confirm(`Permanently delete this run and all its findings?\n\n"${runLabel}"\n\nThis cannot be undone.`)) return;
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + ciSelectedRunId), { method: 'DELETE' });
            const d = await r.json();
            if (!r.ok) { showToast(d.error || 'Delete failed', 'error'); return; }
            showToast('Run deleted', 'success');
            // Remove the option from the selector and reset
            if (selector) {
                const opt = selector.querySelector(`option[value="${ciSelectedRunId}"]`);
                if (opt) opt.remove();
            }
            ciSelectedRunId = null;
            const deleteBtn = document.getElementById('ci-delete-run-btn');
            if (deleteBtn) deleteBtn.style.display = 'none';
            const shareBtn2 = document.getElementById('ci-share-run-btn');
            if (shareBtn2) shareBtn2.style.display = 'none';
            // Reset findings panel
            document.getElementById('ci-no-findings').style.display = 'block';
            document.getElementById('ci-key-findings-section').style.display = 'none';
            document.getElementById('ci-run-meta-header').style.display = 'none';
            document.getElementById('ci-report-builder') && (document.getElementById('ci-report-builder').style.display = 'none');
            if (selector) selector.value = '';
        } catch(e) {
            showToast('Delete failed: ' + e.message, 'error');
        }
    }

    // ‚îÄ‚îÄ Goal Assistant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _ciGoalMessages = [];    // local conversation history
    let _ciGoalThinking = false;

    async function ciOpenGoalAssistant() {
        _ciGoalMessages = [];
        document.getElementById('ci-goal-input').value = '';
        document.getElementById('ci-goal-messages').innerHTML = '';
        document.getElementById('ci-goal-modal').style.display = 'flex';
        // Send an empty first turn so the AI greets with context
        await ciGoalSend('');
    }

    function ciCloseGoalAssistant() {
        document.getElementById('ci-goal-modal').style.display = 'none';
    }

    function _ciGoalRole() { return document.getElementById('ci-role')?.value || 'neutral'; }
    function _ciGoalJurisdiction() {
        const sel = document.getElementById('ci-jurisdiction-select');
        if (sel && sel.selectedIndex > 0) {
            return sel.options[sel.selectedIndex].text;
        }
        return 'Not specified';
    }

    function _ciGoalAppendBubble(role, text, suggestedGoal) {
        const wrap = document.getElementById('ci-goal-messages');
        const isAI = role === 'assistant';
        const div = document.createElement('div');
        div.style.cssText = `display:flex; flex-direction:column; align-items:${isAI ? 'flex-start' : 'flex-end'};`;

        // Bubble
        const bubble = document.createElement('div');
        bubble.style.cssText = `max-width:88%; padding:10px 13px; border-radius:${isAI ? '4px 12px 12px 12px' : '12px 4px 12px 12px'}; font-size:13px; line-height:1.5; white-space:pre-wrap; background:${isAI ? '#f4f0f9' : '#8e44ad'}; color:${isAI ? '#2c3e50' : '#fff'};`;
        bubble.textContent = text;
        div.appendChild(bubble);

        // "Use this goal" button on AI messages that have a suggestion
        if (isAI && suggestedGoal) {
            const btn = document.createElement('button');
            btn.textContent = '‚Üê Use this as my goal';
            btn.style.cssText = 'margin-top:5px; background:#8e44ad; color:white; border:none; border-radius:5px; padding:4px 12px; font-size:12px; font-weight:600; cursor:pointer;';
            btn.onclick = () => {
                document.getElementById('ci-goal').value = suggestedGoal;
                ciCloseGoalAssistant();
                showToast('Goal updated!', 'success');
            };
            div.appendChild(btn);
        }

        wrap.appendChild(div);
        wrap.scrollTop = wrap.scrollHeight;
        return div;
    }

    async function ciGoalSend(overrideText) {
        if (_ciGoalThinking) return;
        const inputEl = document.getElementById('ci-goal-input');
        const text = overrideText !== undefined ? overrideText : inputEl.value.trim();
        // Don't add empty user message on first greeting call (overrideText === '')
        if (text) {
            _ciGoalMessages.push({role: 'user', content: text});
            _ciGoalAppendBubble('user', text, null);
            inputEl.value = '';
        }

        // Thinking indicator
        _ciGoalThinking = true;
        const thinkingDiv = _ciGoalAppendBubble('assistant', '‚Ä¶', null);

        try {
            const r = await apiFetch(apiUrl('/api/ci/goal-assistant'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    messages: _ciGoalMessages,
                    context: {
                        role: _ciGoalRole(),
                        jurisdiction: _ciGoalJurisdiction(),
                        draft_goal: document.getElementById('ci-goal')?.value?.trim() || '',
                    },
                }),
            });
            const d = await r.json();
            thinkingDiv.remove();
            if (!r.ok) {
                _ciGoalAppendBubble('assistant', '‚ö†Ô∏è ' + (d.error || 'Error from AI'), null);
                _ciGoalThinking = false;
                return;
            }
            _ciGoalMessages.push({role: 'assistant', content: d.response});
            _ciGoalAppendBubble('assistant', d.response, d.suggested_goal || null);
        } catch(e) {
            thinkingDiv.remove();
            _ciGoalAppendBubble('assistant', '‚ö†Ô∏è ' + e.message, null);
        }
        _ciGoalThinking = false;
    }

    async function ciOpenShareModal() {
        if (!ciSelectedRunId) return;
        const selector = document.getElementById('ci-run-selector');
        const label = selector?.options[selector.selectedIndex]?.text || ciSelectedRunId;
        document.getElementById('ci-share-run-label').textContent = label;
        document.getElementById('ci-share-username-input').value = '';
        document.getElementById('ci-share-error').style.display = 'none';
        document.getElementById('ci-share-modal').style.display = 'flex';
        await ciRefreshShareList();
    }

    function ciCloseShareModal() {
        document.getElementById('ci-share-modal').style.display = 'none';
    }

    async function ciRefreshShareList() {
        const listEl = document.getElementById('ci-share-list');
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + ciSelectedRunId + '/shares'));
            const d = await r.json();
            if (!r.ok) { listEl.innerHTML = `<div style="color:#e74c3c;font-size:13px;">${escapeHtml(d.error||'Error')}</div>`; return; }
            const shares = d.shares || [];
            if (!shares.length) {
                listEl.innerHTML = '<div style="color:#999;font-size:13px;">No one yet</div>';
                return;
            }
            listEl.innerHTML = shares.map(s => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:5px 2px; border-bottom:1px solid #f0f0f0;">
                    <span style="font-size:13px;">üë§ <strong>${escapeHtml(s.display_name)}</strong> <span style="color:#888;font-size:11px;">(${escapeHtml(s.username)})</span></span>
                    <button onclick="ciRemoveShare(${s.user_id})" style="background:none; border:none; color:#e74c3c; cursor:pointer; font-size:16px; padding:0 4px;" title="Remove access">√ó</button>
                </div>`).join('');
        } catch(e) {
            listEl.innerHTML = `<div style="color:#e74c3c;font-size:13px;">Failed to load</div>`;
        }
    }

    async function ciAddShare() {
        const username = document.getElementById('ci-share-username-input').value.trim();
        const errEl = document.getElementById('ci-share-error');
        errEl.style.display = 'none';
        if (!username) { errEl.textContent = 'Enter a username.'; errEl.style.display = 'block'; return; }
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + ciSelectedRunId + '/shares'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username}),
            });
            const d = await r.json();
            if (!r.ok) { errEl.textContent = d.error || 'Failed'; errEl.style.display = 'block'; return; }
            document.getElementById('ci-share-username-input').value = '';
            showToast(`Run shared with ${d.shared_with}`, 'success');
            await ciRefreshShareList();
        } catch(e) {
            errEl.textContent = e.message; errEl.style.display = 'block';
        }
    }

    async function ciRemoveShare(uid) {
        if (!confirm('Remove this user\'s access?')) return;
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + ciSelectedRunId + '/shares/' + uid), { method: 'DELETE' });
            const d = await r.json();
            if (!r.ok) { showToast(d.error || 'Failed', 'error'); return; }
            showToast('Access removed', 'success');
            await ciRefreshShareList();
        } catch(e) {
            showToast(e.message, 'error');
        }
    }

    function ciRenderFindings(d, runId) {
        document.getElementById('ci-no-findings').style.display = 'none';
        document.getElementById('ci-findings-status').style.display = 'none';
        document.getElementById('ci-key-findings-section').style.display = 'block';
        if (IS_ADVANCED && document.getElementById('ci-report-builder')) {
            document.getElementById('ci-report-builder').style.display = 'block';
        }

        // ‚îÄ‚îÄ Run metadata header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const meta = d.run_meta || {};
        if (meta && Object.keys(meta).length) {
            document.getElementById('ci-run-meta-header').style.display = 'block';
            document.getElementById('ci-meta-run-by').textContent  = meta.run_by || '‚Äî';
            document.getElementById('ci-meta-role').textContent    = meta.role || '‚Äî';
            document.getElementById('ci-meta-duration').textContent = meta.duration || '‚Äî';
            document.getElementById('ci-meta-goal').textContent    = meta.goal_text || '‚Äî';
            document.getElementById('ci-meta-docs').textContent    =
                meta.docs_total ? `${meta.docs_total} documents` : '‚Äî';
            document.getElementById('ci-meta-cost').textContent    =
                meta.cost_usd != null ? `$${parseFloat(meta.cost_usd).toFixed(4)}` : '‚Äî';
            const started = meta.created_at ? meta.created_at.substring(0,16).replace('T',' ') : '‚Äî';
            document.getElementById('ci-meta-started').textContent = started;
        }

        // Key findings from summary
        const kf = document.getElementById('ci-key-findings-list');
        const summary = d.findings_summary;
        if (summary && summary.key_findings) {
            kf.innerHTML = summary.key_findings.map(f => `
                <div class="ci-finding-item">
                    <span class="severity-badge ${f.severity || 'medium'}">${(f.severity || 'medium').toUpperCase()}</span>
                    <strong>${escapeHtml(f.finding || '')}</strong>
                    <p style="font-size:12px; color:#555; margin:4px 0 0 0;">${escapeHtml(f.detail || '')}</p>
                    ${f.recommended_action ? '<p style="font-size:11px; color:#2980b9; margin:4px 0 0 0;">‚Üí ' + escapeHtml(f.recommended_action) + '</p>' : ''}
                </div>
            `).join('');
            document.getElementById('ci-key-findings-count').textContent = '(' + (summary.key_findings.length) + ')';
        } else {
            kf.innerHTML = `<div style="background:#fff8f0; border:1px solid #f0d090; border-radius:6px; padding:12px 16px; font-size:12px; color:#666;">
                <strong style="color:#b8860b;">Key findings summary was not generated for this run.</strong>
                This section is synthesized by the Director LLM from entities, contradictions, and theories.
                If this run completed but shows nothing here, the Director synthesis step may have failed or been skipped.
                <br><br>Try running again with a more specific <em>Goal</em> ‚Äî e.g.: <em>"Identify all financial transactions made by the receiver and whether they were authorized by the court order."</em>
            </div>`;
        }

        // Timeline
        const tl = document.getElementById('ci-timeline-list');
        const events = d.timeline || [];
        document.getElementById('ci-timeline-count').textContent = '(' + events.length + ')';
        tl.innerHTML = events.length ? events.map(ev => `
            <div class="ci-finding-item">
                <span class="severity-badge ${ev.significance || 'medium'}">${ev.event_type || 'event'}</span>
                <strong>${escapeHtml(ev.event_date || 'Date unknown')}</strong>
                ‚Äî ${escapeHtml(ev.description || '')}
            </div>
        `).join('') : '<p style="color:#888; font-size:13px;">No timeline events.</p>';

        // Entities
        const el = document.getElementById('ci-entities-list');
        const entities = d.entities || [];
        document.getElementById('ci-entities-count').textContent = '(' + entities.length + ')';
        el.innerHTML = entities.length ? `<table style="width:100%; border-collapse:collapse; font-size:12px;">
            <tr style="background:#ecf0f1;"><th style="padding:5px 8px; text-align:left;">Type</th><th style="padding:5px 8px; text-align:left;">Name</th><th style="padding:5px 8px; text-align:left;">Role</th></tr>
            ${entities.map(e => `<tr style="border-top:1px solid #f0f0f0;">
                <td style="padding:4px 8px;">${escapeHtml(e.entity_type || '')}</td>
                <td style="padding:4px 8px; font-weight:600;">${escapeHtml(e.name || '')}</td>
                <td style="padding:4px 8px; color:#666;">${escapeHtml(e.role_in_case || '')}</td>
            </tr>`).join('')}
        </table>` : '<p style="color:#888; font-size:13px;">No entities extracted.</p>';

        // Disputed facts
        const df = document.getElementById('ci-disputed-list');
        const disputed = d.disputed_facts || [];
        document.getElementById('ci-disputed-count').textContent = '(' + disputed.length + ')';
        df.innerHTML = disputed.length ? disputed.map(f => `
            <div class="ci-finding-item">
                <strong>${escapeHtml(f.fact_description || '')}</strong>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px; font-size:12px;">
                    <div><span style="color:#e74c3c; font-weight:600;">${escapeHtml(f.position_a_label || 'Position A')}:</span><br>${escapeHtml(f.position_a_text || '‚Äî')}</div>
                    <div><span style="color:#2980b9; font-weight:600;">${escapeHtml(f.position_b_label || 'Position B')}:</span><br>${escapeHtml(f.position_b_text || '‚Äî')}</div>
                </div>
            </div>
        `).join('') : `<div style="background:#f8f8ff; border:1px solid #c8d0e8; border-radius:6px; padding:12px 16px; font-size:12px; color:#666;">
            <strong style="color:#555;">No disputed facts were identified in this run.</strong>
            The Disputed Facts Matrix requires at least two documents with conflicting positions on the same fact.
            <br><br><em>Suggestions for next run:</em> Try a goal focused on a specific dispute ‚Äî e.g.:
            <em>"What is each party's position on the amount owed under the mortgage and what documents support each position?"</em>
        </div>`;

        // Contradictions
        const cl = document.getElementById('ci-contradictions-list');
        const contradictions = d.contradictions || [];
        document.getElementById('ci-contradictions-count').textContent = '(' + contradictions.length + ')';
        cl.innerHTML = contradictions.length ? contradictions.map(c => `
            <div class="ci-finding-item">
                <span class="severity-badge ${c.severity || 'medium'}">${(c.severity || 'medium').toUpperCase()}</span>
                ${escapeHtml(c.description || '')}
                ${c.explanation ? '<p style="font-size:12px; color:#555; margin:4px 0 0 0;">' + escapeHtml(c.explanation) + '</p>' : ''}
                ${c.suggested_action ? '<p style="font-size:11px; color:#2980b9; margin:3px 0 0 0;">‚Üí ' + escapeHtml(c.suggested_action) + '</p>' : ''}
            </div>
        `).join('') : '<p style="color:#888; font-size:13px;">No contradictions detected.</p>';

        // Theories
        const thList = document.getElementById('ci-theories-list');
        const theories = d.theories || [];
        const docMap = d.doc_map || {};
        document.getElementById('ci-theories-count').textContent = '(' + theories.length + ')';

        function ciEvidenceCards(jsonStr, docMap, isCounter) {
            let items = [];
            try { items = JSON.parse(jsonStr || '[]'); } catch(e) { return ''; }
            if (!items || !items.length) return '';
            const color  = isCounter ? '#c0392b' : '#27ae60';
            const icon   = isCounter ? 'üî¥' : 'üü¢';
            const label  = isCounter ? 'Counter Evidence' : 'Supporting Evidence';
            const cards  = items.map(ev => {
                const did  = ev.paperless_doc_id;
                const info = did ? (docMap[did] || {}) : {};
                const titleTxt = info.title || (did ? `Document #${did}` : 'Unspecified document');
                const titleEl  = did
                    ? `<a href="https://www.voipguru.org/paperless/documents/${did}" target="_blank"
                          style="color:#2980b9; text-decoration:none; font-weight:600;"
                          title="Open in Paperless">üìÑ ${escapeHtml(titleTxt)}</a> <span style="color:#aaa; font-size:10px;">#${did}</span>`
                    : `<span style="font-weight:600; color:#555;">üìÑ ${escapeHtml(titleTxt)}</span>`;
                const summaryEl = info.summary
                    ? `<div style="font-size:10px; color:#777; margin:2px 0 4px 0; font-style:italic;">${escapeHtml(info.summary.substring(0,200))}‚Ä¶</div>`
                    : '';
                const excerptEl = ev.excerpt
                    ? `<div style="font-size:11px; background:#f9f9f9; border-left:3px solid ${color}; padding:4px 8px; margin:4px 0; color:#333;">"${escapeHtml(ev.excerpt)}"</div>`
                    : '';
                const reasonKey = isCounter ? 'how_it_undermines' : 'how_it_supports';
                const reasonEl  = ev[reasonKey]
                    ? `<div style="font-size:11px; color:#555; margin:2px 0;">${escapeHtml(ev[reasonKey])}</div>`
                    : '';
                const pageEl = ev.page_number ? `<span style="font-size:10px; color:#aaa;"> ‚Äî p.${ev.page_number}</span>` : '';
                return `<div style="border:1px solid #e8e8e8; border-radius:5px; padding:8px 10px; margin:5px 0; background:#fff;">
                    ${titleEl}${pageEl}${summaryEl}${excerptEl}${reasonEl}
                </div>`;
            }).join('');
            return `<div style="margin-top:10px;">
                <div style="font-size:11px; font-weight:700; color:${color}; margin-bottom:4px;">${icon} ${label}</div>
                ${cards}
            </div>`;
        }

        thList.innerHTML = theories.length ? theories.map((t, idx) => {
            const statusColor = t.status === 'supported' ? '#27ae60' : t.status === 'refuted' ? '#c0392b' : '#e67e22';
            const confPct = Math.round((t.confidence || 0.5) * 100);
            const suppHtml    = ciEvidenceCards(t.supporting_evidence, docMap, false);
            const counterHtml = ciEvidenceCards(t.counter_evidence,    docMap, true);
            const panelId = `ci-theory-body-${idx}`;
            return `
            <div style="border:1px solid #dde3ec; border-radius:8px; margin-bottom:10px; overflow:hidden;">
                <div onclick="document.getElementById('${panelId}').style.display = document.getElementById('${panelId}').style.display==='none'?'block':'none'"
                     style="display:flex; align-items:flex-start; gap:10px; padding:12px 14px; cursor:pointer; background:#fafbfc;">
                    <div style="flex-shrink:0; min-width:80px; text-align:center;">
                        <div style="font-weight:700; font-size:13px; color:${statusColor};">${(t.status || 'pending').toUpperCase()}</div>
                        <div style="font-size:20px; font-weight:800; color:${statusColor};">${confPct}%</div>
                        <div style="font-size:10px; color:#888; text-transform:uppercase;">${escapeHtml(t.theory_type || '')}</div>
                    </div>
                    <div style="flex:1; font-size:13px; color:#1a2535; line-height:1.5;">${escapeHtml(t.theory_text || '')}</div>
                    <div style="flex-shrink:0; font-size:18px; color:#aaa;">‚Ä∫</div>
                </div>
                <div id="${panelId}" style="display:none; padding:12px 14px; border-top:1px solid #eee; background:#fff;">
                    ${suppHtml}
                    ${counterHtml}
                    ${t.falsification_report ? `<div style="margin-top:10px;">
                        <div style="font-size:11px; font-weight:700; color:#e67e22; margin-bottom:4px;">‚öîÔ∏è Adversarial Test</div>
                        <div style="font-size:12px; color:#555; line-height:1.5;">${escapeHtml(t.falsification_report)}</div>
                    </div>` : ''}
                    ${t.what_would_change ? `<div style="margin-top:10px; padding:8px 10px; background:#fffbf0; border:1px solid #f0d060; border-radius:5px;">
                        <div style="font-size:11px; font-weight:700; color:#b8860b; margin-bottom:3px;">üí° What Would Strengthen This Theory</div>
                        <div style="font-size:12px; color:#555; line-height:1.5;">${escapeHtml(t.what_would_change)}</div>
                    </div>` : ''}
                </div>
            </div>`;
        }).join('') : '<p style="color:#888; font-size:13px;">No theories generated.</p>';

        // Authorities
        const authList = document.getElementById('ci-authorities-list');
        const auths = d.authorities || [];
        document.getElementById('ci-authorities-count').textContent = '(' + auths.length + ')';
        authList.innerHTML = auths.length ? `<table style="width:100%; border-collapse:collapse; font-size:12px;">
            <tr style="background:#ecf0f1;"><th style="padding:5px 8px; text-align:left;">Citation</th><th style="padding:5px 8px; text-align:left;">Type</th><th style="padding:5px 8px; text-align:left;">Relevance</th></tr>
            ${auths.map(a => `<tr style="border-top:1px solid #f0f0f0;">
                <td style="padding:4px 8px; font-weight:600;">${escapeHtml(a.citation || '')}</td>
                <td style="padding:4px 8px;">${escapeHtml(a.authority_type || '')}</td>
                <td style="padding:4px 8px; color:#666; font-size:11px;">${escapeHtml(a.relevance_note || '')}</td>
            </tr>`).join('')}
        </table>` : `<div style="background:#f8f8ff; border:1px solid #c8d0e8; border-radius:6px; padding:12px 16px; font-size:12px; color:#666;">
            <strong style="color:#555;">No legal authorities were retrieved for this run.</strong>
            Legal authority retrieval requires a Cohere API key to be configured and an authority corpus to be indexed.
            <br><br>If Cohere is not configured, authorities will always be empty. To enable: add <code>COHERE_API_KEY</code> to the container environment and ingest an authority corpus via the authority ingester.
        </div>`;
    }

    // ‚îÄ‚îÄ Report builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let ciCurrentReportId = null;
    let ciReportPollTimer = null;

    async function ciGenerateReport() {
        if (!IS_ADVANCED || !ciSelectedRunId) return;
        const instructions = document.getElementById('ci-report-instructions').value.trim();
        if (!instructions) { showToast('Please enter report instructions', 'warning'); return; }
        const template = document.getElementById('ci-report-template').value;

        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + ciSelectedRunId + '/reports'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ instructions, template }),
            });
            const d = await r.json();
            if (d.report_id) {
                ciCurrentReportId = d.report_id;
                document.getElementById('ci-report-status').style.display = 'block';
                document.getElementById('ci-report-status').textContent = 'Generating report...';
                document.getElementById('ci-report-preview-section').style.display = 'none';
                if (ciReportPollTimer) clearInterval(ciReportPollTimer);
                ciReportPollTimer = setInterval(() => ciPollReport(ciSelectedRunId, ciCurrentReportId), 3000);
            } else {
                showToast(d.error || 'Failed to start report generation', 'error');
            }
        } catch(e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function ciPollReport(runId, reportId) {
        try {
            const r = await apiFetch(apiUrl('/api/ci/runs/' + runId + '/reports/' + reportId));
            const d = await r.json();
            if (d.status === 'complete' && d.content) {
                clearInterval(ciReportPollTimer);
                document.getElementById('ci-report-status').textContent = 'Report ready!';
                document.getElementById('ci-report-preview-section').style.display = 'block';
                document.getElementById('ci-report-preview').textContent = d.content.substring(0, 2000) + (d.content.length > 2000 ? '\n\n[... truncated for preview ...]' : '');
                const pdfLink = document.getElementById('ci-report-pdf-link');
                pdfLink.style.display = 'inline';
                pdfLink.href = apiUrl('/api/ci/runs/' + runId + '/reports/' + reportId + '/pdf');
            } else if (d.status === 'failed') {
                clearInterval(ciReportPollTimer);
                document.getElementById('ci-report-status').textContent = 'Report generation failed.';
            }
        } catch(e) {}
    }

    // ‚îÄ‚îÄ Tab open hook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _origSwitchTab = window.switchTab;
    if (_origSwitchTab) {
        window.switchTab = function(tab) {
            _origSwitchTab(tab);
            if (tab === 'case-intelligence') {
                ciLoadJurisdictions().then(() => ciDetectJurisdiction());
                ciRefreshRuns();
            }
        };
    }

    function escapeHtml(s) {
        if (!s) return '';
        return String(s)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;');
    }

    </script>
    {% endif %}

    {% if COURT_IMPORT_ENABLED %}
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         COURT DOCUMENT IMPORTER ‚Äî v3.5.0
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
    // ‚îÄ‚îÄ AIFormFiller widget ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Reusable class: auto-fills any form from free-form pasted text via AI.
    // Drop this class + POST /api/ai-form/parse into any Flask project for the
    // same behaviour on any form.
    class AIFormFiller {
        static _count = 0;

        constructor({ schema, fields, container, endpoint, onComplete, projectSlug } = {}) {
            this._id         = 'aff' + (++AIFormFiller._count);
            this._schema     = schema || [];
            this._fields     = fields || {};        // {apiFieldName: '#css-selector'}
            this._container  = typeof container === 'string'
                               ? document.querySelector(container) : container;
            this._endpoint   = endpoint;
            this._onComplete = onComplete || null;
            this._slug       = projectSlug;         // string or function
            this._conversation = [];
            this._els        = {};
        }

        _pfx(s) { return `${this._id}-${s}`; }

        _currentSlug() {
            if (typeof this._slug === 'function') return this._slug();
            return this._slug || (typeof CURRENT_PROJECT !== 'undefined' ? CURRENT_PROJECT : 'default');
        }

        render() {
            if (!this._container) return;
            this._container.innerHTML = `
                <p style="color:#6b7280; margin-bottom:10px; font-size:13px;">
                    Paste an email, Slack message, or any notes that contain the credentials.
                    AI will extract the fields and ask follow-up questions if needed.
                </p>
                <textarea id="${this._pfx('paste')}"
                          placeholder="Paste text here ‚Äî e.g. a Slack message, email, or attorney notes\u2026"
                          style="width:100%; box-sizing:border-box; height:90px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; resize:vertical; margin-bottom:8px;"></textarea>
                <button id="${this._pfx('parse-btn')}"
                        style="padding:7px 14px; background:#2563eb; color:#fff; border:none; border-radius:5px; cursor:pointer; font-size:13px; margin-bottom:10px;">\uD83E\uDD16 Parse with AI</button>
                <div id="${this._pfx('chat')}" style="display:none; max-height:240px; overflow-y:auto; margin-bottom:8px; padding:2px;">
                    <div id="${this._pfx('msgs')}"></div>
                </div>
                <div id="${this._pfx('reply-row')}" style="display:none; gap:6px; align-items:center; margin-bottom:4px;">
                    <input type="text" id="${this._pfx('reply')}" placeholder="Type your answer\u2026"
                           style="flex:1; padding:7px 10px; border:1px solid #d1d5db; border-radius:5px; font-size:13px;">
                    <button id="${this._pfx('send-btn')}"
                            style="padding:7px 12px; background:#2563eb; color:#fff; border:none; border-radius:5px; cursor:pointer; font-size:13px; white-space:nowrap;">Send \u2192</button>
                </div>
            `;
            this._els.paste    = document.getElementById(this._pfx('paste'));
            this._els.parseBtn = document.getElementById(this._pfx('parse-btn'));
            this._els.chat     = document.getElementById(this._pfx('chat'));
            this._els.msgs     = document.getElementById(this._pfx('msgs'));
            this._els.replyRow = document.getElementById(this._pfx('reply-row'));
            this._els.reply    = document.getElementById(this._pfx('reply'));
            this._els.sendBtn  = document.getElementById(this._pfx('send-btn'));

            this._els.parseBtn.addEventListener('click', () => this._parse());
            this._els.sendBtn.addEventListener('click', () => this._sendReply());
            this._els.reply.addEventListener('keydown', e => { if (e.key === 'Enter') this._sendReply(); });
        }

        reset() {
            this._conversation = [];
            if (!this._els.paste) return;
            this._els.paste.value            = '';
            this._els.chat.style.display     = 'none';
            this._els.msgs.innerHTML         = '';
            this._els.replyRow.style.display = 'none';
            this._els.reply.value            = '';
        }

        async _parse() {
            const rawText = (this._els.paste?.value || '').trim();
            if (!rawText) { showToast('Paste some text first', 'error'); return; }
            this._conversation = [{
                role: 'user',
                content: `Please extract the required fields from this text:\n\n${rawText}`
            }];
            this._renderBubbles();
            this._els.replyRow.style.display = 'none';
            await this._call();
        }

        async _sendReply() {
            const text = (this._els.reply?.value || '').trim();
            if (!text) return;
            this._conversation.push({ role: 'user', content: text });
            this._els.reply.value            = '';
            this._els.replyRow.style.display = 'none';
            this._renderBubbles();
            await this._call();
        }

        async _call() {
            this._els.chat.style.display = 'block';
            const thinking = document.createElement('div');
            thinking.id = this._pfx('thinking');
            thinking.innerHTML = '<em style="font-size:12px; color:#9ca3af;">\uD83E\uDD16 Thinking\u2026</em>';
            this._els.msgs.appendChild(thinking);
            try {
                const r = await apiFetch(apiUrl(this._endpoint), {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body:    JSON.stringify({
                        schema:       this._schema,
                        conversation: this._conversation,
                        project_slug: this._currentSlug(),
                    })
                });
                const d = await r.json();
                document.getElementById(this._pfx('thinking'))?.remove();
                if (d.error) { showToast('AI: ' + d.error, 'error'); return; }
                this._conversation.push({ role: 'assistant', content: JSON.stringify(d) });
                this._renderBubbles();
                if (d.complete) {
                    this.autofill(d.fields || d);
                } else if (d.follow_up) {
                    this._els.replyRow.style.display = 'flex';
                    this._els.reply.focus();
                }
            } catch(e) {
                document.getElementById(this._pfx('thinking'))?.remove();
                showToast('Parse error: ' + e.message, 'error');
            }
        }

        _renderBubbles() {
            const el = this._els.msgs;
            if (!el) return;
            el.innerHTML = '';
            const PREFIX = 'Please extract the required fields from this text:\n\n';
            this._conversation.forEach(turn => {
                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom:8px;';
                if (turn.role === 'user') {
                    let preview = turn.content;
                    if (preview.startsWith(PREFIX)) {
                        preview = '\uD83D\uDCCB ' + preview.replace(PREFIX, '').slice(0, 80) + (preview.length > 130 ? '\u2026' : '');
                    } else {
                        preview = '\uD83D\uDC64 ' + preview;
                    }
                    div.innerHTML = `<div style="background:#f3f4f6; padding:7px 10px; border-radius:6px; font-size:12px; color:#374151;">${escapeHtml(preview)}</div>`;
                } else {
                    try {
                        const p = JSON.parse(turn.content);
                        let html = `<div style="background:#eff6ff; border:1px solid #bfdbfe; padding:9px 11px; border-radius:6px; font-size:12px; color:#1e40af;">`;
                        html += `<div style="font-weight:600; margin-bottom:4px;">\uD83E\uDD16 ${escapeHtml(p.summary || 'Parsed')}</div>`;
                        if (p.notes) html += `<div style="color:#3b82f6; margin-bottom:4px;">${escapeHtml(p.notes)}</div>`;
                        if (p.complete) {
                            html += `<div style="color:#16a34a; font-weight:600;">\u2713 Fields ready \u2014 review the form below.</div>`;
                        } else if (p.follow_up) {
                            html += `<div style="margin-top:4px; font-style:italic;">${escapeHtml(p.follow_up)}</div>`;
                        }
                        html += '</div>';
                        div.innerHTML = html;
                    } catch {
                        div.innerHTML = `<div style="font-size:12px; color:#6b7280;">${escapeHtml(turn.content)}</div>`;
                    }
                }
                el.appendChild(div);
            });
            el.scrollTop = el.scrollHeight;
        }

        autofill(extractedFields) {
            if (!extractedFields) return;
            Object.entries(this._fields).forEach(([fieldName, selector]) => {
                const val = extractedFields[fieldName];
                if (val == null) return;
                const el = document.querySelector(selector);
                if (el) el.value = String(val);
            });
            if (this._onComplete) this._onComplete(extractedFields);
        }
    }
    // ‚îÄ‚îÄ end AIFormFiller ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    // ‚îÄ‚îÄ Court Import: state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _courtCurrentSystem = 'federal';
    let _courtCurrentCaseId = null;
    let _courtCurrentCaseNumber = '';
    let _courtCurrentCaseTitle = '';
    let _courtDocketEntries = [];
    let _courtImportJobId = null;
    let _courtPollTimer = null;
    let _courtAIFiller = null;             // AIFormFiller instance for the wizard
    const _courtProjectSlug = () => {
        // Prefer the upload tab's project selector (same context), fall back to global
        const sel = document.getElementById('upload-project-select');
        return (sel && sel.value) || CURRENT_PROJECT || 'default';
    };

    // ‚îÄ‚îÄ Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openCourtWizard() {
        document.getElementById('court-wizard-overlay').style.display = 'flex';
        courtWizardStep(1);
        loadCourtCredStatus();
    }
    function closeCourtWizard() {
        document.getElementById('court-wizard-overlay').style.display = 'none';
    }
    function toggleCourtPassword(inputId, btn) {
        const el = document.getElementById(inputId);
        if (!el) return;
        const showing = el.type === 'text';
        el.type = showing ? 'password' : 'text';
        btn.textContent = showing ? 'Show' : 'Hide';
    }
    function toggleNyscefPublic(isPublic) {
        // Pro Se users still need their free NYSCEF account credentials (anonymous
        // searches hit CAPTCHA). We always show the credential fields; just update
        // the hint text to match the account type.
        const desc = document.getElementById('court-wiz-nyscef-cred-desc');
        const userLbl = document.getElementById('court-wiz-nyscef-user-lbl');
        if (desc) desc.textContent = isPublic
            ? 'Enter your free NYSCEF Pro Se account username and password (create one at iapps.courts.state.ny.us/nyscef ‚Üí Unrepresented Litigants ‚Üí Create an Account).'
            : 'Enter your NY Attorney Registration number and e-Filing password.';
        if (userLbl) userLbl.textContent = isPublic ? 'NYSCEF Username' : 'NY Attorney Registration #';
    }
    function courtWizardStep(n) {
        [1,2,3].forEach(i => {
            document.getElementById('court-wizard-step'+i).style.display = (i===n) ? 'block' : 'none';
        });
        if (n === 2) {
            const system = document.querySelector('input[name="court-wizard-system"]:checked')?.value || 'federal';
            _courtCurrentSystem = system;
            document.getElementById('court-wiz-test-result').innerHTML = '';
            // Reset NYSCEF public access toggle
            const pubChk = document.getElementById('court-wiz-nyscef-public');
            if (pubChk) { pubChk.checked = false; toggleNyscefPublic(false); }
            // Lazily init and always reset the AI filler on each entry to step 2
            if (!_courtAIFiller) { _courtAIFiller = _initCourtAIFiller(); }
            _courtAIFiller.reset();
            courtWizEntryMode('manual');
        }
    }

    function courtWizEntryMode(mode) {
        const manBtn  = document.getElementById('court-wiz-tab-manual');
        const pasBtn  = document.getElementById('court-wiz-tab-paste');
        const manPanel = document.getElementById('court-wiz-manual-panel');
        const pasPanel = document.getElementById('court-wiz-paste-panel');
        if (!manBtn || !manPanel) return;

        [['manual', manBtn], ['paste', pasBtn]].forEach(([m, btn]) => {
            const active = m === mode;
            btn.style.color       = active ? '#2563eb' : '#6b7280';
            btn.style.fontWeight  = active ? '600'     : '400';
            btn.style.borderBottom = active ? '2px solid #2563eb' : '2px solid transparent';
        });
        manPanel.style.display = mode === 'manual' ? '' : 'none';
        if (pasPanel) pasPanel.style.display = mode === 'paste' ? '' : 'none';

        if (mode === 'manual') {
            // Re-apply system field visibility
            const fedEl = document.getElementById('court-wizard-federal-fields');
            const nycEl = document.getElementById('court-wizard-nyscef-fields');
            if (fedEl) fedEl.style.display = _courtCurrentSystem === 'federal' ? '' : 'none';
            if (nycEl) nycEl.style.display = _courtCurrentSystem === 'nyscef'  ? '' : 'none';
        }
    }

    async function testCourtCredentials() {
        const system = _courtCurrentSystem;
        const resultEl = document.getElementById('court-wiz-test-result');
        resultEl.innerHTML = '<span style="color:#aaa;">Testing‚Ä¶</span>';
        const body = _buildCredBody(system);
        try {
            const r = await apiFetch(apiUrl('/api/court/credentials/test'), {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            const d = await r.json();
            if (d.ok) {
                resultEl.innerHTML = `<span style="color:#4caf50;">‚úì ${escapeHtml(d.account_info)}</span>`;
            } else {
                resultEl.innerHTML = `<span style="color:#e74c3c;">‚úó ${escapeHtml(d.error)}</span>`;
            }
        } catch(e) {
            resultEl.innerHTML = `<span style="color:#e74c3c;">Error: ${escapeHtml(e.message)}</span>`;
        }
    }

    async function saveCourtCredentials() {
        const system = _courtCurrentSystem;
        const body = _buildCredBody(system);
        try {
            const r = await apiFetch(apiUrl('/api/court/credentials'), {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify(body)
            });
            const d = await r.json();
            if (d.ok) {
                courtWizardStep(3);
                document.getElementById('court-wiz-confirm-msg').innerHTML =
                    `‚úì ${escapeHtml(system.charAt(0).toUpperCase()+system.slice(1))} credentials saved.`;
                loadCourtCredStatus();
            } else {
                showToast(d.error || 'Save failed', 'error');
            }
        } catch(e) {
            showToast('Error: '+e.message, 'error');
        }
    }

    function _buildCredBody(system) {
        const slug = _courtProjectSlug();
        if (system === 'federal') {
            return {
                court_system: 'federal',
                project_slug: slug,
                username: document.getElementById('court-wiz-federal-user').value.trim(),
                password: document.getElementById('court-wiz-federal-pass').value,
                extra_config: {
                    pacer_client_code: document.getElementById('court-wiz-federal-client').value.trim(),
                    courtlistener_api_token: document.getElementById('court-wiz-cl-token').value.trim(),
                }
            };
        } else {
            const _nyscefPublic = document.getElementById('court-wiz-nyscef-public')?.checked || false;
            return {
                court_system: 'nyscef',
                project_slug: slug,
                username: _nyscefPublic ? '' : document.getElementById('court-wiz-nyscef-user').value.trim(),
                password: _nyscefPublic ? '' : document.getElementById('court-wiz-nyscef-pass').value,
                extra_config: {
                    nyscef_county: document.getElementById('court-wiz-nyscef-county').value.trim(),
                    public_only: _nyscefPublic,
                }
            };
        }
    }

    // ‚îÄ‚îÄ AI Paste credential parsing (via AIFormFiller) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function _initCourtAIFiller() {
        const filler = new AIFormFiller({
            schema: [
                { name: 'court_system', label: 'Court System',
                  description: 'Either "federal" (PACER/CourtListener) or "nyscef" (NY state courts)', required: true },
                { name: 'username', label: 'Username',
                  description: 'PACER username (federal) or NY Attorney Registration number (nyscef)' },
                { name: 'password', label: 'Password', description: 'Login password', secret: true },
                { name: 'pacer_client_code', label: 'PACER Client Code',
                  description: 'Optional PACER billing client code (federal only)' },
                { name: 'courtlistener_api_token', label: 'CourtListener API Token',
                  description: 'Optional free token from courtlistener.com for higher rate limits', secret: true },
                { name: 'nyscef_county', label: 'Default NYSCEF County',
                  description: 'Default NY county for NYSCEF filings' },
                { name: 'public_only', label: 'Public Access Only',
                  description: 'Set true if user is a party/defendant/plaintiff (not an attorney) with no credentials ‚Äî works for both federal (CourtListener) and NYSCEF (index number only)' },
            ],
            fields: {
                pacer_client_code:       '#court-wiz-federal-client',
                courtlistener_api_token: '#court-wiz-cl-token',
                nyscef_county:           '#court-wiz-nyscef-county',
            },
            container:   '#court-wiz-paste-panel',
            endpoint:    '/api/ai-form/parse',
            projectSlug: _courtProjectSlug,
            onComplete(fields) {
                // Set court system radio
                if (fields.court_system) {
                    const radio = document.querySelector(`input[name="court-wizard-system"][value="${fields.court_system}"]`);
                    if (radio) radio.checked = true;
                    _courtCurrentSystem = fields.court_system;
                }
                const sys = _courtCurrentSystem || fields.court_system || '';
                // Handle public access flag
                if (fields.public_only) {
                    if (sys === 'nyscef') {
                        const pubChk = document.getElementById('court-wiz-nyscef-public');
                        if (pubChk) { pubChk.checked = true; toggleNyscefPublic(true); }
                    }
                    // For federal public_only, no extra action needed ‚Äî no PACER creds required
                }
                // Route username/password to the correct system's inputs
                if (sys === 'federal') {
                    const u = document.getElementById('court-wiz-federal-user');
                    const p = document.getElementById('court-wiz-federal-pass');
                    if (u && fields.username) u.value = fields.username;
                    if (p && fields.password) p.value = fields.password;
                }
                if (sys === 'nyscef' && !fields.public_only) {
                    const u = document.getElementById('court-wiz-nyscef-user');
                    const p = document.getElementById('court-wiz-nyscef-pass');
                    if (u && fields.username) u.value = fields.username;
                    if (p && fields.password) p.value = fields.password;
                }
                setTimeout(() => {
                    courtWizEntryMode('manual');
                    const msg = fields.public_only
                        ? 'Public access mode set \u2014 click Test Connection to verify, then Save'
                        : 'Fields auto-filled \u2014 review and click Test Connection';
                    showToast(msg, 'info');
                }, 400);
            }
        });
        filler.render();
        return filler;
    }

    function openCourtWizardAIPaste() {
        document.getElementById('court-wizard-overlay').style.display = 'flex';
        // Default to federal; user can change by going back to step 1
        const fedRadio = document.querySelector('input[name="court-wizard-system"][value="federal"]');
        if (fedRadio) fedRadio.checked = true;
        courtWizardStep(2);       // inits/resets filler, shows step 2
        courtWizEntryMode('paste'); // open on the AI Paste tab immediately
        loadCourtCredStatus();
    }

    // ‚îÄ‚îÄ Credential status pills ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function loadCourtCredStatus() {
        const slug = _courtProjectSlug();
        try {
            const r = await apiFetch(apiUrl('/api/court/credentials?project_slug='+encodeURIComponent(slug)));
            const d = await r.json();
            const creds = d.credentials || [];
            ['federal','nyscef'].forEach(sys => {
                const el = document.getElementById('court-cred-pill-'+sys);
                if (!el) return;
                const c = creds.find(x=>x.court_system===sys);
                if (c) {
                    const tested = c.last_tested_at ? (c.last_test_success ? ' ‚úì' : ' ‚úó') : '';
                    el.style.color = c.last_test_success ? '#4caf50' : '#f39c12';
                    el.style.borderColor = c.last_test_success ? '#4caf50' : '#f39c12';
                    el.textContent = `${sys.charAt(0).toUpperCase()+sys.slice(1)}: ${escapeHtml(c.username||'configured')}${tested}`;
                } else {
                    el.style.color = '#888';
                    el.style.borderColor = '#333';
                    el.textContent = `${sys.charAt(0).toUpperCase()+sys.slice(1)} ‚Äî not configured`;
                }
            });
        } catch(e) { /* silently fail */ }
    }

    // ‚îÄ‚îÄ Case Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function searchCourt() {
        const system = document.getElementById('court-system-select').value;
        const caseNum = document.getElementById('court-case-number').value.trim();
        const party   = document.getElementById('court-party-name').value.trim();
        const slug    = _courtProjectSlug();
        if (!caseNum && !party) { showToast('Enter a case number or party name','error'); return; }
        const resultsEl = document.getElementById('court-search-results');
        resultsEl.innerHTML = '<span style="color:#aaa;">Searching‚Ä¶</span>';
        try {
            const r = await apiFetch(apiUrl('/api/court/search'), {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({court_system:system, case_number:caseNum, party_name:party, project_slug:slug})
            });
            const d = await r.json();
            if (d.error) { resultsEl.innerHTML = `<span style="color:#e74c3c;">${escapeHtml(d.error)}</span>`; return; }
            const cases = d.results || [];
            if (!cases.length) { resultsEl.innerHTML = '<span style="color:#aaa;">No results found.</span>'; return; }
            resultsEl.innerHTML = cases.map(c=>`
                <div onclick="loadDocket('${escapeHtml(system)}','${escapeHtml(c.case_id)}','${escapeHtml(c.case_number)}','${escapeHtml(c.case_title.replace(/'/g,"\\'"))}')"
                     style="padding:9px 12px; margin:4px 0; background:#f9fafb; border:1px solid #e5e7eb; border-radius:6px; cursor:pointer; transition:border-color .15s;"
                     onmouseover="this.style.borderColor='#2563eb'; this.style.background='#eff6ff';" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='#f9fafb';">
                    <strong style="color:#1d4ed8; font-size:13px;">${escapeHtml(c.case_number)}</strong>
                    <span style="color:#374151; margin-left:8px; font-size:13px;">${escapeHtml(c.case_title)}</span>
                    <span style="float:right; font-size:11px; color:#9ca3af;">${escapeHtml(c.court)} ¬∑ ${escapeHtml(c.source)}</span>
                </div>
            `).join('');
        } catch(e) { resultsEl.innerHTML = `<span style="color:#e74c3c;">Error: ${escapeHtml(e.message)}</span>`; }
    }

    // ‚îÄ‚îÄ Docket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadDocket(system, caseId, caseNumber, caseTitle) {
        _courtCurrentSystem   = system;
        _courtCurrentCaseId   = caseId;
        _courtCurrentCaseNumber = caseNumber;
        _courtCurrentCaseTitle  = caseTitle;
        const slug = _courtProjectSlug();
        const section = document.getElementById('court-docket-section');
        document.getElementById('court-docket-case-title').textContent = caseTitle || caseNumber;
        document.getElementById('court-docket-meta').textContent = 'Loading docket‚Ä¶';
        document.getElementById('court-docket-tbody').innerHTML = '<tr><td colspan="5" style="padding:12px; color:#aaa;">Loading‚Ä¶</td></tr>';
        document.getElementById('court-import-progress').style.display = 'none';
        section.style.display = 'block';

        try {
            const r = await apiFetch(apiUrl(`/api/court/docket/${encodeURIComponent(system)}/${encodeURIComponent(caseId)}?project_slug=${encodeURIComponent(slug)}`));
            const d = await r.json();
            if (d.error) {
                const isRECAPErr = d.error.includes('RECAP') || d.error.includes('401') ||
                                   d.error.includes('403') || d.error.includes('contributor');
                const isTokenErr = d.error.includes('token') || d.error.includes('Authentication') || isRECAPErr;
                document.getElementById('court-docket-meta').textContent = isTokenErr ? 'RECAP access required' : 'Error: '+d.error;
                if (isTokenErr) {
                    document.getElementById('court-docket-tbody').innerHTML =
                        `<tr><td colspan="5" style="padding:16px 12px;">
                            <div style="color:#92400e; background:#fffbeb; border:1px solid #fcd34d; border-radius:6px; padding:14px 16px; font-size:13px; line-height:1.6;">
                                <strong style="font-size:14px;">&#9888;&#65039; This case has no documents in the RECAP archive</strong><br>
                                <span style="color:#6b7280; font-size:12px;">RECAP only contains documents that were previously accessed by RECAP browser extension users. New cases are PACER-only until someone contributes them.</span>
                                <div style="margin-top:12px; border-top:1px solid #fde68a; padding-top:12px;">
                                    <strong>Option A &mdash; PACER credentials</strong> <em style="color:#6b7280;">(direct access, works immediately)</em><br>
                                    1. Register or log in at <a href="https://pacer.login.uscourts.gov" target="_blank" style="color:#d97706; font-weight:600;">pacer.login.uscourts.gov</a> &mdash; free account, instant approval.<br>
                                    2. Enter your PACER username &amp; password in <strong>&#9881;&#65039; Manage Credentials &rarr; Federal &rarr; PACER</strong>.<br>
                                    3. Re-search the case &mdash; documents will load directly from PACER.
                                </div>
                                <div style="margin-top:12px; border-top:1px solid #fde68a; padding-top:12px;">
                                    <strong>Option B &mdash; RECAP browser extension</strong> <em style="color:#6b7280;">(free, builds public archive)</em><br>
                                    1. Install <a href="https://free.law/recap/" target="_blank" style="color:#d97706; font-weight:600;">the free RECAP extension</a> in Chrome or Firefox.<br>
                                    2. Browse the case in PACER normally &mdash; RECAP automatically donates documents to the public archive.<br>
                                    3. Come back here; documents will appear once contributed.
                                </div>
                            </div>
                        </td></tr>`;
                }
                return;
            }
            _courtDocketEntries = d.entries || [];
            document.getElementById('court-docket-meta').textContent =
                `${_courtDocketEntries.length} documents ¬∑ ${system} ¬∑ ${caseNumber}`;
            document.getElementById('btn-court-import-all').textContent =
                `Import All (${_courtDocketEntries.length} docs)`;
            renderDocket(_courtDocketEntries);
        } catch(e) {
            document.getElementById('court-docket-meta').textContent = 'Error: '+e.message;
        }
    }

    function renderDocket(entries) {
        const tbody = document.getElementById('court-docket-tbody');
        if (!entries.length) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding:12px; color:#aaa;">No docket entries found.</td></tr>';
            return;
        }
        tbody.innerHTML = entries.map(e=>`
            <tr style="border-bottom:1px solid #f3f4f6;">
                <td style="padding:5px 8px;"><input type="checkbox" class="court-doc-check" data-seq="${escapeHtml(e.seq)}"></td>
                <td style="padding:5px 8px; color:#6b7280; white-space:nowrap; font-size:11px;">${escapeHtml(e.seq)}</td>
                <td style="padding:5px 8px; color:#6b7280; white-space:nowrap; font-size:11px;">${escapeHtml(e.date||'')}</td>
                <td style="padding:5px 8px; color:#374151; font-size:12px;">${escapeHtml(e.title||'‚Äî')}</td>
                <td style="padding:5px 8px;">
                    <span style="background:${e.source==='recap'?'#dcfce7':e.source==='pacer'?'#fee2e2':'#dbeafe'}; color:${e.source==='recap'?'#15803d':e.source==='pacer'?'#dc2626':'#1d4ed8'}; border-radius:4px; padding:2px 7px; font-size:11px; font-weight:500;">${escapeHtml(e.source)}</span>
                </td>
            </tr>
        `).join('');
        // Update "Import Selected" button visibility
        document.getElementById('court-docket-tbody').querySelectorAll('.court-doc-check').forEach(cb=>{
            cb.addEventListener('change', _updateImportSelected);
        });
    }

    function filterDocket() {
        const q = document.getElementById('court-docket-filter').value.toLowerCase();
        const src = document.getElementById('court-source-filter').value;
        const filtered = _courtDocketEntries.filter(e=>{
            if (q && !e.title?.toLowerCase().includes(q) && !e.seq?.toLowerCase().includes(q)) return false;
            if (src && e.source !== src) return false;
            return true;
        });
        renderDocket(filtered);
    }

    function courtSelectAll(cb) {
        document.querySelectorAll('.court-doc-check').forEach(c=>{ c.checked = cb.checked; });
        _updateImportSelected();
    }

    function _updateImportSelected() {
        const checked = document.querySelectorAll('.court-doc-check:checked').length;
        const btn = document.getElementById('btn-court-import-selected');
        if (btn) {
            btn.style.display = checked > 0 ? 'inline-flex' : 'none';
            btn.textContent = `Import Selected (${checked})`;
        }
    }

    // ‚îÄ‚îÄ Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function startCourtImport(importAll) {
        if (!_courtCurrentCaseId) { showToast('No case selected', 'error'); return; }
        const slug = _courtProjectSlug();
        const progressEl = document.getElementById('court-import-progress');
        progressEl.style.display = 'block';
        document.getElementById('court-import-bar').style.width = '0%';
        document.getElementById('court-import-counters').textContent = 'Starting‚Ä¶';
        document.getElementById('court-import-log').textContent = '';

        try {
            const r = await apiFetch(apiUrl('/api/court/import/start'), {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    court_system:  _courtCurrentSystem,
                    case_id:       _courtCurrentCaseId,
                    case_number:   _courtCurrentCaseNumber,
                    case_title:    _courtCurrentCaseTitle,
                    project_slug:  slug,
                })
            });
            const d = await r.json();
            if (d.error) { showToast(d.error, 'error'); return; }
            _courtImportJobId = d.job_id;
            if (_courtPollTimer) clearInterval(_courtPollTimer);
            _courtPollTimer = setInterval(()=>pollCourtImport(_courtImportJobId), 2000);
        } catch(e) {
            showToast('Error: '+e.message, 'error');
        }
    }

    async function pollCourtImport(jobId) {
        try {
            const r = await apiFetch(apiUrl(`/api/court/import/status/${jobId}?log_lines=20`));
            const d = await r.json();
            if (d.error) { clearInterval(_courtPollTimer); return; }

            const total = d.total_docs || 1;
            const done  = (d.imported_docs||0) + (d.skipped_docs||0) + (d.failed_docs||0);
            const pct   = total > 0 ? Math.round(done/total*100) : 0;
            document.getElementById('court-import-bar').style.width = pct + '%';
            document.getElementById('court-import-counters').innerHTML =
                `${d.imported_docs||0} imported &nbsp;¬∑&nbsp; ${d.skipped_docs||0} skipped &nbsp;¬∑&nbsp; ${d.failed_docs||0} failed &nbsp;¬∑&nbsp; ${pct}%`;

            const logEl = document.getElementById('court-import-log');
            if (d.log_tail && d.log_tail.length) {
                logEl.textContent = d.log_tail.join('\n');
                logEl.scrollTop = logEl.scrollHeight;
            }

            if (['completed','failed','cancelled'].includes(d.status)) {
                clearInterval(_courtPollTimer);
                _courtPollTimer = null;
                document.getElementById('btn-court-cancel').style.display = 'none';
                const color = d.status==='completed' ? '#4caf50' : d.status==='cancelled' ? '#f39c12' : '#e74c3c';
                document.getElementById('court-import-counters').innerHTML +=
                    `&nbsp;&nbsp;<strong style="color:${color};">${d.status.toUpperCase()}</strong>`;
                loadCourtHistory();
            }
        } catch(e) { /* silently continue polling */ }
    }

    async function cancelCourtImport() {
        if (!_courtImportJobId) return;
        try {
            await apiFetch(apiUrl(`/api/court/import/cancel/${_courtImportJobId}`), {method:'POST'});
            showToast('Cancel signal sent', 'info');
        } catch(e) {
            showToast('Error: '+e.message, 'error');
        }
    }

    // ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCourtHistory() {
        const slug = _courtProjectSlug();
        const el = document.getElementById('court-history-table');
        if (!el) return;
        try {
            const r = await apiFetch(apiUrl(`/api/court/import/history?project_slug=${encodeURIComponent(slug)}&limit=20`));
            const d = await r.json();
            const jobs = d.jobs || [];
            if (!jobs.length) { el.innerHTML = '<span style="color:#555;">No import jobs yet.</span>'; return; }
            const statusColor = {completed:'#16a34a', failed:'#dc2626', cancelled:'#d97706', running:'#2563eb', queued:'#6b7280'};
            el.innerHTML = `<table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead><tr style="background:#f6f8fa; color:#6b7280; text-transform:uppercase; font-size:11px; text-align:left;">
                    <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">Case</th>
                    <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">System</th>
                    <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:right;">‚Üë Skip ‚úó</th>
                    <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">Date</th>
                    <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">Status</th>
                    <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb; text-align:center;">Actions</th>
                </tr></thead>
                <tbody>
                ${jobs.map(j=>`<tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:6px 8px; color:#374151; font-weight:500;" title="${escapeHtml(j.case_title||'')}">
                        ${escapeHtml(j.case_number)}</td>
                    <td style="padding:6px 8px; color:#6b7280;">${escapeHtml(j.court_system)}</td>
                    <td style="padding:6px 8px; text-align:right; white-space:nowrap;">
                        <span style="color:#16a34a;">${j.imported_docs||0}</span>&nbsp;
                        <span style="color:#d97706;">${j.skipped_docs||0}</span>&nbsp;
                        <span style="color:#dc2626;">${j.failed_docs||0}</span>
                    </td>
                    <td style="padding:6px 8px; color:#9ca3af;">
                        ${escapeHtml((j.created_at||'').split('T')[0])}</td>
                    <td style="padding:6px 8px;">
                        <span style="color:${statusColor[j.status]||'#6b7280'}; font-weight:500;">${escapeHtml(j.status)}</span>
                    </td>
                    <td style="padding:6px 8px; text-align:center;">
                        <button style="padding:3px 10px; font-size:11px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:4px; cursor:pointer;"
                            onclick="loadDocket('${escapeHtml(j.court_system)}','${escapeHtml(j.case_number)}','${escapeHtml(j.case_number)}','${escapeHtml((j.case_title||'').replace(/'/g,"\\'"))}')">
                            ‚Ü∫ Sync Again
                        </button>
                    </td>
                </tr>`).join('')}
                </tbody></table>`;
        } catch(e) { el.innerHTML = `<span style="color:#e74c3c;">Error: ${escapeHtml(e.message)}</span>`; }
    }
    </script>
    {% endif %}

    <!-- Tag Evidence Modal -->
    <div id="tag-evidence-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-doc-title">Tag Evidence</h2>
                <button class="modal-close" onclick="closeTagModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-evidence-body">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal">
        <div class="share-modal-box">
            <h3>üîó Share this Chat</h3>
            <div class="share-input-row">
                <input type="text" id="share-username-input" placeholder="Enter username to share with...">
                <button class="btn btn-primary" onclick="addShare()">Share</button>
            </div>
            <div id="share-error" style="color: #e74c3c; font-size: 13px; margin-bottom: 8px; display:none;"></div>
            <div id="share-list-container">
                <div style="font-size: 13px; color: #666; margin-bottom: 6px;">Currently shared with:</div>
                <div class="share-list" id="share-list">
                    <div style="color: #999; font-size: 13px;">No shares yet</div>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ CI Goal Assistant Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="ci-goal-modal" onclick="if(event.target===this)ciCloseGoalAssistant()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:flex-end; justify-content:center;">
        <div style="background:#fff; border-radius:12px 12px 0 0; width:100%; max-width:640px; height:72vh; display:flex; flex-direction:column; box-shadow:0 -8px 40px rgba(0,0,0,0.25);">
            <!-- Header -->
            <div style="padding:14px 18px 10px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; flex-shrink:0;">
                <div>
                    <div style="font-weight:700; font-size:15px; color:#2c3e50;">‚ú® Goal Assistant</div>
                    <div style="font-size:11px; color:#888; margin-top:1px;">Chat with AI to craft a precise Case Intelligence goal</div>
                </div>
                <button onclick="ciCloseGoalAssistant()" style="background:none; border:none; font-size:20px; color:#888; cursor:pointer; padding:0 4px;">√ó</button>
            </div>
            <!-- Messages -->
            <div id="ci-goal-messages" style="flex:1; overflow-y:auto; padding:14px 18px; display:flex; flex-direction:column; gap:12px;"></div>
            <!-- Input row -->
            <div style="padding:10px 18px 14px; border-top:1px solid #e5e7eb; display:flex; gap:8px; flex-shrink:0;">
                <textarea id="ci-goal-input" rows="2" placeholder="Describe your case or ask for adjustments‚Ä¶"
                    style="flex:1; padding:8px 10px; border:1px solid #ddd; border-radius:6px; font-size:13px; resize:none; font-family:inherit;"
                    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();ciGoalSend();}"></textarea>
                <button onclick="ciGoalSend()" style="background:#8e44ad; color:white; border:none; border-radius:6px; padding:0 16px; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap;">Send</button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ CI Run Share Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="ci-share-modal" onclick="if(event.target===this)ciCloseShareModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; border-radius:10px; padding:28px; width:100%; max-width:460px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <h3 style="margin:0 0 6px; font-size:17px; color:#2c3e50;">üë• Share Run</h3>
            <p style="margin:0 0 16px; font-size:13px; color:#666;" id="ci-share-run-label"></p>
            <div style="display:flex; gap:8px; margin-bottom:8px;">
                <input type="text" id="ci-share-username-input" placeholder="Username to share with‚Ä¶"
                       style="flex:1; padding:8px 10px; border:1px solid #ddd; border-radius:5px; font-size:13px;"
                       onkeydown="if(event.key==='Enter')ciAddShare()">
                <button class="btn" onclick="ciAddShare()" style="background:#8e44ad; color:white; white-space:nowrap;">Add</button>
            </div>
            <div id="ci-share-error" style="color:#e74c3c; font-size:12px; margin-bottom:8px; display:none;"></div>
            <div style="font-size:12px; font-weight:600; color:#888; text-transform:uppercase; letter-spacing:.05em; margin-bottom:6px;">Shared with</div>
            <div id="ci-share-list" style="min-height:36px; max-height:200px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; padding:6px 8px; margin-bottom:16px;">
                <div style="color:#999; font-size:13px;">No one yet</div>
            </div>
            <div style="text-align:right;">
                <button class="btn" onclick="ciCloseShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ About Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="about-modal" onclick="if(event.target===this)closeAboutModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#243447; border-radius:12px; padding:36px 36px 28px; width:100%; max-width:480px; box-shadow:0 10px 40px rgba(0,0,0,0.6); color:#cdd4dc;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                <div>
                    <h2 style="color:#fff; margin:0 0 4px; font-size:20px;">üìÑ Paperless AI Analyzer</h2>
                    <div style="font-size:13px; color:#aabbcc;" id="about-version-line">Loading‚Ä¶</div>
                </div>
                <button onclick="closeAboutModal()" style="background:none; border:none; color:#aabbcc; font-size:22px; cursor:pointer; padding:0; line-height:1;">&times;</button>
            </div>
            <p style="font-size:14px; color:#aabbcc; margin:0 0 18px;">
                Intelligent document analysis, anomaly detection, and AI-powered chat interface for <strong style="color:#cce5ff;">Paperless-ngx</strong>.
            </p>
            <div style="background:rgba(255,255,255,0.06); border-radius:8px; padding:14px 16px; margin-bottom:18px; font-size:13px;">
                <div style="display:grid; grid-template-columns:auto 1fr; gap:6px 16px;" id="about-components">
                    <span style="color:#aabbcc;">Loading‚Ä¶</span>
                </div>
            </div>
            <div style="font-size:12px; color:#8899aa; margin-bottom:18px;" id="about-footer-links">
                <a href="https://github.com/dblagbro/paperless-ai-analyzer" target="_blank" style="color:#7db8f7;">üîó GitHub Repository</a>
                &nbsp;¬∑&nbsp;
                <a href="#" onclick="closeAboutModal(); openBugReportModal(); return false;" style="color:#ffd580;">üêõ Report an Issue</a>
            </div>
            <div style="text-align:right;">
                <button onclick="closeAboutModal()" style="padding:8px 22px; background:#4a90d9; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600;">Close</button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Bug Report Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="bug-report-modal" onclick="if(event.target===this)closeBugReportModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#243447; border-radius:12px; padding:32px; width:100%; max-width:520px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.6);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color:#fff; margin:0; font-size:17px;">üêõ Report an Issue</h3>
                <button onclick="closeBugReportModal()" style="background:none; border:none; color:#aabbcc; font-size:22px; cursor:pointer; padding:0; line-height:1;">&times;</button>
            </div>
            <p style="color:#aabbcc; font-size:13px; margin:0 0 18px;">
                Describe what happened and we'll send a detailed report (including recent logs) to the developer.
            </p>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Severity</label>
                <select id="bug-severity" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
                    <option value="Low">Low ‚Äî Minor cosmetic issue or inconvenience</option>
                    <option value="Medium" selected>Medium ‚Äî Feature not working as expected</option>
                    <option value="High">High ‚Äî Major feature broken</option>
                    <option value="Critical">Critical ‚Äî System unusable / data loss risk</option>
                </select>
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">What were you doing when the problem occurred? <span style="color:#e74c3c;">*</span></label>
                <textarea id="bug-description" rows="5" placeholder="e.g. I clicked the Upload button with a PDF file and the page went blank. No error message appeared." style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Your email <span style="color:#e74c3c;">*</span> <span style="color:#667788;">(required ‚Äî so we can follow up with you)</span></label>
                <input type="email" id="bug-contact-email" placeholder="you@example.com" required style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #556677; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#ffd580; margin-bottom:5px; font-weight:600;">‚ö†Ô∏è HAR file ‚Äî <strong>strongly recommended</strong></label>
                <input type="file" id="bug-har-file" accept=".har,.json" style="width:100%; padding:7px 0; color:#cdd4dc; font-size:13px;">
                <div style="font-size:12px; color:#aabbcc; margin-top:6px; line-height:1.5;">
                    <strong>Please capture a HAR file before closing the browser tab where the issue occurred:</strong><br>
                    Chrome/Edge: F12 ‚Üí Network tab ‚Üí right-click any request ‚Üí <em>"Save all as HAR with content"</em><br>
                    Firefox: F12 ‚Üí Network tab ‚Üí gear icon ‚Üí <em>"Save All As HAR"</em>
                </div>
            </div>
            <div style="margin-bottom:18px; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="bug-include-logs" checked style="cursor:pointer;">
                <label for="bug-include-logs" style="font-size:13px; color:#aabbcc; cursor:pointer;">Include recent server logs in report (recommended)</label>
            </div>
            <div id="bug-report-result" style="display:none; padding:10px 12px; border-radius:5px; font-size:13px; margin-bottom:14px;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeBugReportModal()" style="padding:8px 18px; background:rgba(255,255,255,0.1); color:#ccc; border:1px solid #334455; border-radius:5px; cursor:pointer; font-size:13px;">Cancel</button>
                <button onclick="submitBugReport()" style="padding:8px 22px; background:#e07b00; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600;">üì® Send Report</button>
            </div>
        </div>
    </div>

    </div><!-- end #main-content -->
</div><!-- end #app-layout -->
</body>
</html>
