<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paperless AI Analyzer</title>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }

        header p {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-card.status-running .value {
            color: #27ae60;
        }

        .stat-card.status-warning .value {
            color: #f39c12;
        }

        .stat-card.status-error .value {
            color: #e74c3c;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .recent-item {
            padding: 12px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .recent-item.has-anomalies {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .recent-item.high-risk {
            border-left-color: #f39c12;
            background: #fffbf0;
        }

        .recent-item .title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .recent-item .meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .recent-item .meta span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            background: #ecf0f1;
            color: #2c3e50;
            margin-right: 5px;
        }

        .tag.anomaly {
            background: #e74c3c;
            color: white;
        }

        .tag.ai {
            background: #9b59b6;
            color: white;
        }

        .profile-list {
            list-style: none;
        }

        .profile-list li {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-list li:last-child {
            border-bottom: none;
        }

        .profile-name {
            font-weight: 600;
        }

        .profile-version {
            font-size: 12px;
            color: #666;
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .staging-profile {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .staging-profile .filename {
            font-weight: 600;
            color: #856404;
        }

        .staging-profile .actions {
            margin-top: 8px;
            font-size: 12px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-warning {
            background: #e74c3c;
        }

        .btn-warning:hover {
            background: #c0392b;
        }

        /* Tab Navigation */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tabs-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab-button.active {
            background: white;
            color: #2c3e50;
            border-bottom-color: #3498db;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Configuration sub-tabs */
        .config-sub-nav {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0;
            flex-wrap: wrap;
        }
        .config-sub-btn {
            background: none;
            border: 1px solid transparent;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            padding: 8px 20px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            border-radius: 6px 6px 0 0;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .config-sub-btn:hover { background: #f0f4f8; color: #333; }
        .config-sub-btn.active {
            color: #2980b9;
            border-bottom-color: #2980b9;
            font-weight: 600;
            background: #f8fbff;
        }
        .config-sub-content { display: none; }

        /* ‚îÄ‚îÄ Tab Help Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .tab-help-panel {
            display: none;
            background: #eaf4fb;
            border: 1px solid #b3d9f0;
            border-left: 4px solid #3498db;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 18px;
            font-size: 13px;
            color: #2c3e50;
            animation: fadeIn 0.2s ease;
        }
        .tab-help-panel ul { margin: 6px 0 0 0; padding-left: 18px; }
        .tab-help-panel li { margin-bottom: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .config-sub-content.active { display: block; animation: fadeIn 0.2s; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .actions-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .actions-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .action-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .action-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 150px;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .logs-viewer {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .logs-viewer .log-line {
            margin-bottom: 2px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .logs-viewer .log-line.error {
            color: #f48771;
        }

        .logs-viewer .log-line.warning {
            color: #dcdcaa;
        }

        .logs-viewer .log-line.info {
            color: #4fc1ff;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-bar input, .search-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-bar input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .search-bar input[type="number"] {
            width: 100px;
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }

            .action-group {
                flex-direction: column;
                align-items: stretch;
            }

            .action-group input, .action-group button {
                width: 100%;
            }
        }

        /* Chat Interface Styles */
        .chat-container {
            background: white;
            border-radius: 8px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-header {
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .chat-message.user {
            justify-content: flex-end;
        }

        .chat-message.assistant {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 14px;
        }

        /* Markdown formatting in chat bubbles */
        .message-bubble p {
            margin: 0 0 8px 0;
        }

        .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message-bubble ul,
        .message-bubble ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-bubble li {
            margin: 4px 0;
        }

        .message-bubble strong {
            font-weight: 600;
            color: inherit;
        }

        .message-bubble em {
            font-style: italic;
        }

        .message-bubble code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-bubble pre {
            background: rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-bubble pre code {
            background: none;
            padding: 0;
        }

        .message-bubble table {
            border-collapse: collapse;
            width: 100%;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .message-bubble table th,
        .message-bubble table td {
            border: 1px solid rgba(0, 0, 0, 0.2);
            padding: 6px 10px;
            text-align: left;
        }

        .message-bubble table th {
            background: rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .message-bubble table tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.05);
        }

        .message-bubble blockquote {
            border-left: 3px solid rgba(0, 0, 0, 0.3);
            padding-left: 12px;
            margin: 8px 0;
            font-style: italic;
            opacity: 0.9;
        }

        .message-bubble h1,
        .message-bubble h2,
        .message-bubble h3,
        .message-bubble h4 {
            margin: 12px 0 8px 0;
            font-weight: 600;
        }

        .message-bubble h1 { font-size: 1.4em; }
        .message-bubble h2 { font-size: 1.2em; }
        .message-bubble h3 { font-size: 1.1em; }
        .message-bubble h4 { font-size: 1em; }

        .message-bubble hr {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, 0.2);
            margin: 12px 0;
        }

        .chat-message.user .message-bubble {
            background: #3498db;
            color: white;
        }

        .chat-message.assistant .message-bubble {
            background: white;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .message-meta {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }

        .chat-input-area {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            resize: none;
            overflow-y: auto;
            max-height: 120px;
            line-height: 1.4;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #3498db;
        }

        .chat-send-btn {
            padding: 10px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .chat-send-btn:hover {
            background: #2980b9;
        }

        .chat-send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #95a5a6;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-suggestions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 10px 0;
        }

        .suggestion-chip {
            padding: 6px 12px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Vector Store Management Styles */
        .vector-type-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }

        .vector-type-header {
            background: #f8f9fa;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .vector-type-header h3 {
            margin: 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .vector-type-count {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        .vector-documents-list {
            background: white;
        }

        .vector-doc-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vector-doc-item:last-child {
            border-bottom: none;
        }

        .vector-doc-item:hover {
            background: #f8f9fa;
        }

        .vector-doc-info {
            flex: 1;
        }

        .vector-doc-title {
            font-weight: 500;
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .vector-doc-id {
            font-size: 12px;
            color: #999;
            font-family: monospace;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow: auto;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #2c3e50;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f5f5f5;
            color: #333;
        }

        .modal-body {
            padding: 24px;
        }

        .evidence-item {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .evidence-item.severity-critical {
            border-left-color: #e74c3c;
            background: #fef5f5;
        }

        .evidence-item.severity-high {
            border-left-color: #f39c12;
            background: #fef9f3;
        }

        .evidence-item.severity-medium {
            border-left-color: #f39c12;
            background: #fffef8;
        }

        .evidence-item.severity-low {
            border-left-color: #95a5a6;
            background: #f8f9fa;
        }

        .evidence-tag-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .evidence-severity {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .evidence-severity.critical {
            background: #e74c3c;
            color: white;
        }

        .evidence-severity.high {
            background: #f39c12;
            color: white;
        }

        .evidence-severity.medium {
            background: #f39c12;
            color: white;
        }

        .evidence-severity.low {
            background: #95a5a6;
            color: white;
        }

        .evidence-severity.info {
            background: #3498db;
            color: white;
        }

        .evidence-item.severity-info {
            border-left: 4px solid #3498db;
            background: #f0f9ff;
        }

        .evidence-description {
            font-size: 14px;
            color: #555;
            margin: 8px 0;
            line-height: 1.6;
        }

        .evidence-quotes {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border: 1px solid #e0e0e0;
        }

        .evidence-quotes h4 {
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .evidence-quote {
            font-style: italic;
            color: #444;
            padding: 8px;
            border-left: 3px solid #3498db;
            margin: 6px 0;
            background: #f8f9fa;
        }

        .evidence-location {
            font-size: 12px;
            color: #999;
            font-family: monospace;
            margin-top: 4px;
        }

        .evidence-impact {
            margin-top: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
            color: #555;
        }

        .evidence-impact strong {
            color: #2c3e50;
        }

        .tag.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag.clickable:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0.9;
        }

        .no-evidence {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* ‚îÄ‚îÄ Sidebar layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #app-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #chat-sidebar {
            width: 260px;
            flex-shrink: 0;
            background: #1e2a38;
            color: #cdd4dc;
            display: none;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid #263444;
        }

        #chat-sidebar .sidebar-header {
            padding: 16px 14px 12px;
            border-bottom: 1px solid #263444;
        }

        #chat-sidebar .sidebar-header h3 {
            font-size: 13px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.3px;
            margin-bottom: 10px;
        }

        .btn-new-chat {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 12px;
            background: #2c86d4;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        .btn-new-chat:hover { background: #1a76c4; }

        #session-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        #session-list::-webkit-scrollbar { width: 4px; }
        #session-list::-webkit-scrollbar-thumb { background: #334455; border-radius: 2px; }

        .session-group-header {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #667788;
            padding: 10px 14px 4px;
        }

        .session-item {
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 0;
            transition: background 0.1s;
            position: relative;
        }
        .session-item:hover { background: #263444; }
        .session-item.active { background: #2c3e50; }

        .session-title {
            font-size: 13px;
            color: #d0d8e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            max-width: 180px;
        }
        .session-meta {
            font-size: 11px;
            color: #556677;
            margin-top: 2px;
        }

        .session-badge-shared {
            font-size: 10px;
            background: #2c86d4;
            color: white;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 4px;
        }

        .session-actions {
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            gap: 4px;
        }
        .session-item:hover .session-actions { display: flex; }

        .session-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 4px;
            border-radius: 3px;
            opacity: 0.7;
            transition: opacity 0.1s;
        }
        .session-action-btn:hover { opacity: 1; background: rgba(255,255,255,0.1); }

        .sidebar-footer {
            padding: 12px 14px;
            border-top: 1px solid #263444;
            font-size: 12px;
        }

        .sidebar-user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .role-badge {
            font-size: 10px;
            padding: 1px 7px;
            border-radius: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .role-badge.admin { background: #e74c3c; color: white; }
        .role-badge.basic { background: #3d5166; color: #aabbcc; }

        .btn-logout {
            display: block;
            width: 100%;
            padding: 6px;
            background: none;
            border: 1px solid #334455;
            color: #8899aa;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }
        .btn-logout:hover { background: #263444; color: #cdd4dc; border-color: #4455667; }

        #main-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* ‚îÄ‚îÄ Chat session header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .chat-session-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .chat-session-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-session-actions { display: flex; gap: 8px; }
        .btn-session-action {
            padding: 5px 12px;
            font-size: 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .btn-session-action:hover { background: #f0f0f0; }

        /* ‚îÄ‚îÄ Share modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #share-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        #share-modal.active { display: flex; }
        .share-modal-box {
            background: white;
            border-radius: 10px;
            padding: 28px;
            width: 420px;
            max-width: 96vw;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
        }
        .share-modal-box h3 { margin-bottom: 18px; font-size: 17px; color: #2c3e50; }
        .share-input-row { display: flex; gap: 8px; margin-bottom: 14px; }
        .share-input-row input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .share-list { margin-top: 12px; }
        .share-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 7px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        /* ‚îÄ‚îÄ User management table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .user-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .user-table th, .user-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .user-table th { background: #f8f9fa; font-weight: 600; color: #555; font-size: 12px; text-transform: uppercase; }
        .user-table tr:hover td { background: #fafafa; }
    </style>
</head>
<body>
<div id="app-layout">
    <!-- ‚îÄ‚îÄ Chat Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="chat-sidebar">
        <div class="sidebar-header">
            <h3>üí¨ Chat Sessions</h3>
            <button class="btn-new-chat" onclick="newChat()">+ New Chat</button>
        </div>
        <div id="session-list">
            <div style="padding: 20px 14px; font-size: 12px; color: #556677;">Loading sessions...</div>
        </div>
        <div class="sidebar-footer">
            <div class="sidebar-user-info">
                <span style="color: #cdd4dc; font-weight: 600;">{{ current_user.display_name }}</span>
                <span class="role-badge {{ 'admin' if is_admin else 'basic' }}">{{ 'Admin' if is_admin else 'Basic' }}</span>
            </div>
            <a href="{{ url_for('logout') }}" class="btn-logout">Sign Out</a>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="main-content">
    <header>
        <div class="container" style="display: flex; justify-content: space-between; align-items: center; gap: 20px;">
            <div>
                <h1><span class="status-indicator"></span> Paperless AI Analyzer</h1>
                <p>Intelligent document analysis and anomaly detection</p>
            </div>
            <div style="text-align: right;">
                <label for="project-selector" style="color: white; font-size: 14px; display: block; margin-bottom: 5px;">Current Project:</label>
                <select id="project-selector" onchange="switchProject()" style="padding: 8px 12px; font-size: 14px; border-radius: 4px; border: 1px solid #bdc3c7; min-width: 200px;">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div style="text-align: right; white-space: nowrap; flex-shrink: 0;">
                <div style="color: #cce5ff; font-size: 13px; margin-bottom: 6px;">
                    <strong>{{ current_user.display_name }}</strong>
                    <span style="background: {{ '#e74c3c' if is_admin else '#3498db' }}; color: white; font-size: 11px; padding: 1px 6px; border-radius: 10px; margin-left: 6px;">{{ 'Admin' if is_admin else 'Basic' }}</span>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap;">
                    <button onclick="openAboutModal()" style="background: rgba(255,255,255,0.12); color: #cce5ff; border: 1px solid rgba(255,255,255,0.25); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" title="About this application">‚Ñπ About</button>
                    <button onclick="toggleTabHelp()" id="help-toggle-btn" style="background: rgba(255,255,255,0.12); color: #cce5ff; border: 1px solid rgba(255,255,255,0.25); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" title="Toggle help panel for current tab">? Help: Off</button>
                    <button onclick="openBugReportModal()" style="background: rgba(255,165,0,0.25); color: #ffd580; border: 1px solid rgba(255,165,0,0.4); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;" title="Report a problem">üêõ Report Issue</button>
                    <button onclick="openChangePasswordModal()" style="background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 5px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">üîë Change Password</button>
                    <a href="{{ url_for('logout') }}" style="background: rgba(231,76,60,0.7); color: white; border: 1px solid rgba(231,76,60,0.9); padding: 5px 12px; border-radius: 5px; font-size: 12px; text-decoration: none; display: inline-block;">Sign Out</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Change Password Modal -->
    <div id="change-password-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#243447; border-radius:10px; padding:32px; width:100%; max-width:380px; box-shadow:0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color:#fff; margin:0 0 20px; font-size:16px;">üîë Change Password</h3>
            <div id="cp-error" style="display:none; background:rgba(231,76,60,0.2); border:1px solid rgba(231,76,60,0.5); color:#f08080; padding:8px 12px; border-radius:5px; font-size:13px; margin-bottom:14px;"></div>
            <div id="cp-success" style="display:none; background:rgba(39,174,96,0.2); border:1px solid rgba(39,174,96,0.5); color:#7dcea0; padding:8px 12px; border-radius:5px; font-size:13px; margin-bottom:14px;"></div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Current Password</label>
                <input type="password" id="cp-current" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:14px; box-sizing:border-box;" autocomplete="current-password">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">New Password</label>
                <input type="password" id="cp-new" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:14px; box-sizing:border-box;" autocomplete="new-password">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Confirm New Password</label>
                <input type="password" id="cp-confirm" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:14px; box-sizing:border-box;" autocomplete="new-password">
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeChangePasswordModal()" style="padding:8px 18px; background:rgba(255,255,255,0.1); color:#ccc; border:1px solid #334455; border-radius:5px; cursor:pointer; font-size:13px;">Cancel</button>
                <button onclick="submitChangePassword()" style="padding:8px 18px; background:#4a90d9; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600;">Update Password</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tabbed Interface -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-button active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab-button" onclick="switchTab('projects')">üìÅ Manage Projects</button>
                <button class="tab-button" onclick="switchTab('upload')">üì§ Smart Upload</button>
                <button class="tab-button" onclick="switchTab('ai-chat')">üí¨ AI Chat</button>
                <button class="tab-button" onclick="switchTab('search')">üîç Search & Analysis</button>
                <button class="tab-button" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
                <button class="tab-button" onclick="switchTab('tools')">üõ†Ô∏è Debug & Tools</button>
            </div>

            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="tab-help-panel" id="help-overview">
                    <strong>üìä Overview</strong> ‚Äî At a glance, this tab shows the live status of the analyzer and key stats.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Documents Analyzed</strong> ‚Äî Total documents the AI has processed.</li>
                        <li><strong>Anomalies Detected</strong> ‚Äî Documents flagged with any anomaly (balance mismatch, layout issues, etc.).</li>
                        <li><strong>High Risk</strong> ‚Äî Documents with critical or high-severity anomalies requiring review.</li>
                        <li><strong>Recent Activity</strong> ‚Äî The latest processed documents and their results.</li>
                        <li>Use <em>Configuration ‚Üí AI Settings</em> to connect an AI model if no analysis is running.</li>
                    </ul>
                </div>
                <!-- Status bar moved into Overview tab -->
                <div class="status-bar" style="margin-bottom: 30px;">
                    <div class="stat-card status-running">
                        <h3>Status</h3>
                        <div class="value" id="status">Running</div>
                    </div>
                    <div class="stat-card">
                        <h3>Documents Analyzed</h3>
                        <div class="value" id="total-analyzed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Anomalies Detected</h3>
                        <div class="value" id="anomalies-detected">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>High Risk Documents</h3>
                        <div class="value" id="high-risk-count">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Profiles</h3>
                        <div class="value" id="active-profiles">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Embedded (RAG)</h3>
                        <div class="value" id="embedded-docs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Last Update</h3>
                        <div class="value" id="last-update" style="font-size: 14px;">Never</div>
                    </div>
                </div>

                <h2>Recent Activity</h2>
                <div id="recent-analyses" class="loading">Loading...</div>
            </div>

            <!-- Manage Projects Tab -->
            <div id="tab-projects" class="tab-content">
                <div class="tab-help-panel" id="help-projects">
                    <strong>üìÅ Manage Projects</strong> ‚Äî Projects group related documents so the AI can reason across them together.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>Click <strong>+ New Project</strong> to create a project and give it a name, description, and tags.</li>
                        <li>Use <strong>üì¶ Move Documents</strong> to reassign documents from one project to another.</li>
                        <li>Use <strong>üóÑÔ∏è Archive</strong> to hide completed projects without deleting them.</li>
                        <li>The <strong>Current Project</strong> selector in the header controls which project context the AI Chat uses.</li>
                        <li>Deleting a project removes it from the analyzer but does <em>not</em> delete documents from Paperless.</li>
                    </ul>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div>
                        <h2 style="margin:0 0 4px 0;">üìÅ Manage Projects</h2>
                        <p style="color:#666; margin:0; font-size:14px;">Organize documents into projects for better analysis and cross-document reference checking.</p>
                    </div>
                    <button class="btn btn-primary" onclick="openNewProjectModal()" style="white-space:nowrap;">+ New Project</button>
                </div>

                <div id="projects-list" class="loading">Loading projects...</div>
            </div>

            <!-- ‚îÄ‚îÄ Project New/Edit Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="proj-modal" onclick="if(event.target===this)closeProjModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:10px; padding:28px; width:100%; max-width:480px; box-shadow:0 8px 30px rgba(0,0,0,.2); position:relative;">
                    <h3 id="proj-modal-title" style="margin:0 0 20px 0; color:#111;">New Project</h3>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Name <span style="color:#e74c3c;">*</span></label>
                    <input type="text" id="proj-name" placeholder="e.g. Chase Bank 2026"
                        oninput="autoSlug()"
                        style="width:100%; box-sizing:border-box; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;">

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Slug</label>
                    <input type="text" id="proj-slug" placeholder="auto-generated"
                        style="width:100%; box-sizing:border-box; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:5px; font-family:monospace;">
                    <div style="font-size:11px; color:#9ca3af; margin-bottom:14px;">Lowercase letters, numbers and hyphens only. Cannot be changed after creation.</div>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">Description</label>
                    <textarea id="proj-desc" rows="2" placeholder="Optional description"
                        style="width:100%; box-sizing:border-box; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; resize:vertical; margin-bottom:14px;"></textarea>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:8px;">Color</label>
                    <div id="proj-color-swatches" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:6px;">
                    </div>
                    <input type="color" id="proj-color-custom"
                        style="width:36px; height:28px; border:1px solid #d1d5db; border-radius:4px; cursor:pointer; padding:2px;"
                        onchange="selectCustomColor(this.value)">
                    <span style="font-size:12px; color:#6b7280; margin-left:6px;">or pick custom</span>
                    <input type="hidden" id="proj-color-val" value="#3b82f6">

                    <div id="proj-modal-error" style="display:none; color:#e74c3c; font-size:13px; margin-top:10px;"></div>

                    <div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;">
                        <button onclick="closeProjModal()" style="padding:9px 18px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:14px;">Cancel</button>
                        <button class="btn btn-primary" onclick="saveProject()" id="proj-save-btn" style="padding:9px 20px;">Save</button>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Move Documents Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="move-modal" onclick="if(event.target===this)closeMoveModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:10px; padding:28px; width:100%; max-width:500px; box-shadow:0 8px 30px rgba(0,0,0,.2); position:relative;">
                    <h3 style="margin:0 0 20px 0; color:#111;">Move Documents</h3>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">From project</label>
                    <select id="move-source" onchange="updateMovePreview()"
                        style="width:100%; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;"></select>

                    <label style="display:block; font-weight:600; font-size:13px; margin-bottom:5px;">To project</label>
                    <select id="move-dest" onchange="updateMovePreview()"
                        style="width:100%; padding:9px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;"></select>

                    <div style="margin-bottom:14px;">
                        <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Which documents?</label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:14px; margin-bottom:8px; cursor:pointer;">
                            <input type="radio" name="move-scope" value="all" checked onchange="toggleMoveIds()"> Move <strong id="move-all-count">all</strong> documents in source project
                        </label>
                        <label style="display:flex; align-items:center; gap:8px; font-size:14px; cursor:pointer;">
                            <input type="radio" name="move-scope" value="specific" onchange="toggleMoveIds()"> Specify document IDs
                        </label>
                        <div id="move-ids-wrap" style="display:none; margin-top:8px;">
                            <input type="text" id="move-doc-ids" placeholder="Comma-separated IDs, e.g. 12,45,67"
                                style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
                            <div style="font-size:11px; color:#9ca3af; margin-top:3px;">Find document IDs in Paperless or the Overview tab</div>
                        </div>
                    </div>

                    <div id="move-preview" style="background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px; padding:10px 14px; font-size:13px; color:#0c4a6e; display:none;"></div>

                    <div id="move-modal-error" style="display:none; color:#e74c3c; font-size:13px; margin-top:10px;"></div>
                    <div id="move-modal-status" style="display:none; font-size:13px; margin-top:10px;"></div>

                    <div style="display:flex; gap:10px; margin-top:20px; justify-content:flex-end;">
                        <button onclick="closeMoveModal()" style="padding:9px 18px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:14px;">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmMove()" id="move-confirm-btn" style="padding:9px 20px;">Move Documents</button>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ Delete Confirm Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div id="del-proj-modal" onclick="if(event.target===this)closeDelProjModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; border-radius:10px; padding:28px; width:100%; max-width:420px; box-shadow:0 8px 30px rgba(0,0,0,.2);">
                    <h3 style="margin:0 0 12px 0; color:#b91c1c;">Delete Project</h3>
                    <p style="font-size:14px; color:#374151; margin:0 0 14px 0;">
                        Delete <strong id="del-proj-name"></strong>? This removes the project and its <strong id="del-proj-count"></strong> document(s) from all project tracking.
                    </p>
                    <label style="display:flex; align-items:center; gap:8px; font-size:14px; color:#374151; cursor:pointer; margin-bottom:18px;">
                        <input type="checkbox" id="del-proj-data" checked style="width:15px;height:15px;">
                        Also delete analyzer state &amp; vector data for this project
                    </label>
                    <input type="hidden" id="del-proj-slug">
                    <div id="del-proj-error" style="display:none; color:#e74c3c; font-size:13px; margin-bottom:10px;"></div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button onclick="closeDelProjModal()" style="padding:9px 18px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:14px;">Cancel</button>
                        <button onclick="confirmDeleteProject()" style="padding:9px 18px; background:#dc2626; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">Delete</button>
                    </div>
                </div>
            </div>

            <!-- Smart Upload Tab -->
            <div id="tab-upload" class="tab-content">
                <div class="tab-help-panel" id="help-upload">
                    <strong>üì§ Smart Upload</strong> ‚Äî Upload documents to Paperless directly from this interface.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>File</strong> ‚Äî Drag and drop or browse for a PDF, image, or document file.</li>
                        <li><strong>URL</strong> ‚Äî Paste a direct file link <em>or a folder/directory URL</em>. If the URL points to an HTML directory listing, all compatible files (PDF, images, Word, etc.) are discovered automatically so you can pick which ones to upload. Add Basic Auth credentials if the link requires a login.</li>
                        <li><strong>Cloud Share Link</strong> ‚Äî Paste a Google Drive, Dropbox, or OneDrive share link; it will be converted automatically to a direct download URL.</li>
                        <li>Enable <strong>Smart Metadata</strong> to let the AI suggest a title, tags, and project assignment before uploading.</li>
                        <li>The <strong>Import History</strong> panel below tracks all uploads with their status and Paperless document IDs.</li>
                    </ul>
                </div>
                <h2>üì§ Smart Upload</h2>
                <p style="color: #666; margin-bottom: 20px;">Upload documents to Paperless from a file, URL, or cloud share link.</p>

                <!-- Upload Source Card -->
                <div style="background: white; border: 1px solid #e1e4e8; border-radius: 10px; overflow: hidden; margin-bottom: 24px; box-shadow: 0 1px 4px rgba(0,0,0,.06);">

                    <!-- Mode tabs -->
                    <div style="display: flex; border-bottom: 1px solid #e1e4e8; background: #f6f8fa;">
                        <button id="umode-file" onclick="switchUploadMode('file')"
                            style="flex:1; padding: 12px 0; border: none; background: #fff; border-bottom: 3px solid #2563eb; font-weight: 600; color: #2563eb; cursor: pointer; font-size: 14px;">
                            üìÅ File
                        </button>
                        <button id="umode-url" onclick="switchUploadMode('url')"
                            style="flex:1; padding: 12px 0; border: none; background: transparent; border-bottom: 3px solid transparent; font-weight: 500; color: #555; cursor: pointer; font-size: 14px;">
                            üîó URL
                        </button>
                        <button id="umode-cloud" onclick="switchUploadMode('cloud')"
                            style="flex:1; padding: 12px 0; border: none; background: transparent; border-bottom: 3px solid transparent; font-weight: 500; color: #555; cursor: pointer; font-size: 14px;">
                            ‚òÅÔ∏è Cloud Link
                        </button>
                    </div>

                    <div style="padding: 24px;">

                        <!-- FILE MODE -->
                        <div id="uinput-file">
                            <div id="upload-dropzone"
                                ondragover="event.preventDefault(); this.style.background='#eff6ff'; this.style.borderColor='#2563eb';"
                                ondragleave="this.style.background=''; this.style.borderColor='#cbd5e1';"
                                ondrop="handleDrop(event)"
                                onclick="document.getElementById('upload-file-input').click()"
                                style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all .2s;">
                                <div style="font-size: 36px; margin-bottom: 8px;">üìÑ</div>
                                <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">Drop file here or click to browse</div>
                                <div style="font-size: 12px; color: #9ca3af;">PDF, PNG, JPG, JPEG, DOCX, HEIC</div>
                                <div id="upload-file-name" style="margin-top: 10px; font-size: 13px; color: #2563eb; font-weight:500;"></div>
                            </div>
                            <input type="file" id="upload-file-input"
                                accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.heic"
                                style="display: none;"
                                onchange="document.getElementById('upload-file-name').textContent = this.files[0]?.name || ''">
                        </div>

                        <!-- URL MODE -->
                        <div id="uinput-url" style="display:none;">
                            <label style="display:block; font-weight:600; margin-bottom:6px; color:#374151;">File or Folder URL</label>
                            <input type="url" id="upload-url-input" placeholder="https://example.com/document.pdf  or  https://example.com/docs/"
                                style="width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:14px;">

                            <label style="display:block; font-weight:600; margin-bottom:6px; color:#374151;">Authentication</label>
                            <select id="upload-auth-type" onchange="updateAuthFields()"
                                style="padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:10px;">
                                <option value="none">None</option>
                                <option value="basic">Username / Password</option>
                                <option value="token">Bearer Token</option>
                            </select>
                            <div id="upload-auth-basic" style="display:none; margin-top:8px;">
                                <input type="text" id="upload-auth-user" placeholder="Username"
                                    style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:8px;">
                                <input type="password" id="upload-auth-pass" placeholder="Password"
                                    style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                            </div>
                            <div id="upload-auth-token" style="display:none; margin-top:8px;">
                                <input type="text" id="upload-auth-token-val" placeholder="Bearer token"
                                    style="width:100%; box-sizing:border-box; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px;">
                            </div>
                        </div>

                        <!-- CLOUD LINK MODE -->
                        <div id="uinput-cloud" style="display:none;">
                            <label style="display:block; font-weight:600; margin-bottom:6px; color:#374151;">Cloud Share Link</label>
                            <input type="url" id="upload-cloud-input"
                                placeholder="Paste a Google Drive, Dropbox, or OneDrive share link"
                                style="width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; margin-bottom:8px;">
                            <div id="upload-cloud-detected" style="font-size:12px; color:#6b7280; min-height:18px;"></div>
                        </div>

                        <!-- Smart Metadata toggle -->
                        <div style="margin-top:18px; display:flex; align-items:center; gap:10px;">
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:14px; color:#374151; font-weight:500;">
                                <input type="checkbox" id="upload-smart-meta" style="width:16px; height:16px; accent-color:#2563eb;">
                                Smart Metadata ‚Äî AI analyzes before uploading (shows preview)
                            </label>
                        </div>

                        <!-- Upload button -->
                        <div style="margin-top:20px;">
                            <button class="btn btn-primary" onclick="doUpload()"
                                id="upload-submit-btn"
                                style="padding: 10px 28px; font-size: 15px;">
                                üì§ Upload to Paperless
                            </button>
                        </div>

                        <!-- Status -->
                        <div id="upload-status" style="margin-top: 16px;"></div>

                        <!-- Directory file-list picker (shown when a folder URL is scanned) -->
                        <div id="upload-filelist" style="display:none; margin-top:16px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">
                            <div style="padding:10px 14px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; gap:12px; background:#fff;">
                                <span style="font-weight:600; font-size:13px; color:#374151;">üìÅ <span id="upload-filelist-count">0</span> compatible files found</span>
                                <label style="font-size:12px; color:#6b7280; display:flex; align-items:center; gap:5px; cursor:pointer; margin-left:auto;">
                                    <input type="checkbox" id="upload-filelist-selectall" checked
                                        onchange="toggleSelectAllFiles(this.checked)"
                                        style="width:13px; height:13px;">
                                    Select all
                                </label>
                            </div>
                            <div id="upload-filelist-table"
                                style="max-height:280px; overflow-y:auto;"
                                onchange="if(event.target.classList.contains('flist-cb')) _updateFileListBtn()">
                            </div>
                            <div style="padding:10px 14px; border-top:1px solid #e5e7eb; display:flex; gap:8px; align-items:center; background:#fff;">
                                <button class="btn btn-primary" id="upload-filelist-btn"
                                    onclick="uploadSelectedFiles()"
                                    style="font-size:13px; padding:7px 18px;">Upload 0 files</button>
                                <button class="btn" onclick="cancelFileList()"
                                    style="font-size:13px; padding:7px 14px; background:#f3f4f6; color:#374151; border:1px solid #d1d5db; border-radius:5px;">Cancel</button>
                                <span id="upload-filelist-progress" style="font-size:12px; color:#6b7280; margin-left:6px;"></span>
                            </div>
                        </div>

                        <!-- Smart metadata preview card -->
                        <div id="upload-meta-preview" style="display:none; margin-top:16px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:16px;">
                            <div style="font-weight:600; color:#0c4a6e; margin-bottom:10px;">AI Metadata Preview ‚Äî confirm before submitting</div>
                            <div id="upload-meta-content" style="font-size:13px; color:#374151;"></div>
                            <div style="margin-top:14px; display:flex; gap:10px;">
                                <button class="btn btn-primary" onclick="confirmSmartUpload()" style="padding:8px 20px;">
                                    ‚úÖ Confirm &amp; Upload
                                </button>
                                <button class="btn" onclick="cancelSmartPreview()" style="padding:8px 16px; background:#e5e7eb; color:#374151;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import History -->
                <div style="background: white; border: 1px solid #e1e4e8; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,.06);">
                    <div style="padding: 16px 20px; border-bottom: 1px solid #e1e4e8; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:600; color:#374151;">Recent Imports</span>
                        <button onclick="loadImportHistory()" style="font-size:12px; border:none; background:none; color:#2563eb; cursor:pointer;">‚Üª Refresh</button>
                    </div>
                    <div id="upload-history-body" style="overflow-x:auto;">
                        <div style="padding:20px; color:#9ca3af; font-size:13px; text-align:center;">Loading‚Ä¶</div>
                    </div>
                </div>
            </div>

            <!-- AI Chat Tab -->
            <div id="tab-ai-chat" class="tab-content">
                <div class="tab-help-panel" id="help-ai-chat">
                    <strong>üí¨ AI Chat</strong> ‚Äî Ask the AI questions about your documents using natural language.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>The AI has access to all analyzed documents in the <strong>Current Project</strong> selected in the header.</li>
                        <li>Ask things like: <em>"Are there any documents with balance mismatches?"</em> or <em>"Summarize documents from March 2024."</em></li>
                        <li>Use <strong>+ New Chat</strong> in the sidebar to start a fresh conversation.</li>
                        <li>Chat sessions can be <strong>shared</strong> with other users using the share button in the header bar.</li>
                        <li>Requires an AI API key ‚Äî configure one under <strong>‚öôÔ∏è Configuration ‚Üí AI Settings</strong>.</li>
                    </ul>
                </div>
                <!-- API key warning banner (hidden until checked) -->
                <div id="ai-key-warning" style="display:none; background:#fff3cd; border:1px solid #ffc107; color:#856404; padding:12px 16px; border-radius:6px; margin-bottom:14px; font-size:13px;">
                    ‚ö†Ô∏è <strong>No AI API key configured.</strong> Chat will not work until you add one.
                    Go to the <a href="#" onclick="switchTab('config'); return false;" style="color:#856404; font-weight:600;">‚öôÔ∏è Configuration tab</a> ‚Üí AI Configuration section to add your key.
                </div>
                <!-- Session header -->
                <div class="chat-session-header">
                    <span class="chat-session-title" id="active-session-title">New Chat</span>
                    <div class="chat-session-actions">
                        <button class="btn-session-action" onclick="shareCurrentChat()" id="btn-share-chat" title="Share chat">üîó Share</button>
                        <button class="btn-session-action" onclick="exportCurrentChat()" id="btn-export-chat" title="Export as PDF">üì• Export PDF</button>
                        <button class="btn-session-action" onclick="clearChat()" title="Clear chat">üóëÔ∏è Clear</button>
                    </div>
                </div>
                <div class="chat-container" style="margin: 0;">
                    <div class="chat-header">
                        <h2>üí¨ AI Document Assistant</h2>
                    </div>
                    <div class="chat-messages" id="chat-messages">
                        <div class="chat-message assistant">
                            <div class="message-bubble">
                                <div>üëã Hi! I'm your AI document assistant. I can help you:</div>
                                <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                                    <li>Analyze patterns across all your documents</li>
                                    <li>Find specific transactions or anomalies</li>
                                    <li>Generate reports and ledgers</li>
                                    <li>Answer questions about your financial documents</li>
                                </ul>
                                <div style="margin-top: 10px;">Try asking me something!</div>
                            </div>
                        </div>
                        <div class="chat-suggestions">
                            <div class="suggestion-chip" onclick="sendSuggestion('Show me all high-risk documents')">Show me all high-risk documents</div>
                            <div class="suggestion-chip" onclick="sendSuggestion('What anomalies were most common?')">What anomalies were most common?</div>
                            <div class="suggestion-chip" onclick="sendSuggestion('Generate a summary of all analyzed documents')">Generate a summary</div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <label for="document-type-filter" style="font-size: 14px; color: #666;">Filter by type:</label>
                            <select id="document-type-filter" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; background: white;">
                                <option value="all">All Documents</option>
                            </select>
                            <span id="type-breakdown" style="font-size: 12px; color: #999;"></span>
                        </div>
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ask me anything about your documents‚Ä¶ (Enter to send, Ctrl+Enter for new line)" onkeydown="handleChatKeypress(event)"></textarea>
                            <button class="chat-send-btn" id="chat-send-btn" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search & Analysis Tab -->
            <div id="tab-search" class="tab-content">
                <div class="tab-help-panel" id="help-search">
                    <strong>üîç Search &amp; Analysis</strong> ‚Äî Search and filter all analyzed documents and their AI findings.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li>Search by <strong>title</strong>, <strong>document ID</strong>, or <strong>anomaly type</strong> (e.g., "balance_mismatch").</li>
                        <li>Filter by <strong>risk percentage</strong> range to focus on high-risk documents.</li>
                        <li>Check <strong>Anomalies Only</strong> to hide clean documents from results.</li>
                        <li>Click a result row to expand and see the full AI analysis, tags, and evidence.</li>
                        <li>Click <strong>View Tags</strong> to see how individual anomaly tags were determined.</li>
                    </ul>
                </div>
                <h2>üîç Search Analyses</h2>
                <div class="search-bar">
                    <input type="text" id="search-query" placeholder="Search by title, doc ID, or anomaly..." />
                    <input type="number" id="search-risk-min" placeholder="Min risk %" />
                    <input type="number" id="search-risk-max" placeholder="Max risk %" />
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="checkbox" id="search-anomalies" />
                        Has anomalies
                    </label>
                    <button class="btn" onclick="performSearch()">Search</button>
                    <button class="btn" onclick="clearSearch()">Clear</button>
                </div>
                <div id="search-results" style="margin-bottom: 20px;"></div>

                <h2 style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1;">All Recent Analyses</h2>
                <div id="recent-analyses-list" class="loading">Loading...</div>
            </div>

            <!-- Configuration Tab -->
            <div id="tab-config" class="tab-content">
                <div class="tab-help-panel" id="help-config">
                    <strong>‚öôÔ∏è Configuration</strong> ‚Äî Set up AI providers, analysis profiles, and system settings.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>AI Settings</strong> ‚Äî Add OpenAI or Anthropic API keys. Without a key, no AI analysis or chat will run.</li>
                        <li><strong>Profiles</strong> ‚Äî Rules files that define how the AI tags and classifies documents. Activate staging profiles to use them.</li>
                        <li><strong>Vector Store</strong> ‚Äî Manages the embedded document index used for AI Chat. Clear it if documents seem stale.</li>
                        <li><strong>Notifications (SMTP)</strong> ‚Äî Configure outgoing email for bug reports and alerts.</li>
                        <li><strong>Users</strong> (admin) ‚Äî Add, edit, or remove user accounts and set roles.</li>
                    </ul>
                </div>

                <!-- Sub-tab navigation -->
                <div class="config-sub-nav">
                    <button class="config-sub-btn active" onclick="switchConfigTab('ai')" id="cfg-btn-ai">ü§ñ AI Settings</button>
                    <button class="config-sub-btn" onclick="switchConfigTab('profiles')" id="cfg-btn-profiles">üìÑ Profiles</button>
                    <button class="config-sub-btn" onclick="switchConfigTab('vectorstore')" id="cfg-btn-vectorstore">üóÑÔ∏è Vector Store</button>
                    {% if is_admin %}
                    <button class="config-sub-btn" onclick="switchConfigTab('smtp')" id="cfg-btn-smtp">üìß Notifications</button>
                    <button class="config-sub-btn" onclick="switchConfigTab('users')" id="cfg-btn-users">üë• Users</button>
                    {% endif %}
                </div>

                <!-- ‚îÄ‚îÄ AI Settings sub-section ‚îÄ‚îÄ -->
                <div id="cfg-ai" class="config-sub-content active">
                <h2 style="margin-bottom: 15px;">ü§ñ AI Configuration</h2>
                <div class="card" style="margin-bottom: 20px;">
                    <div style="margin-bottom: 15px; color: #555;">
                        <strong>Configure AI providers for document analysis and chat:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Document Analysis:</strong> OpenAI GPT (best for legal/forensic) ‚Üí Anthropic Claude</li>
                            <li><strong>Chat:</strong> Same priority - tries best models first, falls back automatically</li>
                            <li>Automatic fallback ensures system always works with available models</li>
                        </ul>
                    </div>

                    <!-- OpenAI Configuration -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px;">
                            <input type="checkbox" id="openai-enabled" style="margin-right: 8px; cursor: pointer;" />
                            OpenAI GPT (Recommended for Forensic Analysis)
                        </h3>
                        <div style="margin-bottom: 10px; font-size: 13px; color: #666;">
                            Best for: Legal documents, forensic analysis, financial document understanding
                        </div>
                        <div class="action-group" style="margin-bottom: 10px;">
                            <input type="text" autocomplete="off" id="openai-api-key" placeholder="OpenAI API key (sk-...)"
                                   style="flex: 1; font-family: monospace; font-size: 13px;" />
                            <button class="btn" onclick="testAIProvider('openai')">üß™ Test</button>
                        </div>
                        <div style="font-size: 12px;">
                            <strong>Model Priority:</strong> gpt-4o ‚Üí gpt-4-turbo ‚Üí gpt-4 ‚Üí gpt-3.5-turbo
                            <a href="https://platform.openai.com/api-keys" target="_blank" style="margin-left: 10px;">üîó Get API Key</a>
                        </div>
                        <div id="openai-test-result" style="margin-top: 10px; display: none;"></div>
                    </div>

                    <!-- Anthropic Configuration -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px;">
                            <input type="checkbox" id="anthropic-enabled" style="margin-right: 8px; cursor: pointer;" />
                            Anthropic Claude (Fallback)
                        </h3>
                        <div style="margin-bottom: 10px; font-size: 13px; color: #666;">
                            Best for: General analysis, code understanding, logical reasoning
                        </div>
                        <div class="action-group" style="margin-bottom: 10px;">
                            <input type="text" autocomplete="off" id="anthropic-api-key" placeholder="Anthropic API key (sk-ant-api03-...)"
                                   style="flex: 1; font-family: monospace; font-size: 13px;" />
                            <button class="btn" onclick="testAIProvider('anthropic')">üß™ Test</button>
                        </div>
                        <div style="font-size: 12px;">
                            <strong>Model Priority:</strong> Opus ‚Üí Sonnet 3.5 ‚Üí Sonnet 3 ‚Üí Haiku
                            <a href="https://console.anthropic.com/settings/keys" target="_blank" style="margin-left: 10px;">üîó Get API Key</a>
                        </div>
                        <div id="anthropic-test-result" style="margin-top: 10px; display: none;"></div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; padding-top: 15px; border-top: 1px solid #dee2e6;">
                        <button class="btn btn-success" onclick="saveAIConfig()" style="font-size: 14px; padding: 10px 30px;">
                            üíæ Save AI Configuration
                        </button>
                        <div id="ai-config-result" style="margin-top: 10px; display: none;"></div>
                    </div>

                    <div style="font-size: 12px; color: #666; margin-top: 15px; text-align: center;">
                        ‚ÑπÔ∏è API keys are stored securely in /app/data/ai_config.json and never leave your server<br>
                        Cost: ~$0.30-0.50 for initial analysis of all documents, then ~$0.01 per new document
                    </div>
                </div>

                <!-- Settings sub-section folded into AI tab -->
                <h2 style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1;">‚öôÔ∏è Settings</h2>
                <div class="card" style="margin-top: 15px;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Polling Configuration</h3>
                    <div class="action-group">
                        <label for="poll-interval" style="font-weight: 500;">Poll Interval (seconds):</label>
                        <input type="number" id="poll-interval" value="30" min="5" max="3600" style="width: 100px;" />
                        <button class="btn" onclick="updatePollInterval()">Update Interval</button>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 10px;">
                        ‚ÑπÔ∏è How often the analyzer checks for new documents (default: 30 seconds)
                    </div>
                    <div id="settings-result" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>
                </div><!-- /cfg-ai -->

                <!-- ‚îÄ‚îÄ Profiles sub-section ‚îÄ‚îÄ -->
                <div id="cfg-profiles" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üìÑ Profile Management</h2>
                <div class="content-grid">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="margin: 0;">Active Profiles</h2>
                            <button class="btn btn-primary" onclick="detectDuplicates()">üîç Detect Duplicates</button>
                        </div>
                        <ul id="active-profiles-list" class="profile-list loading">Loading...</ul>
                        <div id="duplicates-result" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <div class="card" id="staging-section" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="margin: 0;">Staging Profiles (Awaiting Review)</h2>
                            <button class="btn btn-success" onclick="activateAllStagingProfiles()" id="activate-all-btn">‚úì Activate All</button>
                        </div>
                        <div id="staging-profiles"></div>
                    </div>
                </div>

                </div><!-- /content-grid -->
                </div><!-- /cfg-profiles -->

                <!-- ‚îÄ‚îÄ Vector Store sub-section ‚îÄ‚îÄ -->
                <div id="cfg-vectorstore" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üóÑÔ∏è Vector Store Management</h2>
                <div class="card">
                    <!-- Search + controls bar -->
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:16px; flex-wrap:wrap;">
                        <input type="text" id="vs-search" placeholder="Search by title, ID or type‚Ä¶"
                               oninput="filterVsDocs()"
                               style="flex:1; min-width:180px; padding:7px 12px; border:1px solid #ddd; border-radius:4px; font-size:13px;" />
                        <span id="vs-count-label" style="font-size:13px; color:#666; white-space:nowrap;"></span>
                        <button class="btn btn-small" onclick="loadVectorStoreDocuments()">‚Üª Refresh</button>
                        <button class="btn btn-small" onclick="triggerReembedStale()" id="btn-reembed-stale" title="Re-analyze documents whose OCR content changed after they were first embedded">‚ü≥ Re-embed Stale</button>
                        <button class="btn btn-warning" onclick="confirmClearVectorStore()">Clear All</button>
                    </div>
                    <div id="vector-store-manager">
                        <div class="loading">Loading vector store documents‚Ä¶</div>
                    </div>
                    <!-- Pagination -->
                    <div id="vs-pagination" style="display:none; margin-top:16px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center;"></div>
                </div>
                </div><!-- /cfg-vectorstore -->

                <!-- ‚îÄ‚îÄ SMTP / Notifications sub-section (admin only) ‚îÄ‚îÄ -->
                {% if is_admin %}
                <div id="cfg-smtp" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üìß Notifications &amp; Email</h2>
                <div class="card" style="margin-bottom: 20px;">
                    <p style="color:#555; font-size:14px; margin-bottom:16px;">
                        Configure outgoing email (SMTP) used for bug reports and alerts. All settings are stored securely on the server.
                    </p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">SMTP Host</label>
                            <input type="text" id="smtp-host" placeholder="e.g. smtpauth.earthlink.net" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Port</label>
                            <input type="number" id="smtp-port" value="587" min="1" max="65535" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Username</label>
                            <input type="text" id="smtp-user" autocomplete="off" placeholder="your@email.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Password</label>
                            <input type="password" id="smtp-pass" autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">From Address</label>
                            <input type="text" id="smtp-from" placeholder="noreply@yourdomain.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">HELO Hostname (optional)</label>
                            <input type="text" id="smtp-helo" placeholder="yourdomain.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-size:12px; color:#666; margin-bottom:4px;">Bug Reports Sent To</label>
                            <input type="email" id="smtp-bug-report-to" placeholder="admin@yourdomain.com" style="width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:4px; font-size:13px; box-sizing:border-box;">
                        </div>
                        <div style="display:flex; align-items:center; gap:8px; padding-top:18px;">
                            <input type="checkbox" id="smtp-starttls" checked style="cursor:pointer;">
                            <label for="smtp-starttls" style="font-size:13px; cursor:pointer;">Use STARTTLS (recommended)</label>
                        </div>
                    </div>
                    <div id="smtp-result" style="display:none; padding:8px 12px; border-radius:4px; font-size:13px; margin-bottom:12px;"></div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="saveSmtpSettings()">üíæ Save Settings</button>
                        <button class="btn" onclick="testSmtpSettings()">üì® Send Test Email</button>
                    </div>
                </div>
                </div><!-- /cfg-smtp -->
                {% endif %}

                <!-- ‚îÄ‚îÄ Users sub-section (admin only) ‚îÄ‚îÄ -->
                {% if is_admin %}
                <div id="cfg-users" class="config-sub-content">
                <h2 style="margin-bottom: 15px;">üë• User Management</h2>
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <span style="color: #555; font-size: 14px;">Manage user accounts and roles.</span>
                        <button class="btn btn-primary" onclick="showAddUserForm()">+ Add User</button>
                    </div>

                    <!-- Add User Form (hidden by default) -->
                    <div id="add-user-form" style="display: none; background: #f8f9fa; padding: 16px; border-radius: 6px; margin-bottom: 16px;">
                        <h3 style="margin-bottom: 12px; font-size: 15px;">New User</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="new-user-username" placeholder="Username" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="new-user-display" placeholder="Display Name (optional)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="password" id="new-user-password" placeholder="Password" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                            <select id="new-user-role" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="basic">Basic</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div id="add-user-error" style="color: #e74c3c; font-size: 13px; margin-bottom: 8px; display:none;"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-success" onclick="createUser()">Create User</button>
                            <button class="btn" onclick="hideAddUserForm()">Cancel</button>
                        </div>
                    </div>

                    <table class="user-table" id="users-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Display Name</th>
                                <th>Role</th>
                                <th>Last Login</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="6" class="loading">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
                </div><!-- /cfg-users -->
                {% endif %}

            </div><!-- /tab-config -->

            <!-- Debug & Tools Tab -->
            <div id="tab-tools" class="tab-content">
                <div class="tab-help-panel" id="help-tools">
                    <strong>üõ†Ô∏è Debug &amp; Tools</strong> ‚Äî Force re-analysis and view live system logs.
                    <ul style="margin:8px 0 0 0; padding-left:18px;">
                        <li><strong>Reprocess All</strong> ‚Äî Clears existing analysis results and re-runs the AI on every document. Use this after changing profiles or AI settings.</li>
                        <li><strong>Reprocess Document</strong> ‚Äî Re-runs analysis on a single document by its Paperless document ID.</li>
                        <li><strong>Live Logs</strong> ‚Äî Shows the last 200 log lines from the analyzer in real time. Useful for diagnosing why a document wasn't processed.</li>
                        <li>If documents are stuck or incorrectly tagged, check the logs here first before filing a bug report.</li>
                    </ul>
                </div>
                <h2>üéõÔ∏è Reprocess Controls</h2>
                <div class="action-group" style="margin-bottom: 30px;">
                    <button class="btn btn-danger" onclick="reprocessAll()">üîÑ Reprocess All Documents</button>
                    <input type="number" id="reprocess-doc-id" placeholder="Doc ID" />
                    <button class="btn btn-success" onclick="reprocessDocument()">üîÑ Reprocess Document</button>
                </div>
                <div style="font-size: 12px; color: #666; margin-bottom: 30px;">
                    ‚ÑπÔ∏è Reprocessing will analyze documents on the next poll cycle (every 30 seconds)
                </div>

                <h2 style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #ecf0f1;">üìã Live Logs <button class="btn btn-small" onclick="refreshLogs()">Refresh</button></h2>
                <div class="logs-viewer" id="logs-viewer" style="margin-top: 15px;">
                    <div class="loading">Loading logs...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Base path injected by Flask from URL_PREFIX env var (set in docker-compose)
        const BASE_PATH = "{{ request.script_root }}";

        // Helper function to build API URLs
        function apiUrl(path) {
            return BASE_PATH + path;
        }

        // Wrapper around fetch that detects session expiry and redirects to login
        async function apiFetch(url, options = {}) {
            const response = await fetch(url, options);
            if (response.redirected && response.url.includes('/login')) {
                window.location.href = apiUrl('/login');
                throw new Error('Session expired');
            }
            if (response.status === 401) {
                window.location.href = apiUrl('/login');
                throw new Error('Session expired');
            }
            return response;
        }

        // ‚îÄ‚îÄ Configuration sub-tab state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let vsAllDocs = [];       // flat array: {title, doc_id, type}
        let vsFiltered = [];
        let vsPage = 0;
        const VS_PAGE_SIZE = 25;
        let vsLoaded = false;

        function switchConfigTab(name) {
            document.querySelectorAll('.config-sub-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.config-sub-content').forEach(c => c.classList.remove('active'));
            const btn = document.getElementById('cfg-btn-' + name);
            const pane = document.getElementById('cfg-' + name);
            if (btn) btn.classList.add('active');
            if (pane) pane.classList.add('active');
            // Lazy-load vector store on first visit
            if (name === 'vectorstore' && !vsLoaded) {
                loadVectorStoreDocuments();
            }
            // Lazy-load users on first visit (admin only)
            if (name === 'users' && typeof loadUsers === 'function') {
                loadUsers();
            }
        }

        function filterVsDocs() {
            const q = (document.getElementById('vs-search')?.value || '').toLowerCase().trim();
            vsFiltered = q
                ? vsAllDocs.filter(d =>
                    (d.title || '').toLowerCase().includes(q) ||
                    String(d.doc_id).includes(q) ||
                    (d.type || '').toLowerCase().includes(q))
                : [...vsAllDocs];
            vsPage = 0;
            renderVsPage();
        }

        function renderVsPage() {
            const container = document.getElementById('vector-store-manager');
            const pagDiv = document.getElementById('vs-pagination');
            const countLabel = document.getElementById('vs-count-label');
            if (!container) return;

            const total = vsFiltered.length;
            const totalPages = Math.ceil(total / VS_PAGE_SIZE) || 1;
            if (countLabel) countLabel.textContent = total + ' document' + (total !== 1 ? 's' : '');

            if (total === 0) {
                container.innerHTML = '<p style="color:#999;">No documents match.</p>';
                if (pagDiv) pagDiv.style.display = 'none';
                return;
            }

            const start = vsPage * VS_PAGE_SIZE;
            const slice = vsFiltered.slice(start, start + VS_PAGE_SIZE);

            // Group current page slice by type for display
            const byType = {};
            slice.forEach(d => {
                if (!byType[d.type]) byType[d.type] = [];
                byType[d.type].push(d);
            });

            let html = '';
            Object.keys(byType).sort().forEach(type => {
                const docs = byType[type];
                html += `<div class="vector-type-section">
                    <div class="vector-type-header">
                        <h3>${escapeHtml(type)} <span class="vector-type-count">(${docs.length})</span></h3>
                        <button class="btn btn-small btn-warning" onclick="confirmDeleteType('${escapeHtml(type)}')">Delete All ${escapeHtml(type)}</button>
                    </div>
                    <div class="vector-documents-list">`;
                docs.forEach(doc => {
                    html += `<div class="vector-doc-item">
                        <div class="vector-doc-info">
                            <div class="vector-doc-title">${escapeHtml(doc.title || 'Untitled')}</div>
                            <div class="vector-doc-id">ID: ${doc.doc_id}</div>
                        </div>
                        <button class="btn btn-small btn-warning" onclick="deleteIndividualDocument(${doc.doc_id}, '${escapeHtml(doc.title || 'this document')}')">Delete</button>
                    </div>`;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;

            // Pagination controls
            if (pagDiv) {
                if (totalPages <= 1) {
                    pagDiv.style.display = 'none';
                } else {
                    pagDiv.style.display = 'flex';
                    let pagHtml = `<button class="btn btn-small" onclick="vsGoPage(${vsPage-1})" ${vsPage===0?'disabled':''}>‚óÄ Prev</button>`;
                    // Show up to 7 page buttons
                    const maxBtns = 7, half = Math.floor(maxBtns/2);
                    let pStart = Math.max(0, vsPage - half);
                    let pEnd = Math.min(totalPages - 1, pStart + maxBtns - 1);
                    if (pEnd - pStart < maxBtns - 1) pStart = Math.max(0, pEnd - maxBtns + 1);
                    for (let p = pStart; p <= pEnd; p++) {
                        pagHtml += `<button class="btn btn-small${p===vsPage?' active':''}" onclick="vsGoPage(${p})">${p+1}</button>`;
                    }
                    pagHtml += `<button class="btn btn-small" onclick="vsGoPage(${vsPage+1})" ${vsPage>=totalPages-1?'disabled':''}>Next ‚ñ∂</button>`;
                    pagHtml += `<span style="font-size:13px;color:#666;margin-left:6px;">Page ${vsPage+1} of ${totalPages}</span>`;
                    pagDiv.innerHTML = pagHtml;
                }
            }
        }

        function vsGoPage(p) {
            const totalPages = Math.ceil(vsFiltered.length / VS_PAGE_SIZE) || 1;
            vsPage = Math.max(0, Math.min(p, totalPages - 1));
            renderVsPage();
            document.getElementById('cfg-vectorstore')?.scrollIntoView({behavior:'smooth', block:'start'});
        }

        // ‚îÄ‚îÄ Tab switching function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Sidebar only visible on AI Chat tab
            const sidebar = document.getElementById('chat-sidebar');
            if (sidebar) sidebar.style.display = tabName === 'ai-chat' ? 'flex' : 'none';

            // Activate selected tab button (match by onclick attribute, not text content)
            document.querySelectorAll('.tab-button').forEach(btn => {
                const m = btn.getAttribute('onclick') && btn.getAttribute('onclick').match(/'([^']+)'/);
                if (m && m[1] === tabName) {
                    btn.classList.add('active');
                }
            });

            // Load projects when projects tab is opened
            if (tabName === 'projects') {
                console.log('Projects tab selected, typeof loadProjectsList:', typeof loadProjectsList);
                if (typeof loadProjectsList === 'function') {
                    loadProjectsList();
                } else {
                    console.error('loadProjectsList is not a function!');
                }
            }
            // Config tab: reset to AI Settings sub-tab on each visit
            if (tabName === 'config') {
                switchConfigTab('ai');
            }
            // Check API key when AI chat tab is opened
            if (tabName === 'ai-chat') {
                checkAiKeyStatus();
            }
            // Load import history when upload tab is opened
            if (tabName === 'upload') {
                loadImportHistory();
            }
        }

        async function checkAiKeyStatus() {
            try {
                const res = await apiFetch(apiUrl('/api/llm/status'));
                const data = await res.json();
                // Show warning if LLM is not enabled or has no key, and also
                // check the chat-specific ai-config for any enabled provider with a key
                const configRes = await apiFetch(apiUrl('/api/ai-config'));
                const configData = await configRes.json();
                const chatProviders = configData.config?.chat?.providers || [];
                const hasAnyKey = chatProviders.some(p => p.enabled && p.api_key && p.api_key.trim());
                document.getElementById('ai-key-warning').style.display = hasAnyKey ? 'none' : 'block';
            } catch (e) {
                // If we can't check, hide the warning (don't block usage)
            }
        }

        function openChangePasswordModal() {
            document.getElementById('cp-current').value = '';
            document.getElementById('cp-new').value = '';
            document.getElementById('cp-confirm').value = '';
            document.getElementById('cp-error').style.display = 'none';
            document.getElementById('cp-success').style.display = 'none';
            document.getElementById('change-password-modal').style.display = 'flex';
        }

        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').style.display = 'none';
        }

        async function submitChangePassword() {
            const current = document.getElementById('cp-current').value;
            const newPw = document.getElementById('cp-new').value;
            const confirm = document.getElementById('cp-confirm').value;
            const errEl = document.getElementById('cp-error');
            const okEl = document.getElementById('cp-success');
            errEl.style.display = 'none';
            okEl.style.display = 'none';
            if (!current || !newPw) { errEl.textContent = 'All fields are required.'; errEl.style.display = 'block'; return; }
            if (newPw !== confirm) { errEl.textContent = 'New passwords do not match.'; errEl.style.display = 'block'; return; }
            if (newPw.length < 6) { errEl.textContent = 'New password must be at least 6 characters.'; errEl.style.display = 'block'; return; }
            try {
                const res = await apiFetch(apiUrl('/api/change-password'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({current_password: current, new_password: newPw})
                });
                const data = await res.json();
                if (data.success) {
                    okEl.textContent = 'Password updated successfully!';
                    okEl.style.display = 'block';
                    setTimeout(closeChangePasswordModal, 1500);
                } else {
                    errEl.textContent = data.error || 'Failed to update password.';
                    errEl.style.display = 'block';
                }
            } catch (e) {
                errEl.textContent = 'Network error: ' + e.message;
                errEl.style.display = 'block';
            }
        }

        // Close modal on backdrop click (use delegation so element doesn't need to exist yet)
        document.addEventListener('click', function(e) {
            const m = document.getElementById('change-password-modal');
            if (m && e.target === m) closeChangePasswordModal();
        });

        // Auto-refresh data every 10 seconds
        let refreshInterval;

        async function fetchStatus() {
            try {
                const response = await apiFetch(apiUrl('/api/status'));
                const data = await response.json();

                // Update stats
                document.getElementById('status').textContent = data.status === 'running' ? 'Running' : 'Stopped';
                document.getElementById('total-analyzed').textContent = data.stats.total_analyzed;
                document.getElementById('anomalies-detected').textContent = data.stats.anomalies_detected;
                document.getElementById('high-risk-count').textContent = data.stats.high_risk_count;
                document.getElementById('active-profiles').textContent = data.active_profiles;

                // Update embedded docs count
                if (data.vector_store && data.vector_store.enabled) {
                    document.getElementById('embedded-docs').textContent = data.vector_store.total_documents + ' ‚úì';
                } else {
                    document.getElementById('embedded-docs').textContent = 'Disabled';
                }

                // Format last update time
                if (data.last_update) {
                    const date = new Date(data.last_update);
                    document.getElementById('last-update').textContent = date.toLocaleTimeString();
                } else {
                    document.getElementById('last-update').textContent = 'Never';
                }
            } catch (error) {
                console.error('Failed to fetch status:', error);
            }
        }

        async function fetchRecent() {
            try {
                const response = await apiFetch(apiUrl('/api/recent'));
                const data = await response.json();

                const overviewContainer = document.getElementById('recent-analyses');
                const searchContainer = document.getElementById('recent-analyses-list');

                // Save open state of all details elements before updating
                const openDetailsIds = new Set();
                document.querySelectorAll('details[id^="summary-details-"]').forEach(details => {
                    if (details.open) {
                        openDetailsIds.add(details.id);
                    }
                });

                if (data.analyses.length === 0) {
                    const emptyHtml = '<div class="empty-state">No analyses yet</div>';
                    if (overviewContainer) overviewContainer.innerHTML = emptyHtml;
                    if (searchContainer) searchContainer.innerHTML = emptyHtml;
                    return;
                }

                const analysesHtml = data.analyses.slice(-20).reverse().map(analysis => {
                    const hasAnomalies = analysis.anomalies_found && analysis.anomalies_found.length > 0;
                    const isHighRisk = analysis.risk_score >= 70;
                    const classes = ['recent-item'];
                    if (hasAnomalies) classes.push('has-anomalies');
                    if (isHighRisk) classes.push('high-risk');

                    let tags = '';
                    if (analysis.anomalies_found) {
                        // Check if this document has enhanced tags (issue count > 0 indicates detailed evidence)
                        const hasEvidence = analysis.issue_count > 0 || analysis.enhanced_tags;

                        tags = analysis.anomalies_found.map(a => {
                            // All anomaly tags are now clickable to show explanations
                            return `<span class="tag anomaly clickable" onclick="event.stopPropagation(); showTagEvidence(${analysis.document_id || analysis.doc_id}, '${(analysis.document_title || analysis.title).replace(/'/g, "\\'")}')" title="Click to see why this was flagged">üîç ${a}</span>`;
                        }).join('');

                        // Add "View Evidence" button if document has integrity issues
                        if (hasEvidence) {
                            tags += ` <span class="tag clickable" style="background: #3498db; color: white;" onclick="event.stopPropagation(); showTagEvidence(${analysis.document_id || analysis.doc_id}, '${(analysis.document_title || analysis.title).replace(/'/g, "\\'")}');" title="Click to view all evidence">üìã View Evidence</span>`;
                        }
                    }

                    // Format summaries if available
                    const briefSummary = analysis.brief_summary || '';
                    const fullSummary = analysis.full_summary || '';
                    const detailsId = `summary-details-${analysis.doc_id}`;
                    const summaryHtml = briefSummary ? `
                        <div style="margin-top: 8px; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 4px; font-size: 0.9em;">
                            <div style="color: #555; font-style: italic;">
                                üí° ${briefSummary}
                            </div>
                            ${fullSummary && fullSummary !== briefSummary ? `
                                <details id="${detailsId}" style="margin-top: 4px;">
                                    <summary style="cursor: pointer; color: #3498db; font-size: 0.85em;">Show full summary</summary>
                                    <div style="margin-top: 6px; color: #666; line-height: 1.4;">
                                        ${fullSummary}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    ` : '';

                    return `
                        <div class="${classes.join(' ')}">
                            <div class="title">${analysis.document_title || analysis.title}</div>
                            <div class="meta">
                                <span>üìÑ <a href="https://www.voipguru.org/paperless/documents/${analysis.document_id || analysis.doc_id}" target="_blank" style="color: #3498db; text-decoration: none;">Doc #${analysis.document_id || analysis.doc_id}</a></span>
                                <span>‚ö†Ô∏è Risk: ${analysis.risk_score}%</span>
                                ${analysis.profile_matched ? `<span>üìã ${analysis.profile_matched}</span>` : '<span>‚ùì No profile</span>'}
                                <span>‚è±Ô∏è ${new Date(analysis.timestamp).toLocaleString()}</span>
                            </div>
                            ${summaryHtml}
                            ${tags ? `<div style="margin-top: 8px;">${tags}</div>` : ''}
                        </div>
                    `;
                }).join('');

                // Update both containers
                if (overviewContainer) overviewContainer.innerHTML = analysesHtml;
                if (searchContainer) searchContainer.innerHTML = analysesHtml;

                // Restore open state of details elements after updating
                setTimeout(() => {
                    openDetailsIds.forEach(id => {
                        const details = document.getElementById(id);
                        if (details) {
                            details.open = true;
                        }
                    });
                }, 0);
            } catch (error) {
                console.error('Failed to fetch recent analyses:', error);
                const errorHtml = '<div class="empty-state">Failed to load</div>';
                const overviewContainer = document.getElementById('recent-analyses');
                const searchContainer = document.getElementById('recent-analyses-list');
                if (overviewContainer) overviewContainer.innerHTML = errorHtml;
                if (searchContainer) searchContainer.innerHTML = errorHtml;
            }
        }

        async function fetchProfiles() {
            try {
                const response = await apiFetch(apiUrl('/api/profiles'));
                const data = await response.json();

                // Active profiles
                const activeList = document.getElementById('active-profiles-list');
                if (data.active.length === 0) {
                    activeList.innerHTML = '<li class="empty-state">No active profiles</li>';
                } else {
                    activeList.innerHTML = data.active.map(profile => `
                        <li style="display: flex; justify-content: space-between; align-items: center; padding: 12px;">
                            <div>
                                <span class="profile-name">${profile.name}</span>
                                <span class="profile-version">v${profile.version}</span>
                                <div style="font-size: 11px; color: #999; margin-top: 4px;">${profile.filename}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-small" onclick="viewActiveProfile('${profile.filename}')">üëÅÔ∏è View</button>
                                <button class="btn btn-small" onclick="renameActiveProfile('${profile.filename}', '${profile.name}')">‚úèÔ∏è Rename</button>
                                <button class="btn btn-small btn-danger" onclick="deleteActiveProfile('${profile.filename}')">‚úó Delete</button>
                            </div>
                        </li>
                    `).join('');
                }

                // Staging profiles
                const stagingSection = document.getElementById('staging-section');
                const stagingContainer = document.getElementById('staging-profiles');
                if (data.staging.length > 0) {
                    if (stagingSection) stagingSection.style.display = 'block';
                    if (stagingContainer) {
                        stagingContainer.innerHTML = data.staging.map(profile => `
                            <div class="staging-profile">
                                <div class="filename">${profile.filename}</div>
                                <div class="actions" style="margin-top: 8px;">
                                    <span style="font-size: 12px; color: #666;">
                                        Created: ${new Date(profile.created).toLocaleString()}
                                    </span>
                                    <div style="margin-top: 8px; display: flex; gap: 10px;">
                                        <button class="btn btn-small" onclick="viewStagingProfile('${profile.filename}')">üëÅÔ∏è View</button>
                                        <button class="btn btn-small btn-success" onclick="activateStagingProfile('${profile.filename}')">‚úì Activate</button>
                                        <button class="btn btn-small btn-danger" onclick="deleteStagingProfile('${profile.filename}')">‚úó Delete</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    if (stagingSection) stagingSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to fetch profiles:', error);
            }
        }

        // ‚îÄ‚îÄ Manage Projects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const PROJ_COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#64748b'];
        let _projEditSlug = null;   // null = new project, slug string = edit
        let _projCache = [];        // last fetched project list

        async function loadProjectsList() {
            const list = document.getElementById('projects-list');
            try {
                const res = await apiFetch(apiUrl('/api/projects'));
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();
                _projCache = data.projects || [];

                if (!_projCache.length) {
                    list.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No projects found. Click <strong>+ New Project</strong> to get started.</div>';
                    return;
                }

                list.innerHTML = _projCache.map(p => {
                    const color = p.color || '#3b82f6';
                    const archived = p.is_archived;
                    return `
                    <div style="background:#fff; border:1px solid #e5e7eb; border-left:4px solid ${color}; border-radius:8px; padding:18px 20px; margin-bottom:12px; display:flex; align-items:center; gap:16px; ${archived ? 'opacity:.55;' : ''}">
                        <div style="flex:1; min-width:0;">
                            <div style="display:flex; align-items:center; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700; font-size:15px; color:#111; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${p.name}</span>
                                ${archived ? '<span style="font-size:11px; background:#fef3c7; color:#92400e; padding:1px 7px; border-radius:10px; font-weight:600;">Archived</span>' : ''}
                            </div>
                            <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">${p.description || '<em style="color:#aaa;">No description</em>'}</div>
                            <div style="font-size:12px; color:#9ca3af;">
                                üìÑ <strong style="color:#374151;">${p.document_count}</strong> docs &nbsp;¬∑&nbsp;
                                üíæ ${(p.storage_size_mb||0).toFixed(2)} MB &nbsp;¬∑&nbsp;
                                üìÖ ${new Date(p.created_at).toLocaleDateString()} &nbsp;¬∑&nbsp;
                                <span style="font-family:monospace; font-size:11px; background:#f3f4f6; padding:1px 6px; border-radius:4px;">${p.slug}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:6px; flex-shrink:0;">
                            <button onclick="openEditProjectModal('${p.slug}')" title="Edit"
                                style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">‚úèÔ∏è</button>
                            <button onclick="openMoveModal('${p.slug}')" title="Move documents"
                                style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">üì¶ Move</button>
                            ${archived
                                ? `<button onclick="toggleArchiveProject('${p.slug}', false)" title="Unarchive"
                                    style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">üìÇ Restore</button>`
                                : `<button onclick="toggleArchiveProject('${p.slug}', true)" title="Archive"
                                    style="padding:6px 11px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:13px;">üóÑÔ∏è Archive</button>`}
                            ${p.slug !== 'default'
                                ? `<button onclick="openDelProjModal('${p.slug}', '${p.name.replace(/'/g,"\\'")}', ${p.document_count})" title="Delete"
                                    style="padding:6px 11px; border:1px solid #fca5a5; border-radius:6px; background:#fff; cursor:pointer; font-size:13px; color:#dc2626;">üóëÔ∏è</button>`
                                : ''}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                list.innerHTML = `<div style="color:#e74c3c; padding:20px; text-align:center;"><strong>Error loading projects:</strong><br>${e.message}</div>`;
            }
        }

        // ‚îÄ‚îÄ New / Edit modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function _buildColorSwatches(selectedColor) {
            const wrap = document.getElementById('proj-color-swatches');
            wrap.innerHTML = PROJ_COLORS.map(c =>
                `<div onclick="selectSwatch('${c}')" style="width:26px; height:26px; border-radius:50%; background:${c}; cursor:pointer; outline:${c === selectedColor ? '3px solid #1d4ed8' : '2px solid transparent'}; outline-offset:2px; transition:outline .1s;" data-color="${c}"></div>`
            ).join('');
        }

        function selectSwatch(color) {
            document.getElementById('proj-color-val').value = color;
            document.querySelectorAll('#proj-color-swatches div').forEach(el => {
                el.style.outline = el.dataset.color === color ? '3px solid #1d4ed8' : '2px solid transparent';
            });
        }

        function selectCustomColor(color) {
            document.getElementById('proj-color-val').value = color;
            document.querySelectorAll('#proj-color-swatches div').forEach(el => {
                el.style.outline = '2px solid transparent';
            });
        }

        function autoSlug() {
            if (_projEditSlug) return;  // don't overwrite slug when editing
            const name = document.getElementById('proj-name').value;
            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
            document.getElementById('proj-slug').value = slug;
        }

        function openNewProjectModal() {
            _projEditSlug = null;
            document.getElementById('proj-modal-title').textContent = 'New Project';
            document.getElementById('proj-name').value = '';
            document.getElementById('proj-slug').value = '';
            document.getElementById('proj-slug').disabled = false;
            document.getElementById('proj-desc').value = '';
            document.getElementById('proj-modal-error').style.display = 'none';
            const defaultColor = PROJ_COLORS[Math.floor(Math.random() * PROJ_COLORS.length)];
            document.getElementById('proj-color-val').value = defaultColor;
            _buildColorSwatches(defaultColor);
            document.getElementById('proj-modal').style.display = 'flex';
            document.getElementById('proj-name').focus();
        }

        function openEditProjectModal(slug) {
            const p = _projCache.find(x => x.slug === slug);
            if (!p) return;
            _projEditSlug = slug;
            document.getElementById('proj-modal-title').textContent = 'Edit Project';
            document.getElementById('proj-name').value = p.name;
            document.getElementById('proj-slug').value = p.slug;
            document.getElementById('proj-slug').disabled = true;
            document.getElementById('proj-desc').value = p.description || '';
            document.getElementById('proj-modal-error').style.display = 'none';
            const color = p.color || PROJ_COLORS[0];
            document.getElementById('proj-color-val').value = color;
            _buildColorSwatches(color);
            document.getElementById('proj-modal').style.display = 'flex';
            document.getElementById('proj-name').focus();
        }

        function closeProjModal() {
            document.getElementById('proj-modal').style.display = 'none';
        }

        async function saveProject() {
            const name = document.getElementById('proj-name').value.trim();
            const slug = document.getElementById('proj-slug').value.trim();
            const description = document.getElementById('proj-desc').value.trim();
            const color = document.getElementById('proj-color-val').value;
            const errDiv = document.getElementById('proj-modal-error');
            const btn = document.getElementById('proj-save-btn');

            if (!name) { errDiv.textContent = 'Name is required.'; errDiv.style.display = ''; return; }
            if (!_projEditSlug && !slug) { errDiv.textContent = 'Slug is required.'; errDiv.style.display = ''; return; }
            if (!_projEditSlug && !/^[a-z0-9-]+$/.test(slug)) {
                errDiv.textContent = 'Slug must contain only lowercase letters, numbers, and hyphens.';
                errDiv.style.display = ''; return;
            }

            btn.disabled = true; errDiv.style.display = 'none';

            try {
                let res;
                if (_projEditSlug) {
                    res = await apiFetch(apiUrl(`/api/projects/${_projEditSlug}`), {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name, description, color})
                    });
                } else {
                    res = await apiFetch(apiUrl('/api/projects'), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name, slug, description, color})
                    });
                }
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                closeProjModal();
                loadProjectsList();
                loadProjectSelector();
            } catch (e) {
                errDiv.textContent = e.message;
                errDiv.style.display = '';
            } finally {
                btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Archive / Unarchive ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function toggleArchiveProject(slug, archive) {
            const action = archive ? 'archive' : 'unarchive';
            try {
                const res = await apiFetch(apiUrl(`/api/projects/${slug}/${action}`), {method: 'POST'});
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                loadProjectsList();
                loadProjectSelector();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ‚îÄ‚îÄ Delete modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function openDelProjModal(slug, name, docCount) {
            document.getElementById('del-proj-slug').value = slug;
            document.getElementById('del-proj-name').textContent = name;
            document.getElementById('del-proj-count').textContent = docCount;
            document.getElementById('del-proj-data').checked = true;
            document.getElementById('del-proj-error').style.display = 'none';
            document.getElementById('del-proj-modal').style.display = 'flex';
        }

        function closeDelProjModal() {
            document.getElementById('del-proj-modal').style.display = 'none';
        }

        async function confirmDeleteProject() {
            const slug = document.getElementById('del-proj-slug').value;
            const deleteData = document.getElementById('del-proj-data').checked;
            const errDiv = document.getElementById('del-proj-error');
            try {
                const res = await apiFetch(apiUrl(`/api/projects/${slug}?delete_data=${deleteData}`), {method: 'DELETE'});
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                closeDelProjModal();
                loadProjectsList();
                loadProjectSelector();
            } catch (e) {
                errDiv.textContent = e.message;
                errDiv.style.display = '';
            }
        }

        // ‚îÄ‚îÄ Move Documents modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function _populateMoveSelects(sourceSlug) {
            const active = _projCache.filter(p => !p.is_archived);
            const opts = active.map(p => `<option value="${p.slug}">${p.name} (${p.document_count} docs)</option>`).join('');
            const src = document.getElementById('move-source');
            const dst = document.getElementById('move-dest');
            src.innerHTML = opts;
            dst.innerHTML = opts;
            if (sourceSlug) src.value = sourceSlug;
            // Default dest to something different
            const destSlug = active.find(p => p.slug !== src.value)?.slug;
            if (destSlug) dst.value = destSlug;
        }

        function openMoveModal(sourceSlug) {
            _populateMoveSelects(sourceSlug);
            document.querySelector('input[name="move-scope"][value="all"]').checked = true;
            document.getElementById('move-ids-wrap').style.display = 'none';
            document.getElementById('move-doc-ids').value = '';
            document.getElementById('move-modal-error').style.display = 'none';
            document.getElementById('move-modal-status').style.display = 'none';
            document.getElementById('move-confirm-btn').disabled = false;
            updateMovePreview();
            document.getElementById('move-modal').style.display = 'flex';
        }

        function closeMoveModal() {
            document.getElementById('move-modal').style.display = 'none';
        }

        function toggleMoveIds() {
            const specific = document.querySelector('input[name="move-scope"][value="specific"]').checked;
            document.getElementById('move-ids-wrap').style.display = specific ? '' : 'none';
        }

        function updateMovePreview() {
            const srcSlug = document.getElementById('move-source').value;
            const srcProj = _projCache.find(p => p.slug === srcSlug);
            const preview = document.getElementById('move-preview');
            if (srcProj) {
                document.getElementById('move-all-count').textContent = srcProj.document_count;
                preview.textContent = `üì¶ Up to ${srcProj.document_count} document(s) will be re-tagged in Paperless. This runs in the background.`;
                preview.style.display = '';
            } else {
                preview.style.display = 'none';
            }
        }

        async function confirmMove() {
            const srcSlug = document.getElementById('move-source').value;
            const dstSlug = document.getElementById('move-dest').value;
            const specific = document.querySelector('input[name="move-scope"][value="specific"]').checked;
            const errDiv = document.getElementById('move-modal-error');
            const statusDiv = document.getElementById('move-modal-status');
            const btn = document.getElementById('move-confirm-btn');

            if (srcSlug === dstSlug) {
                errDiv.textContent = 'Source and destination must be different projects.';
                errDiv.style.display = ''; return;
            }

            let docIds = [];
            if (specific) {
                const raw = document.getElementById('move-doc-ids').value.trim();
                if (!raw) { errDiv.textContent = 'Enter at least one document ID.'; errDiv.style.display = ''; return; }
                docIds = raw.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
                if (!docIds.length) { errDiv.textContent = 'No valid document IDs found.'; errDiv.style.display = ''; return; }
            }

            btn.disabled = true;
            errDiv.style.display = 'none';
            statusDiv.style.display = 'none';

            try {
                const res = await apiFetch(apiUrl('/api/projects/migrate-documents'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        source_project: srcSlug,
                        destination_project: dstSlug,
                        document_ids: docIds
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Request failed');
                statusDiv.innerHTML = `<span style="color:#16a34a;">‚úÖ ${data.message || 'Migration started.'}</span><br><span style="font-size:12px; color:#6b7280;">${data.note || ''}</span>`;
                statusDiv.style.display = '';
                btn.textContent = 'Close';
                btn.onclick = () => { closeMoveModal(); loadProjectsList(); loadProjectSelector(); btn.textContent = 'Move Documents'; btn.onclick = confirmMove; btn.disabled = false; };
                btn.disabled = false;
            } catch (e) {
                errDiv.textContent = e.message;
                errDiv.style.display = '';
                btn.disabled = false;
            }
        }

        // ‚îÄ‚îÄ Upload tab state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _uploadMode = 'file';          // 'file' | 'url' | 'cloud'
        let _smartPendingPayload = null;   // holds {type, file|url, metadata, source} during preview
        let _fileListFiles = [];           // files returned by scan-url directory scan
        let _fileListAuthPayload = {};     // auth/source payload shared by all batch uploads

        function switchUploadMode(mode) {
            _uploadMode = mode;
            ['file', 'url', 'cloud'].forEach(m => {
                const btn = document.getElementById('umode-' + m);
                const pnl = document.getElementById('uinput-' + m);
                const active = m === mode;
                btn.style.background = active ? '#fff' : 'transparent';
                btn.style.borderBottom = active ? '3px solid #2563eb' : '3px solid transparent';
                btn.style.fontWeight = active ? '600' : '500';
                btn.style.color = active ? '#2563eb' : '#555';
                pnl.style.display = active ? '' : 'none';
            });
            document.getElementById('upload-status').innerHTML = '';
            cancelSmartPreview();
        }

        function updateAuthFields() {
            const t = document.getElementById('upload-auth-type').value;
            document.getElementById('upload-auth-basic').style.display = t === 'basic' ? '' : 'none';
            document.getElementById('upload-auth-token').style.display = t === 'token' ? '' : 'none';
        }

        function handleDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (!files.length) return;
            const input = document.getElementById('upload-file-input');
            const dt = new DataTransfer();
            dt.items.add(files[0]);
            input.files = dt.files;
            document.getElementById('upload-file-name').textContent = files[0].name;
            const dz = document.getElementById('upload-dropzone');
            dz.style.background = '';
            dz.style.borderColor = '#2563eb';
        }

        function setUploadStatus(html) {
            document.getElementById('upload-status').innerHTML = html;
        }

        function cancelSmartPreview() {
            _smartPendingPayload = null;
            document.getElementById('upload-meta-preview').style.display = 'none';
            document.getElementById('upload-meta-content').innerHTML = '';
        }

        async function detectAndTransform(url) {
            const res = await apiFetch(apiUrl('/api/upload/transform-url'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url})
            });
            return await res.json();
        }

        async function _scanUrl(url, authPayload) {
            try {
                const res = await apiFetch(apiUrl('/api/upload/scan-url'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(Object.assign({url}, authPayload)),
                });
                return await res.json();
            } catch(e) {
                return {error: e.message};
            }
        }

        function _fmtSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return Math.round(bytes / 1024) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function _showFileList(files, authPayload) {
            _fileListFiles = files;
            _fileListAuthPayload = authPayload;

            const extColor = {
                '.pdf':'#dc2626','.docx':'#2563eb','.doc':'#2563eb','.odt':'#2563eb',
                '.png':'#16a34a','.jpg':'#16a34a','.jpeg':'#16a34a','.gif':'#16a34a',
                '.tiff':'#16a34a','.tif':'#16a34a','.webp':'#16a34a','.heic':'#16a34a',
                '.xlsx':'#15803d','.xls':'#15803d','.ods':'#15803d','.csv':'#15803d',
                '.pptx':'#d97706','.ppt':'#d97706','.txt':'#6b7280','.eml':'#9333ea',
            };
            const rows = files.map(function(f, i) {
                const col = extColor[f.ext] || '#6b7280';
                const badge = f.ext.slice(1).toUpperCase();
                const sz = _fmtSize(f.size_bytes);
                return '<div style="display:flex;align-items:center;gap:8px;padding:7px 12px;border-bottom:1px solid #f0f0f0;" id="flist-row-' + i + '">'
                    + '<input type="checkbox" class="flist-cb" data-idx="' + i + '" checked style="width:13px;height:13px;flex-shrink:0;">'
                    + '<span style="background:' + col + ';color:#fff;font-size:10px;font-weight:700;padding:1px 5px;border-radius:3px;min-width:34px;text-align:center;flex-shrink:0;">' + badge + '</span>'
                    + '<span style="flex:1;font-size:13px;color:#111;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + f.filename + '">' + f.filename + '</span>'
                    + (sz ? '<span style="font-size:11px;color:#9ca3af;white-space:nowrap;">' + sz + '</span>' : '')
                    + '<span id="flist-st-' + i + '" style="font-size:12px;width:20px;text-align:center;flex-shrink:0;"></span>'
                    + '</div>';
            }).join('');

            document.getElementById('upload-filelist-table').innerHTML = rows;
            document.getElementById('upload-filelist-count').textContent = files.length;
            document.getElementById('upload-filelist-selectall').checked = true;
            document.getElementById('upload-filelist').style.display = '';
            document.getElementById('upload-filelist-progress').textContent = '';
            setUploadStatus('');
            _updateFileListBtn();
        }

        function _updateFileListBtn() {
            const n = document.querySelectorAll('.flist-cb:checked').length;
            const btn = document.getElementById('upload-filelist-btn');
            btn.textContent = 'Upload ' + n + ' file' + (n !== 1 ? 's' : '');
            btn.disabled = n === 0;
        }

        function toggleSelectAllFiles(checked) {
            document.querySelectorAll('.flist-cb').forEach(function(cb) { cb.checked = checked; });
            _updateFileListBtn();
        }

        function cancelFileList() {
            _fileListFiles = [];
            _fileListAuthPayload = {};
            document.getElementById('upload-filelist').style.display = 'none';
            setUploadStatus('');
        }

        async function uploadSelectedFiles() {
            const indices = [];
            document.querySelectorAll('.flist-cb:checked').forEach(function(cb) {
                indices.push(parseInt(cb.getAttribute('data-idx')));
            });
            if (!indices.length) return;

            const btn = document.getElementById('upload-filelist-btn');
            const prog = document.getElementById('upload-filelist-progress');
            btn.disabled = true;

            let done = 0, failed = 0;
            for (let i = 0; i < indices.length; i++) {
                const idx = indices[i];
                const f = _fileListFiles[idx];
                const stEl = document.getElementById('flist-st-' + idx);
                stEl.textContent = '‚è≥';
                prog.textContent = (i + 1) + '/' + indices.length + ' uploading‚Ä¶';
                try {
                    const payload = Object.assign({}, _fileListAuthPayload, {url: f.url});
                    const res = await apiFetch(apiUrl('/api/upload/from-url'), {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload),
                    });
                    const data = await res.json();
                    if (data.success) { stEl.textContent = '‚úÖ'; done++; }
                    else { stEl.title = data.error || 'failed'; stEl.textContent = '‚ùå'; failed++; }
                } catch(e) {
                    stEl.title = e.message; stEl.textContent = '‚ùå'; failed++;
                }
            }
            prog.textContent = done + ' uploaded' + (failed ? ', ' + failed + ' failed' : '') + ' ‚Äî ‚è≥ analyzer picks up in ~30 s';
            btn.disabled = false;
            if (done > 0) loadImportHistory();
        }

        async function doUpload() {
            const btn = document.getElementById('upload-submit-btn');
            const smartMeta = document.getElementById('upload-smart-meta').checked;
            btn.disabled = true;
            cancelSmartPreview();

            try {
                if (_uploadMode === 'file') {
                    await _doFileUpload(smartMeta);
                } else {
                    await _doUrlUpload(smartMeta);
                }
            } finally {
                btn.disabled = false;
            }
        }

        async function _doFileUpload(smartMeta) {
            const fileInput = document.getElementById('upload-file-input');
            if (!fileInput.files || !fileInput.files.length) {
                setUploadStatus('<div style="color:#e74c3c;">Please select a file first.</div>');
                return;
            }
            const file = fileInput.files[0];

            if (smartMeta) {
                // Step 1: analyze
                setUploadStatus('<div style="color:#2563eb;">üîç Analyzing document with AI‚Ä¶</div>');
                const fd = new FormData();
                fd.append('file', file);
                const res = await apiFetch(apiUrl('/api/upload/analyze'), {method: 'POST', body: fd});
                const meta = await res.json();
                if (meta.error) {
                    setUploadStatus('<div style="color:#e74c3c;">‚ùå Analysis failed: ' + meta.error + '</div>');
                    return;
                }
                _smartPendingPayload = {type: 'file', file, metadata: meta};
                showSmartPreview(meta);
                setUploadStatus('');
            } else {
                setUploadStatus('<div style="color:#2563eb;">‚è≥ Uploading‚Ä¶</div>');
                const fd = new FormData();
                fd.append('file', file);
                const res = await apiFetch(apiUrl('/api/upload/submit'), {method: 'POST', body: fd});
                const data = await res.json();
                if (data.success) {
                    setUploadStatus('<div style="color:#16a34a; padding:10px; background:#dcfce7; border-radius:6px;">‚úÖ Uploaded: <strong>' + (data.title || file.name) + '</strong><br><span style="font-size:12px; color:#6b7280;">‚è≥ Analyzer will process it on the next poll (~30 s)</span></div>');
                    fileInput.value = '';
                    document.getElementById('upload-file-name').textContent = '';
                    loadImportHistory();
                } else {
                    setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + (data.error || 'Upload failed') + '</div>');
                }
            }
        }

        async function _doUrlUpload(smartMeta) {
            const rawUrl = (_uploadMode === 'cloud'
                ? document.getElementById('upload-cloud-input')
                : document.getElementById('upload-url-input')).value.trim();

            if (!rawUrl) {
                setUploadStatus('<div style="color:#e74c3c;">Please enter a URL.</div>');
                return;
            }

            // Step 1: transform cloud / share links to direct download URLs
            let directUrl = rawUrl;
            let service = 'url';
            try {
                setUploadStatus('<div style="color:#2563eb;">üîó Resolving URL‚Ä¶</div>');
                const tx = await detectAndTransform(rawUrl);
                if (tx.error) throw new Error(tx.error);
                directUrl = tx.direct_url;
                service = tx.service || 'url';
                if (_uploadMode === 'cloud') {
                    const det = document.getElementById('upload-cloud-detected');
                    det.textContent = 'Detected: ' + service.replace('_', ' ');
                }
            } catch (e) {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå URL transform error: ' + e.message + '</div>');
                return;
            }

            const authType = _uploadMode === 'url' ? document.getElementById('upload-auth-type').value : 'none';
            const urlPayload = {
                url: directUrl,
                source: service,
                auth_type: authType,
                username: authType === 'basic' ? document.getElementById('upload-auth-user').value : undefined,
                password: authType === 'basic' ? document.getElementById('upload-auth-pass').value : undefined,
                token: authType === 'token' ? document.getElementById('upload-auth-token-val').value : undefined,
            };

            // Step 2: scan ‚Äî single file or a directory listing?
            setUploadStatus('<div style="color:#2563eb;">üîç Scanning URL‚Ä¶</div>');
            const scan = await _scanUrl(directUrl, urlPayload);
            if (scan.error) {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + scan.error + '</div>');
                return;
            }

            if (scan.type === 'directory') {
                // Show file-picker panel; user chooses which files to upload
                _showFileList(scan.files, urlPayload);
                return;
            }

            // Single file ‚Äî proceed to direct upload
            if (smartMeta) {
                setUploadStatus('<div style="color:#f59e0b; padding:8px 12px; background:#fef3c7; border-radius:6px;">‚ö†Ô∏è Smart Metadata is not available for URL uploads ‚Äî uploading directly.</div>');
                await new Promise(r => setTimeout(r, 1500));
            }

            setUploadStatus('<div style="color:#2563eb;">‚è≥ Downloading and uploading‚Ä¶</div>');
            const res = await apiFetch(apiUrl('/api/upload/from-url'), {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(urlPayload)
            });
            const data = await res.json();
            if (data.success) {
                setUploadStatus('<div style="color:#16a34a; padding:10px; background:#dcfce7; border-radius:6px;">‚úÖ Uploaded: <strong>' + (data.title || directUrl) + '</strong><br><span style="font-size:12px; color:#6b7280;">‚è≥ Analyzer will process it on the next poll (~30 s)</span></div>');
                if (_uploadMode === 'cloud') document.getElementById('upload-cloud-input').value = '';
                if (_uploadMode === 'url') document.getElementById('upload-url-input').value = '';
                loadImportHistory();
            } else {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + (data.error || 'Upload failed') + '</div>');
            }
        }

        function showSmartPreview(meta) {
            const top = meta.project_suggestions?.[0];
            const html = `
                <table style="width:100%; border-collapse:collapse; font-size:13px;">
                    <tr><td style="padding:4px 8px; color:#6b7280; white-space:nowrap; width:130px;">Title</td><td style="padding:4px 8px; font-weight:600;">${meta.suggested_title || '‚Äî'}</td></tr>
                    <tr><td style="padding:4px 8px; color:#6b7280;">Type</td><td style="padding:4px 8px;">${meta.document_type || '‚Äî'}</td></tr>
                    <tr><td style="padding:4px 8px; color:#6b7280;">Tags</td><td style="padding:4px 8px;">${(meta.suggested_tags || []).join(', ') || '‚Äî'}</td></tr>
                    <tr><td style="padding:4px 8px; color:#6b7280;">Project</td><td style="padding:4px 8px;">${top ? top.name + ' (' + Math.round((top.confidence||0)*100) + '%)' : '‚Äî'}</td></tr>
                </table>
                ${top ? '<input type="hidden" id="smart-project-slug" value="' + top.slug + '">' : ''}
            `;
            document.getElementById('upload-meta-content').innerHTML = html;
            document.getElementById('upload-meta-preview').style.display = '';
        }

        async function confirmSmartUpload() {
            if (!_smartPendingPayload) return;
            const {type, file, metadata} = _smartPendingPayload;
            const projectSlug = document.getElementById('smart-project-slug')?.value;
            if (!projectSlug) {
                setUploadStatus('<div style="color:#e74c3c;">No project suggested ‚Äî please upload without Smart Metadata.</div>');
                return;
            }
            cancelSmartPreview();
            setUploadStatus('<div style="color:#2563eb;">‚è≥ Uploading with AI metadata‚Ä¶</div>');

            const fd = new FormData();
            fd.append('file', file);
            fd.append('project_slug', projectSlug);
            fd.append('metadata', JSON.stringify(metadata));
            const res = await apiFetch(apiUrl('/api/upload/submit'), {method: 'POST', body: fd});
            const data = await res.json();
            if (data.success) {
                setUploadStatus('<div style="color:#16a34a; padding:10px; background:#dcfce7; border-radius:6px;">‚úÖ Uploaded: <strong>' + (data.title || file.name) + '</strong><br><span style="font-size:12px; color:#6b7280;">‚è≥ Analyzer will process it on the next poll (~30 s)</span></div>');
                document.getElementById('upload-file-input').value = '';
                document.getElementById('upload-file-name').textContent = '';
                loadImportHistory();
            } else {
                setUploadStatus('<div style="color:#e74c3c;">‚ùå ' + (data.error || 'Upload failed') + '</div>');
            }
        }

        async function loadImportHistory() {
            const body = document.getElementById('upload-history-body');
            if (!body) return;
            try {
                const res = await apiFetch(apiUrl('/api/upload/history'));
                const data = await res.json();
                const rows = data.history || [];
                if (!rows.length) {
                    body.innerHTML = '<div style="padding:20px; color:#9ca3af; font-size:13px; text-align:center;">No imports yet.</div>';
                    return;
                }
                const badgeColors = {
                    file: '#6366f1', url: '#0284c7',
                    google_drive: '#16a34a', dropbox: '#2563eb', onedrive: '#0ea5e9'
                };
                const rows_html = rows.map(r => {
                    const color = badgeColors[r.source] || '#6b7280';
                    const badge = `<span style="background:${color}; color:#fff; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:600;">${(r.source || 'unknown').replace('_', '\u00a0')}</span>`;
                    const statusIcon = r.status === 'uploaded' ? '‚úÖ' : '‚ùå';
                    const ts = r.created_at ? r.created_at.replace('T', ' ').slice(0, 16) : '';
                    return `<tr style="border-top:1px solid #f3f4f6;">
                        <td style="padding:8px 12px; font-size:13px; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.filename || r.original_url || '‚Äî'}</td>
                        <td style="padding:8px 12px;">${badge}</td>
                        <td style="padding:8px 12px; font-size:12px; color:#6b7280; white-space:nowrap;">${ts}</td>
                        <td style="padding:8px 12px; font-size:13px;">${statusIcon} ${r.status}</td>
                    </tr>`;
                }).join('');
                body.innerHTML = `<table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="background:#f9fafb;">
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Filename / URL</th>
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Source</th>
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Uploaded</th>
                        <th style="padding:8px 12px; text-align:left; font-size:12px; color:#6b7280; font-weight:600;">Status</th>
                    </tr></thead>
                    <tbody>${rows_html}</tbody>
                </table>`;
            } catch (e) {
                body.innerHTML = '<div style="padding:12px; color:#e74c3c; font-size:13px;">Failed to load history.</div>';
            }
        }

        function refresh() {
            fetchStatus();
            fetchRecent();
            fetchProfiles();
            refreshVectorTypes();
            loadAIConfig();
            // Refresh import history only when the upload tab is visible
            if (document.getElementById('tab-upload')?.classList.contains('active')) {
                loadImportHistory();
            }
            // Vector store documents are loaded lazily when the sub-tab is opened;
            // no need to reload 700+ doc rows on every 10-second poll
        }

        // Reprocess all documents
        async function reprocessAll() {
            if (!confirm('Reset state and reprocess ALL documents? This will analyze every document on the next poll cycle.')) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/reprocess'), { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    refresh();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to reprocess: ' + error.message);
            }
        }

        // Reprocess specific document
        async function reprocessDocument() {
            const docId = document.getElementById('reprocess-doc-id').value;
            if (!docId) {
                alert('Please enter a document ID');
                return;
            }

            try {
                const response = await apiFetch(apiUrl(`/api/reprocess/${docId}`), { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    document.getElementById('reprocess-doc-id').value = '';
                    refresh();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to reprocess: ' + error.message);
            }
        }

        // Vector store management functions
        async function refreshVectorTypes() {
            try {
                const response = await apiFetch(apiUrl('/api/vector/types'));
                const data = await response.json();

                if (!data.success) {
                    console.error('Failed to load document types');
                    return;
                }

                // Update dropdown
                const dropdown = document.getElementById('document-type-filter');
                const currentSelection = dropdown.value;

                dropdown.innerHTML = '<option value="all">All Documents</option>';
                data.document_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    const count = data.by_type[type] || 0;
                    option.textContent = `${type} (${count})`;
                    dropdown.appendChild(option);
                });

                // Restore selection if it still exists
                if (data.document_types.includes(currentSelection)) {
                    dropdown.value = currentSelection;
                } else {
                    dropdown.value = 'all';
                }

                // Update breakdown text
                const breakdownSpan = document.getElementById('type-breakdown');
                const totalDocs = Object.values(data.by_type).reduce((sum, count) => sum + count, 0);
                breakdownSpan.textContent = `${totalDocs} total documents`;

            } catch (error) {
                console.error('Failed to refresh document types:', error);
            }
        }

        // Load all vector store documents grouped by type
        async function loadVectorStoreDocuments() {
            vsLoaded = true;
            const container = document.getElementById('vector-store-manager');
            if (container) container.innerHTML = '<div class="loading">Loading vector store documents‚Ä¶</div>';
            try {
                const response = await apiFetch(apiUrl('/api/vector/documents'));
                const data = await response.json();

                if (!data.success) {
                    if (container) container.innerHTML = '<p style="color:#e74c3c;">Failed to load vector store documents</p>';
                    return;
                }

                if (!data.documents || Object.keys(data.documents).length === 0) {
                    if (container) container.innerHTML = '<p style="color:#999;">No documents in vector store yet.</p>';
                    vsAllDocs = [];
                    vsFiltered = [];
                    renderVsPage();
                    return;
                }

                // Flatten into [{title, doc_id, type}, ‚Ä¶]
                vsAllDocs = [];
                Object.entries(data.documents).forEach(([type, docs]) => {
                    docs.forEach(d => vsAllDocs.push({title: d.title, doc_id: d.doc_id, type}));
                });
                // Preserve any active search filter
                filterVsDocs();

            } catch (error) {
                console.error('Failed to load vector store documents:', error);
                if (container) container.innerHTML = '<p style="color:#e74c3c;">Failed to load vector store documents</p>';
            }
        }

        // Delete individual document from vector store
        async function deleteIndividualDocument(docId, docTitle) {
            if (!confirm(`Delete "${docTitle}" from vector store?\n\nThis will remove the embedding but NOT delete the original document from Paperless.`)) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/vector/delete-document'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ doc_id: docId })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    vsLoaded = false;
                    loadVectorStoreDocuments();
                    fetchStatus();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to delete document: ' + error.message);
            }
        }

        async function confirmDeleteType(documentType) {
            if (!confirm(`Delete all "${documentType}" documents from vector store?\n\nThis will remove embeddings but NOT delete the original documents from Paperless.`)) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/vector/delete-by-type'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ document_type: documentType })
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}`);
                    refreshVectorTypes();
                    vsLoaded = false;
                    loadVectorStoreDocuments();
                    fetchStatus();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to delete documents: ' + error.message);
            }
        }

        async function confirmClearVectorStore() {
            if (!confirm('Clear ALL embeddings from vector store?\n\nThis will NOT delete the original documents from Paperless, only the vector embeddings. You can re-embed documents by reprocessing them.')) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/vector/clear'), { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    refreshVectorTypes();
                    vsLoaded = false;
                    loadVectorStoreDocuments();
                    fetchStatus();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to clear vector store: ' + error.message);
            }
        }

        async function triggerReembedStale() {
            const btn = document.getElementById('btn-reembed-stale');
            const orig = btn ? btn.textContent : '';
            if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Checking‚Ä¶'; }
            try {
                const response = await apiFetch(apiUrl('/api/vector/reembed-stale'), { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed to start stale check: ' + error.message);
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = orig; }
            }
        }

        // Update poll interval setting
        async function updatePollInterval() {
            const interval = document.getElementById('poll-interval').value;
            const resultDiv = document.getElementById('settings-result');

            if (!interval || interval < 5 || interval > 3600) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fff3cd';
                resultDiv.style.color = '#856404';
                resultDiv.textContent = '‚ö†Ô∏è Poll interval must be between 5 and 3600 seconds';
                return;
            }

            if (!confirm(`Update poll interval to ${interval} seconds?\n\nThis will require restarting the analyzer container to take effect.`)) {
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üîÑ Updating poll interval...';

            try {
                const response = await apiFetch(apiUrl('/api/settings/poll-interval'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ interval: parseInt(interval) })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.innerHTML = '‚úÖ ' + data.message.replace(/\n/g, '<br>');
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = '‚úó ' + (data.error || 'Unknown error');
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Failed to update: ' + error.message;
            }
        }

        // Refresh logs
        async function refreshLogs() {
            try {
                const response = await apiFetch(apiUrl('/api/logs?limit=100'));
                const data = await response.json();

                const logsViewer = document.getElementById('logs-viewer');

                if (data.logs.length === 0) {
                    logsViewer.innerHTML = '<div class="empty-state">No logs available</div>';
                    return;
                }

                logsViewer.innerHTML = data.logs.filter(line => line.trim()).map(line => {
                    let className = 'log-line';
                    if (line.includes('ERROR')) className += ' error';
                    else if (line.includes('WARNING') || line.includes('WARN')) className += ' warning';
                    else if (line.includes('INFO')) className += ' info';

                    return `<div class="${className}">${escapeHtml(line)}</div>`;
                }).join('');

                // Auto-scroll to bottom
                logsViewer.scrollTop = logsViewer.scrollHeight;
            } catch (error) {
                console.error('Failed to fetch logs:', error);
                document.getElementById('logs-viewer').innerHTML = '<div class="empty-state">Failed to load logs</div>';
            }
        }

        // Search analyses
        async function performSearch() {
            const query = document.getElementById('search-query').value;
            const riskMin = document.getElementById('search-risk-min').value;
            const riskMax = document.getElementById('search-risk-max').value;
            const hasAnomalies = document.getElementById('search-anomalies').checked;

            const params = new URLSearchParams();
            if (query) params.append('q', query);
            if (riskMin) params.append('risk_min', riskMin);
            if (riskMax) params.append('risk_max', riskMax);
            if (hasAnomalies) params.append('has_anomalies', 'true');

            try {
                const response = await apiFetch(apiUrl(`/api/search?${params}`));
                const data = await response.json();

                const resultsContainer = document.getElementById('search-results');

                if (data.results.length === 0) {
                    resultsContainer.innerHTML = '<div class="empty-state">No results found</div>';
                    return;
                }

                resultsContainer.innerHTML = `
                    <div style="margin-bottom: 10px; font-weight: 600;">Found ${data.count} result(s)</div>
                    ${data.results.map(analysis => {
                        const hasAnomalies = analysis.anomalies_found && analysis.anomalies_found.length > 0;
                        const isHighRisk = analysis.risk_score >= 70;
                        const classes = ['recent-item'];
                        if (hasAnomalies) classes.push('has-anomalies');
                        if (isHighRisk) classes.push('high-risk');

                        let tags = '';
                        if (analysis.anomalies_found) {
                            // Check if this document has enhanced tags (issue count > 0 indicates detailed evidence)
                            const hasEvidence = analysis.issue_count > 0 || analysis.enhanced_tags;

                            tags = analysis.anomalies_found.map(a => {
                                // All anomaly tags are now clickable to show explanations
                                return `<span class="tag anomaly clickable" onclick="event.stopPropagation(); showTagEvidence(${analysis.document_id || analysis.doc_id}, '${(analysis.document_title || analysis.title).replace(/'/g, "\\'")}')" title="Click to see why this was flagged">üîç ${a}</span>`;
                            }).join('');

                            // Add "View Evidence" button if document has integrity issues
                            if (hasEvidence) {
                                tags += ` <span class="tag clickable" style="background: #3498db; color: white;" onclick="event.stopPropagation(); showTagEvidence(${analysis.document_id || analysis.doc_id}, '${(analysis.document_title || analysis.title).replace(/'/g, "\\'")}');" title="Click to view all evidence">üìã View Evidence</span>`;
                            }
                        }

                        // Format summaries if available
                        const briefSummary = analysis.brief_summary || '';
                        const fullSummary = analysis.full_summary || '';
                        const detailsId = `search-summary-details-${analysis.doc_id}`;
                        const summaryHtml = briefSummary ? `
                            <div style="margin-top: 8px; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 4px; font-size: 0.9em;">
                                <div style="color: #555; font-style: italic;">
                                    üí° ${briefSummary}
                                </div>
                                ${fullSummary && fullSummary !== briefSummary ? `
                                    <details id="${detailsId}" style="margin-top: 4px;">
                                        <summary style="cursor: pointer; color: #3498db; font-size: 0.85em;">Show full summary</summary>
                                        <div style="margin-top: 6px; color: #666; line-height: 1.4;">
                                            ${fullSummary}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        ` : '';

                        return `
                            <div class="${classes.join(' ')}">
                                <div class="title">${analysis.document_title || analysis.title}</div>
                                <div class="meta">
                                    <span>üìÑ <a href="https://www.voipguru.org/paperless/documents/${analysis.document_id || analysis.doc_id}" target="_blank" style="color: #3498db; text-decoration: none;">Doc #${analysis.document_id || analysis.doc_id}</a></span>
                                    <span>‚ö†Ô∏è Risk: ${analysis.risk_score}%</span>
                                    ${analysis.profile_matched ? `<span>üìã ${analysis.profile_matched}</span>` : '<span>‚ùì No profile</span>'}
                                    <span>‚è±Ô∏è ${new Date(analysis.timestamp).toLocaleString()}</span>
                                </div>
                                ${summaryHtml}
                                ${tags ? `<div style="margin-top: 8px;">${tags}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                `;
            } catch (error) {
                console.error('Search failed:', error);
                document.getElementById('search-results').innerHTML = '<div class="empty-state">Search failed</div>';
            }
        }

        // Clear search
        function clearSearch() {
            document.getElementById('search-query').value = '';
            document.getElementById('search-risk-min').value = '';
            document.getElementById('search-risk-max').value = '';
            document.getElementById('search-anomalies').checked = false;
            document.getElementById('search-results').innerHTML = '';
        }

        // HTML escape utility
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check LLM status and show setup panel if needed
        async function checkLLMStatus() {
            try {
                const response = await apiFetch(apiUrl('/api/llm/status'));
                const data = await response.json();

                if (!data.enabled || !data.has_key) {
                    document.getElementById('llm-setup-panel').style.display = 'block';
                    document.getElementById('llm-setup-link').href = data.setup_url;
                }

                // Update provider dropdown change handler
                document.getElementById('llm-provider').value = data.provider;
                document.getElementById('llm-provider').addEventListener('change', function(e) {
                    const links = {
                        'anthropic': 'https://console.anthropic.com/settings/keys',
                        'openai': 'https://platform.openai.com/api-keys'
                    };
                    document.getElementById('llm-setup-link').href = links[e.target.value];
                });
            } catch (error) {
                console.error('Failed to check LLM status:', error);
            }
        }

        // Test LLM API key
        async function testLLMKey() {
            const apiKey = document.getElementById('llm-api-key').value.trim();
            const provider = document.getElementById('llm-provider').value;
            const resultDiv = document.getElementById('llm-test-result');
            const saveBtn = document.getElementById('save-llm-btn');

            if (!apiKey) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fff3cd';
                resultDiv.style.color = '#856404';
                resultDiv.textContent = '‚ö†Ô∏è Please paste your API key first';
                saveBtn.style.display = 'none';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üîÑ Testing API key...';
            saveBtn.style.display = 'none';

            try {
                const response = await apiFetch(apiUrl('/api/llm/test'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, api_key: apiKey})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.textContent = data.message;
                    saveBtn.style.display = 'inline-block';
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = data.error;
                    saveBtn.style.display = 'none';
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Failed to test key: ' + error.message;
                saveBtn.style.display = 'none';
            }
        }

        // View staging profile
        async function viewStagingProfile(filename) {
            try {
                const response = await apiFetch(apiUrl(`/api/staging/${filename}`));
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Format YAML nicely
                const yaml = JSON.stringify(data, null, 2);
                const formatted = yaml.replace(/[{}"]/g, '').replace(/,\n/g, '\n');

                alert(`Profile: ${filename}\n\n${formatted}\n\nTo activate, click the ‚úì Activate button.`);
            } catch (error) {
                alert('Failed to load profile: ' + error.message);
            }
        }

        // Activate staging profile
        async function activateStagingProfile(filename) {
            if (!confirm(`Activate profile "${filename}"?\n\nThis will move it to active profiles and restart the analyzer.`)) {
                return;
            }

            try {
                const response = await fetch(`api/staging/${filename}/activate`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Activate all staging profiles
        async function activateAllStagingProfiles() {
            if (!confirm('Activate ALL staging profiles?\n\nThis will move all staging profiles to active and require an analyzer restart.')) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/staging/activate-all'), {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    const msg = `‚úÖ ${data.message}\n\nActivated: ${data.activated}\nFailed: ${data.failed}`;
                    alert(msg);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Delete staging profile
        async function deleteStagingProfile(filename) {
            if (!confirm(`Delete profile "${filename}"?\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`api/staging/${filename}/delete`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Profile deleted');
                    fetchProfiles();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Active profile management
        async function viewActiveProfile(filename) {
            try {
                const response = await apiFetch(apiUrl(`/api/active/${filename}`));
                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                const yaml = JSON.stringify(data, null, 2);
                const formatted = yaml.replace(/[{}"]/g, '').replace(/,\n/g, '\n');
                alert(`Active Profile: ${filename}\n\n${formatted}`);
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        async function renameActiveProfile(filename, currentName) {
            const newName = prompt(`Rename profile "${currentName}":\n\nEnter new display name:`, currentName);
            if (!newName || newName === currentName) {
                return;
            }

            try {
                const response = await fetch(`api/active/${filename}/rename`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({display_name: newName})
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Profile renamed! Reloading profiles...');
                    fetchProfiles();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        async function deleteActiveProfile(filename) {
            if (!confirm(`Delete active profile "${filename}"?\n\nThis will stop using this profile for matching. This cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`api/active/${filename}/delete`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Profile deleted! Restart the analyzer to reload profiles.');
                    fetchProfiles();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Detect duplicate profiles
        async function detectDuplicates() {
            const resultDiv = document.getElementById('duplicates-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">Analyzing profiles for duplicates...</div>';

            try {
                const response = await apiFetch(apiUrl('/api/active/duplicates'));
                const data = await response.json();

                if (data.duplicate_groups === 0) {
                    resultDiv.innerHTML = '<div style="padding: 15px; background: #d4edda; color: #155724; border-radius: 4px;">‚úÖ No duplicates found! All profiles are unique.</div>';
                    return;
                }

                // Build duplicate groups display
                let html = `<div style="padding: 15px; background: #fff3cd; color: #856404; border-radius: 4px; margin-bottom: 15px;">
                    ‚ö†Ô∏è Found ${data.duplicate_groups} duplicate group(s) affecting ${data.groups.reduce((sum, g) => sum + g.profiles.length, 0)} profiles
                </div>`;

                data.groups.forEach((group, idx) => {
                    html += `<div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
                        <strong>Duplicate Group ${idx + 1}</strong> (${group.type})
                        <div style="font-size: 12px; color: #666; margin: 5px 0;">${group.reason}</div>
                        <ul style="margin: 10px 0; padding-left: 20px;">`;

                    group.profiles.forEach(profile => {
                        html += `<li>
                            <input type="checkbox" class="duplicate-checkbox" value="${profile.filename}" style="margin-right: 8px;">
                            <strong>${profile.filename}</strong> - ${profile.display_name}
                        </li>`;
                    });

                    html += `</ul></div>`;
                });

                html += `<div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="removeDuplicates()">üóëÔ∏è Remove Selected</button>
                    <button class="btn btn-secondary" onclick="selectAllDuplicates()">Select All</button>
                    <button class="btn btn-secondary" onclick="deselectAllDuplicates()">Deselect All</button>
                </div>`;

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div style="padding: 15px; background: #f8d7da; color: #721c24; border-radius: 4px;">‚ùå Failed to detect duplicates: ${error.message}</div>`;
            }
        }

        function selectAllDuplicates() {
            document.querySelectorAll('.duplicate-checkbox').forEach(cb => cb.checked = true);
        }

        function deselectAllDuplicates() {
            document.querySelectorAll('.duplicate-checkbox').forEach(cb => cb.checked = false);
        }

        async function removeDuplicates() {
            const checkboxes = document.querySelectorAll('.duplicate-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one profile to remove');
                return;
            }

            const filenames = Array.from(checkboxes).map(cb => cb.value);
            if (!confirm(`Remove ${filenames.length} selected profile(s)?\n\nFiles:\n${filenames.join('\n')}\n\nThis cannot be undone.`)) {
                return;
            }

            try {
                const response = await apiFetch(apiUrl('/api/active/duplicates/remove'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filenames})
                });
                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ ${data.message}\n\nRemoved: ${data.removed}\nFailed: ${data.failed}`);
                    fetchProfiles();
                    document.getElementById('duplicates-result').style.display = 'none';
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Failed: ' + error.message);
            }
        }

        // Save LLM API key
        async function saveLLMKey() {
            const apiKey = document.getElementById('llm-api-key').value.trim();
            const provider = document.getElementById('llm-provider').value;
            const resultDiv = document.getElementById('llm-test-result');

            if (!confirm('Save this API key and enable AI analysis?')) {
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üíæ Saving configuration...';

            try {
                const response = await apiFetch(apiUrl('/api/llm/save'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, api_key: apiKey})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.innerHTML = '‚úÖ ' + data.message.replace(/\n/g, '<br>');

                    // Offer to restart
                    setTimeout(() => {
                        if (confirm('Restart the analyzer container now to enable AI analysis?')) {
                            resultDiv.textContent = 'üîÑ Restarting container... (page will reload in 10 seconds)';
                            setTimeout(() => location.reload(), 10000);
                        }
                    }, 2000);
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = '‚úó ' + data.error;
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Failed to save: ' + error.message;
            }
        }

        // AI Configuration Management
        async function loadAIConfig() {
            try {
                const response = await apiFetch(apiUrl('/api/ai-config'));
                const data = await response.json();

                if (data.success && data.config) {
                    const config = data.config;

                    // Load OpenAI config
                    const openaiProvider = config.document_analysis?.providers?.find(p => p.name === 'openai');
                    if (openaiProvider) {
                        document.getElementById('openai-enabled').checked = openaiProvider.enabled || false;
                        document.getElementById('openai-api-key').value = openaiProvider.api_key || '';
                    }

                    // Load Anthropic config
                    const anthropicProvider = config.document_analysis?.providers?.find(p => p.name === 'anthropic');
                    if (anthropicProvider) {
                        document.getElementById('anthropic-enabled').checked = anthropicProvider.enabled || false;
                        document.getElementById('anthropic-api-key').value = anthropicProvider.api_key || '';
                    }
                }
            } catch (error) {
                console.error('Failed to load AI config:', error);
            }
        }

        async function testAIProvider(provider) {
            const apiKeyInput = document.getElementById(`${provider}-api-key`);
            const resultDiv = document.getElementById(`${provider}-test-result`);
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.padding = '10px';
                resultDiv.style.borderRadius = '4px';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Please enter an API key';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.padding = '10px';
            resultDiv.style.borderRadius = '4px';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üß™ Testing API key...';

            try {
                const response = await apiFetch(apiUrl('/api/ai-config/test'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({provider, api_key: apiKey})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.textContent = data.message;

                    // Auto-enable the provider
                    document.getElementById(`${provider}-enabled`).checked = true;
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = data.error;
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Test failed: ' + error.message;
            }
        }

        async function saveAIConfig() {
            const resultDiv = document.getElementById('ai-config-result');

            // Build configuration object
            const config = {
                document_analysis: {
                    providers: [
                        {
                            name: 'openai',
                            api_key: document.getElementById('openai-api-key').value.trim(),
                            models: ['gpt-4o', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo'],
                            enabled: document.getElementById('openai-enabled').checked
                        },
                        {
                            name: 'anthropic',
                            api_key: document.getElementById('anthropic-api-key').value.trim(),
                            models: ['claude-3-opus-20240229', 'claude-3-5-sonnet-20241022', 'claude-3-sonnet-20240229', 'claude-3-haiku-20240307'],
                            enabled: document.getElementById('anthropic-enabled').checked
                        }
                    ]
                },
                chat: {
                    providers: [
                        {
                            name: 'openai',
                            api_key: document.getElementById('openai-api-key').value.trim(),
                            models: ['gpt-4o', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo'],
                            enabled: document.getElementById('openai-enabled').checked
                        },
                        {
                            name: 'anthropic',
                            api_key: document.getElementById('anthropic-api-key').value.trim(),
                            models: ['claude-3-opus-20240229', 'claude-3-5-sonnet-20241022', 'claude-3-sonnet-20240229', 'claude-3-haiku-20240307'],
                            enabled: document.getElementById('anthropic-enabled').checked
                        }
                    ]
                }
            };

            // Validate at least one provider is enabled
            const hasEnabled = config.document_analysis.providers.some(p => p.enabled && p.api_key);
            if (!hasEnabled) {
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#fff3cd';
                resultDiv.style.padding = '10px';
                resultDiv.style.borderRadius = '4px';
                resultDiv.style.color = '#856404';
                resultDiv.textContent = '‚ö†Ô∏è Warning: No providers enabled. Enable and configure at least one provider.';
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.style.background = '#e7f3ff';
            resultDiv.style.padding = '10px';
            resultDiv.style.borderRadius = '4px';
            resultDiv.style.color = '#004085';
            resultDiv.textContent = 'üíæ Saving AI configuration...';

            try {
                const response = await apiFetch(apiUrl('/api/ai-config'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({config})
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.style.color = '#155724';
                    resultDiv.innerHTML = '‚úÖ ' + data.message;

                    setTimeout(() => {
                        resultDiv.style.display = 'none';
                    }, 5000);
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.style.color = '#721c24';
                    resultDiv.textContent = '‚úó ' + data.error;
                }
            } catch (error) {
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.color = '#721c24';
                resultDiv.textContent = '‚úó Failed to save: ' + error.message;
            }
        }

        // ‚îÄ‚îÄ Chat session state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentSessionId = null;

        async function loadSessions() {
            try {
                const res = await apiFetch(apiUrl('/api/chat/sessions'));
                const data = await res.json();
                renderSessionList(data);
            } catch (e) {
                console.error('Failed to load sessions:', e);
            }
        }

        function renderSessionList(data) {
            const container = document.getElementById('session-list');
            const isAdmin = data.is_admin;
            let html = '';

            function formatDate(iso) {
                if (!iso) return '';
                const d = new Date(iso);
                const now = new Date();
                const diffMs = now - d;
                const diffH = Math.floor(diffMs / 3600000);
                if (diffH < 1) return 'Just now';
                if (diffH < 24) return `${diffH}h ago`;
                const diffD = Math.floor(diffH / 24);
                if (diffD < 7) return `${diffD}d ago`;
                return d.toLocaleDateString();
            }

            function sessionItemHtml(s) {
                const active = s.id === currentSessionId ? ' active' : '';
                const sharedBadge = s.is_shared ? '<span class="session-badge-shared">shared</span>' : '';
                return `<div class="session-item${active}" data-session-id="${s.id}" onclick="loadSession('${s.id}')">
                    <span class="session-title">title: ${escapeHtml(s.title)}${sharedBadge}</span>
                    <span class="session-meta">${formatDate(s.updated_at)}</span>
                    <div class="session-actions" onclick="event.stopPropagation()">
                        <button class="session-action-btn" title="Rename" onclick="renameSessionPrompt('${s.id}', '${escapeHtml(s.title).replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                        ${s.is_own !== false ? `<button class="session-action-btn" title="Delete" onclick="deleteSession('${s.id}')">üóëÔ∏è</button>` : ''}
                    </div>
                </div>`;
            }

            if (isAdmin && data.sessions_by_user) {
                for (const [username, sessions] of Object.entries(data.sessions_by_user)) {
                    html += `<div class="session-group-header">${escapeHtml(username)}</div>`;
                    sessions.forEach(s => { html += sessionItemHtml(s); });
                }
            } else if (data.sessions) {
                const own = data.sessions.filter(s => s.is_own && !s.is_shared);
                const shared = data.sessions.filter(s => s.is_shared);
                if (own.length) {
                    html += '<div class="session-group-header">My Chats</div>';
                    own.forEach(s => { html += sessionItemHtml(s); });
                }
                if (shared.length) {
                    html += '<div class="session-group-header">Shared with me</div>';
                    shared.forEach(s => { html += sessionItemHtml(s); });
                }
            }

            if (!html) {
                html = '<div style="padding: 20px 14px; font-size: 12px; color: #556677;">No chats yet. Start a new chat!</div>';
            }
            container.innerHTML = html;
        }

        function escapeHtml(str) {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        async function loadSession(sessionId) {
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${sessionId}`));
                if (!res.ok) { alert('Failed to load session'); return; }
                const data = await res.json();

                currentSessionId = sessionId;
                chatHistory = [];

                // Update header title
                document.getElementById('active-session-title').textContent = data.session.title;

                // Populate chat messages
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                data.messages.forEach(m => {
                    addChatMessage(m.role, m.content);
                    chatHistory.push({role: m.role, content: m.content});
                });

                if (!data.messages.length) {
                    // Show welcome message if empty session
                    addWelcomeMessage();
                }

                // Switch to AI Chat tab
                switchTab('ai-chat');
                // Update sidebar highlights
                loadSessions();
            } catch (e) {
                console.error('loadSession error:', e);
            }
        }

        function newChat() {
            currentSessionId = null;
            chatHistory = [];
            document.getElementById('active-session-title').textContent = 'New Chat';
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = '';
            addWelcomeMessage();
            switchTab('ai-chat');
            // Deselect active session in sidebar
            document.querySelectorAll('.session-item.active').forEach(el => el.classList.remove('active'));
        }

        function addWelcomeMessage() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = `
                <div class="chat-message assistant">
                    <div class="message-bubble">
                        <div>üëã Hi! I'm your AI document assistant. I can help you:</div>
                        <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                            <li>Analyze patterns across all your documents</li>
                            <li>Find specific transactions or anomalies</li>
                            <li>Generate reports and ledgers</li>
                            <li>Answer questions about your financial documents</li>
                        </ul>
                        <div style="margin-top: 10px;">Try asking me something!</div>
                    </div>
                </div>
                <div class="chat-suggestions">
                    <div class="suggestion-chip" onclick="sendSuggestion('Show me all high-risk documents')">Show me all high-risk documents</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('What anomalies were most common?')">What anomalies were most common?</div>
                    <div class="suggestion-chip" onclick="sendSuggestion('Generate a summary of all analyzed documents')">Generate a summary</div>
                </div>`;
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete this chat session? This cannot be undone.')) return;
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${sessionId}`), {method: 'DELETE'});
                if (!res.ok) { alert('Failed to delete session'); return; }
                if (currentSessionId === sessionId) newChat();
                loadSessions();
            } catch (e) { console.error(e); }
        }

        async function renameSessionPrompt(sessionId, currentTitle) {
            const newTitle = prompt('Rename chat:', currentTitle);
            if (!newTitle || newTitle.trim() === currentTitle) return;
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${sessionId}`), {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: newTitle.trim()}),
                });
                if (!res.ok) { alert('Failed to rename session'); return; }
                if (currentSessionId === sessionId) {
                    document.getElementById('active-session-title').textContent = newTitle.trim();
                }
                loadSessions();
            } catch (e) { console.error(e); }
        }

        // ‚îÄ‚îÄ Share modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _shareSessionId = null;

        function shareCurrentChat() {
            if (!currentSessionId) { alert('Start a chat first, then share it.'); return; }
            openShareModal(currentSessionId);
        }

        async function openShareModal(sessionId) {
            _shareSessionId = sessionId;
            document.getElementById('share-modal').classList.add('active');
            document.getElementById('share-username-input').value = '';
            document.getElementById('share-error').style.display = 'none';
            await refreshShareList();
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
            _shareSessionId = null;
        }

        async function refreshShareList() {
            if (!_shareSessionId) return;
            const res = await apiFetch(apiUrl(`/api/chat/sessions/${_shareSessionId}`));
            const data = await res.json();
            const shares = data.shared_with || [];
            const list = document.getElementById('share-list');
            if (!shares.length) {
                list.innerHTML = '<div style="color: #999; font-size: 13px;">No shares yet</div>';
            } else {
                list.innerHTML = shares.map(s => `
                    <div class="share-list-item">
                        <span>üë§ ${escapeHtml(s.username)}</span>
                        <button class="btn btn-danger" style="font-size: 12px; padding: 3px 10px;"
                            onclick="removeShare(${s.id})">Remove</button>
                    </div>`).join('');
            }
        }

        async function addShare() {
            const username = document.getElementById('share-username-input').value.trim();
            const errEl = document.getElementById('share-error');
            if (!username) { errEl.textContent = 'Enter a username'; errEl.style.display = 'block'; return; }
            errEl.style.display = 'none';
            try {
                const res = await apiFetch(apiUrl(`/api/chat/sessions/${_shareSessionId}/share`), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username}),
                });
                const data = await res.json();
                if (!res.ok) { errEl.textContent = data.error || 'Failed to share'; errEl.style.display = 'block'; return; }
                document.getElementById('share-username-input').value = '';
                await refreshShareList();
            } catch (e) { errEl.textContent = e.message; errEl.style.display = 'block'; }
        }

        async function removeShare(uid) {
            await apiFetch(apiUrl(`/api/chat/sessions/${_shareSessionId}/share/${uid}`), {method: 'DELETE'});
            await refreshShareList();
        }

        document.addEventListener('click', e => {
            const m = document.getElementById('share-modal');
            if (m && e.target === m) closeShareModal();
        });

        // ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function exportCurrentChat() {
            if (!currentSessionId) { alert('Start a chat first, then export it.'); return; }
            window.location.href = apiUrl(`/api/chat/sessions/${currentSessionId}/export`);
        }

        // ‚îÄ‚îÄ User management (admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadUsers() {
            try {
                const res = await apiFetch(apiUrl('/api/users'));
                if (!res.ok) return;
                const data = await res.json();
                renderUsersTable(data.users);
            } catch (e) { console.error(e); }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            if (!users || !users.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:#999;">No users found</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(u => `<tr>
                <td><strong>${escapeHtml(u.username)}</strong></td>
                <td>${escapeHtml(u.display_name || '')}</td>
                <td><span class="role-badge ${u.role}">${u.role}</span></td>
                <td style="font-size:12px; color:#666;">${u.last_login ? u.last_login.split('T')[0] : 'Never'}</td>
                <td>${u.is_active ? '‚úÖ' : '‚ùå'}</td>
                <td style="display:flex; gap:6px; flex-wrap:wrap;">
                    <select id="role-sel-${u.id}" style="padding:3px 6px; font-size:12px; border:1px solid #ddd; border-radius:3px;">
                        <option value="basic" ${u.role==='basic'?'selected':''}>Basic</option>
                        <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                    </select>
                    <button class="btn" style="font-size:11px; padding:3px 8px;" onclick="updateUserRole(${u.id})">Save</button>
                    ${u.is_active
                        ? `<button class="btn btn-danger" style="font-size:11px; padding:3px 8px;" onclick="deactivateUser(${u.id})">Deactivate</button>`
                        : `<button class="btn btn-success" style="font-size:11px; padding:3px 8px;" onclick="activateUser(${u.id})">Activate</button>`
                    }
                </td>
            </tr>`).join('');
        }

        function showAddUserForm() {
            document.getElementById('add-user-form').style.display = 'block';
        }
        function hideAddUserForm() {
            document.getElementById('add-user-form').style.display = 'none';
        }

        async function createUser() {
            const username = document.getElementById('new-user-username').value.trim();
            const password = document.getElementById('new-user-password').value.trim();
            const display_name = document.getElementById('new-user-display').value.trim();
            const role = document.getElementById('new-user-role').value;
            const errEl = document.getElementById('add-user-error');
            if (!username || !password) { errEl.textContent = 'Username and password required'; errEl.style.display = 'block'; return; }
            errEl.style.display = 'none';
            try {
                const res = await apiFetch(apiUrl('/api/users'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password, role, display_name}),
                });
                const data = await res.json();
                if (!res.ok) { errEl.textContent = data.error || 'Failed to create user'; errEl.style.display = 'block'; return; }
                hideAddUserForm();
                document.getElementById('new-user-username').value = '';
                document.getElementById('new-user-password').value = '';
                document.getElementById('new-user-display').value = '';
                loadUsers();
            } catch (e) { errEl.textContent = e.message; errEl.style.display = 'block'; }
        }

        async function updateUserRole(uid) {
            const role = document.getElementById(`role-sel-${uid}`).value;
            await apiFetch(apiUrl(`/api/users/${uid}`), {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({role}),
            });
            loadUsers();
        }

        async function deactivateUser(uid) {
            if (!confirm('Deactivate this user?')) return;
            await apiFetch(apiUrl(`/api/users/${uid}`), {method: 'DELETE'});
            loadUsers();
        }

        async function activateUser(uid) {
            await apiFetch(apiUrl(`/api/users/${uid}`), {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({is_active: 1}),
            });
            loadUsers();
        }

        // Load users when config tab is opened
        const _origSwitchTab = window.switchTab;
        // (We'll hook into switchTab below after it's defined)

        // Chat functionality
        let chatHistory = [];

        function addChatMessage(role, content) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            // Render markdown for assistant messages, plain text for user
            if (role === 'assistant' && typeof marked !== 'undefined') {
                // Configure marked for safe rendering
                marked.setOptions({
                    breaks: true,  // Convert \n to <br>
                    gfm: true,     // GitHub Flavored Markdown (tables, etc.)
                    headerIds: false,
                    mangle: false
                });
                bubble.innerHTML = marked.parse(content);
            } else {
                bubble.textContent = content;
            }

            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            chatHistory.push({role, content});
        }

        function showTypingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-message assistant';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = '<div class="message-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');
            const documentTypeFilter = document.getElementById('document-type-filter');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addChatMessage('user', message);
            input.value = '';

            // Disable input while processing
            input.disabled = true;
            sendBtn.disabled = true;
            showTypingIndicator();

            try {
                const requestBody = {
                    message: message,
                    history: chatHistory.slice(-10), // Last 10 messages for context
                    session_id: currentSessionId,
                };

                // Add document type filter if selected
                if (documentTypeFilter && documentTypeFilter.value !== 'all') {
                    requestBody.document_type = documentTypeFilter.value;
                }

                const response = await apiFetch(apiUrl('/api/chat'), {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });

                // Detect session expiry: redirected to login page
                if (response.redirected && response.url.includes('/login')) {
                    hideTypingIndicator();
                    addChatMessage('assistant', '‚ö†Ô∏è Your session has expired. Please [reload the page](' + window.location.href + ') and log in again.');
                    return;
                }

                if (!response.ok && response.status === 401) {
                    hideTypingIndicator();
                    window.location.href = apiUrl('/login');
                    return;
                }

                const data = await response.json();

                hideTypingIndicator();

                if (data.response) {
                    addChatMessage('assistant', data.response);
                    // Track session and update sidebar
                    if (data.session_id) {
                        const wasNew = !currentSessionId;
                        currentSessionId = data.session_id;
                        if (wasNew) {
                            // Auto-title: update header from first message
                            const autoTitle = message.slice(0, 60);
                            document.getElementById('active-session-title').textContent = autoTitle;
                        }
                        loadSessions();
                    }
                } else {
                    addChatMessage('assistant', 'Sorry, I encountered an error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                hideTypingIndicator();
                addChatMessage('assistant', 'Sorry, I encountered an error: ' + error.message);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.ctrlKey) {
                event.preventDefault();
                sendChatMessage();
            }
            // Ctrl+Enter falls through to default textarea behaviour (inserts newline)
        }

        function sendSuggestion(text) {
            document.getElementById('chat-input').value = text;
            sendChatMessage();
        }

        function clearChat() {
            if (!confirm('Start a new chat? The current session will remain in the sidebar.')) return;
            newChat();
        }

        // Initial load
        refresh();
        refreshLogs();
        checkLLMStatus();

        // Auto-refresh every 10 seconds
        refreshInterval = setInterval(refresh, 10000);

        // Auto-refresh logs every 15 seconds
        setInterval(refreshLogs, 15000);

        // Tag Evidence Modal Functions
        async function showTagEvidence(docId, docTitle) {
            const modal = document.getElementById('tag-evidence-modal');
            const modalTitle = document.getElementById('modal-doc-title');
            const modalBody = document.getElementById('modal-evidence-body');

            // Show modal and loading state
            modal.classList.add('active');
            modalTitle.textContent = `Document #${docId}: ${docTitle}`;
            modalBody.innerHTML = '<div class="loading">Loading evidence...</div>';

            try {
                const response = await apiFetch(apiUrl(`/api/tag-evidence/${docId}`));
                const data = await response.json();

                if (data.error) {
                    modalBody.innerHTML = `<div class="no-evidence">${data.error}</div>`;
                    return;
                }

                if (!data.tags || data.tags.length === 0) {
                    modalBody.innerHTML = '<div class="no-evidence">No detailed evidence available for this document.</div>';
                    return;
                }

                // Render evidence items
                let html = '';
                if (data.integrity_summary) {
                    html += `<div style="margin-bottom: 20px; padding: 12px; background: #e8f4f8; border-radius: 6px;">
                        <strong>Integrity Summary:</strong> ${data.integrity_summary}
                        ${data.critical_count > 0 ? `<span style="color: #e74c3c; margin-left: 12px;">‚ö†Ô∏è ${data.critical_count} critical issue(s)</span>` : ''}
                    </div>`;
                }

                for (const tag of data.tags) {
                    const sev = tag.severity || 'low';
                    const severityClass = `severity-${sev}`;
                    const evidence = tag.evidence || {};

                    // Convert newlines in description to <br> for HTML rendering
                    const descHtml = (tag.description || 'No description')
                        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                        .replace(/\n/g, '<br>');

                    // Style for info-level (false positive / pass)
                    const itemStyle = sev === 'info'
                        ? 'style="background: #f0f9ff; border-left: 4px solid #3498db; opacity: 0.85;"'
                        : '';

                    html += `
                        <div class="evidence-item ${severityClass}" ${itemStyle}>
                            <div class="evidence-tag-name">
                                <span>${tag.tag}</span>
                                <span class="evidence-severity ${sev}">${sev}</span>
                            </div>
                            <div class="evidence-description">
                                <strong>${tag.category || 'Issue'}:</strong><br>${descHtml}
                            </div>
                    `;

                    // Duplicate text lines ‚Äî show as quoted code blocks
                    if (evidence.duplicate_texts && evidence.duplicate_texts.length > 0) {
                        html += '<div class="evidence-quotes"><h4>üîÅ Duplicated text:</h4>';
                        for (const line of evidence.duplicate_texts.slice(0, 10)) {
                            const safe = line.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote" style="font-family:monospace; font-size:0.85em;">${safe}</div>`;
                        }
                        html += '</div>';
                    }

                    // Details list (page_discontinuity, etc.)
                    if (evidence.details && evidence.details.length > 0) {
                        html += '<div class="evidence-quotes"><h4>üìã Details:</h4>';
                        for (const detail of evidence.details) {
                            const safe = detail.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote">‚Ä¢ ${safe}</div>`;
                        }
                        html += '</div>';
                    }

                    // Quotes if available (LLM-detected issues)
                    if (evidence.quotes && evidence.quotes.length > 0) {
                        html += '<div class="evidence-quotes"><h4>üìÑ Evidence from document:</h4>';
                        for (const quote of evidence.quotes.slice(0, 3)) {
                            const safe = quote.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote">"${safe}"</div>`;
                        }
                        html += '</div>';
                    }

                    // Conflicting values if available
                    if (evidence.conflicting_values && evidence.conflicting_values.length > 0) {
                        html += '<div class="evidence-quotes"><h4>‚ö†Ô∏è Conflicting values:</h4>';
                        for (const conflict of evidence.conflicting_values) {
                            const safe = conflict.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            html += `<div class="evidence-quote">${safe}</div>`;
                        }
                        html += '</div>';
                    }

                    // Location if available
                    if (evidence.location) {
                        html += `<div class="evidence-location">üìç Found: ${evidence.location}</div>`;
                    }

                    // Impact
                    if (tag.impact) {
                        html += `<div class="evidence-impact"><strong>Impact:</strong> ${tag.impact}</div>`;
                    }

                    // Suggested action
                    if (tag.suggested_action) {
                        html += `<div class="evidence-impact" style="background: #e8f8f5;"><strong>Suggested Action:</strong> ${tag.suggested_action}</div>`;
                    }

                    html += '</div>';
                }

                modalBody.innerHTML = html;
            } catch (error) {
                modalBody.innerHTML = `<div class="no-evidence">Error loading evidence: ${error.message}</div>`;
            }
        }

        function closeTagModal() {
            document.getElementById('tag-evidence-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('tag-evidence-modal');
            if (e.target === modal) {
                closeTagModal();
            }
        });

        // Project Selector Functions
        async function loadProjectSelector() {
            try {
                const response = await apiFetch(apiUrl('/api/projects'));
                const data = await response.json();

                const selector = document.getElementById('project-selector');
                if (!selector) return;

                // Get current project
                const currentResponse = await apiFetch(apiUrl('/api/current-project'));
                const currentProject = await currentResponse.json();

                // Populate dropdown
                selector.innerHTML = data.projects
                    .filter(p => !p.is_archived)
                    .map(p => `<option value="${p.slug}" ${p.slug === currentProject.slug ? 'selected' : ''}>${p.name}</option>`)
                    .join('');

            } catch (error) {
                console.error('Failed to load project selector:', error);
                const selector = document.getElementById('project-selector');
                if (selector) {
                    selector.innerHTML = '<option value="">Error loading projects</option>';
                }
            }
        }

        async function switchProject() {
            const selector = document.getElementById('project-selector');
            const projectSlug = selector.value;

            try {
                const response = await apiFetch(apiUrl('/api/current-project'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ project_slug: projectSlug })
                });

                if (response.ok) {
                    // Reload page to refresh all data for new project
                    window.location.reload();
                } else {
                    alert('Failed to switch project');
                }
            } catch (error) {
                console.error('Failed to switch project:', error);
                alert('Failed to switch project');
            }
        }

        // Load project selector on page load
        loadProjectSelector();
        // Load chat sessions on page load
        loadSessions();


        // ‚îÄ‚îÄ About / Help / Bug Report / SMTP ‚Äî initialise state first ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Variables must be initialised before any code that could throw, so
        // that function bodies that reference them don't hit the TDZ.
        var _helpVisible = false;
        var _helpPanelMap = {
            'overview': 'help-overview',
            'projects': 'help-projects',
            'upload':   'help-upload',
            'ai-chat':  'help-ai-chat',
            'search':   'help-search',
            'config':   'help-config',
            'tools':    'help-tools',
        };
        var _smtpLoaded = false;

        // ‚îÄ‚îÄ About Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openAboutModal() {
            var m = document.getElementById('about-modal');
            if (!m) return;
            m.style.display = 'flex';
            document.getElementById('about-version-line').textContent = 'Loading‚Ä¶';
            document.getElementById('about-components').innerHTML = '<span style="color:#8899aa;">Loading‚Ä¶</span>';
            apiFetch(apiUrl('/api/about')).then(function(r) { return r.json(); }).then(function(d) {
                document.getElementById('about-version-line').textContent = 'Version ' + d.version;
                var comp = d.components || {};
                var rows = '';
                Object.keys(comp).forEach(function(k) {
                    rows += '<span style="color:#aabbcc;">' + escapeHtml(k) + '</span>' +
                            '<span style="color:#7db8f7; font-weight:600;">' + escapeHtml(comp[k]) + '</span>';
                });
                document.getElementById('about-components').innerHTML = rows || '<span style="color:#aabbcc;">‚Äî</span>';
            }).catch(function() {
                document.getElementById('about-version-line').textContent = 'Version unknown';
            });
        }
        function closeAboutModal() {
            var m = document.getElementById('about-modal');
            if (m) m.style.display = 'none';
        }

        // ‚îÄ‚îÄ Tab Help Panels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleTabHelp() {
            _helpVisible = !_helpVisible;
            var btn = document.getElementById('help-toggle-btn');
            if (btn) {
                btn.style.background = _helpVisible
                    ? 'rgba(52,152,219,0.35)'
                    : 'rgba(255,255,255,0.12)';
                btn.textContent = _helpVisible ? '? Help: On' : '? Help: Off';
            }
            _refreshHelpPanel();
        }
        function _refreshHelpPanel() {
            Object.keys(_helpPanelMap).forEach(function(k) {
                var el = document.getElementById(_helpPanelMap[k]);
                if (el) el.style.display = 'none';
            });
            if (!_helpVisible) return;
            var activeTab = document.querySelector('.tab-button.active');
            if (!activeTab) return;
            var m = activeTab.getAttribute('onclick').match(/'([^']+)'/);
            var tabName = m ? m[1] : null;
            var panelId = tabName ? _helpPanelMap[tabName] : null;
            if (panelId) {
                var el = document.getElementById(panelId);
                if (el) el.style.display = 'block';
            }
        }
        // Wrap switchTab so the help panel updates and config sub-tabs are
        // fully reset whenever we leave the config tab.
        (function() {
            var _orig = switchTab;
            switchTab = function(name) {
                _orig(name);
                // Explicitly clear config sub-tab active state when leaving config.
                // This prevents sub-tab content from bleeding into other main tabs
                // during the CSS fadeIn animation window.
                if (name !== 'config') {
                    document.querySelectorAll('.config-sub-content').forEach(function(c) {
                        c.classList.remove('active');
                    });
                }
                _refreshHelpPanel();
            };
        })();

        // ‚îÄ‚îÄ Bug Report Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openBugReportModal() {
            var m = document.getElementById('bug-report-modal');
            if (!m) return;
            m.style.display = 'flex';
            document.getElementById('bug-report-result').style.display = 'none';
            document.getElementById('bug-description').value = '';
            document.getElementById('bug-contact-email').value = '';
            document.getElementById('bug-har-file').value = '';
            document.getElementById('bug-severity').value = 'Medium';
            document.getElementById('bug-include-logs').checked = true;
        }
        function closeBugReportModal() {
            var m = document.getElementById('bug-report-modal');
            if (m) m.style.display = 'none';
        }
        async function submitBugReport() {
            var desc = document.getElementById('bug-description').value.trim();
            var resEl = document.getElementById('bug-report-result');
            function showErr(msg) {
                resEl.style.display = 'block';
                resEl.style.background = 'rgba(231,76,60,0.15)';
                resEl.style.border = '1px solid rgba(231,76,60,0.4)';
                resEl.style.color = '#f08080';
                resEl.textContent = msg;
            }
            if (!desc) { showErr('Please describe the problem before sending.'); return; }
            var email = document.getElementById('bug-contact-email').value.trim();
            if (!email) { showErr('Please enter your email address so we can follow up.'); return; }
            var btn = document.querySelector('#bug-report-modal button[onclick="submitBugReport()"]');
            if (btn) { btn.disabled = true; btn.textContent = 'Sending‚Ä¶'; }
            var fd = new FormData();
            fd.append('description', desc);
            fd.append('severity', document.getElementById('bug-severity').value);
            fd.append('contact_email', document.getElementById('bug-contact-email').value);
            fd.append('include_logs', document.getElementById('bug-include-logs').checked ? 'true' : 'false');
            var harInput = document.getElementById('bug-har-file');
            if (harInput.files && harInput.files[0]) fd.append('har_file', harInput.files[0]);
            try {
                var r = await apiFetch(apiUrl('/api/bug-report'), { method: 'POST', body: fd });
                var d = await r.json();
                resEl.style.display = 'block';
                if (d.ok) {
                    resEl.style.background = 'rgba(39,174,96,0.15)';
                    resEl.style.border = '1px solid rgba(39,174,96,0.4)';
                    resEl.style.color = '#7dcea0';
                    resEl.textContent = d.message;
                    if (btn) { btn.disabled = false; btn.textContent = 'üì® Send Report'; }
                    setTimeout(closeBugReportModal, 3000);
                } else {
                    showErr(d.error || 'Failed to send report.');
                    if (btn) { btn.disabled = false; btn.textContent = 'üì® Send Report'; }
                }
            } catch (e) {
                showErr('Network error: ' + e.message);
                if (btn) { btn.disabled = false; btn.textContent = 'üì® Send Report'; }
            }
        }

        // ‚îÄ‚îÄ SMTP Settings (admin) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function _ensureSmtpLoaded(subtab) {
            if (subtab === 'smtp' && !_smtpLoaded) {
                _smtpLoaded = true;
                loadSmtpSettings();
            }
        }
        // Wrap switchConfigTab to lazy-load SMTP settings
        (function() {
            var _orig = switchConfigTab;
            switchConfigTab = function(name) { _orig(name); _ensureSmtpLoaded(name); };
        })();
        function loadSmtpSettings() {
            apiFetch(apiUrl('/api/smtp-settings')).then(function(r) { return r.json(); }).then(function(d) {
                if (d.error) return;
                document.getElementById('smtp-host').value = d.host || '';
                document.getElementById('smtp-port').value = d.port || 587;
                document.getElementById('smtp-user').value = d.user || '';
                document.getElementById('smtp-pass').value = d.pass || '';
                document.getElementById('smtp-from').value = d.from || '';
                document.getElementById('smtp-helo').value = d.helo || '';
                document.getElementById('smtp-bug-report-to').value = d.bug_report_to || '';
                document.getElementById('smtp-starttls').checked = !!d.starttls;
            }).catch(function() {});
        }
        function _showSmtpResult(msg, ok) {
            var el = document.getElementById('smtp-result');
            el.style.display = 'block';
            el.style.background = ok ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)';
            el.style.border = '1px solid ' + (ok ? 'rgba(39,174,96,0.4)' : 'rgba(231,76,60,0.4)');
            el.style.color = ok ? '#27ae60' : '#e74c3c';
            el.textContent = msg;
        }
        async function saveSmtpSettings() {
            var payload = {
                host: document.getElementById('smtp-host').value.trim(),
                port: parseInt(document.getElementById('smtp-port').value) || 587,
                user: document.getElementById('smtp-user').value.trim(),
                pass: document.getElementById('smtp-pass').value,
                from: document.getElementById('smtp-from').value.trim(),
                helo: document.getElementById('smtp-helo').value.trim(),
                bug_report_to: document.getElementById('smtp-bug-report-to').value.trim(),
                starttls: document.getElementById('smtp-starttls').checked,
            };
            try {
                var r = await apiFetch(apiUrl('/api/smtp-settings'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                var d = await r.json();
                _showSmtpResult(d.ok ? d.message : (d.error || 'Failed'), !!d.ok);
            } catch (e) {
                _showSmtpResult('Error: ' + e.message, false);
            }
        }
        async function testSmtpSettings() {
            _showSmtpResult('Sending test email‚Ä¶', true);
            try {
                var r = await apiFetch(apiUrl('/api/smtp-settings/test'), { method: 'POST' });
                var d = await r.json();
                _showSmtpResult(d.ok ? d.message : (d.error || 'Failed'), !!d.ok);
            } catch (e) {
                _showSmtpResult('Error: ' + e.message, false);
            }
        }
    </script>

    <!-- Tag Evidence Modal -->
    <div id="tag-evidence-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-doc-title">Tag Evidence</h2>
                <button class="modal-close" onclick="closeTagModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-evidence-body">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal">
        <div class="share-modal-box">
            <h3>üîó Share this Chat</h3>
            <div class="share-input-row">
                <input type="text" id="share-username-input" placeholder="Enter username to share with...">
                <button class="btn btn-primary" onclick="addShare()">Share</button>
            </div>
            <div id="share-error" style="color: #e74c3c; font-size: 13px; margin-bottom: 8px; display:none;"></div>
            <div id="share-list-container">
                <div style="font-size: 13px; color: #666; margin-bottom: 6px;">Currently shared with:</div>
                <div class="share-list" id="share-list">
                    <div style="color: #999; font-size: 13px;">No shares yet</div>
                </div>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn" onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ About Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="about-modal" onclick="if(event.target===this)closeAboutModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#243447; border-radius:12px; padding:36px 36px 28px; width:100%; max-width:480px; box-shadow:0 10px 40px rgba(0,0,0,0.6); color:#cdd4dc;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                <div>
                    <h2 style="color:#fff; margin:0 0 4px; font-size:20px;">üìÑ Paperless AI Analyzer</h2>
                    <div style="font-size:13px; color:#aabbcc;" id="about-version-line">Loading‚Ä¶</div>
                </div>
                <button onclick="closeAboutModal()" style="background:none; border:none; color:#aabbcc; font-size:22px; cursor:pointer; padding:0; line-height:1;">&times;</button>
            </div>
            <p style="font-size:14px; color:#aabbcc; margin:0 0 18px;">
                Intelligent document analysis, anomaly detection, and AI-powered chat interface for <strong style="color:#cce5ff;">Paperless-ngx</strong>.
            </p>
            <div style="background:rgba(255,255,255,0.06); border-radius:8px; padding:14px 16px; margin-bottom:18px; font-size:13px;">
                <div style="display:grid; grid-template-columns:auto 1fr; gap:6px 16px;" id="about-components">
                    <span style="color:#aabbcc;">Loading‚Ä¶</span>
                </div>
            </div>
            <div style="font-size:12px; color:#8899aa; margin-bottom:18px;" id="about-footer-links">
                <a href="https://github.com/dblagbro/paperless-ai-analyzer" target="_blank" style="color:#7db8f7;">üîó GitHub Repository</a>
                &nbsp;¬∑&nbsp;
                <a href="#" onclick="closeAboutModal(); openBugReportModal(); return false;" style="color:#ffd580;">üêõ Report an Issue</a>
            </div>
            <div style="text-align:right;">
                <button onclick="closeAboutModal()" style="padding:8px 22px; background:#4a90d9; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600;">Close</button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Bug Report Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="bug-report-modal" onclick="if(event.target===this)closeBugReportModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#243447; border-radius:12px; padding:32px; width:100%; max-width:520px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.6);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color:#fff; margin:0; font-size:17px;">üêõ Report an Issue</h3>
                <button onclick="closeBugReportModal()" style="background:none; border:none; color:#aabbcc; font-size:22px; cursor:pointer; padding:0; line-height:1;">&times;</button>
            </div>
            <p style="color:#aabbcc; font-size:13px; margin:0 0 18px;">
                Describe what happened and we'll send a detailed report (including recent logs) to the developer.
            </p>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Severity</label>
                <select id="bug-severity" style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
                    <option value="Low">Low ‚Äî Minor cosmetic issue or inconvenience</option>
                    <option value="Medium" selected>Medium ‚Äî Feature not working as expected</option>
                    <option value="High">High ‚Äî Major feature broken</option>
                    <option value="Critical">Critical ‚Äî System unusable / data loss risk</option>
                </select>
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">What were you doing when the problem occurred? <span style="color:#e74c3c;">*</span></label>
                <textarea id="bug-description" rows="5" placeholder="e.g. I clicked the Upload button with a PDF file and the page went blank. No error message appeared." style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #334455; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box; resize:vertical;"></textarea>
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#aabbcc; margin-bottom:5px;">Your email <span style="color:#e74c3c;">*</span> <span style="color:#667788;">(required ‚Äî so we can follow up with you)</span></label>
                <input type="email" id="bug-contact-email" placeholder="you@example.com" required style="width:100%; padding:9px 12px; background:#1a2332; border:1px solid #556677; border-radius:5px; color:#eee; font-size:13px; box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block; font-size:12px; color:#ffd580; margin-bottom:5px; font-weight:600;">‚ö†Ô∏è HAR file ‚Äî <strong>strongly recommended</strong></label>
                <input type="file" id="bug-har-file" accept=".har,.json" style="width:100%; padding:7px 0; color:#cdd4dc; font-size:13px;">
                <div style="font-size:12px; color:#aabbcc; margin-top:6px; line-height:1.5;">
                    <strong>Please capture a HAR file before closing the browser tab where the issue occurred:</strong><br>
                    Chrome/Edge: F12 ‚Üí Network tab ‚Üí right-click any request ‚Üí <em>"Save all as HAR with content"</em><br>
                    Firefox: F12 ‚Üí Network tab ‚Üí gear icon ‚Üí <em>"Save All As HAR"</em>
                </div>
            </div>
            <div style="margin-bottom:18px; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="bug-include-logs" checked style="cursor:pointer;">
                <label for="bug-include-logs" style="font-size:13px; color:#aabbcc; cursor:pointer;">Include recent server logs in report (recommended)</label>
            </div>
            <div id="bug-report-result" style="display:none; padding:10px 12px; border-radius:5px; font-size:13px; margin-bottom:14px;"></div>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeBugReportModal()" style="padding:8px 18px; background:rgba(255,255,255,0.1); color:#ccc; border:1px solid #334455; border-radius:5px; cursor:pointer; font-size:13px;">Cancel</button>
                <button onclick="submitBugReport()" style="padding:8px 22px; background:#e07b00; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:600;">üì® Send Report</button>
            </div>
        </div>
    </div>

    </div><!-- end #main-content -->
</div><!-- end #app-layout -->
</body>
</html>
